/*! For license information please see 05cf136b.07c856a9.js.LICENSE.txt */
(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[94573],{377788:(e,t,s)=>{"use strict";s.d(t,{Icon16Ghost:()=>n});var n=(0,s(844990).makeIcon)("Icon16Ghost","ghost_16","0 0 16 16",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" id="ghost_16"><path fill-rule="evenodd" d="M8 1a6.5 6.5 0 0 0-6.5 6.5v4.881c0 .407.095.809.277 1.172a1.5 1.5 0 0 0 2.11.615l.35-.21a1.41 1.41 0 0 1 1.504.036l.857.571.03.02a2.5 2.5 0 0 0 2.745 0l.03-.02.856-.571a1.41 1.41 0 0 1 1.504-.036l.35.21c.748.449 1.72.166 2.11-.615a2.6 2.6 0 0 0 .277-1.172V7.5A6.5 6.5 0 0 0 8 1m-1.091 9.121a.75.75 0 0 0-.818 1.258c.601.39 1.243.618 1.916.619.675 0 1.315-.225 1.911-.625a.75.75 0 1 0-.836-1.246c-.397.267-.75.371-1.072.37-.325 0-.687-.107-1.101-.376M5.5 8.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2m6-1a1 1 0 1 1-2 0 1 1 0 0 1 2 0" clip-rule="evenodd" /></symbol>',16,16,!1,void 0)},914978:(e,t,s)=>{"use strict";s.d(t,{Icon20GlobeCrossOutline:()=>n});var n=(0,s(844990).makeIcon)("Icon20GlobeCrossOutline","globe_cross_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" id="globe_cross_outline_20"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M8.219 7.999h4.191a.75.75 0 0 0 .7-1.02 19 19 0 0 0-1.653-3.827 7.01 7.01 0 0 1 5.08 4.339l.01.024a.75.75 0 1 0 1.401-.533l-.01-.03A8.5 8.5 0 1 0 6.973 17.945a.75.75 0 0 0 .533-1.4 7.02 7.02 0 0 1-3.57-3.043H6.86a.75.75 0 1 0 0-1.5H3.29A7 7 0 0 1 3 10c0-.696.101-1.367.29-2.001h3.401a12.5 12.5 0 0 0-.182 1.623l-.003.059a1 1 0 0 0 .002.106.75.75 0 1 0 1.498-.078l.001-.018c.027-.584.101-1.15.212-1.692m.361-4.855a7 7 0 0 0-4.643 3.355h3.116c.39-1.281.942-2.414 1.527-3.355m1.443.528a18 18 0 0 1 1.344 2.827H8.63c.375-1.084.876-2.04 1.393-2.827" /><path d="M14.002 19a5 5 0 1 0 0-10 5 5 0 0 0 0 10m2.524-6.47a.75.75 0 1 0-1.061-1.06l-1.466 1.468-1.469-1.468a.75.75 0 1 0-1.06 1.06L12.938 14l-1.469 1.47a.75.75 0 1 0 1.062 1.06l1.468-1.47 1.47 1.47a.75.75 0 1 0 1.061-1.06l-1.47-1.471z" /></g></symbol>',20,20,!1,void 0)},900421:(e,t,s)=>{"use strict";s.d(t,{Icon20PlaceOutline:()=>n});var n=(0,s(844990).makeIcon)("Icon20PlaceOutline","place_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" id="place_outline_20"><g fill="none" fill-rule="evenodd"><path d="M0 0h20v20H0z" opacity=".4" /><path fill="currentColor" fill-rule="nonzero" d="M10 1c4.148 0 7.5 3.433 7.5 7.5 0 2.85-1.843 6.172-5.435 10.095a2.8 2.8 0 0 1-4.13 0C4.343 14.672 2.5 11.35 2.5 8.5 2.5 4.433 5.852 1 10 1m0 1.5c-3.382 0-6 2.825-6 6q0 3.574 5.041 9.082a1.3 1.3 0 0 0 1.918 0Q15.999 12.075 16 8.5c0-3.175-2.618-6-6-6M10 5a3.5 3.5 0 1 1-.001 7.001A3.5 3.5 0 0 1 10 5m0 1.5a2 2 0 1 0 .001 4.001A2 2 0 0 0 10 6.5" /></g></symbol>',20,20,!1,void 0)},52315:(e,t,s)=>{"use strict";s.d(t,{Icon20UserAddOutline:()=>n});var n=(0,s(844990).makeIcon)("Icon20UserAddOutline","user_add_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" id="user_add_outline_20"><path fill-rule="evenodd" d="M12.5 8.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5M8.5 6a4 4 0 1 1 8 0 4 4 0 0 1-8 0m-4-.25a.75.75 0 1 0-1.5 0v2H1a.75.75 0 0 0 0 1.5h2v2a.75.75 0 0 0 1.5 0v-2h2a.75.75 0 0 0 0-1.5h-2zm4.155 7.227c.865-.458 2.194-.727 3.845-.727 1.65 0 2.98.27 3.845.727.794.42 1.155.959 1.155 1.71a.7.7 0 0 1-.05.288.3.3 0 0 1-.092.12c-.077.063-.26.155-.599.155H8.241c-.34 0-.522-.092-.6-.156a.3.3 0 0 1-.09-.12.7.7 0 0 1-.051-.287c0-.751.36-1.29 1.155-1.71M12.5 10.75c-1.774 0-3.38.283-4.547.902C6.783 12.27 6 13.26 6 14.688c0 .688.268 1.217.687 1.563.408.337.956.499 1.554.499h8.518c.598 0 1.146-.162 1.555-.499.418-.346.686-.875.686-1.564 0-1.426-.783-2.416-1.953-3.035-1.168-.619-2.773-.902-4.547-.902" clip-rule="evenodd" /></symbol>',20,20,!1,void 0)},7034:(e,t,s)=>{"use strict";s.d(t,{Icon20Users3Outline:()=>n});var n=(0,s(844990).makeIcon)("Icon20Users3Outline","users_3_outline_20","0 0 20 20",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20" id="users_3_outline_20"><path fill="currentColor" fill-rule="evenodd" d="M10 7.75a1.25 1.25 0 1 1 0-2.5 1.25 1.25 0 0 1 0 2.5M7.25 6.5a2.75 2.75 0 1 1 5.5 0 2.75 2.75 0 0 1-5.5 0m-.5 7.25c0-.416.231-.828.796-1.172C8.12 12.23 8.975 12 10 12s1.881.23 2.454.578c.565.344.796.756.796 1.172 0 .293-.1.444-.218.54-.142.113-.396.21-.782.21h-4.5c-.386 0-.64-.097-.781-.21-.12-.096-.219-.247-.219-.54M10 10.5c-1.225 0-2.369.27-3.234.797-.872.531-1.516 1.369-1.516 2.453 0 .707.276 1.306.781 1.71.484.387 1.105.54 1.719.54h4.5c.614 0 1.235-.153 1.719-.54.506-.404.781-1.003.781-1.71 0-1.084-.643-1.922-1.516-2.453-.865-.526-2.01-.797-3.234-.797m4.006-5.588a.75.75 0 0 1 .848-.637A2.5 2.5 0 0 1 14.5 9.25a.75.75 0 0 1 0-1.5 1 1 0 0 0 .143-1.99.75.75 0 0 1-.637-.848M15.749 10a.75.75 0 0 0 0 1.5c1.158 0 1.75.673 1.75 1.25a.86.86 0 0 1-.185.547.57.57 0 0 1-.464.203.75.75 0 0 0 0 1.5c1.428 0 2.15-1.21 2.15-2.25 0-1.712-1.607-2.75-3.251-2.75M5 10.75a.75.75 0 0 0-.75-.75C2.606 10 .999 11.038.999 12.75c0 1.04.722 2.25 2.15 2.25a.75.75 0 0 0 0-1.5.57.57 0 0 1-.465-.203.86.86 0 0 1-.185-.547c0-.577.592-1.25 1.751-1.25a.75.75 0 0 0 .75-.75m.142-6.474a.75.75 0 0 1 .214 1.484A1 1 0 0 0 5.5 7.75a.75.75 0 1 1 0 1.5 2.5 2.5 0 0 1-.358-4.975" clip-rule="evenodd" /></symbol>',20,20,!1,void 0)},963328:(e,t,s)=>{"use strict";s.d(t,{Icon24Headphones:()=>n});var n=(0,s(844990).makeIcon)("Icon24Headphones","headphones_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" id="headphones_24"><path d="M12 2.25a9 9 0 0 0-9 9V18a3 3 0 0 0 3 3h1.5A1.5 1.5 0 0 0 9 19.5v-5A1.5 1.5 0 0 0 7.5 13H5v-1.75c0-3.87 3.13-7 7-7s7 3.13 7 7V13h-2.5a1.5 1.5 0 0 0-1.5 1.5v5a1.5 1.5 0 0 0 1.5 1.5H18a3 3 0 0 0 3-3v-6.75a9 9 0 0 0-9-9" /></symbol>',24,24,!1,void 0)},628204:(e,t,s)=>{"use strict";s.d(t,{Icon24PhoneAddOutline:()=>n});var n=(0,s(844990).makeIcon)("Icon24PhoneAddOutline","phone_add_outline_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="phone_add_outline_24"><g fill="currentColor"><path d="M4.495 4.123c-2.92 3.213-1.36 8.186 2.928 12.494 4.198 4.217 9.394 5.794 12.47 2.932 1.681-1.565 1.433-4.337-.645-6.19-1.88-1.596-4.832-1.872-6.714-.106-.634-.533-1.174-1.163-1.754-1.753 1.626-1.706 1.621-4.676-.055-6.679C8.84 2.57 5.98 2.49 4.495 4.123m4.851 1.852c1.059 1.265 1.2 3.28-.05 4.46-.628.565-1.243.899 1.032 3.213 2.455 2.496 2.76 1.62 3.4.95 1.005-1.008 2.971-1.102 4.323.104 1.496 1.332 1.334 2.864.617 3.531-2.219 2.065-6.468.635-9.97-2.884-3.504-3.52-5.058-7.612-2.873-10.017.508-.558 2.099-1.057 3.521.643M18.5 2a.9.9 0 0 1 .9.9v1.7h1.7a.9.9 0 0 1 0 1.8h-1.7v1.7a.9.9 0 1 1-1.8 0V6.4h-1.7a.9.9 0 0 1 0-1.8h1.7V2.9a.9.9 0 0 1 .9-.9" /></g></symbol>',24,24,!1,void 0)},573638:(e,t,s)=>{"use strict";s.d(t,{Icon24Refresh:()=>n});var n=(0,s(844990).makeIcon)("Icon24Refresh","refresh_24","0 0 24 24",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" id="refresh_24"><path d="M12 9.096a.4.4 0 0 0 .67.296l4.287-3.899a.667.667 0 0 0 0-.987L12.67.609a.4.4 0 0 0-.67.295V4a8 8 0 1 0 8 8 1 1 0 1 0-2 0 6 6 0 1 1-6-6z" /></symbol>',24,24,!1,void 0)},205726:(e,t,s)=>{"use strict";s.d(t,{Icon40PlayCircle:()=>n});var n=(0,s(844990).makeIcon)("Icon40PlayCircle","play_circle_40","0 0 40 40",'<symbol xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 40 40" id="play_circle_40"><path fill-rule="evenodd" d="M40 20c0 11.046-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0s20 8.954 20 20m-14.329 1.077a1.25 1.25 0 0 0 0-2.154l-8.787-5.175A1.25 1.25 0 0 0 15 14.826v10.348a1.25 1.25 0 0 0 1.884 1.078z" clip-rule="evenodd" /></symbol>',40,40,!1,void 0)},895619:()=>{},154335:()=>{},532331:()=>{},853233:()=>{},358633:()=>{},462234:()=>{},198141:()=>{},210795:()=>{},276389:()=>{},258231:()=>{},453963:()=>{},154961:()=>{},315403:()=>{},404614:()=>{},851240:function(e){e.exports=function(){"use strict";var e=function(){return e=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++)for(var r in t=arguments[s])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},e.apply(this,arguments)};function t(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(s[n[r]]=e[n[r]])}return s}var s=function(){function e(e,t){this.ATT_FACTOR=4,this.GRAPH_X=2,this.AMPLITUDE_FACTOR=.6,this.ctrl=e,this.definition=t}return e.prototype.globalAttFn=function(e){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(e,this.ATT_FACTOR)),this.ATT_FACTOR)},e.prototype.xPos=function(e){return this.ctrl.width*((e+this.GRAPH_X)/(2*this.GRAPH_X))},e.prototype.yPos=function(e){return this.AMPLITUDE_FACTOR*(this.globalAttFn(e)*(this.ctrl.heightMax*this.ctrl.amplitude)*(1/this.definition.attenuation)*Math.sin(this.ctrl.opt.frequency*e-this.ctrl.phase))},e.prototype.draw=function(){var e=this.ctrl.ctx;e.moveTo(0,0),e.beginPath();var t=(this.definition.color||this.ctrl.color).replace(/rgb\(/g,"").replace(/\)/g,"");e.strokeStyle="rgba(".concat(t,",").concat(this.definition.opacity,")"),e.lineWidth=this.definition.lineWidth;for(var s=-this.GRAPH_X;s<=this.GRAPH_X;s+=this.ctrl.opt.pixelDepth)e.lineTo(this.xPos(s),this.ctrl.heightMax+this.yPos(s));e.stroke()},e.getDefinition=function(){return[{attenuation:-2,lineWidth:1,opacity:.1},{attenuation:-6,lineWidth:1,opacity:.2},{attenuation:4,lineWidth:1,opacity:.4},{attenuation:2,lineWidth:1,opacity:.6},{attenuation:1,lineWidth:1.5,opacity:1}]},e}(),n=function(){function e(e,t){this.GRAPH_X=25,this.AMPLITUDE_FACTOR=.8,this.SPEED_FACTOR=1,this.DEAD_PX=2,this.ATT_FACTOR=4,this.DESPAWN_FACTOR=.02,this.NOOFCURVES_RANGES=[2,5],this.AMPLITUDE_RANGES=[.3,1],this.OFFSET_RANGES=[-3,3],this.WIDTH_RANGES=[1,3],this.SPEED_RANGES=[.5,1],this.DESPAWN_TIMEOUT_RANGES=[500,2e3],this.ctrl=e,this.definition=t,this.noOfCurves=0,this.spawnAt=0,this.prevMaxY=0,this.phases=[],this.offsets=[],this.speeds=[],this.finalAmplitudes=[],this.widths=[],this.amplitudes=[],this.despawnTimeouts=[],this.verses=[]}return e.prototype.getRandomRange=function(e){return e[0]+Math.random()*(e[1]-e[0])},e.prototype.spawnSingle=function(e){this.phases[e]=0,this.amplitudes[e]=0,this.despawnTimeouts[e]=this.getRandomRange(this.DESPAWN_TIMEOUT_RANGES),this.offsets[e]=this.getRandomRange(this.OFFSET_RANGES),this.speeds[e]=this.getRandomRange(this.SPEED_RANGES),this.finalAmplitudes[e]=this.getRandomRange(this.AMPLITUDE_RANGES),this.widths[e]=this.getRandomRange(this.WIDTH_RANGES),this.verses[e]=this.getRandomRange([-1,1])},e.prototype.getEmptyArray=function(e){return new Array(e)},e.prototype.spawn=function(){this.spawnAt=Date.now(),this.noOfCurves=Math.floor(this.getRandomRange(this.NOOFCURVES_RANGES)),this.phases=this.getEmptyArray(this.noOfCurves),this.offsets=this.getEmptyArray(this.noOfCurves),this.speeds=this.getEmptyArray(this.noOfCurves),this.finalAmplitudes=this.getEmptyArray(this.noOfCurves),this.widths=this.getEmptyArray(this.noOfCurves),this.amplitudes=this.getEmptyArray(this.noOfCurves),this.despawnTimeouts=this.getEmptyArray(this.noOfCurves),this.verses=this.getEmptyArray(this.noOfCurves);for(var e=0;e<this.noOfCurves;e++)this.spawnSingle(e)},e.prototype.globalAttFn=function(e){return Math.pow(this.ATT_FACTOR/(this.ATT_FACTOR+Math.pow(e,2)),this.ATT_FACTOR)},e.prototype.sin=function(e,t){return Math.sin(e-t)},e.prototype.yRelativePos=function(e){for(var t=0,s=0;s<this.noOfCurves;s++){var n=4*(s/(this.noOfCurves-1)*2-1);n+=this.offsets[s];var r=e*(1/this.widths[s])-n;t+=Math.abs(this.amplitudes[s]*this.sin(this.verses[s]*r,this.phases[s])*this.globalAttFn(r))}return t/this.noOfCurves},e.prototype.yPos=function(e){return this.AMPLITUDE_FACTOR*this.ctrl.heightMax*this.ctrl.amplitude*this.yRelativePos(e)*this.globalAttFn(e/this.GRAPH_X*2)},e.prototype.xPos=function(e){return this.ctrl.width*((e+this.GRAPH_X)/(2*this.GRAPH_X))},e.prototype.drawSupportLine=function(){var e=this.ctrl.ctx,t=[0,this.ctrl.heightMax,this.ctrl.width,1],s=e.createLinearGradient.apply(e,t);s.addColorStop(0,"transparent"),s.addColorStop(.1,"rgba(255,255,255,.5)"),s.addColorStop(.8,"rgba(255,255,255,.5)"),s.addColorStop(1,"transparent"),e.fillStyle=s,e.fillRect.apply(e,t)},e.prototype.draw=function(){var e=this.ctrl.ctx;if(e.globalAlpha=.7,e.globalCompositeOperation="lighter",0===this.spawnAt&&this.spawn(),this.definition.supportLine)return this.drawSupportLine();for(var t=0;t<this.noOfCurves;t++)this.spawnAt+this.despawnTimeouts[t]<=Date.now()?this.amplitudes[t]-=this.DESPAWN_FACTOR:this.amplitudes[t]+=this.DESPAWN_FACTOR,this.amplitudes[t]=Math.min(Math.max(this.amplitudes[t],0),this.finalAmplitudes[t]),this.phases[t]=(this.phases[t]+this.ctrl.speed*this.speeds[t]*this.SPEED_FACTOR)%(2*Math.PI);for(var s=-1/0,n=0,r=[1,-1];n<r.length;n++){var a=r[n];e.beginPath();for(var i=-this.GRAPH_X;i<=this.GRAPH_X;i+=this.ctrl.opt.pixelDepth){var o=this.xPos(i),c=this.yPos(i);e.lineTo(o,this.ctrl.heightMax-a*c),s=Math.max(s,c)}e.closePath(),e.fillStyle="rgba(".concat(this.definition.color,", 1)"),e.strokeStyle="rgba(".concat(this.definition.color,", 1)"),e.fill()}return s<this.DEAD_PX&&this.prevMaxY>s&&(this.spawnAt=0),this.prevMaxY=s,null},e.getDefinition=function(){return[{color:"255,255,255",supportLine:!0},{color:"15, 82, 169"},{color:"173, 57, 76"},{color:"48, 220, 155"}]},e}();return function(){function r(r){var a=this,i=r.container,o=t(r,["container"]);this.phase=0,this.run=!1,this.curves=[];var c=window.getComputedStyle(i);this.opt=e({container:i,style:"ios",ratio:window.devicePixelRatio||1,speed:.2,amplitude:1,frequency:6,color:"#fff",cover:!1,width:parseInt(c.width.replace("px",""),10),height:parseInt(c.height.replace("px",""),10),autostart:!0,pixelDepth:.02,lerpSpeed:.1},o),this.speed=Number(this.opt.speed),this.amplitude=Number(this.opt.amplitude),this.width=Number(this.opt.ratio*this.opt.width),this.height=Number(this.opt.ratio*this.opt.height),this.heightMax=Number(this.height/2)-6,this.color="rgb(".concat(this.hex2rgb(this.opt.color),")"),this.interpolation={speed:this.speed,amplitude:this.amplitude},this.canvas=document.createElement("canvas");var d=this.canvas.getContext("2d");if(null===d)throw new Error("Unable to create 2D Context");this.ctx=d,this.canvas.width=this.width,this.canvas.height=this.height,!0===this.opt.cover?this.canvas.style.width=this.canvas.style.height="100%":(this.canvas.style.width="".concat(this.width/this.opt.ratio,"px"),this.canvas.style.height="".concat(this.height/this.opt.ratio,"px")),"ios9"===this.opt.style?this.curves=(this.opt.curveDefinition||n.getDefinition()).map((function(e){return new n(a,e)})):this.curves=(this.opt.curveDefinition||s.getDefinition()).map((function(e){return new s(a,e)})),this.opt.container.appendChild(this.canvas),this.opt.autostart&&this.start()}return r.prototype.hex2rgb=function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,(function(e,t,s,n){return t+t+s+s+n+n}));var s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return s?"".concat(parseInt(s[1],16).toString(),",").concat(parseInt(s[2],16).toString(),",").concat(parseInt(s[3],16).toString()):null},r.prototype.intLerp=function(e,t,s){return e*(1-s)+t*s},r.prototype.lerp=function(e){var t=this.interpolation[e];return null!==t&&(this[e]=this.intLerp(this[e],t,this.opt.lerpSpeed),this[e]-t==0&&(this.interpolation[e]=null)),this[e]},r.prototype.clear=function(){this.ctx.globalCompositeOperation="destination-out",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.globalCompositeOperation="source-over"},r.prototype.draw=function(){this.curves.forEach((function(e){return e.draw()}))},r.prototype.startDrawCycle=function(){this.clear(),this.lerp("amplitude"),this.lerp("speed"),this.draw(),this.phase=(this.phase+Math.PI/2*this.speed)%(2*Math.PI),window.requestAnimationFrame?this.animationFrameId=window.requestAnimationFrame(this.startDrawCycle.bind(this)):this.timeoutId=setTimeout(this.startDrawCycle.bind(this),20)},r.prototype.start=function(){if(!this.canvas)throw new Error("This instance of SiriWave has been disposed, please create a new instance");this.phase=0,this.run||(this.run=!0,this.startDrawCycle())},r.prototype.stop=function(){this.phase=0,this.run=!1,this.animationFrameId&&window.cancelAnimationFrame(this.animationFrameId),this.timeoutId&&clearTimeout(this.timeoutId)},r.prototype.dispose=function(){this.stop(),this.canvas&&(this.canvas.remove(),this.canvas=null)},r.prototype.set=function(e,t){this.interpolation[e]=t},r.prototype.setSpeed=function(e){this.set("speed",e)},r.prototype.setAmplitude=function(e){this.set("amplitude",e)},r}()}()},78874:(e,t,s)=>{"use strict";s.d(t,{API_ERROR_ACCESS:()=>d,API_ERROR_AUTH:()=>r,API_ERROR_AUTH_VALIDATION:()=>l,API_ERROR_CAPTCHA:()=>c,API_ERROR_FLOOD:()=>i,API_ERROR_LIMITS:()=>f,API_ERROR_MESSAGES_CHAT_ADD_TEMPORARY_DENIED:()=>A,API_ERROR_MESSAGES_CHAT_CANT_ADD_USER_BY_PRIVACY:()=>E,API_ERROR_MESSAGES_CHAT_DISABLED:()=>b,API_ERROR_MESSAGES_CHAT_MEMBER_NOT_STAFF:()=>R,API_ERROR_MESSAGES_CHAT_NOT_ADMIN:()=>y,API_ERROR_MESSAGES_CHAT_UNSUPPORTED:()=>w,API_ERROR_MESSAGES_CHAT_USER_NO_ACCESS:()=>v,API_ERROR_MESSAGES_CHAT_WAS_DELETED:()=>N,API_ERROR_MESSAGES_CONTACT_NOT_FOUND:()=>k,API_ERROR_MESSAGES_FOLDERS_LIMIT_REACHED:()=>M,API_ERROR_MESSAGES_GROUP_PEER_ACCESS:()=>_,API_ERROR_MESSAGES_MEMBER_ACCESS_TO_GROUP_DENIED:()=>S,API_ERROR_MESSAGES_MESSAGE_REQUEST_ALREADY_SENT:()=>I,API_ERROR_MESSAGES_SHOULD_BE_EDU:()=>T,API_ERROR_MESSAGES_SHOULD_NOT_BE_EDU:()=>F,API_ERROR_MESSAGES_SPAM_RESTRICTION:()=>U,API_ERROR_MESSAGES_TOO_LONG_MESSAGE:()=>C,API_ERROR_MESSAGES_WRITING_DISABLED_FOR_CHAT:()=>P,API_ERROR_METHOD_DISABLED:()=>u,API_ERROR_PARAM:()=>g,API_ERROR_RATE_LIMIT:()=>p,API_ERROR_SECTION_DISABLED:()=>m,API_ERROR_SERVER:()=>o,API_ERROR_TOO_MANY:()=>a,API_ERROR_UNKNOWN:()=>n,API_ERROR_UNKNOWN_USER:()=>h,API_ERROR_USER_DEACTIVATED:()=>x});const n=1,r=5,a=6,i=9,o=10,c=14,d=15,l=17,u=23,p=29,h=39,m=43,g=100,f=103,C=914,v=917,y=925,_=932,k=936,I=939,b=945,w=946,S=947,R=967,M=975,E=981,A=982,U=984,P=1012,T=1015,F=1016,N=1017,x=3610},309319:(e,t,s)=>{"use strict";s.d(t,{Player:()=>i});var n=s(485184),r=s(822438);const a="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";class i extends n.EventEmitter{play(e,t){this.state.currentTrackEntity?.audioTrack?.url!==e.audioTrack.url?("stopped"!==this.state.status&&this.stopCurrentTrackBeforeStartingNewTrack(),this.startNewTrack(e,t)):"stopped"===this.state.status?this.repeateCurrentTrack(e,t):"paused"===this.state.status?this.resumeTrack(e,t):this.player.currentTime=e.audioTrack.duration*e.audioTrack.progress}playNext(e,t){const{shuffle:s,repeatMode:n}=this.getState(),r=t?.getNext(e,s,n);r&&this.play(r,t)}playPrev(e,t){const{shuffle:s,repeatMode:n}=this.getState(),r=t?.getPrev(e,s,n);r&&this.play(r,t)}pause(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=e?.audioTrack;if(n){const{currentTime:a}=this.player,{duration:i}=n,o={...this.state,status:"paused",playlist:t,playedTimeAccumulator:s,currentTrackEntity:{...e,audioTrack:{...n,progress:a/i}}};this.setState(o),this.player.pause();const c={state:o};this.emit(r.PlayerEventTypes.PAUSE_CURRENT_TRACK,c)}}resume(){const{currentTrackEntity:e,playlist:t}=this.state,s=e?.audioTrack;s&&this.resumeTrack(e,t)}resetCurrentTrackState(){const{currentTrackEntity:e,playlist:t,playedTimeAccumulator:s}=this.state,n=e?.audioTrack;if(n){const r={...this.state,status:"stopped",playlist:t,playedTimeAccumulator:s,currentTrackEntity:{...e,audioTrack:{...n,progress:0}}};this.setState(r)}}startNewTrack(e,t){const s={...this.getState(),status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:e};this.setState(s);const n={state:s};this.emit(r.PlayerEventTypes.START_NEW_TRACK,n);const a=e.audioTrack.url,i=e.audioTrack.duration*e.audioTrack.progress;this.playHTML5Player(a,i)}resumeTrack(e,t){const s=this.getState(),n={...s,status:"playing",playlist:t,playedTimeAccumulator:s.playedTimeAccumulator,currentTrackEntity:e},a=s.currentTrackEntity?.audioTrack?.url;let i;this.player.duration!==1/0&&this.state.currentTrackEntity?.audioTrack?.progress!==e.audioTrack.progress&&(i=e.audioTrack.duration*e.audioTrack.progress),this.setState(n);const o={state:n};this.emit(r.PlayerEventTypes.RESUME_TRACK,o),this.playHTML5Player(a,i)}repeateCurrentTrack(e,t){this.startNewTrack(e,t)}startNextTrackAutomatically(){const e=this.getState(),{playlist:t,currentTrackEntity:s,repeatMode:n,shuffle:a}=e;let i={state:e};if(!t||!s)return void this.emit(r.PlayerEventTypes.PLAYLIST_ENDED,i);const o="one"===n?{...s,audioTrack:{...s.audioTrack,progress:0}}:t.getNext(s,a,n);if(!o)return void this.emit(r.PlayerEventTypes.PLAYLIST_ENDED,i);const c={...e,status:"playing",playlist:t,playedTimeAccumulator:{},currentTrackEntity:o};this.setState(c),i={state:c},this.emit(r.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,i);const d=o.audioTrack.url,l=o.audioTrack.duration*o.audioTrack.progress;this.playHTML5Player(d,l)}stopCurrentTrackAutomatically(){const{currentTrackEntity:e}=this.state;if(e){const e={state:{...this.state}};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_AUTOMATICALLY,e),this.resetCurrentTrackState(),this.player.duration===1/0&&(this.player.src="")}}stopCurrentTrackBeforeStartingNewTrack(){const{currentTrackEntity:e,status:t}=this.state,s=e?.audioTrack;if(s&&"playing"===t){this.player.pause();const e={state:{...this.state,status:"stopped"}};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK,e),this.resetCurrentTrackState()}else s&&"paused"===t&&this.resetCurrentTrackState()}stopCurrentTrackByError(){const{currentTrackEntity:e}=this.state,t=e?.audioTrack;if(t){this.resetCurrentTrackState();const e={state:this.state};this.emit(r.PlayerEventTypes.STOP_CURRENT_TRACK_BY_ERROR,e)}}stopPlayer(){this.state.currentTrackEntity?.audioTrack&&(this.pause(),this.resetCurrentTrackState(),this.setState({...this.state,currentTrackEntity:void 0,playlist:void 0}))}seek(e){const t=this.getState(),{currentTrackEntity:s}=t,n=s?.audioTrack;if(!n)return;const r={...t,currentTrackEntity:{...s,audioTrack:{...n,progress:e}}};this.player.currentTime=n.duration*e,this.setState(r)}setState(e){this.state=e,this.player.volume=e.volume/100,this.player.muted=e.mute,this.player.playbackRate=e.playbackRate,this.emit("stateupdated",e)}getState(){return{...this.state}}forceUpdate(e){this.setState(e),this.player.src=e.currentTrackEntity?.audioTrack?.url||a}setVolume(e){const t={...this.getState(),mute:!1,volume:e};this.setState(t)}setMute(e){const t={...this.getState(),mute:e};this.setState(t)}setShuffle(e){const t={...this.getState(),shuffle:e};this.setState(t)}setRepeatMode(e){const t={...this.getState(),repeatMode:e};this.setState(t)}setPlaybackRate(e){const t=this.getState();this.setState({...t,playbackRate:e})}playHTML5Player(e,t){"number"==typeof t&&(this.player.currentTime=t),e&&this.player.src!==e&&(this.player.src=e),this.player.play().then((()=>{"playing"!==this.getState().status&&this.player.pause(),e&&this.player.src!==e&&this.player.pause()})).catch((()=>{this.stopCurrentTrackByError()}))}dispose(){}constructor(e){super(),this.state=e,this.player=document.createElement("audio"),this.player.volume=e.volume/100,this.player.src=a,this.player.playbackRate=e.playbackRate,this.player.addEventListener("ended",(()=>{const{currentTrackEntity:e}=this.state,t=e?.audioTrack;if(t){const e={...this.state,status:"ended"};this.setState(e),this.stopCurrentTrackAutomatically(),this.startNextTrackAutomatically()}})),this.player.addEventListener("error",(()=>{this.stopCurrentTrackByError()})),this.player.addEventListener("timeupdate",(()=>{const e={...this.state};if(e.currentTrackEntity?.audioTrack){const{currentTime:t,duration:s}=this.player,{duration:n,progress:r,id:a}=e.currentTrackEntity.audioTrack,i=t/n;i>0&&(e.playedTimeAccumulator[a]=(e=>{const t=e.played;let s=0;for(let e=0;e<t.length;e++)s+=t.end(e)-t.start(e);return s})(this.player)),this.setState({...e,currentTrackEntity:{...e.currentTrackEntity,audioTrack:{...e.currentTrackEntity.audioTrack,progress:i>1?1:i}}}),s===1/0&&(0===i&&0!==r||i>1)&&this.player.dispatchEvent(new Event("ended"))}}))}}},431834:(e,t,s)=>{"use strict";s.d(t,{PlayerStorage:()=>a,VoicePlayerStorage:()=>i});var n=s(534053),r=s(37942);class a extends n.Storage{getPlaylist(){const e=this.get("reforged_audio_player_playlist");if((0,r.isRestoredConvoAudiosPlaylist)(e))return new r.ConvoAudiosPlaylist(e)}getCurrentTrack(){const e=this.get("reforged_audio_player_track");if((0,r.isConvoAudioTrack)(e))return e}getVolume(){return this.get("reforged_audio_player_volume")}storeVolume(e){this.set("reforged_audio_player_volume",e)}getMute(){return this.get("reforged_audio_player_mute")}storeMute(e){this.set("reforged_audio_player_mute",e)}getShuffle(){return this.get("reforged_audio_player_shuffle")}storeShuffle(e){this.set("reforged_audio_player_shuffle",e)}getRepeatMode(){return this.get("reforged_audio_player_repeat_mode")}storeRepeatMode(e){this.set("reforged_audio_player_repeat_mode",e)}invalidatePlayerStateCache(){const e=this.get("reforged_audio_player_saved")||0;Date.now()-72e5>e&&(this.del("reforged_audio_player_playlist"),this.del("reforged_audio_player_saved"),this.del("reforged_audio_player_track"))}restorePlayerState(){this.invalidatePlayerStateCache();const e=this.getVolume()||100,t=this.getMute()||!1,s=this.getShuffle()||!1,n=this.getRepeatMode()||"none";return{status:"stopped",playedTimeAccumulator:{},currentTrackEntity:this.getCurrentTrack(),playlist:this.getPlaylist(),volume:e,mute:t,shuffle:s,repeatMode:n,playbackRate:1}}storePlayerState(e){const{currentTrackEntity:t,playlist:s,volume:n}=e;this.set("reforged_audio_player_saved",Date.now()),this.set("reforged_audio_player_volume",n),t?this.set("reforged_audio_player_track",t):this.del("reforged_audio_player_track"),s?s instanceof r.ConvoAudiosPlaylist&&this.set("reforged_audio_player_playlist",{meta:s.getPlaylistMeta(),list:s.getConvoAudiosList()}):this.del("reforged_audio_player_playlist")}}class i extends n.Storage{getVolume(){return this.get("reforged_voice_player_volume")}storeVolume(e){this.set("reforged_voice_player_volume",e)}getMute(){return this.get("reforged_voice_player_mute")}storeMute(e){this.set("reforged_voice_player_mute",e)}getPlaybackRate(){return this.get("reforged_voice_player_playback_rate")}storePlaybackRate(e){this.set("reforged_voice_player_playback_rate",e)}restorePlayerState(){return{status:"stopped",playedTimeAccumulator:{},volume:this.getVolume()||100,mute:this.getMute()||!1,shuffle:!1,repeatMode:"none",playbackRate:this.getPlaybackRate()||1}}}},932904:(e,t,s)=>{"use strict";s.d(t,{BroadcastChannel:()=>r});var n=s(485184);class r extends n.EventEmitter{emit(e){const t=this.connectionId,s=JSON.stringify((e=>({__act:e}))(e));window.localStorage.removeItem(t),window.localStorage.setItem(t,s)}emitLocally(e,t){super.emit(e,t)}dispose(){this.onDisposeActions.forEach((e=>e()))}constructor(){super(),this.onDisposeActions=[],this.connectionId="queue_connection_events_queue78668286";const e=e=>{try{if(e.key===this.connectionId&&e.newValue){const t=JSON.parse(e.newValue),s=t?.__act;s&&super.emit(s)}}catch{}};window.addEventListener("storage",e),this.onDisposeActions.push((()=>window.removeEventListener("storage",e)))}}},249824:(e,t,s)=>{"use strict";s.d(t,{ExternalEvents:()=>n});class n{dispose(){}constructor(){this.listeners=[],this.send=(e,t)=>{for(const s of this.listeners)s(e,t)},this.subscribe=e=>(this.listeners.push(e),()=>{this.listeners=this.listeners.filter((t=>t!==e))})}}},892496:(e,t,s)=>{"use strict";s.d(t,{MEAppMediaMediator:()=>r});var n=s(932904);class r{dispose(){this.broadcastChannel.unsubscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.unsubscribe("stories_video_start",this.pauseCurrentMedia),this.broadcastChannel.dispose()}constructor(){this.broadcastChannel=new n.BroadcastChannel,this.player=null,this.voicePlayer=null,this.videoMessagePlayer=null,this.currentMedia=null,this.prevMedia=null,this.pauseCurrentMedia=()=>{this.currentMedia?.isPlaying()&&this.currentMedia.handleMediaMediatorPause()},this.handlePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.player=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.player){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.player):(this.prevMedia=null,this.currentMedia=this.player)}}else this.prevMedia=null,this.currentMedia=this.player},this.handleVoicePlayerOn=e=>{if(this.broadcastChannel.emit("audio_start"),this.voicePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.voicePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.voicePlayer):(this.prevMedia=null,this.currentMedia=this.voicePlayer)}}else this.prevMedia=null,this.currentMedia=this.voicePlayer},this.handleVoicePlayerOff=e=>{this.voicePlayer=e,this.currentMedia&&this.currentMedia===this.voicePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVideoMessagePlayerOn=e=>{if(this.broadcastChannel.emit("video_message_start"),this.videoMessagePlayer=e,this.currentMedia){if(this.currentMedia&&this.currentMedia!==this.videoMessagePlayer){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=this.videoMessagePlayer):(this.prevMedia=null,this.currentMedia=this.videoMessagePlayer)}}else this.prevMedia=null,this.currentMedia=this.videoMessagePlayer},this.handleVideoMessagePlayerOff=e=>{this.videoMessagePlayer=e,this.currentMedia&&this.currentMedia===this.videoMessagePlayer&&(this.currentMedia=null,this.prevMedia&&(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null))},this.handleVoiceRecorderOn=()=>{if(this.broadcastChannel.emit("audio_start"),this.currentMedia||this.prevMedia!==this.player)if(this.currentMedia){if(this.currentMedia){this.currentMedia.isPlaying()?(this.currentMedia.handleMediaMediatorPause(),this.prevMedia=this.currentMedia,this.currentMedia=null):(this.prevMedia=null,this.currentMedia=null)}}else this.prevMedia=null,this.currentMedia=null},this.handleVoiceRecorderOff=()=>{this.prevMedia&&this.prevMedia===this.player?(this.prevMedia.handleMediaMediatorResume(),this.currentMedia=this.prevMedia,this.prevMedia=null):(this.currentMedia=null,this.prevMedia=null)},this.broadcastChannel.subscribe("audio_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("video_message_start",this.pauseCurrentMedia),this.broadcastChannel.subscribe("stories_video_start",this.pauseCurrentMedia)}}},71883:(e,t,s)=>{"use strict";s.d(t,{MEAppPlayer:()=>c,MEAppVideoMessagePlayer:()=>l,MEAppVoicePlayer:()=>d});var n=s(309319),r=s(324351),a=s(431834),i=s(822438),o=s(73514);class c extends n.Player{play(e,t){return this.mediaMediator.handlePlayerOn(this),super.play(e,t)}setVolume(e){super.setVolume(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setMute(e){super.setMute(e);const{volume:t,mute:s}=this.getState();this.playerStorage.storeVolume(t),this.playerStorage.storeMute(s)}setShuffle(e){super.setShuffle(e);const{shuffle:t}=this.getState();this.playerStorage.storeShuffle(t)}setRepeatMode(e){super.setRepeatMode(e);const{repeatMode:t}=this.getState();this.playerStorage.storeRepeatMode(t)}stopPlayer(){super.stopPlayer();const e=this.getState();this.playerStorage.storePlayerState({...e,status:"stopped"})}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.subscribe(i.PlayerEventTypes.START_NEW_TRACK,(e=>{this.playerStorage.storePlayerState({...e.state,status:"stopped"})})),this.subscribe(i.PlayerEventTypes.START_NEXT_TRACK_AUTOMATICALLY,(e=>{this.playerStorage.storePlayerState({...e.state,status:"stopped"})})),this.mediaMediator=e,this.playerStorage=new a.PlayerStorage(o.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class d extends n.Player{setVolume(e){super.setVolume(e);const{volume:t,mute:s}=this.getState();this.playerStorage?.storeVolume(t),this.playerStorage?.storeMute(s)}setMute(e){super.setMute(e);const{volume:t,mute:s}=this.getState();this.playerStorage?.storeVolume(t),this.playerStorage?.storeMute(s)}setPlaybackRate(e){super.setPlaybackRate(e);const{playbackRate:t}=this.getState();this.playerStorage?.storePlaybackRate(t)}play(e,t){return this.mediaMediator.handleVoicePlayerOn(this),super.play(e,t)}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e,t){super({status:"stopped",playedTimeAccumulator:{},volume:100,mute:!1,shuffle:!1,repeatMode:"none",playbackRate:1}),this.mediaMediator=e,this.subscribe(i.PlayerEventTypes.PLAYLIST_ENDED,(()=>this.mediaMediator.handleVoicePlayerOff(this))),this.playerStorage=new a.VoicePlayerStorage(o.STORAGE_DB_NAME),this.playerStorage.identify(t);const s=this.playerStorage.restorePlayerState();this.forceUpdate(s)}}class l extends r.VideoMessagePlayer{play(e,t){this.mediaMediator.handleVideoMessagePlayerOn(this),super.play(e,t)}resume(){this.mediaMediator.handleVideoMessagePlayerOn(this),super.resume()}stop(){this.mediaMediator.handleVideoMessagePlayerOff(this),super.stop()}dispose(){this.mediaMediator.dispose(),super.dispose()}isPlaying(){const{status:e}=this.getState();return"playing"===e}handleMediaMediatorResume(){super.resume()}handleMediaMediatorPause(){super.pause()}constructor(e){super({status:"stopped",settings:{volume:1,playbackRate:1,muted:!1}}),this.pause=()=>{super.pause(),this.mediaMediator.handleVideoMessagePlayerOff(this)},this.mediaMediator=e}}},170759:(e,t,s)=>{"use strict";s.d(t,{MEAppRecorder:()=>r});var n=s(820724);class r extends n.Recorder{start(){return this.mediaMediator.handleVoiceRecorderOn(),super.start()}pause(){const e=super.pause();return this.mediaMediator.handleVoiceRecorderOff(),e}resume(){return this.mediaMediator.handleVoiceRecorderOn(),super.resume()}stop(){const e=super.stop();return this.mediaMediator.handleVoiceRecorderOff(),e}constructor(e={},t,s){super(e,s),this.mediaMediator=t}}},820724:(e,t,s)=>{"use strict";s.d(t,{Recorder:()=>r});const n={bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!0,wavBitDepth:16,encoderPath:new URL(s(431270),s.b).href,reuseWorker:!0};class r{initWorklet(){return this.audioContext.audioWorklet?this.audioContext.audioWorklet.addModule(this.config.encoderPath):Promise.resolve()}initEncoder(){this.audioContext.audioWorklet&&(this.encoderNode=new AudioWorkletNode(this.audioContext,"encoder-worklet",{numberOfOutputs:0}),this.encoder=this.encoderNode.port)}storePage(e){this.recordedPages.push(e),this.totalLength+=e.length}streamPage(e){this.onDataAvailable(e)}clearStream(){this.stream&&this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}suspendAudioContext(){if("suspended"!==this.audioContext.state)try{this.audioContext.suspend()}catch{}}finish(){if(!this.config.streamPages){const e=new Uint8Array(this.totalLength);this.recordedPages.reduce(((t,s)=>(e.set(s,t),t+s.length)),0),this.onDataAvailable(e),this.recordedPages=[],this.totalLength=0}this.onStop()}initWorker(){const e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,new Promise((t=>{const s=({data:n})=>{switch(n.message){case"ready":t();break;case"page":e(n.page);break;case"done":this.encoder?.removeEventListener("message",s),this.finish()}};this.encoder?.addEventListener("message",s),this.encoder?.start&&this.encoder.start(),this.encoder?.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))}))}initSourceNode(){return window.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then((e=>{this.stream=e,this.sourceNode=this.audioContext.createMediaStreamSource(e)}))}start(){return"inactive"===this.state?(this.state="loading",this.audioContext.resume().then((()=>this.initialize)).then((()=>Promise.all([this.initSourceNode(),this.initWorker()]))).then((()=>{this.sourceNode&&this.encoderNode?(this.state="recording",this.encoder?.postMessage({command:"getHeaderPages"}),this.sourceNode?.connect(this.monitorGainNode),this.sourceNode?.connect(this.recordingGainNode),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode.connect(this.encoderNode),this.onStart()):this.state="inactive"})).catch((e=>{throw this.suspendAudioContext(),this.state="inactive",e}))):Promise.resolve()}pause(){return"recording"===this.state?(this.state="paused",this.recordingGainNode.disconnect(),new Promise((e=>{const t=({data:s})=>{"flushed"===s.message&&(this.encoder?.removeEventListener("message",t),this.onPause(),e())};this.encoder?.addEventListener("message",t),this.encoder?.start(),this.encoder?.postMessage({command:"flush"})}))):(this.onPause(),Promise.resolve())}resume(){"paused"===this.state&&this.encoderNode&&(this.state="recording",this.recordingGainNode.connect(this.encoderNode),this.onResume())}stop(){return this.resume(),"recording"===this.state?(this.state="inactive",this.monitorGainNode.disconnect(),this.clearStream(),this.suspendAudioContext(),new Promise((e=>{const t=({data:s})=>{"done"===s.message&&(this.encoder?.removeEventListener("message",t),e())};this.encoder?.addEventListener("message",t),this.encoder?.start(),this.encoder?.postMessage({command:"done"})}))):(this.onStop(),Promise.resolve())}subscribeToAnalyzer(e){const t=this.sourceNode,s=t.context.createAnalyser();s.fftSize=64,t.connect(s);const n=s.frequencyBinCount,r=new Uint8Array(n);let a=!1;function i(){if(a)return;s.getByteFrequencyData(r);const t=r.reduce(((e,t)=>e+t),0)/n/255;e(t<.1?0:t),requestAnimationFrame(i)}return i(),[()=>{a=!0},()=>{a=!1,i()}]}dispose(){}constructor(e={},t){this.state="inactive",this.config=n,this.recordedPages=[],this.totalLength=0,this.onDataAvailable=function(e){},this.onStart=function(){},this.onPause=function(){},this.onResume=function(){},this.onStop=function(){},this.config={...n,...e};try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.suspendAudioContext.call(this)}catch(e){t.info(`[VoiceRecorder]: new AudioContext ERROR: ${e}`),this.audioContext={createGain(){}}}this.monitorGainNode=this.audioContext.createGain(),this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(this.config.monitorGain,this.audioContext.currentTime,.01),this.recordingGainNode=this.audioContext.createGain(),this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(this.config.recordingGain,this.audioContext.currentTime,.01),this.initialize=this.initWorklet().then((()=>this.initEncoder()))}}},534053:(e,t,s)=>{"use strict";s.d(t,{Storage:()=>r});var n=s(465284);class r{mapKey(e){if(!this.viewerPeerId)throw new Error("Перед использованием Storage должен быть идентифицирован!");return`${this.dbName}-${this.viewerPeerId}-${e}`}dispose(){}constructor(e,t){this.idbStoreName="storage",this.identify=e=>{this.viewerPeerId=e},this.get=e=>{const t=this.mapKey(e);try{const e=localStorage.getItem(t);if(!e)return;return JSON.parse(e,i)}catch(e){return void this.logger?.info("Не удалось получить значение из Storage",e)}},this.set=(e,t)=>{const s=this.mapKey(e);try{localStorage.setItem(s,JSON.stringify(t,a))}catch(e){this.logger?.info("Не удалось записать значение в Storage",e)}},this.del=e=>{const t=this.mapKey(e);try{localStorage.removeItem(t)}catch(e){this.logger?.info("Не удалось удалить значение из Storage",e)}},this.getIDB=async e=>{try{const t=this.mapKey(e);return await n.get(t,this.idbStorage)}catch(e){return void this.logger?.info("Не удалось получить значение из IndexedDB Storage",e)}},this.setIDB=async(e,t)=>{try{const s=this.mapKey(e);return await n.set(s,t,this.idbStorage)}catch(e){this.logger?.info("Не удалось записать значение в IndexedDB Storage",e)}},this.updateIDB=async(e,t)=>{try{const s=this.mapKey(e);return n.update(s,t,this.idbStorage)}catch(e){this.logger?.info("Не удалось обновить значение в IndexedDB Storage",e)}},this.delIDB=async e=>{try{const t=this.mapKey(e);return await n.del(t,this.idbStorage)}catch(e){this.logger?.info("Не удалось удалить значение из IndexedDB Storage",e)}},this.dbName=e,this.logger=t;try{this.idbStorage=window.indexedDB&&n.createStore(e,this.idbStoreName)}catch(e){t?.info("Не удалось создать Storage",e)}}}function a(e,t){return t instanceof Map?{dataType:"Map",entries:Array.from(t.entries())}:t instanceof Set?{dataType:"Set",values:Array.from(t.values())}:t}function i(e,t){if("object"==typeof t&&null!==t){if("Map"===t.dataType)return new Map(t.entries);if("Set"===t.dataType)return new Set(t.values)}return t}},324351:(e,t,s)=>{"use strict";s.d(t,{VideoMessagePlayer:()=>o});var n=s(485184),r=s(822438),a=s(442091);const i={volume:1,playbackRate:1};class o extends n.EventEmitter{updateProgressState(e){const{currentVideoMessageTrack:t}=this.state;t&&this.setState({...this.state,currentVideoMessageTrack:{...t,progress:e}})}setVolume(e){this.setState({...this.state,settings:{...this.state.settings,muted:!1,volume:e}}),this.player.muted=!1,this.player.volume=e,localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}setMuted(e){const t={...this.state,settings:{...this.state.settings,muted:e}};this.setState(t),this.player.muted=e}setPlaybackRate(e){this.setState({...this.state,settings:{...this.state.settings,playbackRate:e}}),this.player.playbackRate=e,localStorage.setItem("videomessage_settings",JSON.stringify(this.state.settings))}stop(){this.player.pause(),this.player.currentTime=0,this.player.src="",this.setState({...this.state,status:"stopped",playlist:void 0,currentVideoMessageTrack:void 0})}play(e,t){this.playHTML5Player(t,t.progress),this.setState({...this.state,status:"playing",convoPeerId:e,currentVideoMessageTrack:t})}move(e=!1){if(!this.state.currentVideoMessageTrack)return;const{playlist:t}=this.state;if(t){const s=e?t.getPrev(this.state.currentVideoMessageTrack):t.getNext(this.state.currentVideoMessageTrack),{source:n}=t.getPlaylistMeta();if(s&&"message"===n?.kind)return this.play(n.peerId,s),this.scrollToMessage(),s;this.stop()}else this.stop()}pause(){const{currentVideoMessageTrack:e}=this.state;e&&(this.player.pause(),this.setState({...this.state,status:"paused"}))}resume(){const{currentVideoMessageTrack:e}=this.state;e&&(this.playHTML5Player(e),this.setState({...this.state,status:"playing"}))}endTrack(){this.setState({...this.state,status:"ended"});const{playlist:e}=this.state;e?this.move():this.stop()}setProgress(e){const{currentVideoMessageTrack:t}=this.state;t&&(this.player.currentTime=(t.duration??0)*e,this.updateProgressState(e))}scrollToMessage(){this.state.currentVideoMessageTrack&&this.emit(r.VideoMessagePlayerEventTypes.SCROLL_TO_MESSAGE,this.state.currentVideoMessageTrack.id)}stopCurrentTrackByError(e){const{currentVideoMessageTrack:t}=this.state;t?.id===e&&this.setState({...this.state,status:"stopped",currentVideoMessageTrack:{...t,progress:0}})}setState(e){this.state=e,this.emit(r.VideoMessagePlayerEventTypes.STATE_UPDATED,e)}getState(){return this.state}getPlayer(){return this.player}forceUpdate(e){this.setState(e)}setPlaylist(e){this.setState({...this.state,playlist:e})}tick(){const{currentVideoMessageTrack:e}=this.state;if(e){const{currentTime:t,duration:s}=this.player,{duration:n=1,progress:r=0}=e,a=t/n;this.updateProgressState(a>1?1:a),s===1/0&&0===a&&0!==r&&this.player.dispatchEvent(new Event("ended"))}}playHTML5Player(e,t){const s=(0,a.getVideoSource)(e.files);"number"==typeof t&&(this.player.currentTime=t),s&&this.player.src!==s&&(this.player.src=s),this.player.volume=this.state.settings.volume,this.player.playbackRate=this.state.settings.playbackRate,this.player.muted=this.state.settings.muted,this.player.play().then((()=>{const{status:e}=this.state;"playing"!==e&&this.player.pause(),s&&this.player.src!==s&&this.player.pause()})).catch((()=>{this.stopCurrentTrackByError(e.id)}))}dispose(){}constructor(e){super(),this.player=document.createElement("video"),this.player.disablePictureInPicture=!0,this.player.playsInline=!0,this.player.src="",this.state=e;const t=localStorage.getItem("videomessage_settings");this.state.settings=t?JSON.parse(t):i,this.player.addEventListener("ended",(()=>{this.endTrack()})),this.player.addEventListener("timeupdate",(()=>{this.tick()})),this.player.addEventListener("error",(()=>{const{currentVideoMessageTrack:e}=this.state;e&&this.stopCurrentTrackByError(e.id)}))}}},442091:(e,t,s)=>{"use strict";function n(e,t,s,n,r){return{...t,id:`${s}_${t.id}`,rootMessageId:s,progress:e,messageSentAt:n,messageAuthorId:r}}function r(e){return e?.mp4_2160||e?.mp4_1440||e?.mp4_1080||e?.mp4_720||e?.mp4_480||e?.mp4_360||e?.mp4_240||e?.mp4_144||""}s.d(t,{getVideoSource:()=>r,toVideoMessageTrack:()=>n})},869634:(e,t,s)=>{"use strict";s.d(t,{searchChannels:()=>m,searchConversationMembers:()=>g,searchConversations:()=>l,searchMessages:()=>u,searchPosts:()=>h,searchUsersGlobal:()=>p});var n=s(872466),r=s(175953),a=s(946990),i=s(73514),o=s(841093),c=s(350946),d=s(777211);async function l(e,t,s,r){const a=await e("messages.searchConversations",{q:s,count:i.SEARCH_CONVOS_COUNT,extended:1,group_id:r}),{profiles:o,groups:c,items:d,contacts:l}=a;return t({profiles:o,groups:c,conversations:d,contacts:l}),d.reduce(((e,t)=>{const s=(0,n.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set)}async function u(e,t,s,n){const r=await e("messages.search",{...n,extended:1,count:i.SEARCH_MESSAGES_COUNT}),{items:o,count:c,conversations:d,contacts:l,profiles:u,groups:p}=r;s({profiles:u,groups:p,conversations:d,contacts:l});return{results:o.reduce(((e,s)=>{const n=(0,a.fromApiMessage)(s).message;return"Normal"===n.kind?e.push(n):t.error(`Сообщение неожиданного типа вернулось из message.search: ${n.kind}`),e}),[]),count:c,apiItemsCount:o.length}}async function p(e,t,s,n=!1){const a=await e(n?"meEducation.usersSearch":"users.search",s),{items:i,count:o}=a;t({profiles:i});return{results:i.map((e=>r.resolveRealId("User",e.id))),count:o}}async function h(e,t,s,n){const r=await e("wall.search",{owners_only:1,query:n.query,offset:n.offset,domain:n.channelId,extended:1,count:i.SEARCH_POSTS_COUNT}),{items:a,count:c,profiles:d,groups:l}=r;s({profiles:d,groups:l});return{results:a.reduce(((e,t)=>{const s=(0,o.fromApiSearchPost)(t);return s?(e.push(s),e):e}),[]),count:c,apiItemsCount:a.length}}async function m(e,{count:t,query:s,offset:n}){const r=await e("channels.search",{extended:1,target:"channels",q:s,count:t,offset:n}),{channels:a,count:i,groups:o}=r;return{items:a.reduce(((e,t)=>{const s=o?.find((e=>-e.id===t.channel.channel_id));if(!s)throw new Error("С бэка не приходит нужная группа для канала");const n=(0,c.fromApiChannel)(t,s);return e.push(n),e}),[]),apiCount:i}}async function g(e,t,{count:s,query:{query:n},peerId:r,ownerId:a}){if(!n)return{items:[],apiCount:0};const i=await e("messages.searchConversationMembers",{q:n,count:s,peer_id:r,extended:1,group_id:(0,d.getOwnerGroupId)(a)}),{items:o,count:c,contacts:l,profiles:u,groups:p}=i;return t({profiles:u,groups:p,contacts:l}),{items:o,apiCount:c}}},127976:(e,t,s)=>{"use strict";s.d(t,{useApiFetch:()=>o});var n=s(70915),r=s(296540),a=s(592087),i=s(444329);function o(){const{api:e}=(0,n.useBrowserEnv)(),t=(0,r.useRef)(new Set);return(0,r.useEffect)((()=>()=>{t.current.forEach((s=>{e.dangerouslyAbort(s),t.current.delete(s)}))}),[e]),(0,r.useCallback)(((s,n,r)=>{const o=r?.trackId??a.IApi.resolveTrackId(s,(0,i.nanoid)(5));return t.current.add(o),e.fetch(s,n,{...r,trackId:o})}),[e])}},470542:(e,t,s)=>{"use strict";s.d(t,{useFormatPhoneNumber:()=>a});var n=s(522300),r=s(296540);function a(){const[e,t]=(0,r.useState)(!1),a=(0,r.useRef)(null);(0,r.useEffect)((()=>{s.e(85128).then(s.bind(s,85128)).then((({getAsYouType:e})=>{a.current=e("RU"),t(!0)}))}),[]);return{isReady:e,format:(0,r.useCallback)((e=>{if(!a.current)return e;if(0===e.length)return"";const t=(0,n.preparePhoneNumber)(e);return a.current.reset(t.replace(/[^\d+]/g,"")),a.current.number().trim()}),[])}}},972283:(e,t,s)=>{"use strict";s.d(t,{useTabListNavigation:()=>a});var n=s(296540);const r=0;function a({hasMore:e=!1}){const[t,s]=(0,n.useState)(r),[a,i]=(0,n.useState)(!1),o=(0,n.useRef)(0),c=(0,n.useCallback)((e=>o.current=e),[]),d=(0,n.useRef)(),l=(0,n.useCallback)((e=>d.current=e),[]),u=(0,n.useCallback)(((e=r)=>{i(!1),s(e)}),[]),p=(0,n.useCallback)(((n,r)=>{if(0!==o.current)switch(n){case"Enter":case"Mod+Enter":r.stopPropagation(),r.preventDefault(),d.current?.(t);break;case"ArrowDown":r.stopPropagation(),r.preventDefault(),i(e&&t+1===o.current),s((e=>e+1<o.current?e+1:e));break;case"ArrowUp":r.stopPropagation(),r.preventDefault(),s((e=>e>0?e-1:0)),i(!1)}}),[t,e]);return{setTabsCount:c,setSelectHandler:l,indexToSelect:t,onKeyDown:p,resetIndexToSelect:u,forceScrollToLoader:a}}},632434:(e,t,s)=>{"use strict";s.d(t,{usePhoneJoin:()=>l});var n=s(296540),r=s(334298),a=s(175953),i=s(843779),o=s(70915),c=s(62812),d=s(468831);function l({onClose:e,onSuccess:t,onError:s,onMyNumberEntered:l,peerId:u}){const{api:p,lang:h}=(0,o.useBrowserEnv)(),{importContact:m}=(0,c.useImportContact)(),g=(0,o.useInsertIntoCache)(),[f,C]=(0,n.useState)(!1),[v,y]=(0,n.useState)(""),{profileType:_}=(0,o.useViewer)(),k=i.isEdu(_),I=(0,n.useCallback)((()=>{e(),C(!1),y("")}),[e]),b=(0,n.useCallback)((()=>y("")),[]),w=(0,n.useCallback)((async e=>{let n;C(!0);try{const s=await m({phone:e,name:"",withExisting:!0});if(s.hasFailed)return y(s.isMyPhoneNumber?h.use("me_phone_invite_error_already_exists"):h.use(k?"me_phone_invite_error_not_found_edu":"me_phone_invite_error_not_found")),void(s.isMyPhoneNumber&&l&&l());g({contacts:[s.contact],profiles:s.profile?[s.profile]:void 0}),n=(0,d.fromApiContact)(s.contact),u&&a.isChatPeerId(u)&&await p.fetch("messages.addChatUser",{peer_id:n.id,chat_id:a.toRealId(u),source:"phone"}),t(n.id)}catch(e){s?.(e,n)}finally{C(!1)}}),[p,m,g,h,s,t,l,u,k]),S=void 0!==u;return{modal:n.createElement(r.PhoneInviteModal,{onClose:I,onSubmit:w,onErrorReset:b,error:v,isLoading:f,title:h.use(S?"me_phone_invite_title":"me_phone_write_title"),subtitle:h.use(S?"me_phone_invite_subtitle":"me_phone_write_subtitle"),action:h.use(S?"me_phone_invite_action":"me_phone_write_action"),focusOnMount:!0})}}},445164:(e,t,s)=>{"use strict";s.d(t,{useChannelsSearchData:()=>P,useConvoSearch:()=>C,useConvoSearchData:()=>_,useMessagesSearchData:()=>I,usePostsSearchData:()=>b,useSearchConversationMembers:()=>N,useSearchHandlers:()=>v,useUsersGlobalSearchData:()=>R});var n=s(296540),r=s(70915),a=s(175953),i=s(856562),o=s(769609),c=s(869634),d=s(972283),l=s(181735),u=s(777211),p=s(127976),h=s(73514),m=s(843779),g=s(592087),f=s(444329);function C({onSelect:e,searchIndex:t,defaultResults:s}){const{setTabsCount:r,setSelectHandler:a,resetIndexToSelect:i,onKeyDown:o,indexToSelect:c,forceScrollToLoader:l}=(0,d.useTabListNavigation)({}),{query:u,setNavigationParams:p,...h}=v();(0,n.useEffect)((()=>{p({resetIndexToSelect:i,onKeyDown:o})}),[p,i,o]);const{results:m,isLoading:g,isDefault:f}=_({searchIndex:t,defaultResults:s,query:u}),C=(0,n.useMemo)((()=>M(m)??[]),[m]),y=(0,n.useCallback)((t=>{const s=C[t];void 0!==s&&e(s)}),[C,e]);return(0,n.useEffect)((()=>{a(y)}),[y,a]),(0,n.useEffect)((()=>{r(C.length)}),[C,r]),{query:u,...h,results:m,isLoading:g,isDefault:f,indexToSelect:c,forceScrollToLoader:l}}function v(e){const t=(0,n.useRef)(null),s=(0,n.useCallback)((e=>t.current=e),[]),[r,a]=(0,n.useState)(""),[i,o]=(0,n.useState)(!1),c=(0,n.useCallback)((e=>{a(e),t.current?.resetIndexToSelect()}),[]),d=(0,n.useCallback)((e=>c(e.target.value)),[c]),u=(0,n.useMemo)((()=>(0,l.onElementKeyDownFactory)(((s,n)=>{if("Escape"===s)return n.preventDefault(),r&&(c(""),n.stopPropagation()),void(e?.current&&(e?.current?.blur(),n.stopPropagation()));t.current?.onKeyDown(s,n)}))),[r,c,e]),p=(0,n.useCallback)((()=>{o(!0)}),[]),h=(0,n.useCallback)((()=>{o(!1)}),[]),m=(0,n.useCallback)((()=>{c("")}),[c]),g=(0,n.useRef)(),[f,C]=(0,n.useState)(!1);return(0,n.useLayoutEffect)((()=>{i&&C(!1)}),[i]),(0,n.useLayoutEffect)((()=>{C(!r&&!!g.current),g.current=r}),[r]),{onChange:d,onKeyDown:u,onFocus:p,onBlur:h,reset:m,isFocused:i,becameEmpty:f,setNavigationParams:s,query:r,setQuery:c}}const y=new Set;function _({defaultResults:e=y,searchIndex:t,query:s}){const d=(0,r.useConvos)(),{vkm_delete_chat:l}=(0,r.useFeatureFlags)(),[m,g]=(0,n.useState)({isLoading:!1,results:e}),f=(0,n.useRef)(!0),{debounced:C,debouncedUpdatesCount:v}=(0,r.useDebounced)(s,h.SEARCH_DEBOUNCE_MS),_=(0,p.useApiFetch)(),k=(0,r.useOwner)(),I=(0,r.useInsertIntoCache)(),b=0===s.length,w=(0,r.usePeers)();(0,n.useEffect)((()=>{b&&(f.current=!0,g({isLoading:!1,results:e}))}),[b,e]),(0,n.useEffect)((()=>{if(b)return;f.current=!1;let e=t?o.search(t,s,{direct:!0}):new Set;l&&(e=new Set([...e].filter((e=>{const t=i.safeGet(d,e);return!i.isDeleted(t)})))),g({isLoading:!0,results:e})}),[s,b]);const S=(0,n.useRef)(s);S.current=s;const R=(0,n.useCallback)((async e=>{if(0!==e.length){g((e=>({...e,loading:!0})));try{const n=await(0,c.searchConversations)(_,I,e,(0,u.getOwnerGroupId)(k.id));if(S.current!==e)return;g((e=>{const r=new Set([...e.results.values()]);n.forEach((e=>{if(a.isContactPeerId(e)){const t=w.get(e);if("Contact"===t?.kind&&t.userId)return}r.has(e)||r.add(e)}));return(t?o.search(t,s,{direct:!1,localCased:!0,translit:!0}):new Set).forEach((e=>r.add(e))),{isLoading:!1,results:r}}))}catch{g((e=>({...e,loading:!1})))}}}),[_,I,k.id,w,s,t]);(0,n.useEffect)((()=>{R(C)}),[v,C]);const{isLoading:M,results:E}=m;let A;return A=s&&M&&0===E.size?"loading":s&&!M&&0===E.size?"empty":E,{results:A,isLoading:M,isDefault:f.current}}const k=[];function I({query:e,date:t,peerId:s}){const a=0===e.length&&!t,{logger:i}=(0,r.useBrowserEnv)(),o=(0,r.useOwner)(),d=(0,r.useInsertIntoCache)(),l=(0,p.useApiFetch)(),[h,m]=(0,n.useState)({isLoading:!1,hasMore:!0,results:k}),g=(0,n.useRef)(0),f=(0,n.useRef)(e);f.current=e;const C=(0,n.useCallback)((async e=>{if(!a){m((e=>({...e,isLoading:!0})));try{const n=await(0,c.searchMessages)(l,i,d,{q:e,peer_id:s,date:t,offset:g.current,group_id:(0,u.getOwnerGroupId)(o.id)});if(f.current!==e)return;const{results:r,count:a,apiItemsCount:p}=n;g.current+=p,m((e=>({isLoading:!1,hasMore:a>g.current&&p>0,results:[...e.results,...r]})))}catch{m((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[a,s,t,l,d,i,o.id]),{isLoading:v,hasMore:y,results:_}=h,I=(0,n.useCallback)((()=>{y&&!v&&C(e)}),[y,v,C,e]);(0,n.useLayoutEffect)((()=>{g.current=0,a?m({isLoading:!1,hasMore:!1,results:k}):(m({isLoading:!0,hasMore:!0,results:[]}),C(e))}),[a,e,s,t]);return{results:0===_.length&&!v&&!y&&!a?"empty":_,isLoading:v,hasMore:y,loadMore:I}}function b({query:e,channelId:t}){const s=0===e.length,{logger:a}=(0,r.useBrowserEnv)(),i=(0,r.useInsertIntoCache)(),o=(0,p.useApiFetch)(),[d,l]=(0,n.useState)({isLoading:!1,hasMore:!0,results:[]}),u=(0,n.useRef)(0),m=(0,n.useRef)(e);m.current=e;const g=(0,n.useCallback)((async e=>{if(!s){l((e=>({...e,isLoading:!0})));try{if(!t)return;const s=await(0,c.searchPosts)(o,a,i,{query:e,channelId:t,offset:u.current});if(m.current!==e)return;const{results:n,apiItemsCount:r}=s;u.current+=r,l((e=>({isLoading:!1,hasMore:h.SEARCH_POSTS_COUNT===r,results:[...e.results,...n]})))}catch{l((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[s,o,i,a,t]),{isLoading:f,hasMore:C,results:v}=d,y=(0,n.useCallback)((()=>{C&&!f&&g(e)}),[C,f,g,e]);(0,n.useLayoutEffect)((()=>{u.current=0,s?l({isLoading:!1,hasMore:!1,results:[]}):(l({isLoading:!0,hasMore:!0,results:[]}),g(e))}),[s,e,t]);return{results:0===v.length&&!f&&!C&&!s?"empty":v,isLoading:f,hasMore:C,loadMore:y}}const w=20,S=[];function R({query:e}){const t=0===e.length,s=(0,p.useApiFetch)(),a=(0,r.useFeatureFlags)(),{profileType:i,viewer:o}=(0,r.useViewer)(),d=a.vkm_add_non_friends&&!m.isEdu(i)||a.vkm_edu_global_users_search&&m.isEdu(i)&&o.isVerified,l=(0,r.useInsertIntoCache)(),[u,h]=(0,n.useState)({isLoading:!1,hasMore:!0,results:S}),g=(0,n.useRef)(0),f=(0,n.useRef)(e);f.current=e;const C=(0,n.useCallback)((async e=>{if(!t){h((e=>({...e,isLoading:!0})));try{const t=await(0,c.searchUsersGlobal)(s,l,{q:e,offset:g.current,count:w},m.isEdu(i));if(f.current!==e)return;const{results:n,count:r}=t;g.current+=w,h((e=>({isLoading:!1,hasMore:r>g.current&&0!==n.length,results:[...e.results,...n]})))}catch{h((e=>({...e,isLoading:!1,hasMore:!1})))}}}),[t,s,l,i]),{isLoading:v,hasMore:y,results:_}=u,k=(0,n.useCallback)((()=>{y&&!v&&d&&C(e)}),[y,v,C,e,d]),I=(0,n.useCallback)((()=>{h((e=>({...e,hasMore:!0,results:S})))}),[]);(0,n.useLayoutEffect)((()=>{g.current=0,!t&&d?(h({isLoading:!0,hasMore:!0,results:S}),C(e)):h({isLoading:!1,hasMore:!1,results:S})}),[t,e,d]);return{results:0===_.length&&!v&&!y&&!t?"empty":_,isLoading:v,hasMore:y,loadMore:k,reset:I}}const M=e=>"empty"===e||"loading"===e?null:Array.from(e.values()),E=({query:e,defaultQuery:t,searchCount:s,defaultResults:a=[],loadResults:i,isQueryEmpty:o,isQueryEqual:c})=>{const{api:d}=(0,r.useBrowserEnv)(),l=(0,p.useApiFetch)(),{debounced:u}=(0,r.useDebounced)(e,h.SEARCH_DEBOUNCE_MS),[m,C]=(0,n.useState)({results:a,hasMore:!0,query:t}),[v,y]=(0,n.useState)(!1),[_,k]=(0,n.useState)(void 0),I=(0,n.useRef)(t),b=(0,n.useRef)(0),w=(0,n.useRef)(void 0),S=(0,n.useCallback)((()=>{C({results:a,hasMore:!0,query:t}),I.current=t,b.current=0,w.current=void 0,y(!1),k(void 0)}),[a,t]),R=(0,n.useCallback)((async(e,t=0)=>i(((e,t,s)=>{w.current&&d.dangerouslyAbort(w.current);const n=g.IApi.resolveTrackId(e,(0,f.nanoid)(5));return w.current=n,l(e,t,{...s,trackId:n})}),{query:e,offset:t,count:s})),[d,l,i,s]),M=(0,n.useCallback)((async(e,t)=>{y(!0),k(void 0);try{const n=await R(e,t);if(e!==I.current)return;C((s=>({results:t?[...s.results,...n.items]:n.items,hasMore:n.apiCount>b.current&&!!n.items.length,query:e}))),b.current=(t??0)+s,y(!1)}catch(t){if(t instanceof g.IApi.AbortError)return;t instanceof g.IApi.RequestError&&e===I.current&&(k(t),y(!1))}}),[R,s]),E=(0,n.useCallback)((()=>{m.hasMore&&!v&&M(I.current,b.current)}),[M,v,m.hasMore]),A=(0,n.useCallback)((()=>{void 0!==_&&M(I.current,b.current)}),[M,_]);return(0,n.useEffect)((()=>{I.current=u,c(u,m.query)||M(u)}),[u]),(0,n.useEffect)((()=>{y(e!==m.query),o(e)&&S()}),[e,o]),{...m,isLoading:v,error:_,loadMore:E,retry:A}},A=e=>0===e.length,U=(e,t)=>e===t;function P({query:e}){return E({query:e,defaultQuery:"",isQueryEmpty:A,isQueryEqual:U,searchCount:h.SEARCH_CHANNELS_COUNT,loadResults:c.searchChannels})}const T=e=>!e.query,F=(e,t)=>e.query===t.query;function N({query:e,peerId:t}){const s=(0,r.useOwner)(),a=(0,r.useInsertIntoCache)(),i=(0,r.useFeatureFlags)(),{searchCount:o=h.MEMBERS_SEARCH_COUNT}=i.vkm_members_search_pagination||{},d=(0,n.useCallback)((async(e,{query:n,count:r})=>(0,c.searchConversationMembers)(e,a,{query:n,count:r,peerId:t,ownerId:s.id})),[a,s.id,t]);return E({query:e,defaultQuery:{},isQueryEmpty:T,isQueryEqual:F,searchCount:o,loadResults:d})}},554312:(e,t,s)=>{"use strict";s.d(t,{ContactList:()=>P});s(532331);var n=s(296540),r=s(836692),a=s(70915),i=s(52315),o=s(914978),c=s(500542),d=s(175953),l=s(769609),u=s(206618),p=s(596934),h=s(700952),m=s(239036),g=s(445164),f=s(833472),C=s(793415),v=s(632434),y=s(45056),_=s(794515),k=s(753457),I=s(181735),b=s(592087),w=s(78874),S=s(138234),R=s(73514),M=s(504551),E=s(370415),A=s(399076);const U={sliceCount:R.CONVOS_PER_PAGE,preloadCount:R.CONVOS_PER_PAGE/10,throttleDelay:100,sliceCountIncrement:R.CONVOS_PER_PAGE/2},P=({items:e,contacts:t,hasMore:s,onSelect:r,goBack:d})=>{const h=(0,a.useDispatch)(),{lang:m}=(0,a.useBrowserEnv)(),{navigate:I}=(0,y.useRouter)(),R=(0,_.useSnackbar)(),P=(0,a.useFeatureFlags)(),{viewer:F}=(0,a.useViewer)(),N=(0,n.useRef)(null),[x,q]=(0,n.useState)(!1),[O,D]=(0,n.useState)("loading"),[B,L]=(0,n.useState)([]),G=(0,n.useMemo)((()=>new Map([...t].filter((([,e])=>0===e.userId)))),[t]),{query:H,onChange:V,onKeyDown:K,onFocus:z,onBlur:W,reset:j}=(0,g.useSearchHandlers)(),$=(0,n.useCallback)((()=>q(!0)),[]),Q=(0,n.useCallback)((()=>q(!1)),[]),J=(0,n.useCallback)((()=>n.createElement("li",{className:"ContactList__itemWrapper"},n.createElement("button",{className:"ContactList__importButton",onClick:$},n.createElement("span",{className:"ContactList__importButtonIcon"},n.createElement(i.Icon20UserAddOutline,null)),m.use("me_contacts_import")))),[m,$]),X=(0,C.useModal)(),Y=(0,n.useCallback)((e=>{X.close(),I({kind:"ConvoRoute",peerId:e,entrypoint:"contacts_list"})}),[I,X]),Z=(0,n.useCallback)((e=>{let t=m.use("me_phone_invite_contacts_unknown_error");e instanceof b.IApi.RequestError&&(e.code===w.API_ERROR_MESSAGES_SPAM_RESTRICTION||e.code===w.API_ERROR_FLOOD)&&(t=m.use("me_phone_invite_contacts_spamblock_or_floodcontrol_error")),R({before:n.createElement(o.Icon20GlobeCrossOutline,{fill:"var(--vkui--color_text_negative)"}),message:t})}),[R,m]),{modal:ee}=(0,v.usePhoneJoin)({onClose:X.close,onSuccess:Y,onError:Z,onMyNumberEntered:()=>{d?.(),X.close(),I({kind:"ConvoRoute",peerId:F.id,entrypoint:"contacts_list"})}}),te=(0,n.useCallback)((()=>n.createElement("li",{className:"ContactList__itemWrapper"},n.createElement(f.InviteButton,{onClick:X.open,className:"ContactList__phoneJoin"},m.use("me_phone_invite_contacts_action")))),[X.open,m]),se=(0,n.useMemo)((()=>{const e=[{key:"import",render:J}];return P.vkm_write_non_friends_by_phone&&e.push({key:"writeByPhone",render:te}),e}),[P.vkm_write_non_friends_by_phone,J,te]),ne=(0,n.useMemo)((()=>l.add(l.create(),[...e.values(),...t.values()],(e=>({id:"Contact"===e.kind&&e.userId?e.userId:e.id,strings:l.peerWords(e)})))),[t,e]);(0,n.useEffect)((()=>{if(s)return void h({type:"LoadContactList",offset:0});const t=[...e.keys(),...G.keys()];L(t),D(0===t.length?"empty":"results")}),[s,h,e,G]),(0,n.useEffect)((()=>{N.current?.focus()}),[]),(0,n.useEffect)((()=>{if("loading"===O)return;if(H){const e=[...l.search(ne,H).values()];return L(e),void D(e.length?"results":"empty")}const t=[...e.keys(),...G.keys()];L(t),D(0===t.length?"empty":"results")}),[G,H,e,ne,O]);const re=(0,n.useCallback)((e=>se[e]?.render()||null),[se]),[ae,ie]=(0,n.useState)(null),[oe,ce]=(0,n.useState)(null),de=(0,n.useMemo)((()=>({ref:ie})),[]),le=(0,n.useMemo)((()=>({className:"ChannelsList__scrollbar-content",ref:ce})),[]),ue=(0,n.useMemo)((()=>({kind:"Upper"})),[H]),[pe]=(0,n.useState)((()=>new S.VirtualizerCore(U))),he=(0,n.useMemo)((()=>{const e=se.map((({key:e})=>e));return B.forEach((t=>e.push(t.toString()))),e}),[B,se]),{virtualizerState:me}=(0,M.useVirtualScroll)({virtualizerCore:pe,wrapper:ae,content:oe,options:{scrollPosition:ue,itemsKeys:he,anchorAlign:"scrollTop"}});return n.createElement("div",{className:"ContactList"},"loading"!==O&&t.size>0&&n.createElement("div",{className:"ContactList__search"},n.createElement(k.Search,{placeholder:m.use("me_convo_list_search_placeholder"),getRef:N,value:H,onChange:V,onKeyDown:K,onFocus:z,onBlur:W,onReset:j})),"empty"===O?n.createElement("div",{className:"ContactList__contacts"},se.length>0&&n.createElement("ul",null,se.map(((e,t)=>re(t)))),n.createElement("div",{className:"ContactList__noResults"},m.use(H?"me_search_empty_contacts":"me_contacts_empty"))):n.createElement("div",{className:"ContactList__contacts"},"loading"===O?n.createElement(c.OptimizedSpinner,{className:"ContactList__loader"}):n.createElement(p.ScrollbarProvider,{scrollableProps:de,contentProps:le,overflowX:"hidden"},n.createElement(A.VirtualScrollList,{virtualizerCore:pe,virtualizerState:me},he.map(((e,t)=>n.createElement(E.VirtualScrollItem,{key:e,itemKey:e},n.createElement(T,{index:t,onSelect:r,actionButtons:se,contacts:G,results:B}))))))),x&&n.createElement(u.ImportContactModal,{onClose:Q}),X.isActive&&ee)},T=({index:e,contacts:t,results:s,onSelect:r,actionButtons:i})=>{const o=(0,a.usePeers)();if(e<i.length)return i[e]?.render();const c=s[e-i.length];if(!c)return null;const d=o.get(c)||t.get(c);return!d||"User"!==d.kind&&"Contact"!==d.kind?null:n.createElement(F,{peer:d,onSelect:r})},F=n.memo((({peer:e,onSelect:t})=>{const s=(0,a.useLastSeen)(e.id);return n.createElement("li",{className:"ContactList__itemWrapper",key:e.id},n.createElement("div",{className:"ContactList__item",onClick:()=>t(e.id),onKeyDown:(0,I.onElementKeyDownFactory)(((s,n)=>{"Enter"===s&&(n.stopPropagation(),n.preventDefault(),t(e.id))})),tabIndex:0,role:"button"},n.createElement("div",{className:"ContactList__avatar"},n.createElement(r.Avatar,{peer:e,size:40,withBirthday:!0})),n.createElement("div",{className:"ContactList__itemContent"},n.createElement("div",{className:"ContactList__name"},d.name(e)),s?n.createElement(h.OnlineStatus,{user:e,className:"ContactList__info"}):e.phone?n.createElement(m.FormattedPhoneNumber,{phone:e.phone,className:"ContactList__info"}):null)))}))},94686:(e,t,s)=>{"use strict";s.d(t,{CopyText:()=>r});s(853233);var n=s(296540);const r=({text:e,stopPropagation:t=!0,onCopyDone:s,children:r})=>{const a=(0,n.useRef)(null),i=(0,n.useCallback)((n=>{function r(){if(a.current){const e=document.activeElement;a.current.focus(),a.current.select(),document.execCommand("copy"),e instanceof HTMLElement&&e.focus(),s&&s()}}n.preventDefault(),t&&n.stopPropagation(),navigator.clipboard.writeText?navigator.clipboard.writeText(e).then((()=>{s&&s()})).catch(r):r()}),[s,e,t]);return n.createElement("div",{className:"CopyText",onClick:i},n.createElement("input",{tabIndex:-1,"aria-hidden":!0,type:"text",readOnly:!0,value:e||"",ref:a,className:"CopyText__input"}),r)}},239036:(e,t,s)=>{"use strict";s.d(t,{FormattedPhoneNumber:()=>a});var n=s(296540),r=s(522300);const a=({phone:e,className:t})=>{const[s,a]=(0,n.useState)(e);return(0,n.useEffect)((()=>{(0,r.formatPhoneNumber)(e).then((e=>a(e.international))).catch((()=>a(e)))}),[e]),n.createElement("div",{className:t},s??e)}},206618:(e,t,s)=>{"use strict";s.d(t,{ImportContactModal:()=>o});var n=s(296540),r=s(793415),a=s(240105),i=s(102902);s(358633);const o=({onClose:e})=>{const t=(0,r.useModalGroup)(),s=(0,r.useModal)(t.id),o=(0,r.useModal)(t.id),[c,d]=(0,n.useState)(null),[l,u]=(0,n.useState)({name:"",surname:"",phone:""});return(0,n.useLayoutEffect)((()=>(s.open(),()=>{t.closeGroup()})),[]),n.createElement(n.Fragment,null,s.isActive&&n.createElement(a.InputContactModal,{initialData:l,openInviteModal:o.open,onClose:e,setContactPhone:d,onFromChange:u}),o.isActive&&c&&n.createElement(i.InviteContactModal,{contactPhone:c,onClose:e,onBack:o.close}))}},240105:(e,t,s)=>{"use strict";s.d(t,{InputContactModal:()=>f});var n=s(296540),r=s(753457),a=s(32485),i=s.n(a),o=s(401193),c=s(175953),d=s(70915),l=s(45056),u=s(742400),p=s(62812),h=s(795486),m=(s(462234),s(470542));const g=e=>({status:"default",value:e??""}),f=({initialData:e,onFromChange:t,onClose:s,openInviteModal:a,setContactPhone:i})=>{const{lang:u}=(0,d.useBrowserEnv)(),{navigate:f}=(0,l.useRouter)(),{isLoading:v,importContact:y}=(0,p.useImportContact)(),[_,k]=(0,n.useState)(e?(e=>({phone:g(e.phone),name:g(e.name),surname:g(e.surname)}))(e):{phone:g(),name:g(),surname:g()}),I=(0,d.useDispatch)(),b=(0,n.useMemo)((()=>!(_.phone.value&&_.name.value.trim())),[_.name.value,_.phone.value]),{isReady:w,format:S}=(0,m.useFormatPhoneNumber)(),R=(0,n.useCallback)(((e,t)=>{k((s=>{const n={...s};return n[e]=t,n}))}),[]),M=(0,n.useCallback)((async e=>{const t=e.target.name;var s;if(s=t,["phone","name","surname"].some((e=>s===e))&&w)if("phone"===t){const s=S(e.target.value);R(t,{status:"default",value:s})}else R(t,{status:"default",value:e.target.value.trim()})}),[S,w,R]),E=(0,n.useCallback)((async()=>{const e=_.phone.value,t=_.name.value,n=_.surname.value;if(!(0,o.isValidPhoneNumber)(e))return R("phone",{status:"error",value:e});if(0===t.length)return R("name",{status:"error",value:t});const r=await y({phone:e,name:t,surname:n});r.hasFailed?(i(e),a()):(I({type:"ImportContact",profile:r.profile,contact:r.contact}),f({kind:"ConvoRoute",peerId:r.profile?.id?c.resolveRealId("User",r.profile.id):c.resolveRealId("Contact",r.contact.id),entrypoint:"contacts_list"}),s())}),[I,_.name.value,_.phone.value,_.surname.value,y,f,s,a,i,R]),A=v||!w;return(0,n.useEffect)((()=>{const e={name:_.name.value,surname:_.surname.value,phone:_.phone.value};t?.(e)}),[_,t]),n.createElement(h.ModalInterface,{title:u.use("me_contacts_import_modal_title"),closeLabel:u.use("me_close"),onClose:s,buttons:n.createElement(r.Button,{disabled:b,loading:A,mode:"primary",onClick:E},u.use("me_contacts_import_add_button")),contextClass:"MEConfig",withCustomLayout:!0},n.createElement(C,{formItems:_,onFormItemChange:M,onSubmit:E}))},C=({formItems:e,onFormItemChange:t,onSubmit:s})=>{const{mode:a}=(0,u.useLayoutData)(),o="one-column"===a,{lang:c}=(0,d.useBrowserEnv)(),l=(0,n.useRef)(null);return(0,n.useEffect)((()=>{l.current&&l.current.focus()}),[]),n.createElement("form",{className:i()("ImportContactModal",{"ImportContactModal--fullScreen":o}),onSubmit:e=>{e.preventDefault(),s()}},n.createElement(r.FormItem,{top:n.createElement(n.Fragment,null,c.use("me_contacts_import_modal_phone_input")," ",n.createElement("span",{className:"InputContactModal__requiredSymbol"},"*")),status:e.phone.status,topComponent:"h5"},n.createElement(r.Input,{getRef:l,type:"tel",maxLength:250,autoComplete:"tel",name:"phone",value:e.phone.value,onChange:t,placeholder:c.use("me_contacts_import_tel_placeholder"),required:!0})),n.createElement(r.FormLayoutGroup,{mode:"horizontal"},n.createElement(r.FormItem,{top:n.createElement(n.Fragment,null,c.use("me_contacts_import_modal_name_input")," ",n.createElement("span",{className:"InputContactModal__requiredSymbol"},"*")),status:e.name.status,topComponent:"h5"},n.createElement(r.Input,{maxLength:250,type:"text",name:"name",autoComplete:"given-name",value:e.name.value,onChange:t,required:!0})),n.createElement(r.FormItem,{top:c.use("me_contacts_import_modal_surname_input"),topComponent:"h5"},n.createElement(r.Input,{maxLength:250,type:"text",name:"surname",autoComplete:"family-name",value:e.surname.value,onChange:t}))))}},102902:(e,t,s)=>{"use strict";s.d(t,{InviteContactModal:()=>h});var n=s(296540),r=s(753457),a=s(32485),i=s.n(a),o=s(73514),c=s(70915),d=s(742400),l=s(795486),u=s(94686),p=(s(198141),s(125272));const h=({contactPhone:e,onClose:t,onBack:s})=>{const{lang:a}=(0,c.useBrowserEnv)(),{mode:h}=(0,d.useLayoutData)(),[m,g]=(0,n.useState)(!1),f=(0,n.useRef)(null);(0,n.useEffect)((()=>()=>{f.current&&clearTimeout(f.current)}),[]);const C="one-column"===h;return n.createElement(l.ModalInterface,{title:a.use("me_contacts_invite_modal_title"),closeLabel:a.use("me_close"),onClose:t,contextClass:"MEConfig",backLabel:a.use("me_back"),onBack:s,withCustomLayout:!0},n.createElement("div",{className:i()("InviteContactModal",{"InviteContactModal--fullScreen":C})},n.createElement("div",{className:"InviteContactModal__textWrapper"},n.createElement("p",{className:"InviteContactModal__text"},n.createElement(p.FormattedLangKey,{langkey:"me_contacts_invite_modal_user_not_found",values:{phone:n.createElement("span",{className:"InviteContactModal__phone"},e)}})),n.createElement("p",{className:"InviteContactModal__text"},a.use("me_contacts_invite_modal_app_promo"))),n.createElement(r.Input,{className:"InviteContactModal__linkBox",value:o.VKME_APP_INSTALL_LINK,readOnly:!0,autoFocus:!0,type:"text"}),n.createElement("div",{className:"InviteContactModal__linkCopyWrapper"},n.createElement(u.CopyText,{onCopyDone:()=>{g(!0),f.current&&clearTimeout(f.current),f.current=setTimeout((()=>g(!1)),2e3)},text:o.VKME_APP_INSTALL_LINK},n.createElement(r.Button,{mode:"secondary",size:"m"},a.use("me_contacts_invite_modal_link_copy"))),n.createElement("span",{className:i()("InviteContactModal__linkCopyNotice",{"InviteContactModal__linkCopyNotice--blink":m})},a.use("me_contacts_invite_modal_link_copied")))))}},62812:(e,t,s)=>{"use strict";s.d(t,{useImportContact:()=>a});var n=s(70915),r=s(296540);const a=()=>{const{api:e}=(0,n.useBrowserEnv)(),t=(0,n.useDeviceId)(),[s,a]=(0,r.useState)(!1);return{isLoading:s,importContact:(0,r.useCallback)((async({phone:s,name:n,surname:r,withExisting:i})=>{a(!0);const o=r?n+" "+r:n,c=await e.fetch("account.importMessagesContacts",{contacts:JSON.stringify([{phones:[s],name:o}]),with_existing:Boolean(i),extended:1,device_id:t});return 0===c.items.synced.length&&0===c.items.existing.length||!c.contacts?.[0]?{hasFailed:!0,isMyPhoneNumber:c.items.has_my_phone_number}:(a(!1),{items:c.items,profile:c.profiles?.[0],contact:c.contacts[0],hasFailed:!1})}),[e,t])}}},833472:(e,t,s)=>{"use strict";s.d(t,{InviteButton:()=>i});var n=s(296540),r=s(628204),a=s(869859);s(210795);const i=({children:e,className:t,onClick:s,icon:i=n.createElement(r.Icon24PhoneAddOutline,null)})=>n.createElement("button",{className:(0,a.classNames)("InviteButton",t),type:"button",onClick:s},n.createElement("span",{className:"InviteButton__icon","aria-hidden":!0},i),n.createElement("span",{className:"InviteButton__label"},e))},795486:(e,t,s)=>{"use strict";s.d(t,{ModalInterface:()=>l});s(276389);var n=s(296540),r=s(306684),a=s(174728),i=s(483620),o=s(768836),c=s(419108),d=s(826520);const l=({onClose:e,closeLabel:t,onBack:s,backLabel:l,title:u,contextClass:p,panelClass:h,headerClass:m,hasClearBackdrop:g,isHidden:f,portalTarget:C,buttons:v,withCustomLayout:y,children:_,footerHint:k,isDarkBody:I})=>{const b=(0,n.useId)();return n.createElement(r.ModalView,{onEscape:e,contextClass:p,portalTarget:C,isHidden:f},n.createElement(a.ModalBackdrop,{onClick:e,isClear:g},n.createElement(i.ModalPanel,{className:h,ariaLabelledby:b},n.createElement(o.ModalHeader,{className:m,closeLabel:t,onClose:e,backLabel:l,onBack:s,title:u,titleId:b}),n.createElement(c.ModalBody,{withCustomLayout:y,isDark:I},_),v&&n.createElement(d.ModalFooter,{buttons:v,hint:k}))))}},700952:(e,t,s)=>{"use strict";s.d(t,{OnlineStatus:()=>o});var n=s(296540),r=s(70915),a=s(175953),i=s(935242);const o=n.memo((function({className:e,user:t}){const{lang:s}=(0,r.useBrowserEnv)(),o=(0,r.useLastSeen)(t.id),c=(0,i.useNow)(6e5);if(a.isVkAdministration(t.id))return n.createElement("span",{className:e,role:"status"},s.use("me_service_notifications_label"));if("Contact"===t.kind){if(t.lastSeen&&["today","recently"].includes(t.lastSeen)){const r={today:s.use("global_online_was_today",{sex:"male"}),recently:s.use("global_online_was_recently",{sex:"male"})}[t.lastSeen];return n.createElement("span",{className:e,role:"status"},r)}return null}const d=n.createElement("div",{className:e,"aria-hidden":!0}," ");if(!o)return d;if(o.isOnline)return n.createElement("span",{className:e,role:"status"},s.use("global_online",{sex:t.sex}));if("number"==typeof o.at)return n.createElement("span",{className:e,role:"status"},s.use("me_online_was_time",{sex:t.sex,values:{time:s.formatDate(o.at,{now:c,variant:"time-ago"})}}));let l;switch(o.at){case"recently":l="global_online_was_recently";break;case"last_week":l="global_online_was_week";break;case"last_month":l="global_online_this_month";break;case"long_ago":case"not_show":l="global_online_long_ago";break;default:o.at;return d}return n.createElement("span",{role:"status",className:e},s.use(l,{sex:t.sex}))}))},550084:(e,t,s)=>{"use strict";s.d(t,{OptionsListItem:()=>o,OptionsListItemWrapper:()=>d});s(258231);var n=s(296540),r=s(32485),a=s.n(r),i=s(78510);const o=({icon:e,title:t,description:s,aside:r,isPadded:o=!0,isInteractive:c,hasChevron:l,hasIconBackground:u,onClick:p,className:h})=>n.createElement(d,{onClick:p,isInteractive:c,className:h,isPadded:o},n.createElement("div",{className:a()("OptionsListItem__icon",{"OptionsListItem__icon--withBG":u}),"aria-hidden":!0},e),n.createElement("div",{className:"OptionsListItem__main"},n.createElement("div",{className:"OptionsListItem__title"},t),s&&n.createElement("div",{className:"OptionsListItem__description"},s)),l&&n.createElement("div",{className:"OptionsListItem__aside OptionsListItem__aside--chevron"},n.createElement(i.Icon28ChevronRightOutline,null)),r&&n.createElement("div",{className:"OptionsListItem__aside"},r));function c(e){e.preventDefault()}const d=({children:e,className:t,isInteractive:s,isPadded:r=!0,onClick:i})=>{const o=a()("OptionsListItem",t,{"OptionsListItem--interactive":s??i,"OptionsListItem--padded":r});return n.createElement("li",{className:o,onClick:i,tabIndex:i?0:void 0,onMouseDown:i?c:void 0},e)}},823e3:(e,t,s)=>{"use strict";s.d(t,{PhoneInvite:()=>o});var n=s(296540),r=s(425414),a=s(753457),i=(s(453963),s(470542));const o=({onSubmit:e,onErrorReset:t,isLoading:s=!1,title:o,subtitle:c,action:d,error:l,focusOnMount:u})=>{const[p,h]=(0,n.useState)(""),{isReady:m,format:g}=(0,i.useFormatPhoneNumber)(),f=(0,n.useRef)(null),C=(0,n.useCallback)((e=>{t?.();const s=g(e.target.value);h(s)}),[g,t]);return(0,n.useEffect)((()=>{u&&f.current&&f.current.focus()}),[]),n.createElement("form",{className:"PhoneInvite",onSubmit:t=>{t.preventDefault(),s||e(p)}},n.createElement(r.Icon56PhoneOutline,{className:"PhoneInvite__icon",color:"var(--vkui--color_icon_accent)"}),n.createElement("h3",{className:"PhoneInvite__title"},o),n.createElement("div",{className:"PhoneInvite__subtitle"},c),n.createElement(a.FormItem,{status:l?"error":"default",bottom:l,className:"PhoneInvite__row"},n.createElement(a.Input,{className:"PhoneInvite__input",type:"tel",name:"phone",autoComplete:"tel",value:p,onChange:C,placeholder:"+7 (000) 000-00-00",getRef:f})),n.createElement("div",{className:"PhoneInvite__action"},n.createElement(a.Button,{type:"submit",size:"l",stretched:!0,mode:"primary",loading:s||!m,disabled:!p},d)))}},334298:(e,t,s)=>{"use strict";s.d(t,{PhoneInviteModal:()=>u});var n=s(296540),r=s(306684),a=s(174728),i=s(483620),o=s(419108),c=s(823e3),d=(s(154961),s(70915)),l=s(917919);const u=({onClose:e,...t})=>{const{lang:s}=(0,d.useBrowserEnv)();return n.createElement(r.ModalView,{contextClass:"MEConfig",onEscape:e},n.createElement(a.ModalBackdrop,{onClick:e},n.createElement(i.ModalPanel,{className:"PhoneInviteModal__panel"},n.createElement(o.ModalBody,{withCustomLayout:!0},n.createElement("div",{className:"PhoneInviteModal"},n.createElement("button",{className:"PhoneInviteModal__close",type:"button","aria-label":s.use("me_close"),onClick:e},n.createElement("span",{className:"PhoneInviteModal__closeInner"},n.createElement(l.Icon20Cancel,null))),n.createElement(c.PhoneInvite,{...t}))))))}},346440:(e,t,s)=>{"use strict";s.d(t,{Symbols:()=>r});s(315403);var n=s(296540);const r=()=>n.createElement("svg",{className:"Symbols"},n.createElement("defs",null,n.createElement("symbol",{id:"mePhone10"},n.createElement("path",{d:"M6.17 6.8c1.1-1.09 2.32-.5 3.3.33 1.15.97.26 2.7-1.08 2.83-1.82.24-3.72-.63-5.72-2.63-2-2-2.88-3.91-2.63-5.73C.16.27 1.91-.62 2.87.52c.82.98 1.41 2.2.32 3.3-.9.9-.16 1.55.64 2.35s1.45 1.53 2.34.64z"})),n.createElement("symbol",{id:"meExpand"},n.createElement("path",{d:"M15.7688 13.7067L11.906 10L15.7688 6.29326C16.0771 5.99741 16.0771 5.51774 15.7688 5.22189C15.4605 4.92604 14.9606 4.92604 14.6523 5.22189L10.2312 9.46431C9.92292 9.76017 9.92292 10.2398 10.2312 10.5357L14.6523 14.7781C14.9606 15.074 15.4605 15.074 15.7688 14.7781C16.0771 14.4823 16.0771 14.0026 15.7688 13.7067Z"}),n.createElement("path",{d:"M9.76877 13.7067L5.90596 10L9.76877 6.29326C10.0771 5.99741 10.0771 5.51774 9.76877 5.22189C9.46046 4.92604 8.96059 4.92604 8.65228 5.22189L4.23123 9.46431C3.92292 9.76017 3.92292 10.2398 4.23123 10.5357L8.65228 14.7781C8.96059 15.074 9.46046 15.074 9.76877 14.7781C10.0771 14.4823 10.0771 14.0026 9.76877 13.7067Z"})),n.createElement("symbol",{id:"meCake10"},n.createElement("path",{d:"M9.16667 8.07392C8.33947 8.29895 7.41292 8.1867 6.66667 7.73385C5.66596 8.34111 4.33404 8.34111 3.33333 7.73385C2.58708 8.1867 1.66053 8.29895 0.833333 8.07392V9.09126C0.833333 9.59314 1.20643 10 1.66667 10H8.33333C8.79357 10 9.16667 9.59314 9.16667 9.09126V8.07392Z"}),n.createElement("path",{d:"M0 5.00191C0 4.50003 0.373096 4.09317 0.833333 4.09317H9.16667C9.6269 4.09317 10 4.50003 10 5.00191C10 6.36503 9.16667 6.8194 8.33333 6.8194C7.08333 6.8194 6.66667 5.91065 6.66667 5.91065C6.66667 5.91065 6.25 6.8194 5 6.8194C3.75 6.8194 3.33333 5.91065 3.33333 5.91065C3.33333 5.91065 2.91667 6.8194 1.66667 6.8194C0.833333 6.8194 0 6.36503 0 5.00191Z"}),n.createElement("path",{d:"M7.83935 0.0492567C7.87234 -0.0164189 7.96099 -0.0164189 7.99398 0.0492567C8.38334 0.824332 8.75 1.16164 8.75 1.82131C8.75 2.32319 8.3769 2.73005 7.91667 2.73005C7.45643 2.73005 7.08333 2.32319 7.08333 1.82131C7.08333 1.16164 7.44999 0.824332 7.83935 0.0492567Z"}),n.createElement("path",{d:"M2.00602 0.0492567C2.03901 -0.0164189 2.12766 -0.0164189 2.16065 0.0492567C2.55001 0.824332 2.91667 1.16164 2.91667 1.82131C2.91667 2.32319 2.54357 2.73005 2.08333 2.73005C1.6231 2.73005 1.25 2.32319 1.25 1.82131C1.25 1.16164 1.61665 0.824332 2.00602 0.0492567Z"}),n.createElement("path",{d:"M4.92268 0.0492567C4.95568 -0.0164189 5.04432 -0.0164189 5.07732 0.0492567C5.46668 0.824332 5.83333 1.16164 5.83333 1.82131C5.83333 2.32319 5.46024 2.73005 5 2.73005C4.53976 2.73005 4.16667 2.32319 4.16667 1.82131C4.16667 1.16164 4.53332 0.824332 4.92268 0.0492567Z"}))),n.createElement("circle",{id:"mePeerFrameOffline20",cx:"10",cy:"10",r:"10"}),n.createElement("path",{id:"mePeerFrameMe24",d:"M20 10a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),n.createElement("circle",{id:"mePeerFrameOffline24",cx:"12",cy:"12",r:"12"}),n.createElement("path",{id:"mePeerFrameOnline24",d:"M23.57 15.18A12.02 12.02 0 0012 0a12 12 0 103.18 23.57 6 6 0 018.4-8.4z"}),n.createElement("path",{id:"mePeerFrameMobile24",d:"M14.08 23.82a12 12 0 119.9-12.29 3.98 3.98 0 00-1.98-.53h-4a4 4 0 00-4 4v8c0 .28.03.56.08.82z"}),n.createElement("path",{id:"mePeerFrameMe24",d:"M23.84 13.95a12 12 0 10-9.9 9.9 7 7 0 019.9-9.9z"}),n.createElement("circle",{id:"mePeerFrameOffline32",cx:"16",cy:"16",r:"16"}),n.createElement("path",{id:"mePeerFrameOnline32",d:"M30.72 22.29a16 16 0 10-8.43 8.43 6 6 0 018.43-8.43z"}),n.createElement("path",{id:"mePeerFrameMobile32",d:"M21 31.2a16 16 0 1110.52-11.3A3.98 3.98 0 0029 19h-4a4 4 0 00-4 4v8.2z"}),n.createElement("path",{id:"mePeerFrameMe32",d:"M31.1 21.32a16 16 0 10-9.77 9.77 7 7 0 019.77-9.77z"}),n.createElement("path",{id:"mePeerFrameMe32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.8656 32 19.6565 31.6807 21.3213 31.0938C20.4899 29.9426 20 28.5285 20 27C20 24.8923 20.9316 23.0021 22.4054 21.7188C17.0253 20.533 13 15.7366 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM30.2451 20.796C30.5411 20.9512 30.8247 21.1269 31.0938 21.3213C31.2337 20.9244 31.3584 20.5204 31.4672 20.1099C31.0749 20.3614 30.6669 20.5907 30.2451 20.796Z"}),n.createElement("path",{id:"mePeerFrameMobile32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C17.748 32 19.4305 31.7197 21.005 31.2016C21.0017 31.1348 21 31.0676 21 31V23C21 22.4411 21.1146 21.9089 21.3217 21.4257C16.4937 19.8727 13 15.3443 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651Z"}),n.createElement("path",{id:"mePeerFrameOffline32c",d:"M31.47 20.11A12 12 0 0118.16.14a16 16 0 1013.31 19.97z"}),n.createElement("path",{id:"mePeerFrameOnline32c",d:"M18.1533 0.143651C17.449 0.0489165 16.7302 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32C18.2328 32 20.3588 31.5426 22.2893 30.7165C21.4819 29.6945 21 28.4035 21 27C21 24.8726 22.1072 23.0038 23.7767 21.9384C17.7239 21.3256 13 16.2145 13 10C13 5.91761 15.0386 2.31134 18.1533 0.143651ZM28.9655 21.3293C29.6052 21.551 30.1958 21.8779 30.7165 22.2893C31.0169 21.5873 31.2686 20.8594 31.4672 20.1099C30.6899 20.6082 29.8514 21.0192 28.9655 21.3293Z"}),n.createElement("circle",{id:"mePeerFrameOffline36",cx:"18",cy:"18",r:"18"}),n.createElement("circle",{id:"mePeerFrameOffline40",cx:"20",cy:"20",r:"20"}),n.createElement("path",{id:"mePeerFrameOnline40",d:"M29.29 37.72a20 20 0 118.43-8.43 5.99 5.99 0 10-8.43 8.43z"}),n.createElement("path",{id:"mePeerFrameMobile40",d:"M28.2 38.25a20 20 0 1110.78-11.92A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25z"}),n.createElement("path",{id:"mePeerFrameMe40",d:"M28.31 38.2a20 20 0 119.89-9.89 7 7 0 10-9.89 9.89z"}),n.createElement("path",{id:"mePeerFrameMe40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.97-.65 5.78-1.8 8.31a7 7 0 10-9.89 9.89A20 20 0 1125.38.73 12 12 0 0033 22z"}),n.createElement("path",{id:"mePeerFrameMobile40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 2.21-.36 4.34-1.02 6.33A3.99 3.99 0 0036 25h-4a4 4 0 00-4 4v8a4 4 0 00.2 1.25A20 20 0 1125.38.73 12 12 0 0033 22z"}),n.createElement("path",{id:"mePeerFrameOffline40c",d:"M40 19.75A12 12 0 0125.38.73 20.02 20.02 0 000 20a20 20 0 1040-.25z"}),n.createElement("path",{id:"mePeerFrameOnline40c",d:"M33 22c2.61 0 5.03-.83 7-2.25V20c0 3.35-.83 6.51-2.28 9.29a5.99 5.99 0 10-8.43 8.43A20 20 0 1125.38.74 12 12 0 0033 22z"}),n.createElement("circle",{id:"mePeerFrameOffline44",cx:"22",cy:"22",r:"22"}),n.createElement("path",{id:"mePeerFrameOnline44",d:"M41.21 32.73a22 22 0 10-8.49 8.49 6 6 0 018.49-8.49z"}),n.createElement("path",{id:"mePeerFrameMobile44",d:"M31.13 42.02a22 22 0 1111.1-11.37A4 4 0 0039 29h-4a4 4 0 00-4 4v8c0 .35.05.7.13 1.02z"}),n.createElement("path",{id:"mePeerFrameMe44",d:"M41.7 31.81a22 22 0 10-9.89 9.89 7 7 0 019.89-9.89z"}),n.createElement("path",{id:"mePeerFrameOffline44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 1014.19 19.36z"}),n.createElement("path",{id:"mePeerFrameOnline44c",d:"M29.78 1.41a22 22 0 102.95 39.8 6 6 0 018.49-8.49 21.9 21.9 0 002.75-11.95A12 12 0 0129.78 1.41z"}),n.createElement("path",{id:"mePeerFrameMobile44c",d:"M43.97 20.77A12 12 0 0129.78 1.41a22 22 0 101.35 40.6 4 4 0 01-.13-1.01v-8a4 4 0 014-4h4a4 4 0 013.24 1.65 21.93 21.93 0 001.73-9.88z"}),n.createElement("path",{id:"mePeerFrameMe44c",d:"M29.78 1.41A22 22 0 1031.8 41.7a7 7 0 019.89-9.89 21.91 21.91 0 002.27-11.03A12 12 0 0129.78 1.41z"}),n.createElement("circle",{id:"mePeerFrameOffline46",cx:"23",cy:"23",r:"23"}),n.createElement("path",{id:"mePeerFrameOnline46",d:"M42.94 34.47a23 23 0 10-8.47 8.47 6 6 0 018.47-8.47z"}),n.createElement("path",{id:"mePeerFrameMobile46",d:"M33.06 43.69A23 23 0 1144 32.37 3.99 3.99 0 0041 31h-4a4 4 0 00-4 4v8c0 .24.02.47.06.69z"}),n.createElement("path",{id:"mePeerFrameMe46",d:"M43.43 33.58a23 23 0 10-9.85 9.85 7 7 0 019.85-9.85z"}),n.createElement("path",{id:"mePeerFrameOffline46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 1014.39 19.2z"}),n.createElement("path",{id:"mePeerFrameOnline46c",d:"M31.5 1.63a23 23 0 102.96 41.31 6 6 0 018.47-8.47 22.9 22.9 0 002.97-13.65A12 12 0 0131.5 1.62z"}),n.createElement("path",{id:"mePeerFrameMobile46c",d:"M45.9 20.82A12 12 0 0131.5 1.62a23 23 0 101.55 42.06A4.03 4.03 0 0133 43v-8a4 4 0 014-4h4c1.2 0 2.28.53 3.01 1.37a22.92 22.92 0 001.89-11.55z"}),n.createElement("path",{id:"mePeerFrameMe46c",d:"M31.5 1.63a23 23 0 102.07 41.8 7 7 0 019.85-9.85 22.9 22.9 0 002.48-12.76A12 12 0 0131.5 1.62z"}),n.createElement("circle",{id:"mePeerFrameOffline48",cx:"24",cy:"24",r:"24"}),n.createElement("path",{id:"mePeerFrameOnline48",d:"M44.65 36.2375C46.7781 32.6543 48 28.4699 48 24 48 10.7452 37.2548 0 24 0S0 10.7452 0 24s10.7452 24 24 24c4.4699 0 8.6543-1.2219 12.2375-3.35C35.4614 43.6388 35 42.3733 35 41c0-3.3137 2.6863-6 6-6 1.3733 0 2.6388.4614 3.65 1.2375Z"}),n.createElement("path",{id:"mePeerFrameMobile48",d:"M35.0134 45.3295C31.7149 47.0361 27.97 48 24 48 10.7452 48 0 37.2548 0 24S10.7452 0 24 0s24 10.7452 24 24c0 3.6139-.7987 7.0412-2.2293 10.115C45.0518 33.4245 44.0755 33 43 33h-4c-2.2091 0-4 1.7909-4 4v8c0 .1109.0045.2208.0134.3295Z"}),n.createElement("path",{id:"mePeerFrameMe48",d:"M45.1466 35.3598C46.967 31.9781 48 28.1097 48 24 48 10.7452 37.2548 0 24 0S0 10.7452 0 24s10.7452 24 24 24c4.1097 0 7.9781-1.033 11.3598-2.8534C34.5051 43.986 34 42.552 34 41c0-3.866 3.134-7 7-7 1.552 0 2.986.5051 4.1466 1.3598Z"}),n.createElement("path",{id:"mePeerFrameOffline48c",d:"M47.7535 20.5474c-1.9142 1.485-4.2861 2.3638-6.8546 2.3638-6.3513 0-11.5-5.3726-11.5-12 0-3.60133 1.5202-6.83209 3.9277-9.03164C30.4593.669186 27.3078 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24 24-10.7452 24-24c0-1.1724-.0841-2.3252-.2465-3.4526Z"}),n.createElement("path",{id:"mePeerFrameOnline48c",d:"M33.4417 1.92854C30.5438.687251 27.3522 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c4.4699 0 8.6543-1.2219 12.2375-3.35C35.4614 43.6388 35 42.3733 35 41c0-3.3137 2.6863-6 6-6 1.3733 0 2.6388.4614 3.65 1.2375C46.7781 32.6543 48 28.4699 48 24c0-.9987-.061-1.9832-.1795-2.9499-1.8568 1.1786-4.0595 1.8611-6.4216 1.8611-6.6274 0-12-5.3726-12-12 0-3.57469 1.563-6.78427 4.0428-8.98266Z"}),n.createElement("path",{id:"mePeerFrameMobile48c",d:"M47.8002 20.8886C45.8673 22.2203 43.5247 23 41 23c-6.6274 0-12-5.3726-12-12 0-3.66964 1.6472-6.95456 4.2425-9.15573C30.3978.656185 27.2755 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c3.97 0 7.7149-.9639 11.0134-2.6705C35.0045 45.2208 35 45.1109 35 45v-8c0-2.2091 1.7909-4 4-4h4c1.0755 0 2.0518.4245 2.7707 1.115C47.2013 31.0412 48 27.6139 48 24c0-1.0544-.068-2.0929-.1998-3.1114Z"}),n.createElement("path",{id:"mePeerFrameMe48c",d:"M33.4417 1.92854C30.5438.687251 27.3522 0 24 0 10.7452 0 0 10.7452 0 24s10.7452 24 24 24c4.1097 0 7.9781-1.033 11.3598-2.8534C34.5051 43.986 34 42.552 34 41c0-3.866 3.134-7 7-7 1.552 0 2.986.5051 4.1466 1.3598C46.967 31.9781 48 28.1097 48 24c0-.9987-.061-1.9832-.1795-2.9499-1.8568 1.1786-4.0595 1.8611-6.4216 1.8611-6.6274 0-12-5.3726-12-12 0-3.57469 1.563-6.78427 4.0428-8.98266Z"}),n.createElement("circle",{id:"mePeerFrameOffline72",cx:"37",cy:"37",r:"37"}),n.createElement("circle",{id:"mePeerFrameOffline92",cx:"46",cy:"46",r:"46"}),n.createElement("circle",{id:"mePeerFrameOffline96",cx:"48",cy:"48",r:"48"}),n.createElement("path",{id:"meUsersStack16",d:"M14 2.715A8 8 180 008 0 8 8 180 008 16 8 8 180 0014 13.285 8 8 180 0114 2.715"}),n.createElement("path",{id:"meUsersStack18",d:"M 16 14 A 9 9 90 0 1 9 18 A 9 9 90 0 1 9 0 A 9 9 90 0 1 16 4 A 9 9 90 0 0 16 14"}),n.createElement("path",{id:"meUsersStack24",d:"M22 18.6A12 12 0 0112 24 12 12 0 0112 0 12 12 0 0122 5.4 12 12 0 0022 18.6"}),n.createElement("path",{id:"meUsersStack32",d:"M30 23.8A16 16 0 0116 32 16 16 0 0116 0 16 16 0 0130 8.3 16 16 0 0030 23.8"}),n.createElement("path",{id:"meUsersStack40",d:"M37.5 29.8A20 20 90 0120 40 20 20 90 0120 0 20 20 90 0137.5 10.4 20 20 90 0037.5 29.8"}),n.createElement("path",{id:"meUsersStack44",d:"M41.3 32.7A22 22 90 0122 44 22 22 90 0122 0 22 22 90 0141.3 11.4 22 22 90 0041.3 32.7"}),n.createElement("path",{id:"meUsersStack46",d:"M43.1 34.2A23 23 90 0123 46 23 23 90 0123 0 23 23 90 0143.1 11.9 23 23 90 0043.1 34.2"}),n.createElement("path",{id:"meUsersStack48",d:"M44.9739 35.687c-2.0822 3.7346-5.1243 6.8452-8.8117 9.01C32.4747 46.8618 28.2759 48.0021 24 48c-6.3652 0-12.4697-2.5286-16.97056-7.0294C2.52856 36.4697 0 30.3652 0 24c0-6.3652 2.52856-12.4697 7.02944-16.97056C11.5303 2.52856 17.6348 0 24 0c4.2863.00824717 8.4922 1.16428 12.1806 3.34795 3.6884 2.18368 6.7247 5.31531 8.7933 9.06945-1.9734 3.5603-3.0088 7.5641-3.0088 11.6348 0 4.0706 1.0354 8.0744 3.0088 11.6348Z"}))},370415:(e,t,s)=>{"use strict";s.d(t,{VirtualScrollItem:()=>o});var n=s(399076),r=(s(404614),s(296540)),a=s(32485),i=s.n(a);const o=({itemKey:e,children:t,className:s,itemRole:a})=>{const o=(0,r.useRef)(null),c=(0,r.useRef)(100),d=(0,n.useVirtualList)(),l=d.getSliceArea(),u=d.findVirtualItemIndex(e),p=!l||u<l.upperIndex||u>l.bottomIndex,h=(0,r.useCallback)((e=>{c.current=e.boundingClientRect.height}),[]);return(0,r.useLayoutEffect)((()=>{if(o.current)return d.registerVirtualItem(o.current,h)}),[h,d]),r.createElement("div",{ref:o,"data-itemkey":e,className:i()(s,"VirtualScrollItem"),role:a},p?r.createElement("div",{style:{height:c.current}}):t)};o.displayName="VirtualScrollItem"},399076:(e,t,s)=>{"use strict";s.d(t,{VirtualScrollList:()=>a,useVirtualList:()=>i});var n=s(296540);const r=(0,n.createContext)(void 0),a=({virtualizerCore:e,virtualizerState:t,children:s})=>n.createElement(r.Provider,{value:(0,n.useMemo)((()=>({virtualizerCore:e,virtualizerState:t})),[e,t])},s);a.displayName="VirtualScrollList";const i=()=>{const e=(0,n.useContext)(r);if(!e)throw new Error("VirtualListContext.Provider не добавлен в дерево Реакта!");return e.virtualizerCore}},138234:(e,t,s)=>{"use strict";s.d(t,{VirtualizerCore:()=>i});var n=s(522300),r=s(458933),a=s(401193);class i{getSliceItemKey(e){if(!this.externalProps)return void this.logger.error("No externalProps in getSliceItemKey",e);const t=this.getAnchorAlign();let s;switch(t){case"bottom":s=e.bottomIndex;break;case"scrollTop":case"upper":s=e.upperIndex;break;case"center":s=Math.ceil((e.upperIndex+e.bottomIndex)/2);break;default:(0,a.exhaustivenessCheck)(t)}return{key:this.getItemKey(s),align:t}}scheduleScroll(e){if(this.externalProps)switch(this.logger.debug("Schedule scroll",e,this.scrollReposition),e.kind){case"Item":this.pinBottom=void 0,this.scrollReposition=e;break;case"Anchor":{const t=this.getSliceItem();if(!t)break;this.pinBottom=void 0,this.scrollReposition={kind:"Anchor",options:{...t,blockMomentumScroll:e.blockMomentumScroll}};break}case"Upper":this.pinBottom=void 0,this.scrollReposition={kind:"Upper"};break;case"Bottom":this.pinBottom=!0,this.scrollReposition={kind:"Bottom"};break;case"ScrollTop":if(!this.wrapper)break;this.pinBottom=void 0,this.scrollReposition={kind:"ScrollTop",value:this.wrapper.scrollTop};break;default:(0,a.exhaustivenessCheck)(e)}else if(a.isDev)throw new Error("VList: sliceItem of externalProps are not defined inside scheduleScroll")}getAnchorAlign(){return"scrollTop"===this.externalProps?.anchorAlign?"scrollTop":void 0===this.pinBottom?this.externalProps?.anchorAlign??"upper":this.pinBottom?"bottom":"upper"}constructor(e){this.intersectionBuffer=new Map,this.virtualItems=new Map,this.sliceArea=void 0,this.viewArea=void 0,this.nextPinBottom=!1,this.onPinBottomChanged=e=>{this.nextPinBottom=e,window.setTimeout((()=>{this.logger.debug("onPinBottomChanged timout: ",this.nextPinBottom),this.pinBottom=this.nextPinBottom;const e=this.viewArea&&this.getSliceItemKey(this.viewArea);e&&this.updateSliceItem(e)}),0)},this.getSliceArea=()=>this.sliceArea,this.getSliceItem=()=>{if(!this.sliceItem||!this.content||!this.wrapper)return;let e=this.getVirtualItemElement(this.sliceItem.key);if(e||(this.logger.error("getSliceItem no item with slice key: ",this.sliceItem),e=this.getVirtualItemElement()),!e)return void this.logger.error("getSliceItem no item: ",this.sliceItem);const{dataset:{itemkey:t}}=e;if(!t)return;const{top:s,height:r}=(0,n.getOffsetRect)(e,this.content);if("bottom"===this.getAnchorAlign()){return{itemKey:t,align:"bottom",margin:this.wrapper.scrollTop+this.wrapper.offsetHeight-s-r}}return{itemKey:t,align:"upper",margin:s-this.wrapper.scrollTop}},this.createObservers=(e,t)=>{const s=()=>{this.intersectionObserver?.disconnect(),this.intersectionObserver=void 0,this.resizeObserver?.disconnect(),this.resizeObserver=void 0,this.content=void 0,this.wrapper=void 0};if(this.intersectionObserver||this.resizeObserver){if(a.isDev)throw new Error("Попытка создать новый observer раньше удаления старого");return s}this.wrapper=e,this.content=t;const r=()=>{void 0!==this.wrapperForcedScrollTop&&void 0!==this.wrapper&&(Math.abs(this.wrapper.scrollTop-this.wrapperForcedScrollTop)>=1&&(this.logger.error("scroll to wrapperForcedScrollTop",this.wrapper.scrollTop,this.wrapperForcedScrollTop),n.browser.safari&&(this.wrapper.scrollTop=this.wrapperForcedScrollTop)),this.wrapperForcedScrollTop=void 0)};this.wrapper.addEventListener("scroll",r,{passive:!0});this.intersectionObserver=new IntersectionObserver((e=>{e.forEach((e=>{this.intersectionBuffer.set(e.target,e)})),this.handleIntersectionBuffer()}),{root:this.wrapper}),this.virtualItems.size>0&&[...this.virtualItems.values()].forEach((({element:e})=>this.intersectionObserver?.observe(e)));return this.resizeObserver=new ResizeObserver((()=>{this.logger.error("handleResize: ",this.pinBottom),this.pinBottom&&(this.scheduleScroll({kind:"Bottom"}),this.afterLayoutUpdate())})),this.resizeObserver.observe(this.wrapper),this.logger.debug("Created observer",this.intersectionObserver),()=>{s(),this.handleIntersectionBuffer.cancel?.(),this.wrapper?.removeEventListener("scroll",r)}},this.updateExternalProps=e=>{if(this.logger.debug("Update external props",this.externalProps,e),0===e.itemsKeys.length)return this.logger.debug("Update external props with 0 items"),this.reset();const t=!this.externalProps||this.externalProps.scrollPosition!==e.scrollPosition;let s=!1;switch(this.externalProps&&(s=this.externalProps.itemsKeys!==e.itemsKeys||this.externalProps.contentUpdatesCount!==e.contentUpdatesCount),this.externalProps=e,this.logger.debug("Update external props changed options",t,s),!0){case t:{const{scrollPosition:e}=this.externalProps;let t;t="Upper"===e.kind?this.getItemKey(0):"Bottom"===e.kind?this.getItemKey(this.externalProps.itemsKeys.length-1):e.options.itemKey,this.updateSliceArea({key:t,align:"center"}),this.scheduleScroll(e);break}case s:this.updateSliceArea(),void 0===this.scrollReposition&&this.scheduleScroll("scrollTop"===this.getAnchorAlign()?{kind:"ScrollTop"}:{kind:"Anchor",blockMomentumScroll:!0})}},this.afterLayoutUpdate=()=>{if(!this.scrollReposition||!this.wrapper||!this.content)return;const e=this.wrapper.scrollTop;let t=e;switch(this.scrollReposition.kind){case"Item":case"Anchor":{const e=this.getVirtualItemElement(this.scrollReposition.options.itemKey);if(!e){this.logger.error("no element to scroll: ",this.scrollReposition),this.scrollReposition=void 0;break}const{align:s,margin:n,blockMomentumScroll:a}=this.scrollReposition.options;t=(0,r.scrollToElement)(this.wrapper,this.content,e,s,n,a),this.scrollReposition=void 0;break}case"Upper":t=0,this.wrapper.scrollTop=t,this.scrollReposition=void 0;break;case"Bottom":{const{scrollHeight:e,clientHeight:s}=this.wrapper;t=e-s,this.wrapper.scrollTop=t,this.scrollReposition=void 0;break}case"ScrollTop":t=this.scrollReposition.value,this.wrapper.scrollTop=t,this.scrollReposition=void 0;break;default:(0,a.exhaustivenessCheck)(this.scrollReposition)}this.logger.debug("scroll in layout effect to: ",t),Math.abs(e-t)>=1&&(this.wrapperForcedScrollTop=t),this.onPinBottomChanged(this.nextPinBottom)},this.registerVirtualItem=(e,t)=>{const s=this.getVirtualItemKey(e);if(this.virtualItems.has(s))throw new Error("Can not register virtual item, already have this item");return this.virtualItems.set(s,{key:s,isIntersecting:!1,callback:t,element:e}),this.intersectionObserver?.observe(e),()=>{this.intersectionObserver?.unobserve(e),this.virtualItems.delete(s);const t=this.findViewArea();this.updateViewArea(t)}},this.findVirtualItemIndex=e=>this.externalProps?this.externalProps.itemsKeys.findIndex((t=>t===e)):-1,this.destroy=()=>{this.logger.debug("Destroy virtualizer"),this.intersectionObserver?.disconnect(),this.intersectionObserver=void 0,this.resizeObserver?.disconnect(),this.resizeObserver=void 0,this.content=void 0,this.wrapper=void 0,this.reset()},this.reset=()=>{this.logger.debug("Reset virtualizer"),this.externalProps=void 0,this.sliceArea=void 0,this.viewArea=void 0,this.intersectionBuffer.clear(),this.virtualItems.clear(),this.onViewAreaChangeTimeout&&window.clearTimeout(this.onViewAreaChangeTimeout),this.prevBumpedBorder=void 0,this.pinBottom=void 0,this.nextPinBottom=!1,this.wrapperForcedScrollTop=void 0},this.handleIntersectionBuffer=()=>{if(!this.externalProps||!this.sliceItem)return;Array.from(this.intersectionBuffer.values()).forEach((e=>{const t=this.getVirtualItemKey(e.target),s=this.virtualItems.get(t);s&&(s.isIntersecting=e.isIntersecting,s.callback(e))})),this.intersectionBuffer.clear();const e=this.findViewArea();if(this.updateViewArea(e),!e)return;const t=this.sliceArea&&e.upperIndex-this.sliceArea.upperIndex<=this.config.preloadCount&&this.sliceArea.upperIndex>0,s=this.sliceArea&&this.sliceArea.bottomIndex-e.bottomIndex<=this.config.preloadCount&&this.sliceArea.bottomIndex<this.externalProps.itemsKeys.length-1,n=e.bottomIndex-e.upperIndex+1,r=Math.max(this.config.sliceCountIncrement+n,2.5*n)-this.sliceCount,a=this.getSliceItemKey(e);this.logger.debug("Handle intersection",e,t,s,r,a);let i=!1;const o=()=>{this.externalProps&&this.updateSliceArea(a)&&(i=!0,this.logger.debug("scheduleScroll on updateSliceArea"),this.externalProps.triggerContentUpdate())},c=(e=this.config.sliceCountIncrement)=>{this.logger.debug("Bump Not enough items to display",t,s,this.prevBumpedBorder),this.sliceCount+=Math.round(Math.ceil(e/this.config.sliceCountIncrement)*this.config.sliceCountIncrement)};switch(!0){case r>0:this.prevBumpedBorder=void 0,c(r),o();break;case t:this.logger.debug("Bump upper border"),"bottom"===this.prevBumpedBorder&&c(),o(),this.prevBumpedBorder="upper";break;case s:this.logger.debug("Bump bottom border"),"upper"===this.prevBumpedBorder&&c(),o(),this.prevBumpedBorder="bottom";break;default:this.prevBumpedBorder=void 0,a&&this.updateSliceItem(a)}i&&this.handleIntersectionBuffer()},this.updateSliceItem=e=>{if(!this.externalProps)return;let t=e.key,s=this.findVirtualItemIndex(t);this.logger.debug("Update slice item",e,s),-1===s&&(s=(0,a.clamp)(this.sliceItem?.index||0,0,this.externalProps.itemsKeys.length-1),t=this.getItemKey(s),this.logger.debug("Found true slice item",t,s)),this.sliceItem={key:t,index:s,align:e.align}},this.updateSliceArea=e=>{if(e=e??this.sliceItem,!this.externalProps||!e)return!1;if(this.updateSliceItem(e),!this.sliceItem)return!1;const t=this.sliceCount-1,s=this.externalProps.itemsKeys.length-1,n=.6*this.sliceCount;let r;switch(this.sliceItem.align){case"center":r=this.sliceItem.index+Math.round(.5*this.sliceCount);break;case"upper":case"scrollTop":r=this.sliceItem.index+(t-Math.round(n/2));break;case"bottom":r=this.sliceItem.index+Math.round(n/2);break;default:(0,a.exhaustivenessCheck)(this.sliceItem.align)}let i=Math.min(s,r);const o=Math.max(0,i-t);i=Math.min(s,o+t);const c={upperIndex:o,bottomIndex:i};return this.logger.debug("Got new slice area",c,this.sliceArea,this.getAnchorAlign()),!!this.isAreaChanged(this.sliceArea,c)&&(this.sliceArea=c,this.logger.debug("Slice area updated",c),!0)},this.getItemKey=e=>{const t=this.externalProps?.itemsKeys[e];return void 0===t?(this.logger.error("No key found for index",e),""):t},this.findViewArea=()=>{const e={upperIndex:-1,bottomIndex:-1};if(this.externalProps){for(let t=0;t<this.externalProps.itemsKeys.length;t++){const s=this.getItemKey(t),n=this.virtualItems.get(s);if(n&&(n.isIntersecting&&(-1===e.upperIndex?(e.upperIndex=t,e.bottomIndex=t):e.bottomIndex=t),!n.isIntersecting&&-1!==e.upperIndex))break}return-1===e.upperIndex?void 0:e}},this.updateViewArea=e=>{this.isAreaChanged(this.viewArea,e)&&(this.logger.debug("Update view area",e),this.viewArea=e,this.onViewAreaChangeTimeout&&window.clearTimeout(this.onViewAreaChangeTimeout),this.onViewAreaChangeTimeout=window.setTimeout((()=>this.externalProps?.onViewAreaChange?.(this.viewArea))))},this.getVirtualItemKey=e=>{const{dataset:{itemkey:t}}=e;if(!t){if(a.isDev)throw new Error("itemkey wasn't found at element's dataset");return""}return t},this.getVirtualItemElement=e=>{const t=this.wrapper?.querySelector(e?`[data-itemkey="${e}"]`:"[data-itemkey]");if(e||this.logger.error("getVirtualItemElement without itemKey: ",t),t)return t},this.isAreaChanged=(e,t)=>e?.upperIndex!==t?.upperIndex||e?.bottomIndex!==t?.bottomIndex,this.logger={debug:(...e)=>{a.isDev&&this.externalProps?.debugLog&&console.log("[VLIST]:",...e)},error:(...e)=>{a.isDev&&this.externalProps?.debugLog&&console.error("[VLIST]:",...e)}},this.logger.debug("Create new VirtualizerCore"),this.config=e,this.sliceCount=Math.round(e.sliceCount),this.handleIntersectionBuffer=(0,a.throttle)(this.handleIntersectionBuffer,this.config.throttleDelay)}}},504551:(e,t,s)=>{"use strict";s.d(t,{useVirtualScroll:()=>a});var n=s(296540);const r=e=>e.getSliceArea(),a=({virtualizerCore:e,wrapper:t,content:s,options:a})=>{const[i,o]=(0,n.useReducer)((e=>++e),0);return e.updateExternalProps({contentUpdatesCount:i,triggerContentUpdate:o,...a}),(0,n.useLayoutEffect)((()=>{if(t&&s)return e.createObservers(t,s)}),[t,s,e]),(0,n.useLayoutEffect)((()=>{e.afterLayoutUpdate()})),(0,n.useEffect)((()=>e.destroy),[e]),{triggerContentUpdate:o,virtualizerState:r(e)}}},458933:(e,t,s)=>{"use strict";s.d(t,{animateScroll:()=>o,easeInOutSine:()=>d,scrollToElement:()=>i});var n=s(522300),r=s(401193);const a={vertical:{scrollSize:"scrollHeight",scrollPosition:"scrollTop",containerSize:"clientHeight"},horizontal:{scrollSize:"scrollWidth",scrollPosition:"scrollLeft",containerSize:"clientWidth"}};function i(e,t,s,a,i=0,o=!1){const{offsetHeight:c}=e,{top:d,height:l}=(0,n.getOffsetRect)(s,t);let u;switch(a){case"upper":u=d-i;break;case"bottom":u=d+l-c+i;break;case"center":u=d+(l-c)/2;break;default:(0,r.exhaustivenessCheck)(a)}if(!o)return e.scrollTop=u,u;const p=window.getComputedStyle(e).overflow;return e.style.overflow="hidden",e.scrollTop=u,e.style.overflow=p,u}function o(e,t,s,n,r=600,i=c,o){const d=a[n],{[d.containerSize]:l,[d.scrollSize]:u}=e;let p,h=s-t;if(h<0?h=Math.max(h,-t):h>0&&(h=Math.min(h,u-l-t)),0===h)return o?.();if(0===r)return e[d.scrollPosition]=s,o?.();const m=s=>{void 0===p&&(p=s);const n=i(Math.min(1,(s-p)/r));e[d.scrollPosition]=Math.ceil(t+h*n),n<1?requestAnimationFrame(m):o?.()};requestAnimationFrame(m)}function c(e){return 1-(1-e)**4}function d(e){return.5*(1-Math.cos(Math.PI*e))}},164231:(e,t,s)=>{"use strict";function n(e){return(Number.isNaN(e)||void 0===e)&&(e=0),e}function r(e,t,s){e.hasMore=s,e.comments=t.concat(e.comments)}function a(e,t){-1!==e.comments.findLastIndex((e=>e.cmid===t.cmid))||(e.comments=e.comments.concat([t]))}function i(e,t){const s=e.comments.find((e=>e.cmid===t));s&&(s.kind="Deleted")}function o(e,t){const s=e.comments.find((e=>e.cmid===t));s&&(s.kind="Normal")}function c(e,t){const s=e.get(n(t.id));return void 0===s||!1===s.isCommentsForceHidden}s.d(t,{addComment:()=>a,canShowPlayer:()=>c,deleteComment:()=>i,insertComments:()=>r,resolveId:()=>n,restoreComment:()=>o})},795412:(e,t,s)=>{"use strict";s.d(t,{fromApiComment:()=>l});var n=s(136872),r=s(175953),a=s(302551),i=s(103026),o=s(856061),c=s(596917),d=s(872060);function l(e,t,s){const u={cmid:n.resolveCmid(e.id),postCmid:a.resolveCmid(e.post_id||s||0),channelId:i.resolveId(e.owner_id||t||0),canEdit:Boolean(e.can_edit),canDelete:Boolean(e.can_delete),rootCmid:e.parents_stack?.[0]?n.resolveCmid(e.parents_stack[0]):void 0,replies:{count:e?.thread?.count||0,history:(e.thread?.items||[]).map((e=>l(e,t,s))),nextFrom:e.thread?.next_from,prevFrom:e.thread&&e.thread.prev_from},sentAt:1e3*e.date,peerId:r.resolveId(e.from_id)};return e.deleted?{kind:"Deleted",isThreadDeleted:!1,...u}:{kind:"Normal",...u,chunks:e.text?c.fromServerText(e.text):[],attaches:(0,d.fromApiWallReplyAttach)(e.attachments||[]),likes:{count:e.likes?.count||0,reactionId:Boolean(e.likes?.user_likes)?o.resolveId(0):void 0,availableReactionIds:[],peerIds:new Set}}}},423560:(e,t,s)=>{"use strict";function n(e){return{name:e.name,icon:e.icon,text:e.text,canHide:Boolean(e.can_hide),...e.title&&{title:e.title},...e.icon&&{icon:e.icon},buttons:(e.buttons||[]).map((e=>({layout:e.layout,text:e.text,type:e.type,link:e.link,hideOnAction:Boolean(e.hide_on_action)})))}}s.d(t,{fromApiConversationsBar:()=>n})},959996:(e,t,s)=>{"use strict";s.d(t,{fromApiViewerPushSettings:()=>r});var n=s(843779);function r(e){let t=n.VIEWER_DEFAULT_PUSH_SETTINGS;const s=Array.isArray(e.items)?e.items?.find((e=>"messages"===e.id))?.items:e.items&&[e.items];if(void 0===s)return t;const r=e=>e&&"settings"in e?e.settings.find((e=>e.is_enabled))?.id:void 0,a=(e,t)=>{const n=s.find((e=>e.id===t));n&&"push_value"in n&&(e={...e,isEnabled:"on"===n.push_value});const a={text:!0,no_text:!1},i=r(n);i&&(e={...e,withMessageText:a[i]??e.withMessageText})};a(t.userConvo,"private_messages"),a(t.chatConvo,"group_chats"),a(t.groupConvo,"groups_messages_pushes"),a(t.messageReaction,"group_message_reaction");const i=s.find((e=>"mail"===e.id)),o={all:"every-mention",important:"direct-mention",none:"nothing"},c=r(i);return c&&(t={...t,mention:o[c]??t.mention}),t}},412937:(e,t,s)=>{"use strict";function n(e){return{type:e.type,filter:e.filter,name:e.name,description:e.description,peerIds:new Set}}s.d(t,{fromApiSublist:()=>n})},969769:(e,t,s)=>{"use strict";s.d(t,{fromApiAppearance:()=>i,fromApiBackground:()=>c,fromApiStyle:()=>a});var n=s(776983),r=s(401193);const a=(e,t)=>({id:n.resolveStyleId(e.id),appearanceId:n.resolveAppearanceId(e.appearance_id||e.id),backgroundId:n.resolveBackgroundId(e.background_id||e.id),title:t,sortId:e.sort,updateTime:e.update_time,isHidden:Boolean(e.is_hidden)}),i=e=>({id:n.resolveAppearanceId(e.id),sortId:e.sort,updateTime:e.update_time,light:o(e.light),dark:o(e.dark)}),o=e=>({bubbleGradient:e.bubble_gradient,accentColor:e.accent_color,headerTint:e.header_tint,writeBarTint:e.write_bar_tint,forwardLine:e.forward_line,textPlaceholder:e.text_placeholder,textPrimary:e.text_primary}),c=e=>({id:n.resolveBackgroundId(e.id),sortId:e.sort,updateTime:e.update_time,light:d(e.light),dark:d(e.dark)}),d=e=>{switch(e.type){case"raster":return{kind:"raster",url:e.raster.url,height:e.raster.height,width:e.raster.width};case"vector":return{kind:"vector",blur:e.vector.blur,colorEllipses:e.vector.color_ellipses?.map((e=>({color:l(e.color),radiusX:e.radius_x,radiusY:e.radius_y,x:e.x,y:e.y}))),gradient:e.vector.gradient&&{angle:e.vector.gradient.angle,colors:e.vector.gradient.colors.map(l)},svg:e.vector.svg&&{height:e.vector.svg.height,opacity:e.vector.svg.opacity,url:e.vector.svg.url,width:e.vector.svg.width,isOverlay:e.vector.svg.is_overlay}};default:(0,r.exhaustivenessCheck)(e)}},l=e=>7===e.length?e:`#${e.slice(3)}${e.slice(1,3)}`},400993:(e,t,s)=>{"use strict";s.d(t,{fromAttachVideoConvo:()=>r});var n=s(164231);function r(e,t,s=!1){return{kind:"VideoConvo",id:n.resolveId(e.id),ownerId:e.ownerId,canComment:Boolean(e.canComment),comments:[],hasMore:t,isLive:"live"===e.type,accessKey:e.accessKey,isCommentsForceHidden:s}}},106789:(e,t,s)=>{"use strict";s.d(t,{fromApiProfileType:()=>d,fromApiValidateProfileInfo:()=>c,fromApiViewerAccount:()=>i,fromApiViewerProfileInfo:()=>o});var n=s(175953),r=s(703837),a=s(519267);function i(e){return{id:n.resolveRealId("User",e.id),profileType:d(e.profile_type),firstName:e.first_name??"",lastName:e.last_name??"",photo:(0,r.fromApiPicture)({baseUrl:e.photo_base,photo100:e.photo_100}),isService:e.is_service_account||e.is_service}}function o(e){const{screen_name:t,phone:s,id:i,photo_200:o,first_name:c,last_name:d,nick_name:l,is_service_account:u,bdate:p,is_esia_verified:h}=e;return{screenName:t,phoneNumber:s,id:n.resolveRealId("User",i),avatarPhoto:(0,r.fromApiPicture)({baseUrl:(0,a.getClearBaseUrl)(o),photo200:o}),firstName:c,lastName:d,nickName:l,isServiceAccount:u,bdate:p,isEsiaVerified:h}}function c(e){const{is_error:t,fields:s}=e;return{isError:t,fields:s?.map((({field_name:e,error_code:t,error_msg:s,error_text:n})=>({name:e,code:t,msg:s,text:n})))}}function d(e){return{0:"normal",2:"edu"}[e??0]??"normal"}},417076:(e,t,s)=>{"use strict";s.d(t,{Engine:()=>a});var n=s(401193),r=s(73514);class a{dispose(){this.isWorking=!1,this.isDisposed=!0,this.currentRequestAbortController?.abort("dispose")}constructor(e,t){this.isWorking=!1,this.isDisposed=!1,this.currentRequestAbortController=null,this.empty=()=>({kind:"Buffer",buffer:[]}),this.queued=this.empty(),this.connect=e=>{if(this.isDisposed)return;if(this.isWorking)return;this.isWorking=!0,this.queued=this.empty();(async()=>{for(;this.isWorking;){if("Buffer"===this.queued.kind){if(this.queued.buffer.reduce(((e,t)=>"Batch"===t.kind?e+t.updates.length:e+1),0)>=100)return this.isWorking=!1,void this.dispatch({kind:"Failure"})}try{const t=`https://${e.server}?version=${this.version}&mode=682`,s=new AbortController;this.currentRequestAbortController=s;const n=setTimeout((()=>s.abort("timeout")),3e4),r=await this.request(t,{act:"a_check",key:e.key,ts:e.ts,wait:25},s.signal).finally((()=>{clearTimeout(n),this.currentRequestAbortController=null}));if("failed"in r)throw r;e.ts=r.ts,e.pts=r.pts,this.dispatch({kind:"Batch",...r})}catch(e){this.logger.info("[ENGINE] Error",e),this.isWorking=!1,this.dispatch({kind:"Failure"})}}})().catch((e=>{this.isWorking=!1,this.logger.error("[ENGINE] Drain error",e)})),this.logger.info("[ENGINE] Connected")},this.disconnect=()=>{this.currentRequestAbortController?.abort("disconnect")},this.dispatch=e=>{if("Callback"===this.queued.kind)return this.queued.resolve(e),void(this.queued=this.empty());switch(e.kind){case"Failure":return void this.queued.buffer.push(e);case"Batch":{const t=this.queued.buffer[this.queued.buffer.length-1];return void(t&&"Failure"!==t.kind&&t.pts===e.pts?(t.ts=e.ts,t.pts=e.pts,t.updates.push(...e.updates)):this.queued.buffer.push(e))}default:(0,n.exhaustivenessCheck)(e)}},this.poll=()=>{if("Callback"===this.queued.kind)return this.queued.reject("Engine.poll вызван повторно до обработки первого вызова!"),new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}}));const e=this.queued.buffer.shift();return e?Promise.resolve(e):this.isWorking?new Promise(((e,t)=>{this.queued={kind:"Callback",resolve:e,reject:t}})):Promise.reject("Engine.connect еще не был вызван!")},this.isConnected=()=>this.isWorking,this.logger=e,this.request=t,this.version=r.ENGINE_VERSION}}},485184:(e,t,s)=>{"use strict";s.d(t,{EventEmitter:()=>n});class n{subscribe(e,t){Array.isArray(this.subscriptions[e])?this.subscriptions[e]?.push(t):this.subscriptions[e]=[t]}unsubscribe(e,t){Array.isArray(this.subscriptions[e])&&(this.subscriptions[e]=this.subscriptions[e]?.filter((e=>e!==t))||[])}emit(e,t){Array.isArray(this.subscriptions[e])&&this.subscriptions[e]?.forEach((e=>e(t)))}constructor(){this.subscriptions={}}}},810704:(e,t,s)=>{"use strict";s.d(t,{DEFAULT_CONVOS_FAILED_MESSAGES_STORE:()=>r,getConvosFailedMessagesFromStorage:()=>i,saveConvosFailedMessagesInStorage:()=>a});const n="convos-failed-messages",r={version:1},a=(e,t)=>{const{pending:s}=e.history,a=s.filter((e=>e.item.hasFailed)).map((e=>e.item));t.updateIDB(n,((t=r)=>(a.length?t[e.peerId]=a:delete t[e.peerId],t))).catch((()=>{}))},i=async e=>{const t=await e.getIDB(n)||r;return 1!==t.version?(e.updateIDB(n,(()=>r)).catch((()=>{})),r):t}},162241:(e,t,s)=>{"use strict";var n;s.d(t,{IPerfStats:()=>n}),function(e){e.EventType={openChat:"open_chat",openChannel:"open_channel",appStart:"app_start",receiveMessage:"receive_message",longTasks:"long_tasks",memoryHeap:"memory_heap"}}(n||(n={}))},822438:(e,t,s)=>{"use strict";var n,r;s.d(t,{PlayerEventTypes:()=>n,VideoMessagePlayerEventTypes:()=>r}),function(e){e.STATE_UPDATED="stateupdated",e.START_NEW_TRACK="startNewTrack",e.START_NEXT_TRACK="startNextTrack",e.START_PREV_TRACK="startPrevTrack",e.RESUME_TRACK="resumeTrack",e.START_NEXT_TRACK_AUTOMATICALLY="startNextTrackAutomatically",e.STOP_CURRENT_TRACK_AUTOMATICALLY="stopCurrentTrackAutomatically",e.PLAYLIST_ENDED="playlistEnded",e.STOP_CURRENT_TRACK_BEFORE_STARTING_NEW_TRACK="stopCurrentTrackBeforeStartingNewTrack",e.STOP_CURRENT_TRACK_BY_ERROR="stopCurrentTrackByError",e.PAUSE_CURRENT_TRACK="pauseCurrentTrack"}(n||(n={})),function(e){e.SCROLL_TO_MESSAGE="scrollToMessage",e.STATE_UPDATED="stateUpdated"}(r||(r={}))},398743:(e,t,s)=>{"use strict";s.d(t,{Stats:()=>a});var n=s(401193);class r{dispose(){window.clearInterval(this.intervalId),this.pushStats()}constructor(e,t,s){this.collectEvent=e=>{this.storage.updateIDB("stats-transport-data",(t=>t?.length?[...t,e]:[e])).catch((e=>{console.error(`[Stats] Ошибка записи: ${e}`)}))},this.pushStats=async()=>{const e=await this.storage.getIDB("stats-transport-data")||[],t=(0,n.toNonEmpty)(e.slice(0,this.statsConfig.sendingAmount||1e3));if(!t)return;const s=new Set(t.map((({id:e})=>e)));await this.sendStats(t),await this.storage.updateIDB("stats-transport-data",((e=[])=>e.filter((({id:e})=>!s.has(e)))))},this.statsConfig=e,this.storage=t,this.sendStats=s;this.intervalId=window.setInterval((async()=>{try{await this.pushStats()}catch(e){console.error(`[Stats] Ошибка отправки статистики: ${e}`)}}),2e4)}}class a{logEvent(e){this.init();const t={...this.getBaseEvent(),...e};this.getCollector()?.collectEvent(t),this.lastEvent=t}trackExternalEvent(e){n.isDev&&console.info(`[Stats]: trackExternalEvent (${e.type})`)}init(){if(!this.collector){const{vkm_stats_config:e}=this.featureFlags;this.collector=new r(e,this.storage,this.sendLog)}}getCollector(){return this.collector}getCurrentTime(e=!0){const t=Date.now().toString(10);return e?t+"000":t}getLastEvent(){return this.lastEvent}getIntId(){return Math.floor(Math.random()*a.MAX_INT32)}getBaseEvent(){return{id:this.getIntId(),prev_id:this.getLastEvent()?.id,timestamp:this.getCurrentTime(),url:window.location.href}}dispose(){this.collector?.dispose()}constructor(e,t,s){this.featureFlags=e,this.sendLog=t,this.storage=s}}a.MAX_INT32=2147483647},749006:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(777211),r=s(175953);const a=(e,t,s)=>{const{profiles:a,groups:i,conversations:o,mutualFriends:c,contacts:d}=t;if((0,n.insertConvos)(e,o||[],s),(0,n.insertPeers)(e,{apiUsers:a||[],apiGroups:i||[],apiContacts:d||[]}),c){const t=e.peers.get(r.resolveId(c.peerId));t&&r.updateMutualFriends(t,c.hint.map(r.resolveId),c.count)}return[]}},302496:(e,t,s)=>{"use strict";s.d(t,{handler:()=>p});var n=s(777211),r=s(401193),a=s(726478),i=s(241503),o=s(103026),c=s(302551),d=s(175953),l=s(841093),u=s(73514);const p=(e,t)=>{switch(t.type){case"ChannelEngineBatchReceived":switch(t.variant.kind){case"FromChannelEngine":return function(e,t){const{next:s}=t;if("Failure"===s.kind){e.channelConn.status="resyncing";const{ts:t}=e.channelConn,s=e.channelConn.reconnectAttempts++;return[async function({api:e,channelEngine:n}){if(!n)return{type:"Noop"};const a=Math.min(2**s*500,1e4);let i;await(0,r.sleep)(a);try{i=await e.fetch("channels.getLongPollHistory",{lp_version:n.version,ts:t,limit:1e3,extended:1},{retries:1/0,timeout:u.CHANNELS_GLPH_TIMEOUT})}catch{return{type:"Noop"}}return n.connect({...i.credentials,ts:i.new_ts}),{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineApiHistory",ts:i.new_ts,history:i.history,apiPosts:i.messages||[],apiChannels:i.channels||[],apiGroups:i.groups||[],apiProfiles:i.profiles||[]}}}]}const n=function(e,t){const s=new Set,n=new Set,r=new Map;function a(t){switch(t[0]){case 70001:{const[,a,i,,l]=t,u=o.resolveId(a);if(e.channels.has(u)||s.add(u),!l){const e=c.resolveCmid(i),t=r.get(u);t?t.add(e):r.set(u,new Set([e]));break}if(l.attachments?.[0]?.wall.copy_history?.[0]?.from_id){const e=d.resolveId(l.attachments[0].wall.copy_history[0].from_id);if(d.isUserPeerId(e)){n.add(e);break}if(d.isGroupPeerId(e)){s.add(o.resolveId(e));break}}break}case 70002:{const[,s,n,a]=t,i=o.resolveId(s);if(!e.channels.has(i))break;if(!a){const e=c.resolveCmid(n),t=r.get(i);t?t.add(e):r.set(i,new Set([e]));break}break}case 70010:{const[,s,n,,a]=t,i=o.resolveId(s);if(!e.channels.has(i))break;if(!a){const e=c.resolveCmid(n),t=r.get(i);t?t.add(e):r.set(i,new Set([e]));break}break}case 70003:case 70004:case 70006:case 70007:case 70008:break;case 70005:{const[,e,n]=t;if(n){const t=o.resolveId(e);s.add(t)}break}case 70009:{const[,e,n]=t;if(n){const t=o.resolveId(e);s.add(t)}break}case 70011:for(const e of t[1])a(e);break;case 70012:{const[,n]=t;n.forEach((([t])=>{const n=o.resolveId(t);e.channels.has(n)||s.add(n)}));break}default:}}for(const e of t.updates)a(e);return{channelIds:s,userIds:n,postCmidsByChannel:r}}(e,s);if(n.channelIds.size>0||n.userIds.size>0||n.postCmidsByChannel.size>0)return[async function({api:e}){try{const t=await e.fetchMany([n.channelIds.size>0&&{method:"channels.getById",params:{channel_ids:Array.from(n.channelIds).join(","),extended:1}},n.userIds.size>0&&{method:"users.get",params:{user_ids:Array.from(n.userIds).map(d.toRealId).join(","),extended:1}},...Array.from(n.postCmidsByChannel).map((([e,t])=>({method:"channels.getMessagesById",params:{channel_id:e,cmids:Array.from(t).join(","),extended:1}})))],{retries:1/0});return{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngineWithMissingData",next:s,response:t}}}catch{return{type:"Noop"}}}];return e.channelConn.reconnectAttempts=0,h(e,s)}(e,t.variant);case"FromChannelEngineWithMissingData":return function(e,t){const{next:s,response:[r,a,...i]}=t;let o=new Map;i&&i.forEach((t=>{(0,n.insertPeers)(e,{apiUsers:t.profiles||[],apiGroups:t.groups||[],apiContacts:[]}),t.items?.length&&(o=function(e){const t=new Map;for(const s of e){let e=t.get(s.channel_id);e||(e=new Map,t.set(s.channel_id,e)),e.set(s.cmid,s)}return t}(t.items))}));r&&(0,n.insertChannels)(e,{apiChannels:r.items||[],apiGroups:r.groups||[],dangerouslyMerge:!0});(a||r)&&(0,n.insertPeers)(e,{apiUsers:[...a||[],...r?.profiles||[]],apiGroups:r?.groups||[],apiContacts:[]});return h(e,s,{channelsMessagesById:o})}(e,t.variant);case"FromChannelEngineApiHistory":return function(e,t){const{ts:s,history:r,apiChannels:a,apiGroups:i,apiPosts:o,apiProfiles:c}=t,d=new Map;for(const e of o){let t=d.get(e.channel_id);t||(t=new Map,d.set(e.channel_id,t)),t.set(e.cmid,e)}(0,n.insertPeers)(e,{apiUsers:c,apiGroups:i,apiContacts:[]},{dangerouslyOverwrite:!0}),(0,n.insertChannels)(e,{apiChannels:a,apiGroups:i,dangerouslyMerge:!0});const l={kind:"Batch",ts:s,updates:r.reduce(((e,t)=>{switch(t[0]){case 70001:case 70002:{const s=d.get(t[1])?.get(t[2]);return s?(e.push([...t,s]),e):e}default:return e.push(t),e}}),[])};return h(e,l)}(e,t.variant);default:return(0,r.exhaustivenessCheck)(t.variant)}case"ComposerDraftsUpdateNeeded":return[];default:return(0,r.exhaustivenessCheck)(t)}};function h(e,t,s){e.channelConn.status="running",e.channelConn.ts=t.ts;const n=t=>{switch(t[0]){case 70001:return function(e,t,s){const[,n,r,i,c]=t,d=o.resolveId(n),u=e.channels.get(d);if(!u)return[];if("ChannelRestricted"===u.kind)return[];o.setSortId(u,{minorSortId:i});const p=s?.channelsMessagesById.get(d)?.get(r)||c;if(!p)return[];const{post:h,reactions:m}=(0,l.fromApiPost)(p);for(const t of m)e.reactionsOld.set(t.id,t);o.appendPost(u,h),a.refreshChannels(e.organisers,u),e.locks.channelsCleanup.has(d)||o.cleanup(u);return[]}(e,t,s);case 70002:return function(e,t,s){const[,n,r,a]=t,i=o.resolveId(n),d=e.channels.get(i);if(!d)return[];if("ChannelRestricted"===d.kind)return[];const u=s?.channelsMessagesById.get(i)?.get(r)||a;if(!u)return[];const{post:p,reactions:h}=(0,l.fromApiPost)(u),m=o.findPostByCmid(d,p.cmid),g=c.merge(p,"Node"===m?.kind?m.item:void 0);for(const t of h)e.reactionsOld.set(t.id,t);return o.replacePost(d,g),[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[g]})]}(e,t,s);case 70003:return function(e,t){const[,s,n,r]=t,a=o.resolveId(s),i=c.resolveCmid(n),d=e.channels.get(a);if(!d)return[];if("ChannelRestricted"===d.kind)return[];return o.setSortId(d,{minorSortId:r}),o.deletePost(d,i,{isRestorable:!1}),[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToDelete:[{channelId:a,cmid:i}]})]}(e,t);case 70004:return function(e,t){const[,s,n,r]=t,i=o.resolveId(s),d=c.resolveCmid(n),l=e.channels.get(i);if(!l)return[];if("ChannelRestricted"===l.kind)return[];return o.readUntil(l,d,r),a.refreshChannels(e.organisers,l),[]}(e,t);case 70005:return function(e,t){const[,s,n,r]=t,c=o.resolveId(s),d=e.channels.get(c);if(!d)return[];if("ChannelRestricted"===d.kind)return[];return o.setArchived(d,!n),i.updateCounters(e.organisers.channelFilters,{archiveTotal:r}),a.refreshChannels(e.organisers,d),[]}(e,t);case 70006:return function(e,t){const[,s,n,r]=t,a=o.resolveId(s),i=e.channels.get(a);if(!i)return[];if("ChannelRestricted"===i.kind)return[];return o.setRights(i,{canPost:!!r}),o.setAdminLevel(i,n),[]}(e,t);case 70007:return function(e,t){const[,s,n]=t,r=o.resolveId(s),a=e.channels.get(r);if(!a)return[];if("ChannelRestricted"===a.kind)return[];return o.setMuted(a,0!==n),[]}(e,t);case 70008:return function(e,t){const[,s,n]=t;return i.updateCounters(e.organisers.channelFilters,{unread:s,unreadUnmuted:n}),[]}(e,t);case 70009:return function(e,t){const[,s,n]=t,r=o.resolveId(s),i=e.channels.get(r);if(!i)return[];if("ChannelRestricted"===i.kind)return[];return o.setMembership(i,Boolean(n)),a.refreshChannels(e.organisers,i),[]}(e,t);case 70010:return function(e,t,s){const[,n,r,,a]=t,i=o.resolveId(n),c=e.channels.get(i);if(!c)return[];if("ChannelRestricted"===c.kind)return[];const d=s?.channelsMessagesById.get(i)?.get(r)||a;if(!d)return[];const{post:u}=(0,l.fromApiPost)(d);"Normal"===u.kind&&o.restorePost(c,u.cmid,u);return[]}(e,t,s);case 70011:return t[1].flatMap(n);case 70012:return function(e,t){const[,s]=t;return s.forEach((([t,s])=>{const n=o.resolveId(t),r=e.channels.get(n);r&&"ChannelRestricted"!==r.kind&&(o.setSortId(r,{majorSortId:s}),a.refreshChannels(e.organisers,r))})),[]}(e,t);default:return[]}};return[...t.updates.flatMap(n),async function({channelEngine:e}){if(!e)return{type:"Noop"};try{return{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:await e.poll()}}}catch{return{type:"Noop"}}}]}},495445:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(103026);const a=(e,t)=>{switch(t.type){case"ChannelMediaViewerCacheRemoved":{const s=e.channels.get(t.channel.id);return s&&"ChannelRestricted"!==s.kind?(r.clearMediaViewerCache(s),[]):[]}case"ChannelMediaViewerCacheInserted":{const s=e.channels.get(t.channelId);return s&&"ChannelRestricted"!==s.kind?(s.mediaViewerCache={...s.mediaViewerCache,...t.data},[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},412925:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(241503),a=s(777211);const i=(e,t)=>{switch(t.type){case"ChannelsOnboardingDone":return 0===t.pickedChannelsIds.length?(r.push(e.organisers.channelFilters,"all",[],!1),[async function({api:e}){return await e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}]):[async function({api:e}){try{return{type:"ChannelsOnboardingDone_RequestSucceeded",responseChannels:await e.fetch("channels.unarchive",{channel_ids:t.pickedChannelsIds.join(",")||"",extended:1})}}catch(e){return{type:"ChannelsOnboardingDone_RequestFailed"}}}];case"ChannelsOnboardingDone_RequestSucceeded":{const s=(0,a.insertChannels)(e,{apiChannels:t.responseChannels.succeeded||[],apiGroups:t.responseChannels.groups||[]});return r.push(e.organisers.channelFilters,"all",s,!1),[async function({api:e}){return await e.fetch("account.hideHelpHint",{hint_id:"im:channels_onboarding"},{retries:1/0}),{type:"Noop"}}]}case"ChannelsOnboardingDone_RequestFailed":return[];default:(0,n.exhaustivenessCheck)(t)}}},656441:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(856562);const a=(e,t)=>{switch(t.type){case"ConvoMediaViewerCacheRemoved":{const s=e.convos.get(t.convo.peerId);return s?(r.clearMediaViewerCache(s),[]):[]}case"ConvoMediaViewerCacheInserted":{const s=e.convos.get(t.peerId);return s?(s.mediaViewerCache={...s.mediaViewerCache,...t.data},[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},246230:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;switch(s){case"HideEduIntegrationBanner":{const t=Date.now(),s=e.eduIntegrationBanner.hiddenCount+1;return e.eduIntegrationBanner.hiddenAt=t,e.eduIntegrationBanner.hiddenCount=s,[async function({storage:e,stats:n}){return e.set("edu-integration-banner",{hiddenAt:t,hiddenCount:s}),n.logEvent({type:"type_action",type_action:{type:"type_im_conversations_banner_item",type_im_conversations_banner_item:{event_type:"hide",banner_name:"edu_joining_ejd_chats"}}}),{type:"Noop"}}]}case"ShowEduIntegrationBanner":{const t=null,s=e.eduIntegrationBanner.hiddenCount;return e.eduIntegrationBanner.hiddenAt=t,e.eduIntegrationBanner.hiddenCount=s,[async function({storage:e}){return e.set("edu-integration-banner",{hiddenAt:t,hiddenCount:s}),{type:"Noop"}}]}default:(0,n.exhaustivenessCheck)(s)}}},275795:(e,t,s)=>{"use strict";s.d(t,{handler:()=>P,pollEngine:()=>N});var n=s(679005),r=s(777211),a=s(503485),i=s(946990),o=s(726478),c=s(211274),d=s(175953),l=s(856562),u=s(254335),p=s(649166),h=s(728921),m=s(520828),g=s(157274),f=s(157570),C=s(84113),v=s(358096),y=s(776983),_=s(726356),k=s(401193),I=s(73514),b=s(872466),w=s(755607),S=s(412937),R=s(512871),M=s(592087),E=s(162241),A=s(399332);const U=200,P=(e,t,s)=>{switch(t.type){case"EngineBatchReceived":{const{variant:n}=t;switch(n.kind){case"FromEngineBatch":return function(e,t,s){const{next:n,receivedMessagesStats:r,now:o}=s;if(e.vkm_missing_data_rework){const e=function(e,t){const s=new Map,n=new Set,r=new Set,o=new Set,c=new Set,u=e=>{switch(!0){case d.isUserPeerId(e):return void r.add(e);case d.isGroupPeerId(e):return void o.add(e);case d.isContactPeerId(e):return void c.add(e);case d.isChatPeerId(e):return;default:(0,k.exhaustivenessCheck)(e)}},h=(e,t)=>{let n=s.get(e);n||(n=new Set,s.set(e,n)),n.add(t)};for(const s of t.updates)if(a.IEngine.isIncompleteUpdate(s)){const[,t]=s,r=10004===s[0],a=r?s[4]:s[3],i=d.resolveId(a),o=p.resolveCmid(t),c=e.convos.get(i);if(!c&&!r)continue;c||n.add(i),h(i,o)}else switch(s[0]){case 20:case 21:{const[,e]=s,t=d.resolveId(e);n.add(t);break}case 52:{const[,t,r,i]=s,o=d.resolveId(r),c=e.convos.get(o);if(!c)break;switch(t){case a.IEngine.ChatUpdateType.FlagsChanged:case a.IEngine.ChatUpdateType.TitleChanged:case a.IEngine.ChatUpdateType.AvatarChanged:case a.IEngine.ChatUpdateType.BannerChanged:case a.IEngine.ChatUpdateType.MessageRequestChanged:case a.IEngine.ChatUpdateType.MessageRequestCanceled:case a.IEngine.ChatUpdateType.MessageRequestAccepted:case a.IEngine.ChatUpdateType.MessageRequestRejected:case a.IEngine.ChatUpdateType.CallInProgressChanged:case a.IEngine.ChatUpdateType.ContactConverted:case a.IEngine.ChatUpdateType.ContactJoined:case a.IEngine.ChatUpdateType.DescriptionChanged:case a.IEngine.ChatUpdateType.IncognitoJoined:case a.IEngine.ChatUpdateType.ConvertIncognito:n.add(o);break;case a.IEngine.ChatUpdateType.UserJoined:case a.IEngine.ChatUpdateType.UserLeft:case a.IEngine.ChatUpdateType.UserKicked:{const s=d.resolveId(i);"ChatConvo"===c.kind&&0!==c.members.memberIds.size&&(e.peers.has(s)||u(s)),t===a.IEngine.ChatUpdateType.UserJoined&&s===e.ownerId&&n.add(o);break}case a.IEngine.ChatUpdateType.Pinned:{const[,,e,t]=s;if(0===t)break;const n=d.resolveId(e),r=p.resolveCmid(t),{status:a}=l.findHistoryNodeByCmid(c,r);"NotLoaded"===a&&h(n,r);break}case a.IEngine.ChatUpdateType.CopyFlagChanged:case a.IEngine.ChatUpdateType.AdminGrated:case a.IEngine.ChatUpdateType.AdminKicked:case a.IEngine.ChatUpdateType.KeyboardChanged:case a.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case a.IEngine.ChatUpdateType.DonUnsubscribed:case a.IEngine.ChatUpdateType.DonSubscribed:case a.IEngine.ChatUpdateType.IsNewChange:case a.IEngine.ChatUpdateType.StyleChanged:case a.IEngine.ChatUpdateType.ShortPollReactionsChanged:case a.IEngine.ChatUpdateType.IncognitoLeft:break;default:}break}case 10013:{const[,t]=s,r=d.resolveId(t);e.convos.has(r)&&n.add(r);break}case 63:case 64:case 65:case 66:case 67:case 68:case 10:case 11:case 12:case 80:case 91:case 114:case 115:case 119:case 602:case 604:case 701:case 10001:case 10002:case 10006:case 10007:case 10501:case 10502:case 10503:case 10504:case 10505:case 10506:case 10507:case 10508:case 10509:case 80005:break;case 10003:{const[,e,t,n]=s,r=d.resolveId(n),{isDeleted:a,isSpam:i}=p.convertFlags(t);if(!a&&!i)break;h(r,p.resolveCmid(e));break}case 10004:{const[,t,,,r,,,a,o]=s,c=d.resolveId(r),l=p.resolveCmid(t),m=e.convos.get(c);m||n.add(c);const g=e=>m&&L(m)(e);if(G(o,a,g)){h(c,l);break}const{message:f}=(0,i.fromEngineMessage)(s,e.ownerId,g);if(e.peers.has(f.peerId)||u(f.peerId),e.peers.has(f.authorId)||u(f.authorId),"Service"===f.kind)switch(f.action.type){case"chat_photo_remove":case"chat_group_call_started":case"chat_screenshot":case"chat_invite_user_by_link":case"chat_invite_user_by_call_join_link":case"chat_kick_don":case"call_transcription_failed":case"chat_pin_message":case"chat_unpin_message":case"chat_photo_update":case"chat_create":case"chat_title_update":case"conversation_style_update":case"conversation_style_update_action":case"sent_message_requests_count":case"rejected_message_request":case"custom":case"unknown":break;case"sent_message_request":e.peers.has(f.action.from)||u(f.action.from);break;case"chat_invite_user":case"chat_kick_user":case"accepted_message_request":case"chat_invite_user_by_call":case"chat_invite_user_by_message_request":case"chat_kick_user_call_block":e.peers.has(f.action.peerId)||u(f.action.peerId);break;default:(0,k.exhaustivenessCheck)(f.action)}break}case 10005:case 10018:{const[,t,n,r,,,a,i]=s,o=d.resolveId(r),c=e.convos.get(o);if(!c)break;const u=p.resolveCmid(t);if(!l.findMessageByCmid(c,u))break;G(i,a,L(c))&&h(o,u);p.convertFlags(n).hasReactions&&h(o,u);break}case 10019:{const[,t,n]=s,r=d.resolveId(n),a=e.convos.get(r);if(!a)break;const i=p.resolveCmid(t);if(!l.findMessageByCmid(a,i))break;h(r,i);break}case 601:{const[,t,r,a]=s;if(1!==t&&2!==t)break;if(!e.viewer.settings.push.messageReaction.isEnabled)break;const i=p.resolveCmid(a),o=d.resolveId(r),c=e.convos.get(o);if(c){const{status:e}=C.findNodeByCmid(c.history,i);"NotLoaded"===e&&h(o,i)}else n.add(o),h(o,i);break}case 603:{const[,e,,...t]=s;switch(e){case 0:case 2:break;case 1:t.forEach((e=>{n.add(e)}));break;default:(0,k.exhaustivenessCheck)(e)}break}default:}return n.forEach((e=>{switch(!0){case d.isUserPeerId(e):return void r.delete(e);case d.isGroupPeerId(e):return void o.delete(e);case d.isContactPeerId(e):return void c.delete(e);case d.isChatPeerId(e):return;default:(0,k.exhaustivenessCheck)(e)}})),n.delete(d.resolveId()),s.delete(d.resolveId()),r.delete(d.resolveId()),{cmidsByPeerId:s,convoPeerIds:n,userPeerIds:r,groupPeerIds:o,contactPeerIds:c}}(t,s.next);if(e.cmidsByPeerId.size>0||e.convoPeerIds.size>0||e.userPeerIds.size>0||e.groupPeerIds.size>0||e.contactPeerIds.size>0)return[q(n,t.ownerId,o,e)]}else if(function(e,t){for(const s of t.updates){if(a.IEngine.isIncompleteUpdate(s))return!0;switch(s[0]){case 20:case 21:{const[,t]=s,n=d.resolveId(t);if(!e.convos.has(n))return!0;break}case 52:{const[,t,n,r]=s,i=d.resolveId(n),o=e.convos.get(i);if(!o)break;switch(t){case a.IEngine.ChatUpdateType.FlagsChanged:case a.IEngine.ChatUpdateType.TitleChanged:case a.IEngine.ChatUpdateType.AvatarChanged:case a.IEngine.ChatUpdateType.BannerChanged:case a.IEngine.ChatUpdateType.MessageRequestChanged:case a.IEngine.ChatUpdateType.MessageRequestCanceled:case a.IEngine.ChatUpdateType.MessageRequestAccepted:case a.IEngine.ChatUpdateType.MessageRequestRejected:case a.IEngine.ChatUpdateType.CallInProgressChanged:case a.IEngine.ChatUpdateType.ContactConverted:case a.IEngine.ChatUpdateType.ContactJoined:case a.IEngine.ChatUpdateType.DescriptionChanged:case a.IEngine.ChatUpdateType.IncognitoJoined:case a.IEngine.ChatUpdateType.ConvertIncognito:case a.IEngine.ChatUpdateType.StyleChanged:return!0;case a.IEngine.ChatUpdateType.UserJoined:case a.IEngine.ChatUpdateType.UserLeft:case a.IEngine.ChatUpdateType.UserKicked:{const s=d.resolveId(r);if(!e.peers.has(s))return!0;if(t===a.IEngine.ChatUpdateType.UserJoined&&s===e.ownerId)return!0;break}case a.IEngine.ChatUpdateType.Pinned:{const[,,,e]=s;if(0===e)break;const t=p.resolveCmid(e),{status:n}=l.findHistoryNodeByCmid(o,t);if("NotLoaded"===n)return!0;break}case a.IEngine.ChatUpdateType.CopyFlagChanged:case a.IEngine.ChatUpdateType.AdminGrated:case a.IEngine.ChatUpdateType.AdminKicked:case a.IEngine.ChatUpdateType.KeyboardChanged:case a.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case a.IEngine.ChatUpdateType.DonUnsubscribed:case a.IEngine.ChatUpdateType.DonSubscribed:case a.IEngine.ChatUpdateType.IsNewChange:case a.IEngine.ChatUpdateType.ShortPollReactionsChanged:case a.IEngine.ChatUpdateType.IncognitoLeft:break;default:}break}case 10013:{const[,t]=s,n=d.resolveId(t);if(e.convos.has(n))return!0;break}case 63:case 64:case 65:case 66:case 67:case 68:case 10:case 11:case 12:case 80:case 91:case 114:case 115:case 119:case 602:case 604:case 701:case 10001:case 10002:case 10006:case 10007:case 10501:case 10502:case 10503:case 10504:case 10505:case 10506:case 10507:case 10508:case 10509:case 80005:break;case 10003:{const[,,t,n]=s,r=d.resolveId(n);if(!e.convos.get(r))break;const{isDeleted:a,isSpam:i}=p.convertFlags(t);if(a||i)return!0;break}case 10004:{const[,,,,t,,,n,r]=s,a=d.resolveId(t),o=e.convos.get(a);if(!o)return!0;const c=L(o);if(G(r,n,c))return!0;const{message:l}=(0,i.fromEngineMessage)(s,e.ownerId,c);if(!e.peers.has(l.peerId)||!e.peers.has(l.authorId))return!0;if(d.isUserPeerId(l.authorId)&&l.peerId===l.authorId&&!e.lastSeens.has(l.authorId))return!0;break}case 10005:case 10018:{const[,t,n,r,,,a,i]=s,o=d.resolveId(r),c=e.convos.get(o);if(!c)break;const u=p.resolveCmid(t);if(!l.findMessageByCmid(c,u))break;if(G(i,a,L(c)))return!0;if(p.convertFlags(n).hasReactions)return!0;break}case 10019:{const[,t,n]=s,r=d.resolveId(n),a=e.convos.get(r);if(!a)break;const i=p.resolveCmid(t);if(!l.findMessageByCmid(a,i))break;return!0}case 601:{const[,t,n,r]=s;if(1!==t&&2!==t)break;if(!e.viewer.settings.push.messageReaction.isEnabled)break;const a=e.convos.get(d.resolveId(n));if(!a||"NotLoaded"===C.findNodeByCmid(a.history,p.resolveCmid(r)).status)return!0;break}case 603:{const[,e]=s;switch(e){case 0:case 2:break;case 1:return!0;default:(0,k.exhaustivenessCheck)(e)}break}default:}}return!1}(t,n))return[O(t.convoConn.pts,n,t.ownerId,o)];return t.convoConn.reconnectAttempts=0,[...F(e,t,n,o),x(r)]}(s,e,n);case"FromEngineFailure":case"FromEngineMissingDataFailed":return function(e,t,s){const{now:n}=s,a=t.convoConn.pts,i=t.ownerId;t.convoConn.status="resyncing";const o=t.convoConn.reconnectAttempts++;let c;e.vkm_resync_glph_replacement&&(c=Array.from(t.convos.values()).reduce(((e,s)=>{if("ChatConvo"!==s.kind)return e;if(0===s.members.members.size)return e;return t.locks.convosCleanup.get(s.peerId)?[...e,s.peerId]:(v.resetMembers(s.members),e)}),[]));return[async function({api:t,engine:s,logger:n}){if(!e.vkm_resync_glph_replacement)return{type:"Noop"};let{conversationLimit:o}=e.vkm_resync_glph_replacement;o=Math.min(Math.max(Number(o)||200,1),200);const d=(0,r.getOwnerGroupId)(i),l=0===d;let u;try{u=await t.fetch("messages.getDiff",{group_id:d,from_version:a,conversations_limit:o,lp_version:s.version,extended_filters:["credentials","server_version","profiles","contacts","groups","messages",...l?["counters","folders","folders_with_peers"]:[]].join(","),...l&&{counter_filters:"all",supported_types:h.getSupportedTypes(e)}},{retries:1/0})}catch(e){return n.error("Ошибка апи от messages.getDiff",e),{type:"Noop"}}if(u.invalidate_all)return window.location.reload(),{type:"Noop"};const p=u.server_version;if(!u.credentials||!p)throw new Error("В ответе getDiff с credentials отсутствуют новые креды или pts!");const m=[{apiConversationsInfo:u.conversations_info,apiUsers:u.profiles,apiGroups:u.groups,apiContacts:u.contacts}];let g=u.conversations_source;for(;g;)try{const e=await t.fetch("messages.getDiff",{group_id:(0,r.getOwnerGroupId)(i),from_version:a,to_version:p,conversations_source:g,conversations_limit:o,extended_filters:["profiles","contacts","groups","messages"].join(",")},{retries:1/0});m.push({apiConversationsInfo:e.conversations_info,apiUsers:e.profiles,apiGroups:e.groups,apiContacts:e.contacts}),g=e.conversations_source}catch{return{type:"Noop"}}s.connect({ts:u.credentials.ts,server:u.credentials.server_lp,key:u.credentials.key,pts:p});const f=[];let C;if(c.length>0){const e={from_version:a,to_version:p,peer_ids:c.join(","),limit:200,group_id:d,extended:1};try{C=await t.fetch("messages.getDiffConversationMembers",e,{retries:1/0}),(C.invalidate||C.diff)&&f.push(C)}catch{return{type:"Noop"}}let s=C.source;for(;s;)try{const n=await t.fetch("messages.getDiffConversationMembers",{...e,source:s},{retries:1/0});(n.invalidate||n.diff)&&f.push(n),s=n.source}catch{return{type:"Noop"}}}return{type:"EngineBatchReceived",variant:{kind:"FromApiEngineGetDiff",apiEntities:m,apiCounters:u.counters,apiFolders:u.folders,chatIdsToUpdateMembers:c,apiMembersDiff:f,newPts:p}}},async function({api:t,engine:s,queue:c,logger:d}){if(e.vkm_resync_glph_replacement)return{type:"Noop"};const l=Math.min(2**o*500,1e4);let u,p;await(0,k.sleep)(l);try{[u,p]=await t.fetchSeq([{method:"messages.getLongPollHistory",params:{lp_version:s.version,credentials:1,pts:a,msgs_limit:1100,events_limit:1100,last_n:1e3,extended:1,group_id:(0,r.getOwnerGroupId)(i)}},{method:"messages.getCounters",params:{filter:"all"}}],{retries:1/0})}catch(e){return d.error("Ошибка апи от messages.getLongPollHistory",e),{type:"Noop"}}if(a<(u.from_pts||0))return c.disconnect(),console.error("Выполняется полный ресинк"),{type:"TemporaryHackForResync"};if(!u.credentials||!u.credentials.pts)throw new Error("В ответе getLongPollHistory отсутствуют новые креды!");return s.connect({...u.credentials,pts:u.credentials.pts}),{type:"EngineBatchReceived",variant:{kind:"FromApiEngineHistory",apiMessages:u.messages?.items||[],apiConvos:u.conversations||[],apiUsers:u.profiles||[],apiGroups:u.groups||[],apiContacts:u.contacts||[],apiCounters:p,next:{kind:"Batch",pts:u.credentials.pts,ts:u.credentials.ts,updates:u.history||[]},now:n}}}]}(s,e,n);case"FromEngineWithMissingData":return function(e,t,s){const{apiConvos:n,apiMessages:a,apiUsers:i,apiGroups:o,apiContacts:c,apiIncognitoMembers:d,now:l}=s,u=B(a,n);return(0,r.insertConvos)(t,n.map((e=>({conversation:e,last_message:u.messagesByPeerId.get(e.peer.id)?.get(e.last_conversation_message_id||0)}))),e,{dangerouslyMerge:!0}),(0,r.insertPeers)(t,{apiUsers:i,apiGroups:o,apiContacts:c}),(0,r.insertIncognitoMembers)(t,d),F(e,t,s.skippedBatch,l,u)}(s,e,n);case"FromApiEngineHistory":return function(e,t,s){const{next:n,apiMessages:a,apiConvos:i,apiUsers:o,apiGroups:d,apiContacts:l,apiCounters:u,now:p}=s,m=B(a,i);(0,r.insertConvos)(t,i.map((e=>({conversation:e,last_message:m.messagesByPeerId.get(e.peer.id)?.get(e.last_conversation_message_id||0)}))),e,{dangerouslyMerge:!0}),(0,r.insertPeers)(t,{apiUsers:o,apiGroups:d,apiContacts:l},{dangerouslyOverwrite:!0}),t.activeCallsCount=u.calls||0,c.updateCounters(t.organisers.filters,{unread:u.messages||0,unreadUnmuted:u.messages_unread_unmuted||0,headerNotMutedUnread:0,archive:u.messages_archive_unread||0,archiveMentions:u.messages_archive_mentions_count||0,archiveTotal:u.messages_archive||0,messageRequests:u.message_requests||0,businessNotify:u.business_notify||0,businessNotifyTotal:u.business_notify_all||0}),u.messages_folders?.forEach((e=>{h.setUnreadCounters(t.organisers.folders,h.resolveId(e.folder_id),e.total_count,e.unmuted_count)}));const{unreadUnmutedCount:g,unreadCount:f}=t.organisers.filters.all,C=t.viewer.settings.countOnlyNotMuted;return[...F(e,t,n,p,m),e.vkm_prds&&D(t),async function({notification:e}){return e.setCounters({unread:f,unreadUnmuted:g,showOnlyNotMuted:C}),e.notifyListeners({kind:"counter",payload:g}),e.setIdleCounter(0),{type:"Noop"}}]}(s,e,n);case"FromApiEngineGetDiff":return function(e,t,s){const{apiEntities:n,apiFolders:a,apiCounters:i,chatIdsToUpdateMembers:o,apiMembersDiff:u=[],newPts:m}=s,g=[];for(const{diff:e=[],profiles:s=[],groups:n=[],contacts:a=[],invalidate:i}of u){if(i){g.push(...o);break}(0,r.insertPeers)(t,{apiUsers:s,apiGroups:n,apiContacts:a},{dangerouslyOverwrite:!0}),e.forEach((({peer_id:e,in_items:s=[],out_members:n=[],out_incognitos:a=[],incognito_members:i=[],invalidate:o})=>{const c=t.convos.get(d.resolveId(e));if(c&&"ChatConvo"===c.kind&&0!==c.members.members.size)if(o)g.push(c.peerId);else{(0,r.insertChatMembers)(c.members,s,i);for(const e of n){const s=d.resolveId(e);(d.isUserPeerId(s)||d.isGroupPeerId(s))&&(s===t.ownerId&&l.changeUserState(c,"left"),v.isAdmin(c.members,s)&&v.unsetAdmin(c.members,s),v.removeMember(c.members,s))}for(const e of a){const t=v.resolveIncognitoMemberId(e),s=v.getIncognitoMember(c.members,t);s?.memberId&&v.removeMember(c.members,s.memberId),v.removeIncognitoMember(c.members,t)}}}))}g.forEach((e=>{const s=t.convos.get(e);s&&"ChatConvo"===s.kind&&v.resetMembers(s.members)}));const f=new Map,C=new Map;for(const{apiConversationsInfo:s=[],apiUsers:a=[],apiGroups:i=[],apiContacts:o=[]}of n)s.forEach((({conversation:s,message:n,invalidate:a,cmids_flags:i=[],range_deleted_cmids:o=[],range_updated_cmids:c=[],cmids_updated_reactions:u=[]})=>{if(!s)return;const h=d.resolveId(s.peer.id),m=!t.convos.has(h);(0,r.insertConvos)(t,[{conversation:s,last_message:n?.[0]}],e,{dangerouslyMerge:!0,shouldUpdateSortId:!0,invalidateHistory:a});const g=t.convos.get(h);if(!g)return;if(m||a)return;const v=new Set,y=new Set,_=new Set(u.map(p.resolveCmid));i.forEach((({cmid:e,updated_flags:t})=>{const s=p.resolveCmid(e),{isDeleted:n,isPlayed:r,isEdited:a,wasRestored:i,isExpired:o,isImportant:c,isUnimportant:d}=T(t);if(n&&v.add(s),r||c||d){const e=r?p.MESSAGE_FLAGS.isPlayed:p.MESSAGE_FLAGS.isImportant,t=d?"unset":"set";l.updateMessageFlags(g,s,t,2**e)}(a||o)&&_.add(s),i&&y.add(s)}));const{deletedCmidsInCache:k,updatedCmidsInCache:I}=g.history.confirmed.reduce(((e,t)=>{if("GapNode"===t.kind)return e;const s="DeletedNode"===t.kind?t.restorable:t.item;v.has(s.cmid)&&e.deletedCmidsInCache.add(s.cmid);for(const{min:t,max:n}of o)if(s.cmid>=t&&s.cmid<=n){e.deletedCmidsInCache.add(s.cmid);break}_.has(s.cmid)&&e.updatedCmidsInCache.add(s.cmid);for(const{min:t,max:n}of c)if(s.cmid>=t&&s.cmid<=n){e.updatedCmidsInCache.add(s.cmid);break}return e}),{deletedCmidsInCache:new Set,updatedCmidsInCache:new Set});if(Array.from(y).forEach((e=>{const{status:t}=l.findHistoryNodeByCmid(g,e);"NotLoaded"!==t&&I.add(e)})),k.size>0){const e=Array.from(k);e.forEach((e=>{const t=l.findMessageByCmid(g,e);t&&l.deleteMessage(g,t,{isRestorable:!1})})),C.set(h,e)}I.size>0&&f.set(h,Array.from(I))})),(0,r.insertPeers)(t,{apiUsers:a,apiGroups:i,apiContacts:o},{dangerouslyOverwrite:!0});if(a){e.vkm_sublists_in_folder&&(0,r.insertSublists)(t,a.included_lists_info?.map(S.fromApiSublist));const s=a.items.map(R.fromApiFolder);(0,r.insertFolders)(t,s,{dangerouslyOverwrite:!0})}i&&(t.activeCallsCount=i.calls||0,c.updateCounters(t.organisers.filters,{unread:i.messages||0,unreadUnmuted:i.messages_unread_unmuted||0,headerNotMutedUnread:0,archive:i.messages_archive_unread||0,archiveMentions:i.messages_archive_mentions_count||0,archiveTotal:i.messages_archive||0,messageRequests:i.message_requests||0,businessNotify:i.business_notify||0,businessNotifyTotal:i.business_notify_all||0}),i.messages_folders?.forEach((e=>{h.setUnreadCounters(t.organisers.folders,h.resolveId(e.folder_id),e.total_count,e.unmuted_count)})));t.convoConn.status="running",t.convoConn.pts=m;const{unreadUnmutedCount:y,unreadCount:_}=t.organisers.filters.all,k=t.viewer.settings.countOnlyNotMuted,I=t.ownerId;return[N(),e.vkm_prds&&D(t),async function({notification:e}){return e.setCounters({unread:_,unreadUnmuted:y,showOnlyNotMuted:k}),e.notifyListeners({kind:"counter",payload:y}),{type:"Noop"}},async function({api:e}){if(!f.size)return{type:"Noop"};let t;try{t=await e.fetch("messages.getDiffContent",{conversation_messages:JSON.stringify(Array.from(f).map((([e,t])=>({peer_id:e,updated_cmids:t})))),extended:1,group_id:(0,r.getOwnerGroupId)(I)},{retries:1/0})}catch{return{type:"Noop"}}return{type:"EngineBatchReceived",variant:{kind:"FromApiEngineGetDiffContent",apiMessagesByPeerId:t.items.reduce(((e,{requested_messages:t,peer_id:s})=>{if(!t?.length)return e;const n=d.resolveId(s),r=e.get(n);return r?r.push(...t):e.set(n,t),e}),new Map),apiUsers:t.profiles,apiGroups:t.groups,apiContacts:t.contacts}}},...Array.from(C.entries()).map((([e,t])=>async function(){return{type:"ComposerDraftsUpdateNeeded",peerId:e,foreignKind:"message",itemsToDelete:t.map((t=>({peerId:e,cmid:t})))}})),...g.map((e=>async function(){return{type:"LoadChatMembers",peerId:e}}))]}(s,e,n);case"FromApiEngineGetDiffContent":return function(e,t){const{apiMessagesByPeerId:s,apiUsers:n=[],apiGroups:a=[],apiContacts:o=[]}=t;(0,r.insertPeers)(e,{apiUsers:n,apiGroups:a,apiContacts:o});const c=Array.from(s?.entries()||[]).reduce(((t,[s,n])=>{const{itemsToDelete:r,itemsToReplace:a}=n.reduce(((t,n)=>{const{message:r,mentions:a}=(0,i.fromApiMessage)(n),o=e.convos.get(s);if(!o)return t;const{status:c}=l.findHistoryNodeByCmid(o,r.cmid),d="Deleted"===c;return d?l.restoreMessage(o,r,a.hasDirect||a.hasMass):l.replaceMessage(o,r,a.hasDirect||a.hasMass),"Expired"===r.kind&&(l.replaceExpiredReplies(o,r.cmid),t.itemsToDelete=[...t.itemsToDelete,{peerId:s,cmid:r.cmid}]),"Normal"!==r.kind||d||(t.itemsToReplace=[...t.itemsToReplace,r]),t}),{itemsToDelete:[],itemsToReplace:[]});return(r.length>0||a.length>0)&&(t=[...t,{peerId:s,itemsToDelete:r,itemsToReplace:a}]),t}),[]);return[...c.map((({peerId:e,itemsToDelete:t,itemsToReplace:s})=>async function(){return{type:"ComposerDraftsUpdateNeeded",peerId:e,foreignKind:"message",itemsToDelete:t,itemsToReplace:s}}))]}(e,n);default:return(0,k.exhaustivenessCheck)(n)}}case"EngineBatchReceived_TypingsTimedOut":{const{peerId:s,typingType:n,timestamp:r}=t,a=e.typings.get(s);if(!a)return[];const i=a[n];return i?(i.updatedAt<=r&&delete a[n],0===Object.keys(a).length&&e.typings.delete(s),[]):[]}case"UpdateMessageRequestsCounter":return[async function({api:e}){try{const t=M.IApi.resolveTrackId("messages.getCounters","message_requests");e.dangerouslyAbort(t);const{message_requests:s}=await e.fetch("messages.getCounters",{filter:"message_requests"},{trackId:t});return{type:"UpdateMessageRequestsCounter_RequestCompleted",count:s??0}}catch{return{type:"Noop"}}}];case"UpdateMessageRequestsCounter_RequestCompleted":return c.updateCounters(e.organisers.filters,{messageRequests:t.count}),[];case"RefetchFoldersRequest_RequestCompleted":{const{apiFolders:n,folderId:a}=t,i=e.organisers.folders.find((e=>e.id===a));if(!i)return[];const c=n.items.find((e=>e.id===a))?.included_lists||[];h.setSublists(i,c),(0,r.insertSublists)(e,n.included_lists_info?.map(S.fromApiSublist));for(const[,t]of e.convos)t.peerId!==d.resolveId()&&o.refresh(e.organisers,t,s);return[]}case"RefetchSpaceCounters_RequestCompleted":{const{response:s}=t;if(e.locks.spacesGetCounters=!1,!s)return[];for(const t of s.items){const s=u.resolveId(t.space_id),n=e.spaces.get(s);n&&(n.unreadCount=t.unread_count)}return[]}case"TemporaryHackForResync":case"LoadChatMembers":case"LoadChatInfo":case"ComposerDraftsUpdateNeeded":return[];default:return(0,k.exhaustivenessCheck)(t)}};function T(e){const t={isDeleted:0,isEdited:1,isPlayed:2,isExpired:3,wasRestored:4,isImportant:5,isUnimportant:6};return(0,k.getFlagValueByBitOffset)(e,t)}function F(e,t,s,u,S){t.convoConn.status="running",t.convoConn.pts=s.pts;const M=s.updates.flatMap((s=>{switch(s[0]){case 10:case 11:case 12:return function(e,t,s){const[n,r,a]=t,i=d.resolveId(r),c=e.convos.get(i);if(!c)return[];const u={10:"unset",11:"replace",12:"set"}[n];return l.updateFlags(c,u,a),o.refresh(e.organisers,c,s),[]}(t,s,e);case 20:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=e.convos.get(a);if(!i)return[];return l.updateSortId(i,{majorSortId:r}),o.refresh(e.organisers,i,s),[]}(t,s,e);case 21:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=e.convos.get(a);if(!i)return[];l.updateSortId(i,{minorSortId:r}),o.refresh(e.organisers,i,s);const c=r<=0,u=e.organisers.filters.messageRequest.totalCount>0;if(c&&u)return[async function(){return{type:"UpdateMessageRequestsCounter",peerId:a}}];return[]}(t,s,e);case 52:return function(e,t,s,n){const[,r,i,c]=t,u=d.resolveId(i),h=e.convos.get(u);if(!h)return[];const m=n?.convos.get(i),g=m&&(0,b.fromApiConvo)(m);switch(r){case a.IEngine.ChatUpdateType.CopyFlagChanged:case a.IEngine.ChatUpdateType.TitleChanged:case a.IEngine.ChatUpdateType.AvatarChanged:case a.IEngine.ChatUpdateType.FlagsChanged:case a.IEngine.ChatUpdateType.BannerChanged:case a.IEngine.ChatUpdateType.DescriptionChanged:return[];case a.IEngine.ChatUpdateType.Pinned:{if("ChatConvo"!==h.kind)return[];const t=c,s=p.resolveCmid(t);if(e.hiddenPinnedMessages.delete(u),g?.convo.kind===h.kind)return g.convo.pinnedMessage&&l.pinMessage(h,g.convo.pinnedMessage),[];if(0===s)l.unpinMessage(h);else{const e=l.findMessageByCmid(h,s);"Normal"===e?.kind&&l.pinMessage(h,p.toPinned(e))}return[]}case a.IEngine.ChatUpdateType.ContactJoined:return[];case a.IEngine.ChatUpdateType.UserJoined:{if("ChatConvo"!==h.kind)return[];const t=d.resolveId(c);if(!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];if(0!==h.members.memberIds.size){const s=v.isAdmin(h.members,e.ownerId)&&!v.isAdmin(h.members,t)||h.ownerId===e.ownerId,n=h.members.members.get(t);if(!n)return[d.isChatPeerId(u)&&async function(){return{type:"LoadChatMembers",peerId:u,memberIds:[t]}}];const r={peerId:t,canKick:s,isMessageRequest:!1,isRestrictedToWrite:n.isRestrictedToWrite};v.addMembers(h.members,[r])}if(t===e.ownerId){if(e.locks.getConversationMembers.add(u),s.vkm_up_drafted_convos_in_list){const t=e.composerDrafts[u];t&&t[t.length-1]&&(l.updateIsDrafted(h,!0),o.refresh(e.organisers,h,s))}return[d.isChatPeerId(u)&&async function(){return{type:"LoadChatMembers",peerId:u}},d.isChatPeerId(u)&&async function(){return{type:"LoadChatInfo",peerId:u}}]}return[]}case a.IEngine.ChatUpdateType.UserLeft:{if("ChatConvo"!==h.kind)return[];const t=d.resolveId(c);return d.isUserPeerId(t)||d.isGroupPeerId(t)?(t===e.ownerId&&l.changeUserState(h,"left"),v.isAdmin(h.members,t)&&v.unsetAdmin(h.members,t),v.removeMember(h.members,t),[]):[]}case a.IEngine.ChatUpdateType.UserKicked:{if("ChatConvo"!==h.kind)return[];const t=d.resolveId(c);if(!d.isUserPeerId(t)&&!d.isGroupPeerId(t))break;t===e.ownerId&&(l.changeUserState(h,"kicked"),l.restrictViewerToWrite(h,"kicked"),l.updateIsDrafted(h,!1),o.refresh(e.organisers,h,s)),v.isAdmin(h.members,t)&&v.unsetAdmin(h.members,t),v.removeMember(h.members,t);break}case a.IEngine.ChatUpdateType.KeyboardChanged:return[];case a.IEngine.ChatUpdateType.CallInProgressChanged:{const e=h.inReadBy,t=h.unreadCount;return[async function({calls:s}){return s?.updateConvoCounter(u,e,t),{type:"Noop"}}]}case a.IEngine.ChatUpdateType.IsNewChange:return l.updateIsNew(h,!!c),[];case a.IEngine.ChatUpdateType.AdminGrated:{const t=d.resolveId(c);if("ChatConvo"!==h.kind||!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];v.setAdmin(h.members,t);const s=v.getMember(h.members,t);return s&&v.addMembers(h.members,[{...s,canKick:h.ownerId===e.ownerId}]),t===e.ownerId&&l.isForbidedWritingForAll(h)&&l.allowViewerToWrite(h),[]}case a.IEngine.ChatUpdateType.AdminKicked:{const t=d.resolveId(c);if("ChatConvo"!==h.kind||!d.isUserPeerId(t)&&!d.isGroupPeerId(t))return[];v.unsetAdmin(h.members,t);const n=v.getMember(h.members,t);return n&&v.addMembers(h.members,[{...n,canKick:v.isAdmin(h.members,e.ownerId)}]),t===e.ownerId&&l.isForbidedWritingForAll(h)&&(l.restrictViewerToWrite(h,"forbid_writing_for_all"),l.updateIsDrafted(h,!1),o.refresh(e.organisers,h,s)),[]}case a.IEngine.ChatUpdateType.ContactConverted:{const t=d.resolveId(c),s=e.convos.get(t),n=e.peers.get(t);return n&&s&&"Contact"===n.kind&&d.isUserPeerId(u)?(d.convertContact(n,u),l.updateSortId(s,{minorSortId:0}),[]):[]}case a.IEngine.ChatUpdateType.ShortPollReactionsChanged:return"ChatConvo"!==h.kind||(h.shouldShortPollReactions=Boolean(c)),[];case a.IEngine.ChatUpdateType.IncognitoJoined:{if("ChatConvo"!==h.kind)return[];const t=v.resolveIncognitoMemberId(c),s=v.getIncognitoMember(h.members,t);if(!s?.memberId)return[];const n=d.resolveId(s.memberId);if(!d.isUserPeerId(n)&&!d.isContactPeerId(n))return[];const r={peerId:n,isRestrictedToWrite:!!h.members.members?.get(n)?.isRestrictedToWrite,canKick:v.isAdmin(h.members,e.viewer.id)||e.viewer.id===s.inviterId,isMessageRequest:!1,joinDate:1e3*s.inviteDate};return v.addMembers(h.members,[r]),[]}case a.IEngine.ChatUpdateType.ConvertIncognito:case a.IEngine.ChatUpdateType.IncognitoLeft:{if("ChatConvo"!==h.kind)return[];const e=v.resolveIncognitoMemberId(c),t=v.getIncognitoMember(h.members,e);return t?.memberId&&v.removeMember(h.members,t.memberId),v.removeIncognitoMember(h.members,e),[]}case a.IEngine.ChatUpdateType.StyleChanged:return g?.convo&&(h.styleId=g.convo.styleId),[];case a.IEngine.ChatUpdateType.BusinessNotifyDataChanged:case a.IEngine.ChatUpdateType.MessageRequestChanged:case a.IEngine.ChatUpdateType.MessageRequestAccepted:case a.IEngine.ChatUpdateType.MessageRequestCanceled:case a.IEngine.ChatUpdateType.MessageRequestRejected:case a.IEngine.ChatUpdateType.DonSubscribed:case a.IEngine.ChatUpdateType.DonUnsubscribed:return[];default:}return[]}(t,s,e,S);case 63:case 64:case 65:case 66:case 67:case 68:return function(e,t){const[s,n,r,,a]=t,i=new Set(r.map((e=>d.resolveId(e))));if(i.delete(e.viewer.id),!i.size)return[];const o=d.resolveId(n),c=e.convos.get(o);if(!c)return[];const l={63:"text",64:"voice",65:"photo",66:"video",67:"file",68:"videomessage"}[s],u={...e.typings.get(o)||{},[l]:{peerIds:i,updatedAt:a}};return e.typings.set(o,u),[async function(){return await(0,k.sleep)(I.TYPING_EXPIRATION_TIME),{type:"EngineBatchReceived_TypingsTimedOut",peerId:o,typingType:l,timestamp:a}}]}(t,s);case 80:return function(e,t){const[,s,n,r,a,,i,o,,d]=t;return c.updateCounters(e.organisers.filters,{unread:s,headerNotMutedUnread:i,unreadUnmuted:n,archive:o,archiveMentions:d,businessNotify:a}),e.viewer.settings.countOnlyNotMuted=Boolean(r),[async function({notification:e}){return e.setCounters({unread:s,unreadUnmuted:n,showOnlyNotMuted:Boolean(r)}),e.notifyListeners({kind:"counter",payload:n}),e.setIdleCounter(i),{type:"Noop"}}]}(t,s);case 91:return function(e,t,s,n){const[,r,a,i,c]=t,u=e.convos.get(d.resolveId(a));if(!u||"ChatConvo"!==u.kind)return[];const p=d.resolveId(i);switch(r){case 1:case 2:if(p===e.viewer.id){const t=c?s+1e3*c:void 0;l.restrictViewerToWrite(u,"restricted_to_write_in_chat",t),l.updateIsDrafted(u,!1),o.refresh(e.organisers,u,n)}v.restrictMemberToWrite(u.members,p);break;case 3:if(p===e.viewer.id&&(l.allowViewerToWrite(u),n.vkm_up_drafted_convos_in_list)){const t=e.composerDrafts[u.peerId];t&&t[t.length-1]&&(l.updateIsDrafted(u,!0),o.refresh(e.organisers,u,n))}v.allowMemberToWrite(u.members,p);break;default:(0,k.exhaustivenessCheck)(r)}return[]}(t,s,u,e);case 114:return function(e,t){const[,{peer_id:s}]=t,n=d.resolveId(s),r=e.convos.get(n);if(!r)return[];const a=(0,b.fromLongpollPushSettings)(t);return l.updatePush(r,a),[]}(t,s);case 115:return function(e,t){const[,s]=t,{browserNotifications:n}=e.viewer.settings;return[async function({calls:e,notification:t}){if(!e)return{type:"Noop"};if(e.showIncomingCall(s),!n)return{type:"Noop"};const r=d.resolveId(s.from_id);let a,i="";return s.caller_info&&(i=`${s.caller_info.first_name} ${s.caller_info.last_name}`,a=s.caller_info.photo_400),s.chat_info&&(i=s.chat_info.title,a=s.chat_info.photo_400),t.notify({kind:"call",peerId:r,caller:i,image:a},r),{type:"Noop"}}]}(t,s);case 119:return function(e,t){const[,s]=t,n=d.resolveId(s.peer_id),r=d.resolveId(s.owner_id),a=e.convos.get(n),i=e.peers.get(n),o=e.peers.get(r),c=a&&i&&o?(0,w.fromApiMessageEvent)(i,o,s):void 0;return e.botKeyboardEvent=c,[]}(t,s);case 10501:return function(e,t){return(0,r.insertFolders)(e,[(0,R.fromEngineFolder)(t)]),[]}(t,s);case 10502:return function(e,t,s){const[,n]=t,r=h.resolveId(n);if(h.deleteFolder(e.organisers.folders,r),!s.vkm_new_convo_folder_logic)for(const t of e.convos.values())l.removeFolder(t,r);return[]}(t,s,e);case 10503:return function(e,t){const[,s,n]=t,r=h.resolveId(s),a=e.organisers.folders.find((e=>e.id===r));if(!a)return[];return h.setName(a,n),[]}(t,s);case 10504:return function(e,t,s){const[,n,...a]=t,i=h.resolveId(n),o=(0,r.getConvosByIds)(e,a),c=e.organisers.folders.find((e=>e.id===i));if(!c)return[];return(0,r.addConvosToFolder)(e,i,o,s),[]}(t,s,e);case 10505:return function(e,t,s){const[,n,...a]=t,i=h.resolveId(n),o=(0,r.getConvosByIds)(e,a),c=e.organisers.folders.find((e=>e.id===i));if(!c)return[];return(0,r.removeConvosFromFolder)(e,i,o,s),[]}(t,s,e);case 10506:return function(e,t){const[,...s]=t;return h.reorderFolders(e.organisers.folders,s.map((e=>h.resolveId(e)))),[]}(t,s);case 10507:return function(e,t){const[,...s]=t;for(const t of s){if(t.length<3)continue;const s=h.resolveId(t[0]);h.setUnreadCounters(e.organisers.folders,s,t[1],t[2])}return[]}(t,s);case 10508:return function(e,t){const[,s]=t,n=h.resolveId(s),r=e.organisers.folders.find((e=>e.id===n));if(!r)return[];return h.replaceFolder(e.organisers.folders,(0,R.fromApiFolder)({id:n,name:r.name,type:r.type,flags:h.convertFlags({type:r.type,hasSublist:r.hasSublist})})),[]}(t,s);case 10509:return function(e,t,s){const[,n,r]=t,a=h.resolveId(n),i=e.organisers.folders.find((e=>e.id===a));if(i){if(h.updateFlags(i,r),!s.me_channels&&"channels"===i.type)return h.deleteFolder(e.organisers.folders,i.id),[];if("managed_groups"===i.type)return h.deleteFolder(e.organisers.folders,i.id),[];if(i.hasSublist&&s.vkm_sublists_in_folder&&s.vkm_new_convo_folder_logic)return[async function({api:e}){try{return{type:"RefetchFoldersRequest_RequestCompleted",apiFolders:await e.fetch("messages.getFolders",{with_peers:1,supported_types:h.getSupportedTypes(s)}),folderId:a}}catch{return{type:"Noop"}}}]}return[]}(t,s,e);case 601:return function(e,t,s){const[,r,a,o]=t,c=d.resolveId(a),u=p.resolveCmid(o);let h,m=0,g=[];switch(r){case 1:{const[,,,,e,s,...n]=t;m=s,g=n,h=f.resolveId(e);break}case 2:case 3:case 4:{const[,,,,e,...s]=t;m=e,g=s;break}default:return[]}const C=[];let v=0;for(let e=0;e<m;e++){const e=g[v];if(!e)return[];const t=g.slice(v+1,v+1+e);v+=1+e;const[s,n,r]=t.slice(0,3);if(void 0===s||void 0===n||void 0===r)return[];const a=t.slice(3,3+r).map(d.resolveId).sort(((e,t)=>e-t));C.push({reactionId:f.resolveId(s),count:n,peerIds:new Set(a)})}const y=e.convos.get(c);if(!y)return[];let _,k,I=0,b=[];if(2===r||4===r){I=g[v]??0;const e=v+1,t=e+Math.min(3,I??0);b=g.slice(e,t).map((e=>d.resolveId(e))),_=g[t]?f.resolveId(g[t]):void 0}k=l.findMessageByCmid(y,u),"Normal"===k?.kind&&(1!==r&&3!==r||p.setCurrentUserReaction(k,h),p.setReactions(k,C));if(k)k=(0,n.isDraft)(k)?(0,n.current)(k):k;else{const e=s?.messagesByPeerId.get(c)?.get(u);if(k=e&&(0,i.fromApiMessage)(e).message,!k)return[]}const w=`${c}-${u}`,S=e.messageReactedPeers.get(w)??new Set;let R=[];switch(r){case 2:R=b.filter((e=>!S.has(e))),e.messageReactedPeers.set(w,new Set([...S,...R]));break;case 4:const t=new Set([...S].filter((e=>!b.includes(e))));if(0===t.size){e.messageReactedPeers.delete(w);break}e.messageReactedPeers.set(w,t)}if(e.messageReactedPeers.size>U){const t=e.messageReactedPeers.keys(),s=e.messageReactedPeers.size-U;for(let n=0;n<s;n++)e.messageReactedPeers.delete(t.next().value)}const M=R.map((t=>{const s=e.peers.get(d.resolveId(t));return((0,n.isDraft)(s)?(0,n.current)(s):s)??null})).filter((e=>null!==e)),E=!l.isMuted(y)&&e.viewer.settings.push.messageReaction.isEnabled,P=C.some((t=>!e.messageReactionsConfig.assets.has(t.reactionId)));_&&l.setUnreadReaction(y,u,_);return[async function({notification:e}){if("Normal"!==k?.kind)return{type:"Noop"};const t=k.sentAt<Date.now()-A.Time.HalfDay,s=[...k.reactions.values()].reduce(((e,t)=>e+t.count),0);return E&&k.isOut&&2===r&&!t&&s<8&&I>0&&e.notify({kind:"reaction",message:k,reactedPeers:M,reactedCount:I}),{type:"Noop"}},P&&async function(){return{type:"InvalidateMessageReactions",force:!0}}]}(t,s,S);case 602:return function(e,t){const[,s,...n]=t,r=d.resolveId(s),a=e.convos.get(r);if(!a)return[];const i=n[0];if(void 0===i)return[];const o=n.slice(1,i+1).map(p.resolveCmid);return l.replaceUnreadReactions(a,o),[]}(t,s);case 603:return function(e,t,s){if(!s.vkm_edu_precreated_convos)return[];const[,n]=t;switch(n){case 0:{const[,,,...s]=t;s.forEach((t=>{e.precreatedConvos.peerIds.delete(t)}));break}case 1:{const[,,,...s]=t;s.forEach((t=>{e.precreatedConvos.peerIds.add(t)}));break}case 2:e.precreatedConvos={peerIds:new Set,hasMore:!0};break;default:(0,k.exhaustivenessCheck)(n)}return[]}(t,s,e);case 604:return function(e,t,s){const[,n,r]=t;if(!s.vkm_edu_integration_banner)return[];if(r===I.EDU_INTEGRATION_BANNER_ID)e.eduIntegrationBanner.isEnabled=1===n;else(0,k.exhaustivenessCheck)(r);return[]}(t,s,e);case 701:return function(e,t,s){const[,n]=t,r=d.resolveId(n),a=e.convos.get(r);if(!a)return[];if("ChatConvo"!==a.kind)return[];return a.isDeleted=!0,l.updateIsDrafted(a,!1),o.refresh(e.organisers,a,s),[]}(t,s,e);case 10001:case 10002:case 10003:return function(e,t,s){const[n,r,a,o]=t,c=p.resolveCmid(r),u=d.resolveId(o),h=e.convos.get(u);if(!h)return[];const m=p.convertFlags(a);if(10003===n){const{isDeleted:e,isSpam:t}=m;if((e||t)&&r){const e=s?.messagesByPeerId.get(o)?.get(r);if(e){const t=(0,i.fromApiMessage)(e);l.restoreMessage(h,t.message,t.mentions.hasDirect||t.mentions.hasMass)}}}const g={10001:"replace",10002:"set",10003:"unset"}[n],{status:f}=l.findHistoryNodeByCmid(h,c);if("NotLoaded"===f)return[];return l.updateMessageFlags(h,c,g,a),[async()=>{if(10002!==n)return{type:"Noop"};const{isDeleted:e,isDeletedForAll:t}=m;return e||t?{type:"ComposerDraftsUpdateNeeded",peerId:u,foreignKind:"message",itemsToDelete:[{peerId:u,cmid:c}]}:{type:"Noop"}}]}(t,s,S);case 10004:case 10005:case 10018:case 10019:return function(e,t,s,n){const[,c]=t;let u;switch(t[0]){case 10004:u=t[4];break;case 10005:case 10018:u=t[3];break;case 10019:u=t[2];break;default:(0,k.exhaustivenessCheck)(t)}const h=d.resolveId(u),f=e.convos.get(h);if(!f)return[];const C=n?.messagesByPeerId.get(u)?.get(c);let v,I,b;if(C){const e=(0,i.fromApiMessage)(C);v=e.message,I=e.mentions;const t=n?.convos.get(h)?.current_keyboard;if(t){const e=(0,w.fromApiKeyboard)(t,h);if("InputKeyboard"===e.kind){JSON.stringify(f.currentKeyboard)!==JSON.stringify(e)&&(b={kind:"InputKeyboardUpsertEvent",keyboard:e})}}else b={kind:"InputKeyboardDeleteEvent"}}else{if(a.IEngine.isIncompleteUpdate(t)||10019===t[0])return[];const s=(0,i.fromEngineMessage)(t,e.ownerId,L(f));v=s.message,I=s.mentions,b=s.keyboardEvent}if(C&&!a.IEngine.isIncompleteUpdate(t)&&10019!==t[0]){I=(0,i.fromEngineMessage)(t,e.ownerId,L(f)).mentions}switch(t[0]){case 10004:{const n=e.typings.get(f.peerId);if(n)for(const t of r.TypingVariants){const s=n[t];s&&s.peerIds.has(v.authorId)&&(s.peerIds.delete(v.authorId),0===s.peerIds.size&&delete n[t],0===Object.keys(n).length&&e.typings.delete(f.peerId))}const a=t[3],i=I.hasDirect||I.hasMass;if(i&&k.isDev){if(f.inReadBy>=v.cmid)throw new Error(`Peer: ${f.peerId} получено сообщение с меншеном со cmid: ${v.cmid} и границей прочитанности: ${f.inReadBy}`);if(v.isOut)throw new Error(`Peer: ${f.peerId} получен меншен в исходящем сообщении`)}"ChatConvo"===f.kind?l.appendMessage(f,v,a,i,b):l.appendMessage(f,v,a,!1,b),o.refresh(e.organisers,f,s),e.locks.convosCleanup.has(f.peerId)||l.cleanup(f),"InputKeyboardUpsertEvent"===b?.kind&&e.hiddenBotKeyboards.delete(f.peerId);const c=p.convertFlags(t[2]),u=l.isMessageUnread(f,v);"Normal"!==v.kind||v.isOut||!v.attaches.sticker||!g.isPopupSticker(v.attaches.sticker)||f.isStickersPopupAutoplayDisabledByAdmin||f.isStickersPopupAutoplayDisabledByUser||(0,_.isPopupAutoplayOnGetOff)()||m.toggleStickerIsPopupAutoplayed(v,!1);const{browserNotifications:C,soundNotifications:w,push:S}=e.viewer.settings;let R=null;switch(f.kind){case"UserConvo":R=S.userConvo;break;case"ChatConvo":R=S.chatConvo;break;case"GroupConvo":R=S.groupConvo}const M=!v.isOut&&!c.noPush&&u;let E=M&&C&&R?.isEnabled;const A=M&&(!l.isMuted(f)||i),U=M&&w&&!v.isSilent&&!l.isMuted(f);E&&(E="nothing"!==f.push.mode&&"nothing"!==S.mention&&("direct-mention"===f.push.mode||"direct-mention"===S.mention?!l.isMuted(f)||I.hasDirect:!l.isMuted(f)||i));const P=d.isMarusia(h)&&"Normal"===v.kind&&{type:"add_message",payload:{randomId:Number(v.randomId),text:p.toRawText(v),isOutbound:v.isOut,local:!1,payload:t[7]?.payload,attachIds:m.ids(v.attaches)}},T=f.unreadCount,F=f.inReadBy;return"Service"!==v.kind||"conversation_style_update"!==v.action.type&&"conversation_style_update_action"!==v.action.type||(f.styleId=y.resolveStyleId(v.action.styleId||"system")),[async function({notification:e}){return E&&e.notify({kind:"message",message:v},h),A&&e.notifyListeners({kind:"message"}),U&&e.playSound(),{type:"Noop"}},"ChatConvo"===f.kind&&f.activeCall&&async function({calls:e}){return e?.updateConvoCounter(h,F,T),{type:"Noop"}},P&&async function({marusia:e}){return e?.handleAction(P),{type:"Noop"}}]}case 10005:case 10018:case 10019:return l.replaceMessage(f,v,I.hasDirect||I.hasMass),"Expired"===v.kind&&l.replaceExpiredReplies(f,v.cmid),[async()=>({type:"ComposerDraftsUpdateNeeded",peerId:h,foreignKind:"message",itemsToDelete:"Expired"===v.kind?[{peerId:h,cmid:v.cmid}]:void 0,itemsToReplace:"Normal"===v.kind?[v]:void 0})];default:return(0,k.exhaustivenessCheck)(t)}}(t,s,e,S);case 10006:case 10007:return function(e,t,s){const[n,r,a,i]=t,c=d.resolveId(r),u=p.resolveCmid(a),h=e.convos.get(c);if(!h)return[];10006===n?(l.readInUntil(h,u,i),d.isFavorites(h.peerId,e.ownerId)&&l.readOutUntil(h,u)):l.readOutUntil(h,u);return o.refresh(e.organisers,h,s),[10006===n&&"ChatConvo"===h.kind&&h.activeCall&&async function({calls:e}){return e?.updateConvoCounter(c,a,i),{type:"Noop"}},10006===n&&async function({notification:e}){return e.removeNotification(c,u),{type:"Noop"}}]}(t,s,e);case 10013:return function(e,t,s){const[,n,r]=t,a=d.resolveId(n),i=p.resolveCmid(r),o=e.convos.get(a);if(!o)return[];if(C.lastCmid(o.history)!==i)return[];const c=s?.convos.get(n);if(!c||!(0,b.fromApiConvo)(c))return[async function({logger:e}){return e.error("[EngineBatchReceived]",new Error(`В ${t[0]} отсутствует дозагруженная беседа`)),{type:"Noop"}}];return[]}(t,s,S);case 80005:return e.vkm_prds?function(e,t){return[D(e)]}(t):[];default:return[]}}));return[N(),...M]}function N(){const e=Date.now();return async function({engine:t,perfStats:s}){const n=await t.poll();if("Failure"===n.kind)return{type:"EngineBatchReceived",variant:{kind:"FromEngineFailure",now:e}};const r=function(e,t){if(void 0===t||e.updates.length>10)return;const s=e.updates.filter((e=>10004===e[0]));if(0!==s.length)return{time:t.getCurrentTime(),updates:s};return}(n,s);return{type:"EngineBatchReceived",variant:{kind:"FromEngineBatch",next:n,receivedMessagesStats:r,now:e}}}}function x(e){return async function({perfStats:t}){if(void 0===t||void 0===e)return{type:"Noop"};const{time:s,updates:n}=e,r=n.reduce(((e,t)=>(10004===t[0]&&e.push(d.resolveId(t[4])),e)),[]);void 0!==t.getEvent(E.IPerfStats.EventType.receiveMessage)?.data.LP&&t.removeEvent(E.IPerfStats.EventType.receiveMessage);const a=t.getEvent(E.IPerfStats.EventType.receiveMessage),i={LPMessagesCount:r.length,LP:s};if(void 0===a)return t.addEvent(E.IPerfStats.EventType.receiveMessage,{peerIds:r,data:i}),{type:"Noop"};const o=a.peerIds[0];return o&&r.includes(d.resolveId(o))&&t.addEventData(E.IPerfStats.EventType.receiveMessage,i),{type:"Noop"}}}function q(e,t,s,{cmidsByPeerId:n,convoPeerIds:a,userPeerIds:i,groupPeerIds:o,contactPeerIds:c}){return async function({api:l,logger:u,engine:p}){let h;try{h=await l.fetchMany([n.size>0&&{method:"messages.getDiffContent",params:{conversation_messages:JSON.stringify(Array.from(n).map((([e,t])=>({peer_id:e,updated_cmids:Array.from(t)})))),extended:1,group_id:(0,r.getOwnerGroupId)(t)}},a.size>0&&{method:"messages.getConversationsById",params:{peer_ids:Array.from(a).join(","),group_id:(0,r.getOwnerGroupId)(t),extended:1,with_last_messages:1}},i.size>0&&{method:"users.get",params:{user_ids:Array.from(i).map(d.toRealId).join(",")}},o.size>0&&{method:"groups.getById",params:{group_ids:Array.from(o).map(d.toRealId).join(",")}},c.size>0&&{method:"messages.getContactsById",params:{contact_ids:Array.from(c).map(d.toRealId).join(",")}}],{retries:1/0})}catch(e){return u.error("[fetchMissingData]",e),{type:"EngineBatchReceived",variant:{kind:"FromEngineMissingDataFailed",now:s}}}const[m,g,f,C,v]=h,y=[...m?.items.reduce(((e,{requested_messages:t})=>[...e,...t??[]]),[])??[]],_=new Map;for(const e of y){let t=_.get(e.peer_id);t||(t=new Set,_.set(e.peer_id,t)),t.add(e.conversation_message_id)}if(n.size!==_.size||Array.from(n.entries()).some((([e,t])=>{const s=_.get(e);return!s||(t.size!==s.size||[...t].some((e=>!s.has(e))))})))return p.disconnect(),u.error("fetchMissingData: getDiffContent не вернул сообщения"),{type:"EngineBatchReceived",variant:{kind:"FromEngineMissingDataFailed",now:s}};const k=[...y,...g?.last_messages??[]],I=[...f??[],...m?.profiles??[],...g?.profiles??[]],b=[...C?.groups??[],...m?.groups??[],...g?.groups??[]],w=[...v??[],...m?.contacts??[],...g?.contacts??[]];return{type:"EngineBatchReceived",variant:{kind:"FromEngineWithMissingData",apiConvos:g?.items??[],apiMessages:k,apiUsers:I,apiGroups:b,apiContacts:w,skippedBatch:e,apiIncognitoMembers:[],now:s}}}}function O(e,t,s,n){return async function({api:a,engine:i,queue:o}){let c;try{c=await a.fetch("messages.getLongPollHistory",{pts:e,lp_version:i.version,msgs_limit:1100,events_limit:1100,last_n:1e3,extended:1,group_id:(0,r.getOwnerGroupId)(s)},{retries:1/0})}catch{return{type:"Noop"}}return e<(c.from_pts||0)?(o.disconnect(),{type:"TemporaryHackForResync"}):{type:"EngineBatchReceived",variant:{kind:"FromEngineWithMissingData",apiConvos:c.conversations||[],apiMessages:c.messages?.items||[],apiUsers:c.profiles||[],apiGroups:c.groups||[],skippedBatch:t,apiContacts:c.contacts||[],apiIncognitoMembers:c.incognito_members||[],now:n}}}}function D(e){if(e.locks.spacesGetCounters)return null;e.locks.spacesGetCounters=!0;const t=Array.from(e.spaces.keys());return async function({api:e}){try{return{type:"RefetchSpaceCounters_RequestCompleted",response:await e.fetch("spaces.getCounters",{space_ids:t.join(",")},{retries:1/0})}}catch{return{type:"RefetchSpaceCounters_RequestCompleted"}}}}function B(e,t){const s=new Map;for(const t of e){let e=s.get(t.peer_id);e||(e=new Map,s.set(t.peer_id,e)),e.set(t.conversation_message_id,t)}return{messagesByPeerId:s,convos:new Map(t.map((e=>[e.peer.id,e])))}}function L(e){return function(t){const s=l.findMessageByCmid(e,t);return"Normal"===s?.kind?s:void 0}}function G(e,t,s){if(e.fwd&&!e.reply)return!0;if(e.reply){const t=JSON.parse(e.reply);if(!s(p.resolveCmid(t.conversation_message_id)))return!0}if(e.geo)return!0;if(t.has_template)return!0;if(e.attachments&&e.attach1_type&&!e.attach2_type)try{const t=JSON.parse(e.attachments);if(Array.isArray(t)&&t[0].type===e.attach1_type)return!1}catch{return!0}return!!e.attach1_type}},642469:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(777211);const r=(e,t)=>((0,n.insertPeers)(e,{apiUsers:t.profile?[t.profile]:[],apiContacts:[t.contact],apiGroups:[]},{dangerouslyOverwrite:!0}),(0,n.insertContacts)(e,[t.contact]),[])},322768:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(401193),r=s(157570),a=s(183130),i=s(399332);const o=(e,t,s)=>{switch(t.type){case"InvalidateMessageReactions":{const{force:n}=t;return e.locks.invalidateMessageReactions?[]:(e.locks.invalidateMessageReactions=!0,[async function({api:e,storage:t}){try{const r=await async function({api:e,storage:t,cacheLifetime:s,force:n=!1}){const r=t.get("message-reactions-assets"),a=t.get("channel-reactions-mapping"),i=Date.now(),o=!r||r.expiresAt<i||!r.response.reaction_ids||n,c=!a||a.expiresAt<i||n;let d=r?.response||null,l=a?.response||null;try{const[n,r]=await e.fetchMany([o&&{method:"messages.getReactionsAssets",params:{}},c&&{method:"channels.getReactionsMapping",params:{}}],{retries:3});n&&(d=n,t.set("message-reactions-assets",{response:d,expiresAt:i+s})),r&&(l=r,t.set("channel-reactions-mapping",{response:l,expiresAt:i+s}))}catch{}if(!d||!l)return;return{reactionsAssetsResponse:d,reactionsMappingResponse:l}}({api:e,storage:t,cacheLifetime:s.vkm_reactions_sync_time||i.Time.Day,force:Boolean(n)});return{type:"InvalidateMessageReactions_RequestCompleted",response:r}}catch{return{type:"InvalidateMessageReactions_RequestCompleted"}}}])}case"InvalidateMessageReactions_RequestCompleted":{const{response:s}=t;if(e.locks.invalidateMessageReactions=!1,!s)return[];const{reactionsAssetsResponse:n,reactionsMappingResponse:i}=s,o=new Set(n.reaction_ids.map((e=>r.resolveId(e)))),c=n.assets.reduce(((e,t)=>{const s=n.override_assets?.find((e=>e.reaction_id===t.reaction_id))??t;return e.set(r.resolveId(s.reaction_id),(0,a.fromApiReaction)(s)),e}),new Map);e.messageReactionsConfig={assets:c,allowedIds:o};const d=new Map(i.mapping.map((({channel_reaction_id:e,message_reaction_id:t})=>[t,e])));return e.postReactions=n.assets.reduce(((e,t)=>{if(d.has(t.reaction_id)){const s=n.override_assets?.find((e=>e.reaction_id===t.reaction_id))??t;e.set(r.resolveId(d.get(t.reaction_id)),{id:r.resolveId(d.get(t.reaction_id)),image:s.links.static,animationSmall:s.links.small_animation,animationBig:s.links.big_animation,name:""})}return e}),new Map),[]}default:(0,n.exhaustivenessCheck)(t)}}},320198:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(856562),a=s(358096),i=s(777211),o=s(872466);const c=(e,t)=>{switch(t.type){case"LoadChatInfo":{const{peerId:s}=t,n=(0,i.getOwnerGroupId)(e.ownerId);return e.locks.getConversationInfo.has(s)?[]:(e.locks.getConversationInfo.add(s),[async function({api:e}){try{const t=await e.fetch("messages.getConversationsById",{peer_ids:s.toString(),group_id:n,extended:0});return{type:"LoadChatInfo_RequestComplete",peerId:s,convo:t.items[0],hasFailed:!t.items[0]}}catch{return{type:"LoadChatInfo_RequestComplete",peerId:s,hasFailed:!0}}}])}case"LoadChatInfo_RequestComplete":{const{peerId:s,convo:n,hasFailed:i}=t;e.locks.getConversationInfo.delete(s);const c=e.convos.get(s);if("ChatConvo"!==c?.kind||i||!n)return[];const d=(0,o.fromApiConvo)(n);return"ChatConvo"!==d?.convo.kind||(r.updateAcl(c,{...d.convo.acl}),a.setCount(c.members,d.convo.members.count)),[]}default:(0,n.exhaustivenessCheck)(t)}}},338911:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(358096),a=s(777211);const i=(e,t)=>{switch(t.type){case"LoadChatMembers":{const{peerId:s,offset:n,memberIds:r}=t,i=(0,a.getOwnerGroupId)(e.ownerId),o=e.convos.get(s),c="ChatConvo"!==o?.kind?void 0:o.members.count,d=!!r?.length;return[async function({api:e}){try{return{type:"LoadChatMembers_RequestComplete",peerId:s,response:await e.fetch("messages.getConversationMembers",{peer_id:s,extended:1,group_id:i,count:1e3,offset:n||c,member_ids:r&&r.join(",")},{retries:1}),partialLoading:d,hasFailed:!1}}catch{return{type:"LoadChatMembers_RequestComplete",peerId:s,partialLoading:d,hasFailed:!0}}}]}case"LoadChatMembers_RequestComplete":{const{peerId:s,response:n,partialLoading:i,hasFailed:o}=t;e.locks.getConversationMembers.delete(s);const c=e.convos.get(s);return"ChatConvo"!==c?.kind||o||!n?[]:((0,a.insertChatMembers)(c.members,n.items,n.incognito_members),(0,a.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]}),i?r.setCount(c.members,c.members.members.size+c.members.incognitoMembers.size):r.setCount(c.members,n.count),(c.members.count||0)<n.count?[async function(){return{type:"LoadChatMembers",peerId:s}}]:[])}default:(0,n.exhaustivenessCheck)(t)}}},851147:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t)=>{switch(t.type){case"LoadCommentGroups":return e.locks.loadCommentGroups?[]:(e.locks.loadCommentGroups=!0,[async function({api:e}){try{return{type:"LoadCommentGroups_RequestComplete",response:await e.fetch("account.getCommentGroups",{},{retries:3})}}catch{return{type:"LoadCommentGroups_RequestComplete"}}}]);case"LoadCommentGroups_RequestComplete":{const{response:s}=t;if(e.locks.loadCommentGroups=!1,!s)return[];const{insertedGroups:n}=(0,r.insertPeers)(e,{apiUsers:[],apiGroups:s.items,apiContacts:[]});return e.commentGroups={ids:n.reduce(((e,t)=>(e.add(t.id),e)),new Set),isReady:!0},[]}default:(0,n.exhaustivenessCheck)(t)}}},369466:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t)=>{switch(t.type){case"LoadContactList":return e.locks.contactList?[]:(e.locks.contactList=!0,[async function({api:e}){try{const s=await e.fetch("account.getContactList",{extended:1,offset:t.offset},{retries:1});return{type:"LoadContactList_RequestCompleted",contacts:s.contacts||[],profiles:s.profiles||[],items:s.items||[]}}catch(e){return{type:"LoadContactList_RequestCompleted",contacts:[],profiles:[],items:[]}}}]);case"LoadContactList_RequestCompleted":return e.locks.contactList=!1,(0,r.insertContacts)(e,t.contacts),(0,r.insertContactItems)(e,t.items,t.profiles),e.contacts.hasMore=!1,[];default:(0,n.exhaustivenessCheck)(t)}}},6016:(e,t,s)=>{"use strict";s.d(t,{getImportantMessageKey:()=>o,handler:()=>i});var n=s(401193),r=s(946990),a=s(777211);const i=(e,t,s)=>{switch(t.type){case"LoadImportantMessages":{const t=20*Math.floor(e.importantMessages.messages.size/20),s=e.ownerId;return[async function({api:e}){try{return{type:"LoadImportantMessages_RequestCompleted",hasFailed:!1,response:await e.fetch("messages.getImportantMessages",{count:20,offset:t,extended:1,group_id:(0,a.getOwnerGroupId)(s)})}}catch(e){return{type:"Noop"}}}]}case"LoadImportantMessages_RequestCompleted":{const{response:{messages:n,profiles:i,groups:c,conversations:d}}=t;return(n.items?.length||0)<20&&(e.importantMessages.hasMore=!1),(0,a.insertConvos)(e,d||[],s),(0,a.insertPeers)(e,{apiUsers:i||[],apiGroups:c||[],apiContacts:[]}),n.items?.forEach((t=>{const{message:s}=(0,r.fromApiMessage)(t);"Normal"===s.kind&&e.importantMessages.messages.set(o(s.peerId,s.cmid),s)})),[]}case"UserClosedImportantMessages":return e.importantMessages.messages.clear(),e.importantMessages.hasMore=!0,[];default:return(0,n.exhaustivenessCheck)(t)}},o=(e,t)=>`${e}-${t}`},799516:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(728921),a=s(777211);const i=(e,t,s)=>{switch(t.type){case"LoadRecommendedFolders":return e.locks.loadRecommendedFolders||e.organisers.recommendedFolders.length?[]:(e.locks.loadRecommendedFolders=!0,[async function({api:e}){try{return{type:"LoadRecommendedFolders_RequestComplete",recommendedFolders:(await e.fetch("messages.getRecommendedFolders",{supported_types:r.getSupportedTypes(s)})).items||[],hasFailed:!1}}catch{return{type:"LoadRecommendedFolders_RequestComplete",recommendedFolders:[],hasFailed:!0}}}]);case"LoadRecommendedFolders_RequestComplete":{const{recommendedFolders:s,hasFailed:n}=t;return e.locks.loadRecommendedFolders=n,(0,a.insertRecommendedFolders)(e,s||[]),[]}default:(0,n.exhaustivenessCheck)(t)}}},431773:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(843779),r=s(401193),a=s(726356);const i=(e,t)=>{const{type:s}=t;switch(s){case"LoadStickersSettingsFromApi":return e.locks.loadStickersSettings?[]:(e.locks.loadStickersSettings=!0,[async function({api:e}){try{return{type:"LoadStickersSettingsFromApi_RequestCompleted",response:await e.fetch("stickers.getSettings",{},{retries:2})}}catch{return{type:"Noop"}}}]);case"LoadStickersSettingsFromApi_RequestCompleted":{const{response:s}=t;e.locks.loadStickersSettings=!1;try{s.settings&&(n.updateIsStickersAnimationEnabled(e.viewer,s.settings.animation_autoplay),(0,a.updateSettingsCache)({popupAutoplayOnGet:Boolean(s.settings.popup?.autoplay.on_get),popupAutoplayOnSend:Boolean(s.settings.popup?.autoplay.on_send),popupDisabledPeerIds:s.settings.popup?.autoplay.disabled_peer_ids??[],animationAutoplay:s.settings.animation_autoplay}))}catch{}return[]}case"ChangeStickersSettings":{const{setting:s,value:a}=t;let i,o;if("isStickersAnimationEnabled"===s)i=e.viewer.settings[s],n.updateIsStickersAnimationEnabled(e.viewer,a),o={name:"animation_autoplay",value:a?1:0};else(0,r.exhaustivenessCheck)(s);return[async function({api:e}){try{const t=await e.fetch("stickers.setSettings",o,{retries:2});return{type:"ChangeStickersSettings_RequestCompleted",setting:s,isFailed:void 0===t.settings,prevValue:i}}catch{return{type:"ChangeStickersSettings_RequestCompleted",setting:s,isFailed:!0,prevValue:i}}}]}case"ChangeStickersSettings_RequestCompleted":{const{setting:s,prevValue:a,isFailed:i}=t;if(i){if("isStickersAnimationEnabled"===s)n.updateIsStickersAnimationEnabled(e.viewer,a);else(0,r.exhaustivenessCheck)(s);return[]}if("isStickersAnimationEnabled"===s)e.forceStickersReload=!0;else(0,r.exhaustivenessCheck)(s);return[]}default:(0,r.exhaustivenessCheck)(s)}}},857612:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(777211),r=s(73514),a=s(241503),i=s(401193);const o=(e,t)=>{switch(t.type){case"MoreChannelsNeeded":{const{organiser:s}=t,{filter:n}=s,i=a.getLockId(n);if(e.locks.getChannels[i]||!e.organisers.channelFilters[n].hasMore)return[];const{minorSortId:o,channelId:c}=e.organisers.channelFilters[n].boundary;e.locks.getChannels[i]=!0;const d=r.CHANNELS_PER_PAGE+1,l=a.isLoaded(e.organisers.channelFilters[n])?o:void 0;return[async function({api:e}){try{const n=await e.fetch("channels.get",{count:d,offset_minor_sort_id:l,offset_channel_id:c,filter:a.snakeCaseId(s.filter),extended:1},{retries:3});return{...t,type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!1,response:n,hasMore:(n.items?.length||0)>=d}}catch(e){return{...t,type:"MoreChannelsNeeded_RequestCompleted",hasFailed:!0,hasMore:!1}}}]}case"MoreChannelsNeeded_RequestCompleted":{const{hasFailed:s,organiser:r,hasMore:o}=t;let c="";if("channelFilters"===r.kind)c=a.getLockId(r.filter);else(0,i.exhaustivenessCheck)(r.kind);if(e.locks.getChannels[c]=!1,s)return[];const{response:d}=t;if(d){const t=(0,n.insertChannels)(e,{apiChannels:d.items||[],apiGroups:d.groups||[]});if((0,n.insertPeers)(e,{apiUsers:d.profiles||[],apiGroups:d.groups||[],apiContacts:[]}),"channelFilters"===r.kind)a.push(e.organisers.channelFilters,r.filter,t,o);else(0,i.exhaustivenessCheck)(r.kind)}return[]}default:(0,i.exhaustivenessCheck)(t)}}},590492:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(777211),r=s(73514),a=s(211274),i=s(401193),o=s(728921);const c=(e,t,s)=>{switch(t.type){case"MoreConvosNeeded":{const{organiser:s}=t,c=e.ownerId;let d,l="";switch(s.kind){case"filters":{const{filter:t}=s;if(l=a.getLockId(t),e.locks.getConversations[l]||!e.organisers.filters[t].hasMore)return[];d={start_from_minor_sort_id:a.isLoaded(e.organisers.filters[t])?e.organisers.filters[t].boundary.minorSortId:void 0,filter:a.snakeCaseId(t),extended:1,group_id:(0,n.getOwnerGroupId)(c)};break}case"folders":{const{id:t,filter:r}=s;l=o.getLockId(t,r);const a=e.organisers.folders.find((e=>e.id===t));if(!a)throw new Error("Не найдена папка");if(e.locks.getConversations[l]||o.isLoaded(a,r)&&!a[r].hasMore)return[];d={start_from_minor_sort_id:o.isLoaded(a,r)?a[r].boundaryMinorId:void 0,folder_id:a.id,filter:r,extended:1,group_id:(0,n.getOwnerGroupId)(c)};break}default:(0,i.exhaustivenessCheck)(s)}return e.locks.getConversations[l]=!0,[async function({api:e}){try{if(!d)throw new Error("Нет параметров запроса");const s=r.CONVOS_PER_PAGE,n=await e.fetch("messages.getConversations",{...d,count:s},{retries:1/0});return{...t,type:"MoreConvosNeeded_RequestCompleted",hasFailed:!1,requestedCount:s,hasMore:n.items.length>=s,response:n}}catch(e){return{...t,type:"MoreConvosNeeded_RequestCompleted",hasMore:!1,hasFailed:!0}}}]}case"MoreConvosNeeded_RequestCompleted":{const{hasFailed:r,organiser:c,hasMore:d}=t;let l="";switch(c.kind){case"filters":l=a.getLockId(c.filter);break;case"folders":l=o.getLockId(c.id,c.filter);break;default:(0,i.exhaustivenessCheck)(c)}if(e.locks.getConversations[l]=!1,r)return[];const{response:u}=t;if(u){const t=(0,n.insertConvos)(e,u.items,s,{dangerouslyMerge:!0});switch((0,n.insertPeers)(e,{apiUsers:u.profiles||[],apiGroups:u.groups||[],apiContacts:u.contacts||[]}),c.kind){case"filters":a.push(e.organisers.filters,c.filter,t,d);break;case"folders":if(!e.organisers.folders.find((e=>e.id===c.id)))return[];o.push(e.organisers.folders,c.id,c.filter,t,d,s);break;default:(0,i.exhaustivenessCheck)(c)}}return[]}default:(0,i.exhaustivenessCheck)(t)}}},884075:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(777211),r=s(73514),a=s(401193),i=s(856562);const o=(e,t,s)=>{if(!s.vkm_edu_precreated_convos)return[];switch(t.type){case"MorePrecreatedConvosNeeded":{if(e.locks.getPrecreatedConversations)return[];e.locks.getPrecreatedConversations=!0;const s=[...e.precreatedConvos.peerIds],n=s[s.length-1];return[async function({api:e}){try{const s=await e.fetch("messages.getPrecreatedConversations",{start_after:n,count:r.CONVOS_PER_PAGE,extended:1});return{...t,type:"MorePrecreatedConvosNeeded_RequestCompleted",hasFailed:!1,hasMore:!0,response:s}}catch(e){return{...t,type:"MorePrecreatedConvosNeeded_RequestCompleted",hasMore:!1,hasFailed:!0}}}]}case"MorePrecreatedConvosNeeded_RequestCompleted":{const{hasFailed:s}=t;if(e.locks.getPrecreatedConversations=!1,s||!t.response)return[];const{profiles:a,items:o,contacts:c}=t.response;return(0,n.insertPeers)(e,{apiUsers:a??[],apiGroups:[],apiContacts:c??[]}),o.forEach((t=>{const s=i.resolvePrecreatedConvoId(t);e.precreatedConvos.peerIds.add(s)})),e.precreatedConvos.hasMore=o.length>=r.CONVOS_PER_PAGE,[]}default:(0,a.exhaustivenessCheck)(t)}}},856573:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(777211),r=s(73514),a=s(401193),i=s(164231),o=s(795412);const c=(e,t)=>{switch(t.type){case"MoreVideoCommentsNeeded":{const{startCommentId:s,videoId:n}=t,a=e.videoConvos.get(n);if(!a||e.locks.getVideoCommentsHistory.has(d(n,s)))return[];e.locks.getVideoCommentsHistory.add(d(n,s));const i=a.ownerId,o=a.accessKey;return[async function({api:e}){try{const t=r.VIDEO_COMMENTS_PER_PAGE,a=await e.fetch("video.getComments",{owner_id:i,video_id:n,access_key:o,start_comment_id:Math.max(s,1),count:t,offset:1,extended:1,sort:"desc"},{retries:5});return{type:"MoreVideoCommentsNeeded_RequestCompleted",hasFailed:!1,requestedCount:t,hasMore:a.items.length>=t,response:a,startCommentId:s,videoId:n}}catch(e){return{type:"MoreVideoCommentsNeeded_RequestCompleted",hasMore:!1,hasFailed:!0,startCommentId:s,videoId:n}}}]}case"MoreVideoCommentsNeeded_RequestCompleted":{const{hasFailed:s,hasMore:r,response:a,videoId:c,startCommentId:l}=t;e.locks.getVideoCommentsHistory.delete(d(c,l));const u=e.videoConvos.get(c);return s||!u||a&&((0,n.insertPeers)(e,{apiUsers:a.profiles||[],apiGroups:a.groups||[],apiContacts:[]}),i.insertComments(u,a.items.map((e=>(0,o.fromApiComment)(e))).reverse(),r)),[]}default:(0,a.exhaustivenessCheck)(t)}};function d(e,t){return`${e}-${t}`}},387531:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(103026),r=s(302551),a=s(84113),i=s(856061),o=s(157570),c=s(401193);const d=(e,t)=>{switch(t.type){case"PollChannelPosts":{const{channelId:s,fromCmid:n,toCmid:r}=t,i=e.channels.get(s);if(!i||"Channel"!==i.kind)return[];const o=r??a.lastCmid(i.history);if(!o)return[];const c=a.around(i.history,n);if(void 0===c)return[];const d=c.nodes.reduce(((e,t)=>{const s=a.nodeCmid(t);return void 0!==s&&s>=n&&s<=o&&e.push(s),e}),[]).slice(-200);return[async function({api:e}){try{const t=await e.fetch("channels.getChannelMessagesCounters",{channel_id:s,cmids:d.join(",")});return{type:"PollChannelPosts_RequestSucceed",channelId:s,response:t}}catch(e){console.error(e)}return{type:"Noop"}}]}case"PollChannelPosts_RequestSucceed":{const{channelId:s,response:a}=t,i=e.channels.get(s);return i&&"Channel"===i.kind?(a.items?.forEach((e=>{const t=n.findPostByCmid(i,r.resolveCmid(e.message_id));t&&"Node"===t.kind&&l(t.item,e)})),[]):[]}default:(0,c.exhaustivenessCheck)(t)}},l=(e,t)=>{t.comments&&(e.comments={...e.comments,canPost:!!(t.comments.can_post??e.comments.canPost),canView:!!(t.comments.can_view??e.comments.canView),count:t.comments.count??e.comments.count}),t.reactions?(e.likes={...e.likes,count:t.reactions.count,reactionId:void 0!==t.reactions.user_reaction?i.resolveId(t.reactions.user_reaction):void 0},e.reactionId=void 0!==t.reactions.user_reaction?o.resolveId(t.reactions.user_reaction):void 0,e.reactions=t.reactions.items.reduce(((e,t)=>{const s=o.resolveId(t.id);return e.set(s,{reactionId:s,count:t.count}),e}),new Map)):(e.likes.count=0,e.likes.reactionId=void 0,e.reactionId=void 0,e.reactions=new Map),t.reposts&&(e.reposts={count:t.reposts.count,isReposted:!!(t.reposts.user_reposted??e.reposts.isReposted)}),e.views=t.views?.count??e.views}},518136:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(401193),r=s(649166),a=s(856562),i=s(84113),o=s(777211),c=s(112727);const d=(e,t,s)=>{if(!s.vkm_reactions)return[];switch(t.type){case"PollConvoReactions":{const{peerId:s,fromCmid:n,toCmid:r}=t,a=e.convos.get(s);if(!a)return[];const c=i.around(a.history,n);if(void 0===c)return[];const d=c.nodes.reduce(((e,t)=>{const s="Node"===t.kind?t.item.cmid:void 0;return void 0!==s&&s>=n&&s<=r&&e.push(s),e}),[]).slice(-100),l=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getMessagesReactions",{peer_id:s,cmids:d.join(","),extended:1,group_id:(0,o.getOwnerGroupId)(l)});return{type:"PollConvoReactions_RequestSucceed",peerId:s,cmids:d,apiResponse:t}}catch{}return{type:"Noop"}}]}case"PollConvoReactions_RequestSucceed":{const{peerId:s,apiResponse:n,cmids:i}=t;(0,o.insertPeers)(e,{apiUsers:n.profiles||[],apiGroups:n.groups||[],apiContacts:n.contacts||[]});const d=e.convos.get(s);if(!d)return[];const l=new Set(n.items.map((e=>r.resolveCmid(e.cmid))));let u=!1;i.filter((e=>!l.has(e))).forEach((e=>{const t=a.findMessageByCmid(d,r.resolveCmid(e));"Normal"===t?.kind&&0!==t.reactions.size&&r.setReactions(t,[])}));for(const{cmid:t,counters:s}of n.items){const n=a.findMessageByCmid(d,r.resolveCmid(t));if("Normal"!==n?.kind)continue;const i=(0,c.fromApiMessageReactions)(s);r.setReactions(n,Array.from(i.values())),u||(u=Array.from(i.keys()).some((t=>!e.messageReactionsConfig.assets.has(t))))}return u?[async function(){return{type:"InvalidateMessageReactions",force:!0}}]:[]}default:(0,n.exhaustivenessCheck)(t)}}},595742:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(175953),r=s(468831);const a=(e,t)=>{const{next:s}=t;if("Reconnecting"===s.kind)return[async function({queue:e}){try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}];if("Disconnected"===s.kind){if("manual"===s.reason)return[];const t=e.viewer.id;return[async function({queue:e,api:s}){const r=await s.fetch("queue.subscribe",{queue_ids:`onlfriends_${t},accountcounters_${t}`},{retries:1/0});e.connect({user_id:n.toRealId(t),...r});try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}]}for(const t of s.events)switch(t.entity_type){case"online":const s=n.resolveId(t.data.user_id);if(!n.isUserPeerId(s))break;e.lastSeens.set(s,{isOnline:!!t.data.online,at:1e3*t.data.last_seen,platform:(0,r.convertPlatform)(t.data.platform,t.data.app_id)});break;case"accountcounters":if("calls"===t.data.type)e.activeCallsCount=t.data.count;else{t.data.type}break;default:}return[async function({queue:e}){try{return{type:"QueueBatchReceived",next:await e.poll()}}catch{return{type:"Noop"}}}]}},552347:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(211274),a=s(777211);const i=(e,t)=>{switch(t.type){case"ResetUpdatesCounter":{const t=e.ownerId;return[async function({api:e}){try{return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!await e.fetch("messages.resetUpdatesCounter",{group_id:(0,a.getOwnerGroupId)(t)})}}catch(e){return{type:"ResetUpdatesCounter_RequestCompleted",hasFailed:!0}}}]}case"ResetUpdatesCounter_RequestCompleted":{const{hasFailed:s}=t;return s?[]:(r.updateCounters(e.organisers.filters,{headerNotMutedUnread:0}),[async function({notification:e}){return e.setIdleCounter(0),{type:"Noop"}}])}default:(0,n.exhaustivenessCheck)(t)}}},590901:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingExperimentalUpdated":return e.locks.settings.has("messageSelfMentionHighlighting")?[]:(e.locks.settings.add("messageSelfMentionHighlighting"),e.viewer.settings.messageSelfMentionHighlighting=t.messageMentionHighlighting,[async function(e){const{api:s}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({message_self_mention_highlighting:t.messageMentionHighlighting})},{retries:3}).catch((()=>{})).then((()=>({type:"SettingExperimentalUpdated_RequestCompleted"})))}]);case"SettingExperimentalUpdated_RequestCompleted":return e.locks.settings.delete("messageSelfMentionHighlighting"),[];default:(0,n.exhaustivenessCheck)(s)}}},790250:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingThemeUpdated":return e.viewer.settings.theme===t.value||e.locks.settings.has("theme")?[]:(e.locks.settings.add("theme"),e.viewer.settings.theme=t.value,[async function(e){const{api:s}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({theme:t.value})},{retries:3}).catch((()=>{})).then((()=>({type:"SettingThemeUpdated_RequestCompleted"})))}]);case"SettingThemeUpdated_RequestCompleted":return e.locks.settings.delete("theme"),[];default:(0,n.exhaustivenessCheck)(s)}}},788380:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;switch(s){case"SettingsFromApiLoaded":return 0===Object.keys(t.value).length?[]:[async function(e){return e.api.fetch("messages.setConfig",{config:JSON.stringify(t.value)}).catch((()=>{})).then((()=>({type:"SettingsFromApiLoaded_RequestCompleted"})))}];case"SettingsFromApiLoaded_RequestCompleted":return[];default:(0,n.exhaustivenessCheck)(s)}}},552212:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{switch(t.type){case"SettingsThemeStyleUpdated":{const{themeStyleId:s}=t,n=e.viewer.settings.themeStyleId;return n===s||e.locks.settings.has("themeStyleId")?[]:(e.locks.settings.add("themeStyleId"),e.viewer.settings.themeStyleId=s,[async function({storage:e}){try{return e.set("theme-style-id",s),{type:"SettingsThemeStyleUpdated_RequestCompleted"}}catch(e){return{type:"SettingsThemeStyleUpdated_RequestCompleted",previousThemeStyleId:n}}}])}case"SettingsThemeStyleUpdated_RequestCompleted":{const{prevThemeStyleId:s}=t;return e.locks.settings.delete("themeStyleId"),s&&(e.viewer.settings.themeStyleId=s),[]}default:(0,n.exhaustivenessCheck)(t)}}},358167:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(777211),r=s(401193),a=s(254335),i=s(175953),o=s(592087),c=s(314177);const d=(e,t,s)=>{if("SpaceEngineBatchReceived"===t.type)switch(t.variant.kind){case"FromSpaceEngine":return function(e,t){const{next:s}=t;if("Failure"===s.kind){e.spaceConn.status="resyncing";const{ts:t}=e.spaceConn,s=e.spaceConn.reconnectAttempts++;return[async function({api:e,spaceEngine:n,logger:a}){if(!n)return{type:"Noop"};const i=Math.min(2**s*500,1e4);let c;await(0,r.sleep)(i);try{c=await e.fetch("spaces.getLongPollHistory",{lp_version:n.version,ts:t,limit:1e3,extended:1},{retries:1/0,timeout:3e4})}catch(e){return e instanceof o.IApi.RequestError&&a.error("[SPACE RESYNC]",e),{type:"Noop"}}return n.connect({...c.credentials,ts:c.new_ts}),{type:"SpaceEngineBatchReceived",variant:{kind:"FromSpaceEngineApiHistory",ts:c.new_ts,spacesGLPHResponse:c}}}]}const n=function(e,t){const s=new Set,n=new Set;for(const r of t.updates)switch(r[0]){case 80001:switch(r[1]){case 1:{const[,,e]=r;s.add(a.resolveId(e));break}case 2:break;case 3:{const[,,t]=r,n=a.resolveId(t);e.spaces.has(n)&&s.add(n);break}default:r[1]}break;case 80002:switch(r[1]){case 1:{const[,,e]=r;s.add(a.resolveId(e));break}case 2:break;case 3:{const[,,t,n]=r,i=a.resolveId(t),o=e.spaces.get(i);if(!o)break;if("Incomplete"===o.kind)break;o.sections.has(a.resolveSectionId(n))||s.add(i);break}default:r[1]}break;case 80003:switch(r[1]){case 1:{const[,,e]=r;s.add(a.resolveId(e));break}case 2:break;case 3:{const[,,t,n]=r,i=a.resolveId(t),o=e.spaces.get(i);if(!o)break;if("Incomplete"===o.kind)break;o.rooms.has(a.resolveRoomId(n))||s.add(i);break}default:r[1]}break;case 80004:{const[,,t,n]=r,o=a.resolveId(t);if(i.resolveId(n)!==e.viewer.id)break;const c=e.spaces.get(o);switch(r[1]){case 1:c?.viewerData.isMember||s.add(o);break;case 2:c?.viewerData.isMember&&s.add(o);break;default:r[1]}break}case 80006:{const[,,t]=r,s=a.resolveId(t);e.spaces.has(s)&&n.add(s);break}default:}for(const e of s)n.delete(e);return{spaceIds:s,spaceSettingsIds:n}}(e,s);if(n.spaceIds.size>0||n.spaceSettingsIds.size>0)return[async function({api:e}){try{const[t,r]=await e.fetchMany([n.spaceIds.size>0&&{method:"spaces.getById",params:{space_ids:Array.from(n.spaceIds).join(","),extended:1}},n.spaceSettingsIds.size>0&&{method:"spaces.getSpaceSettings",params:{space_ids:Array.from(n.spaceSettingsIds).join(",")}}],{retries:1/0});return{type:"SpaceEngineBatchReceived",variant:{kind:"FromSpaceEngineWithMissingData",next:s,spacesGetByIdResponse:t,spacesGetSettingsResponse:r}}}catch{return{type:"Noop"}}}];return e.spaceConn.reconnectAttempts=0,l(e,s)}(e,t.variant);case"FromSpaceEngineWithMissingData":return function(e,t,s){const{next:r,spacesGetByIdResponse:i,spacesGetSettingsResponse:o}=t;i&&(0,n.insertSpaces)(e,i.items,{apiConvos:i.conversations||[],apiUsers:i.profiles||[],apiGroups:i.groups||[],apiSpaceCalls:i.calls||[],apiSpaceTribunes:i.tribunes||[]},s);if(o)for(const t of o.items){const s=a.resolveId(t.space_id),n=e.spaces.get(s);n&&(n.viewerData.notificationSettings=(0,c.fromApiNotificationSettings)(t.notification_settings))}return l(e,r)}(e,t.variant,s);case"FromSpaceEngineApiHistory":return function(e,t,s){const{spacesGLPHResponse:r}=t;return(0,n.insertSpaces)(e,r.spaces||[],{apiConvos:r.conversations||[],apiUsers:r.profiles||[],apiGroups:r.groups||[],apiSpaceCalls:r.calls||[],apiSpaceTribunes:r.tribunes||[]},s),l(e,{kind:"Batch",ts:r.new_ts,updates:r.history})}(e,t.variant,s);default:return(0,r.exhaustivenessCheck)(t.variant)}return(0,r.exhaustivenessCheck)(t.type)};function l(e,t){e.spaceConn.status="running",e.spaceConn.ts=t.ts;const s=t.updates.flatMap((t=>{switch(t[0]){case 80001:return function(e,t){const[,,s]=t,n=a.resolveId(s);switch(t[1]){case 1:case 3:return[];case 2:{const t=e.spaces.get(n);if(!t)return[];if("Incomplete"===t.kind)return[];for(const s of t.rooms.values())e.convos.delete(s.relatedEntity.peerId);return e.spaces.delete(n),[]}default:t[1];return[]}}(e,t);case 80002:return function(e,t){const[,,s,n]=t,r=a.resolveId(s),i=a.resolveSectionId(n);switch(t[1]){case 1:case 3:return[];case 2:{const t=e.spaces.get(r);return t?("Incomplete"===t.kind||t.sections.delete(i),[]):[]}default:t[1];return[]}}(e,t);case 80003:return function(e,t){const[,,s,n]=t,r=a.resolveId(s),i=a.resolveRoomId(n);switch(t[1]){case 1:case 3:return[];case 2:{const t=e.spaces.get(r);if(!t)return[];if("Incomplete"===t.kind)return[];const s=t.rooms.get(i);return s?(e.convos.delete(s.relatedEntity.peerId),t.rooms.delete(i),[]):[]}default:t[1];return[]}}(e,t);case 80004:return function(e,t){const[,,s,n,r]=t,o=a.resolveId(s),c=i.resolveId(n),d=e.spaces.get(o);if(!d)return[];switch(t[1]){case 1:a.addMember(d,c,r);break;case 2:a.removeMember(d,c,r);break;default:t[1]}return d.membersCount=r,[]}(e,t);case 80006:return[];default:return[]}}));return[async function({spaceEngine:e}){return e?{type:"SpaceEngineBatchReceived",variant:{kind:"FromSpaceEngine",next:await e.poll()}}:{type:"Noop"}},...s]}},888947:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(700462),r=s(401193);const a=(e,t)=>{switch(t.type){case"StickersCacheReceived":return t.stickers.forEach((t=>{const s=(0,n.fromApiSticker)(t);e.stickers.set(s.id,s)})),[];case"StickersReloadCompleted":return e.forceStickersReload=!1,[];default:(0,r.exhaustivenessCheck)(t)}}},856823:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedBrowserNotifications":return e.locks.settings.add("browserNotifications"),e.viewer.settings.browserNotifications=t.value,[async function(e){return e.storage.set("settings-browser-notifications-on",t.value),{type:"UserChangedBrowserNotifications_RequestCompleted"}}];case"UserChangedBrowserNotifications_RequestCompleted":return e.locks.settings.delete("browserNotifications"),[];default:(0,n.exhaustivenessCheck)(s)}}},572651:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(843779);const a=(e,t,s)=>{const{type:a}=t;switch(a){case"UserChangedBubblesTheme":{if(e.locks.settings.has("bubblesTheme"))return[];e.locks.settings.add("bubblesTheme"),e.viewer.settings.bubblesTheme=t.value;const n=r.isWithoutBubbles(e.viewer,s);return[async function(e){const{api:s,stats:r}=e;return s.fetch("messages.setConfig",{config:JSON.stringify({bubble_theme:"enabled"===t.value?1:0})},{retries:3}).catch((()=>{})).then((e=>void 0!==e?.version?(r.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:"CHANGE_APPEARANCE",label:n?"CLASSIC":"BUBBLE"}}}),{type:"UserChangedBubblesTheme_RequestCompleted"}):{type:"Noop"}))}]}case"UserChangedBubblesTheme_RequestCompleted":return e.locks.settings.delete("bubblesTheme"),[];default:(0,n.exhaustivenessCheck)(a)}}},376308:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(401193),r=s(103026),a=s(726478),i=s(520828),o=s(175953);const c={archive:"archive",unarchive:"archive",join:"join",leave:"join",pin:"pin",unpin:"pin",mute:"mute",unmute:"mute",mark_read:"mark_read"},d={archive:"unarchive",unarchive:"archive",join:"leave",leave:"join",mute:"unmute",unmute:"mute"},l=(e,t,s)=>{const{type:c}=t;switch(c){case"UserChangedChannel":{const{channelId:s,userAction:i}=t,o=u(t.userAction,s);if(e.locks.channelActions.has(o))return[];e.locks.channelActions.add(o);const c=e.channels.get(s);if(!c||"ChannelRestricted"===c.kind)return[];let d;switch(i){case"archive":r.setArchived(c,!0),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.archive",{channel_ids:String(s)}).then((e=>Boolean(e)));break;case"unarchive":r.setArchived(c,!1),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.unarchive",{channel_ids:String(s),extended:1}).then((e=>Boolean(e)));break;case"join":r.setMembership(c,!0),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.join",{channel_id:s,extended:1}).then((e=>Boolean(e)));break;case"leave":r.setMembership(c,!1),a.refreshChannels(e.organisers,c),d=e=>e.fetch("channels.leave",{channel_id:s});break;case"mute":r.setMuted(c,!0),d=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"disabled"}).then((e=>Boolean(e)));break;case"unmute":r.setMuted(c,!1),d=e=>e.fetch("channels.setNotificationMode",{channel_id:s,mode:"enabled"}).then((e=>Boolean(e)));break;case"mark_read":{const e=r.lastPost({channel:c,withPending:!1});if(e){const t=e.cmid;c.inReadCmid=t,d=e=>e.fetch("channels.markAsRead",{last_read_cmid:t,channel_id:s})}break}case"pin":d=e=>e.fetch("channels.pin",{channel_id:s}).then((e=>Boolean(e)));break;case"unpin":d=e=>e.fetch("channels.unpin",{channel_id:s}).then((e=>Boolean(e)));break;default:(0,n.exhaustivenessCheck)(i)}return[async function({api:e}){try{let t=!1;return d&&(t=!await d(e)),{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:t,userAction:i}}catch(e){return{type:"UserChangedChannel_RequestCompleted",channelId:s,hasFailed:!0,userAction:i}}}]}case"UserChangedChannel_RequestCompleted":{const{channelId:n,userAction:r,hasFailed:a}=t,i=u(r,n);e.locks.channelActions.delete(i);const o=d[r];return a&&o&&(l(e,{type:"UserChangedChannel",userAction:o,channelId:n},s),e.locks.channelActions.delete(i)),[]}case"UserSetChannelPhoto":{const{channelId:s,photo:n}=t,a=e.channels.get(s);return a&&"Channel"===a.kind?(r.setPhotos(a,{photo50:i.preview(n,50,50,!0)?.url,photo100:i.preview(n,100,100,!0)?.url,photo:n.originalImage,thumbHashUrl:n.thumbhashUrl}),[]):[]}case"UserUpdateChannelInfo":{const{channelId:s,name:n,description:r,canMessage:a}=t,i=e.channels.get(s);if(!i||"Channel"!==i.kind)return[];if(n&&(i.name=n),void 0!==r&&(i.description=r),void 0!==a){i.canMessage=a;const t=e.peers.get(o.resolveId(s));if(!t||"Group"!==t.kind)return[];t.canMessage=a}return[]}default:(0,n.exhaustivenessCheck)(c)}},u=(e,t)=>`${c[e]}-${t.toString()}`},755255:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(818005),r=s(302551),a=s(401193),i=s(679005),o=s(743206);const c=(e,t)=>{const{channelId:s}=t,c=e.channelComposerDrafts[s]??n.empty();let d=n.empty();switch(t.type){case"UserChangedChannelComposerDraft":switch(t.kind){case"text":{const{text:e,visibility:s,donutDelay:n,date:r,sendOptions:a,ads:i}=t;d={...c,text:e??c.text,visibility:s||c.visibility,donutDelay:n||c.donutDelay,date:r,sendOptions:a||c.sendOptions,ads:i||c.ads};break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=(0,o.applyAttachmentActions)(c,t);d={...c,...e};break;case"editing":{const{editing:e}=t,s=[],a=["mute_notifications"];e.comments.canPost&&e.comments.canView||s.push("close_comments"),e.signerId&&s.push("signed"),d={editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:c.uploadsTrackIds,visibility:r.isDonut(e)?"donut":"all",donutDelay:e.donut?.duration||-1,sendOptions:{selected:s,disabled:a},ads:n.empty().ads};break}case"forward":{const{forward:e}=t;d={...e&&c.editing?n.empty():c,forward:e,attaches:{},ads:n.empty().ads,uploadsTrackIds:new Set};break}default:(0,a.exhaustivenessCheck)(t)}break;case"UserClearedChannelComposerDraft":break;default:(0,a.exhaustivenessCheck)(t)}!d.text&&0===Object.keys(d.attaches).length&&0===d.uploadsTrackIds.size&&"all"===d.visibility&&void 0===d.date&&-1===d.donutDelay&&0===d.sendOptions.selected.length&&0===d.sendOptions.disabled.length&&void 0===d.forward&&""===d.ads.erId&&""===d.ads.predId&&!1===d.ads.isAd?delete e.channelComposerDrafts[s]:e.channelComposerDrafts[s]=d;const l=(0,i.current)(e.channelComposerDrafts);return[async({storage:e})=>(e.set("channels-drafts",l),{type:"Noop"})]}},780642:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(401193),r=s(103026),a=s(302551),i=s(84113),o=s(510632);const c={delete:"delete",restore:"restore",report:"report",enable_comments:"enable_comments",disable_comments:"enable_comments"},d=(e,t,s)=>{const{type:c}=t;switch(c){case"UserChangedChannelPost":{const{channelId:s,cmid:c,userAction:d}=t,u=l(t.userAction.kind,s,c);if(e.locks.channelPostActions.has(u))return[];e.locks.channelPostActions.add(u);const p=e.channels.get(s);if(!p)return[];if("ChannelRestricted"===p.kind)return[];const h=t.isPostponed?null:i.findNodeByCmid(p.history,c);if(h&&"NotLoaded"===h.status)return[];let m;switch(d.kind){case"delete":if(h&&"Deleted"===h.status)break;t.isPostponed?r.deletePostponedPost(p,c):r.deletePost(p,c,{isRestorable:!0,isSpam:!0}),m=e=>e.fetch("wall.delete",{owner_id:s,post_id:c}).then((e=>Boolean(e)));break;case"restore":if(t.isPostponed)r.restorePostponedPost(p,c);else{if(h&&"Deleted"!==h.status)break;r.restorePost(p,c)}m=e=>e.fetch("wall.restore",{owner_id:s,post_id:c}).then((e=>Boolean(e)));break;case"report":if(h&&"Deleted"===h.status)break;r.deletePost(p,c,{isRestorable:!0,isSpam:!0}),m=e=>e.fetch("wall.reportPost",{owner_id:s,post_id:c,reason:d.reason}).then((e=>Boolean(e)));break;case"enable_comments":case"disable_comments":{if(h&&"Deleted"===h.status)break;const e=o.getElementById(p.postponed.history,c);t.isPostponed&&e?a.changeCommentsCanPost(e.content,"enable_comments"===d.kind):h&&a.changeCommentsCanPost(h.node.item,"enable_comments"===d.kind),m=e=>e.fetch("enable_comments"===d.kind?"wall.openComments":"wall.closeComments",{owner_id:s,post_id:c}).then((e=>Boolean(e)));break}default:(0,n.exhaustivenessCheck)(d)}return[async function({api:e}){try{let t=!1;return m&&(t=!await m(e)),{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:c,hasFailed:t,userAction:d}}catch(e){return{type:"UserChangedChannelPost_RequestCompleted",channelId:s,cmid:c,hasFailed:!0,userAction:d}}}]}case"UserChangedChannelPost_RequestCompleted":{const{channelId:r,cmid:a,userAction:i,hasFailed:o}=t,c=l(i.kind,r,a);if(e.locks.channelPostActions.delete(c),o){let t;switch(i.kind){case"delete":case"report":t={kind:"restore"};break;case"restore":t={kind:"delete"};break;case"enable_comments":case"disable_comments":t={kind:"enable_comments"===i.kind?"disable_comments":"enable_comments"};break;default:(0,n.exhaustivenessCheck)(i)}t&&d(e,{type:"UserChangedChannelPost",userAction:t,channelId:r,cmid:a},s),e.locks.channelPostActions.delete(c)}return[]}default:(0,n.exhaustivenessCheck)(c)}},l=(e,t,s)=>`${c[e]}-${t.toString()}-${s}`},742962:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{const{type:s}=t;if("UserChangedCollapsedVersion"===s)return e.channelsConfig.recommendations.lastCollapsedVersion=t.version,[async function({api:e}){return await e.fetch("channels.setConfig",{last_collapsed_recommendations_version:t.version}),{type:"Noop"}}];(0,n.exhaustivenessCheck)(s)}},179061:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(175953),a=s(856562),i=s(520828),o=s(777211);const c=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedChatTitle":{const{peerId:s,title:n}=t,a=r.toRealId(s),i=e.peers.get(s),c=e.ownerId;if(!i||"Chat"!==i.kind)return[];const d=i.title;return r.updateChatInfo(i,{title:n}),[async function({api:e}){try{const t=await e.fetch("messages.editChat",{chat_id:a,title:n,group_id:(0,o.getOwnerGroupId)(c)},{retries:1});return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:1!==t,peerId:s,title:1!==t?d:n}}catch(e){return{type:"UserChangedChatTitle_RequestCompleted",hasFailed:!0,peerId:s,title:d}}}]}case"UserChangedChatTitle_RequestCompleted":{const{peerId:s,title:n,hasFailed:a}=t,i=e.peers.get(s);return i&&"Chat"===i.kind&&a?(r.updateChatInfo(i,{title:n}),[]):[]}case"UserChangedChatDescription":{const{peerId:s,description:n}=t,i=r.toRealId(s),c=e.convos.get(s),d=e.ownerId;if(!c||"ChatConvo"!==c.kind&&"GroupConvo"!==c.kind)return[];const l=c.description;return a.setDescription(c,n),[async function({api:e}){try{const t=await e.fetch("messages.editChat",{chat_id:i,description:n,group_id:(0,o.getOwnerGroupId)(d)},{retries:1});return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:1!==t,peerId:s,description:1!==t?l:n}}catch(e){return{type:"UserChangedChatDescription_RequestCompleted",hasFailed:!0,peerId:s,description:l}}}]}case"UserChangedChatDescription_RequestCompleted":{const{peerId:s,description:n,hasFailed:r}=t,i=e.convos.get(s);return!i||"ChatConvo"!==i.kind&&"GroupConvo"!==i.kind?[]:r?(a.setDescription(i,n),[]):[]}case"UserSetChatPhoto":{const{peerId:s,photo:n}=t,a=e.peers.get(s);return a&&"Chat"===a.kind?(r.updateChatInfo(a,{photo50:i.preview(n,50,50)?.url,photo100:i.preview(n,100,100)?.url,photo200:i.preview(n,200,200)?.url,photo:n.originalImage,thumbHashUrl:n.thumbhashUrl}),[]):[]}case"UserRemovedChatPhoto":{const{peerId:s}=t,n=e.ownerId,a=r.toRealId(s),i=e.peers.get(s);return i&&"Chat"===i.kind?(r.updateChatInfo(i,{photo50:void 0,photo100:void 0,photo200:void 0,photo:void 0}),[async function({api:e}){try{return await e.fetch("messages.deleteChatPhoto",{chat_id:a,group_id:(0,o.getOwnerGroupId)(n)},{retries:1}),{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!1,peerId:s}}catch(e){return{type:"UserRemovedChatPhoto_RequestCompleted",hasFailed:!0,peerId:s}}}]):[]}case"UserRemovedChatPhoto_RequestCompleted":return[];case"UserChangedChatSettings":{const{peerId:s,isService:n,permissions:a}=t,{stickers_popup_autoplay:i,...c}=a,d=r.toRealId(s),l=e.ownerId;return[async function({api:e}){try{return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:1!==await e.fetch("messages.editChat",{chat_id:d,is_service:n?1:0,is_disable_stickers_popup_autoplay:"off"===i?1:0,permissions:JSON.stringify(c),group_id:(0,o.getOwnerGroupId)(l)},{retries:1}),permissions:a,peerId:s,isService:n}}catch(e){return{type:"UserChangedChatSettings_RequestCompleted",hasFailed:!0,permissions:a,peerId:s,isService:n}}}]}case"UserChangedChatSettings_RequestCompleted":{const{peerId:s,isService:n,permissions:r,hasFailed:i}=t;if(i)return[];const o=e.convos.get(s);return o&&"ChatConvo"===o.kind?(a.setChatPermissions(o,r,n),[]):[]}default:(0,n.exhaustivenessCheck)(s)}}},166051:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(401193),r=s(175953),a=s(358096),i=s(777211);const o=(e,t)=>{switch(t.type){case"UserChangedChatMember":{const{peerId:s,memberId:a,userAction:o}=t;if(!e.convos.get(s))return[];const c=function(e,t){const{userAction:s,peerId:a,memberId:o}=t;switch(s){case"promote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:a,role:"admin"});case"demote":return({api:e})=>e.fetch("messages.setMemberRole",{member_id:o,peer_id:a,role:"member"});case"cancel_invitation":case"remove":return({api:t})=>t.fetch("messages.removeChatUser",{chat_id:r.toRealId(a),member_id:o,group_id:(0,i.getOwnerGroupId)(e)});default:return(0,n.exhaustivenessCheck)(s)}}(e.ownerId,t);return[async function(e){try{return{type:"UserChangedChatMember_RequestCompleted",hasFailed:1!==await c(e),peerId:s,memberId:a,userAction:o}}catch(e){return{type:"UserChangedChatMember_RequestCompleted",hasFailed:!0,peerId:s,memberId:a,userAction:o}}}]}case"UserRemoveIncognitoMember":{const{peerId:s,userAction:n,incognitoId:a}=t,o=e.convos.get(s),c=e.ownerId;return o?[async function({api:e}){try{return{type:"UserRemoveIncognitoMember_RequestCompleted",hasFailed:1!==await e.fetch("messages.removeChatUser",{chat_id:r.toRealId(s),incognito_id:a,group_id:(0,i.getOwnerGroupId)(c)}),peerId:s,incognitoId:a,userAction:n}}catch(e){return{type:"UserRemoveIncognitoMember_RequestCompleted",hasFailed:!0,peerId:s,incognitoId:a,userAction:n}}}]:[]}case"UserChangedChatMember_RequestCompleted":{const{memberId:s,peerId:n,userAction:i,hasFailed:o}=t,c=e.convos.get(n);return o||"ChatConvo"!==c?.kind?[]:("cancel_invitation"===i&&a.removeMember(c.members,s),r.isContactPeerId(s)||("promote"===i&&a.setAdmin(c.members,s),"demote"===i&&a.unsetAdmin(c.members,s),"remove"===i&&a.removeMember(c.members,s)),[])}case"UserRemoveIncognitoMember_RequestCompleted":{const{incognitoId:s,peerId:n,hasFailed:i}=t,o=e.convos.get(n);if(i||"ChatConvo"!==o?.kind)return[];const c=a.getIncognitoMember(o.members,s);a.removeIncognitoMember(o.members,s);const d=r.resolveId(c?.memberId);return d&&a.removeMember(o.members,d),[]}default:return(0,n.exhaustivenessCheck)(t)}}},892807:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(856562);const a=(e,t)=>{switch(t.type){case"UserChangedChatStickersDisplay":{const{peerId:s,showChatStickers:n}=t;if(e.locks.setChatStickersDisplay.has(s))return[];e.locks.setChatStickersDisplay.add(s);const a=e.convos.get(s);return a&&"ChatConvo"===a.kind&&a.stickersParams&&r.setStickersParams(a,{...a.stickersParams,isKeyboardHidden:!n}),[async function({api:e,stats:t}){try{if(1!==await e.fetch(n?"stickers.showUGCKeyboard":"stickers.hideUGCKeyboard",{owner_id:s}))throw Error("Запрос выполнен с ошибкой");return t.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:n?"show_sticker_chat":"hide_sticker_chat"}}}),{type:"UserChangedChatStickersDisplay_RequestCompleted",peerId:s,hasFailed:!1,showChatStickers:n}}catch(e){return{type:"UserChangedChatStickersDisplay_RequestCompleted",peerId:s,hasFailed:!0,showChatStickers:!1}}}]}case"UserChangedChatStickersDisplay_RequestCompleted":if(e.locks.setChatStickersDisplay.delete(t.peerId),t.hasFailed){const s=e.convos.get(t.peerId);s&&"ChatConvo"===s.kind&&s.stickersParams&&r.setStickersParams(s,{...s.stickersParams,isKeyboardHidden:t.showChatStickers})}return[];default:(0,n.exhaustivenessCheck)(t)}}},370618:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(302551),a=s(136872),i=s(84113);const o={delete:"delete",restore:"restore",report:"report",deleteThread:"delete",restoreThread:"restore"},c=(e,t,s)=>{const{type:o,channelId:l,postCmid:u,commentCmid:p,userAction:h}=t,m=d(h.kind,l,u,p),g=e.channels.get(l);if("ChannelRestricted"===g?.kind)return[];const f=g&&i.findNodeByCmid(g.history,u).node,C="Node"===f?.kind&&f.item,v=C&&r.findCommentByCmid(C,p);if(!v)return[];switch(o){case"UserChangedComment":{if(e.locks.commentActions.has(m))return[];let t;switch(e.locks.commentActions.add(m),h.kind){case"delete":{if("Normal"!==v.kind)break;const e=a.markDeleted(v,!1);r.replaceComment(C,e),t=t=>t.fetch("wall.deleteComment",{owner_id:l,comment_id:e.cmid}).then((e=>Boolean(e)));break}case"restore":{if("MarkedDeleted"!==v.kind)break;const e=a.restoreDeleted(v);r.replaceComment(C,e),t=t=>t.fetch("wall.restoreComment",{owner_id:l,comment_id:e.cmid}).then((e=>Boolean(e)));break}case"report":{if("Normal"!==v.kind)break;r.deleteComment(C,v.cmid);const e=v.cmid;t=t=>t.fetch("wall.reportComment",{owner_id:l,comment_id:e,reason:h.reason}).then((e=>Boolean(e)));break}case"deleteThread":if("MarkedDeleted"!==v.kind&&"Deleted"!==v.kind)break;a.deleteThread(v),t=e=>e.fetch("wall.deleteThread",{owner_id:l,reply_id:p}).then((e=>Boolean(e)));break;case"restoreThread":if("MarkedDeleted"!==v.kind&&"Deleted"!==v.kind)break;a.restoreThread(v),t=e=>e.fetch("wall.restoreThread",{owner_id:l,reply_id:p}).then((e=>Boolean(e)));break;default:(0,n.exhaustivenessCheck)(h)}return t?[async function({api:e}){try{let s=!1;if(t){s=!await t(e)}return{type:"UserChangedComment_RequestCompleted",channelId:l,postCmid:u,commentCmid:p,hasFailed:s,userAction:h}}catch(e){return{type:"UserChangedComment_RequestCompleted",channelId:l,postCmid:u,commentCmid:p,hasFailed:!0,userAction:h}}}]:[]}case"UserChangedComment_RequestCompleted":{const{hasFailed:r}=t;if(e.locks.commentActions.delete(m),r){let t;switch(h.kind){case"delete":case"report":t={kind:"restore"};break;case"restore":t={kind:"delete"};break;case"deleteThread":t={kind:"restoreThread"};break;case"restoreThread":t={kind:"deleteThread"};break;default:(0,n.exhaustivenessCheck)(h)}if(t){const n=d(t.kind,l,u,p);c(e,{type:"UserChangedComment",userAction:t,channelId:l,postCmid:u,commentCmid:p},s),e.locks.commentActions.delete(n)}}return[]}default:(0,n.exhaustivenessCheck)(t)}},d=(e,t,s,n)=>`${o[e]}-${t}-${s}-${n}`},124596:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(884618),r=s(136872),a=s(401193),i=s(679005),o=s(743206);const c=(e,t)=>{const{channelId:s,postCmid:c}=t,d=`${s}-${c}`,l=e.commentsComposerDrafts[d]??n.empty();let u=n.empty();switch(t.type){case"UserChangedCommentsComposerDraft":switch(t.kind){case"text":{const{text:e}=t;u={...l,text:e??l.text};break}case"editing":{const{editing:e}=t;u={editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:l.uploadsTrackIds,reply:void 0};break}case"reply":{const{reply:e}=t;u={...e&&l.editing?n.empty():l,reply:e};break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=(0,o.applyAttachmentActions)(l,t);u={...l,...e};break;default:(0,a.exhaustivenessCheck)(t)}break;case"UserClearedCommentsComposerDraft":break;default:(0,a.exhaustivenessCheck)(t)}!u.text&&!u.reply&&!u.editing&&0===u.uploadsTrackIds.size&&0===Object.keys(u.attaches).length?delete e.commentsComposerDrafts[d]:e.commentsComposerDrafts[d]=u;const p=(0,i.current)(e.commentsComposerDrafts);return[async({storage:e})=>(e.set("comments-drafts",p),{type:"Noop"})]}},743206:(e,t,s)=>{"use strict";s.d(t,{applyAttachmentActions:()=>g,handler:()=>m});var n=s(19068),r=s(649166),a=s(856562),i=s(726478),o=s(520828),c=s(401193),d=s(679005),l=s(777211),u=s(946990),p=s(841093),h=s(795412);const m=(e,t,s)=>{const{peerId:o}=t,m=void 0!==o?e.composerDrafts[o]??[]:[],y=m[m.length-1]??(0,d.castDraft)(n.empty());let _=(0,d.castDraft)(m.slice(0,-1));switch(t.type){case"UserChangedComposerDraft":switch(t.kind){case"text":{const{text:e}=t;_.push({...y,text:e??y.text});break}case"addAttaches":case"removeAttach":case"removeVoice":case"startUploading":case"removeUploads":case"rearrangeAttaches":const e=g(y,t);_.push({...y,...e});break;case"editing":{const{editing:e}=t;_.push(y,{editing:e,text:r.toRawText(e),attaches:e.attaches,uploadsTrackIds:y.uploadsTrackIds,forward:e.forwardedMessages&&{kind:"message",items:e.forwardedMessages},reply:e.replyMessage});break}case"forward":{const{forward:e,isForwardAuthorHidden:s}=t;_.push({...e&&y.editing?n.empty():y,reply:void 0,forward:e,isForwardAuthorHidden:s??n.DEFAULT_FORWARD_AUTHOR_HIDDEN});break}case"reply":{const{reply:e}=t;_.push({...e&&y.editing?n.empty():y,forward:void 0,reply:e});break}default:(0,c.exhaustivenessCheck)(t)}break;case"UserClearedComposerDraft":break;case"ComposerDraftsUpdateNeeded":{const{itemsToDelete:s,itemsToReplace:n,foreignKind:r}=t;_.push(y),_=_.reduce(((e,t)=>{const{editing:a,reply:i}=t;if("message"===r){if(void 0!==a&&f(s,a))return e;if(void 0===a&&void 0!==i)if(f(s,i))t.reply=void 0;else{const e=f(n,i);void 0!==e&&(t.reply=e)}}return e.push(t),e}),[]);const a=Object.values(e.composerDrafts).reduce(((e,t)=>(t.forEach((t=>e.push(t))),e)),[y]);a.forEach((e=>{const{forward:t,editing:a}=e;if(void 0===a&&void 0!==t){if("message"===r&&"message"===t.kind){const r=(0,c.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=f(n,t);return void 0!==r?(e.push(r),e):(f(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"message",items:r}:void 0}if("post"===r&&"post"===t.kind){const r=(0,c.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=C(n,t);return void 0!==r&&"Postponed"!==r.kind?(e.push(r),e):(C(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"post",items:r}:void 0}if("comment"===t.kind&&"comment"===r){const r=(0,c.toNonEmpty)([...t.items].reduce(((e,t)=>{const r=v(n,t);return void 0!==r?(e.push(r),e):(v(s,t)||e.push(t),e)}),[]));e.forward=null!==r?{kind:"comment",items:r}:void 0}}}));break}case"ActualizeComposerDraft":{const t=e.ownerId;return _.push(y),_.map((e=>{const s=(0,d.isDraft)(e)?(0,d.current)(e):e;return async({api:e})=>{const{reply:n,forward:r,editing:a}=s,i=[...a?[a]:[],...n?[n]:[],..."message"===r?.kind?r.items:[]].reduce(((e,t)=>("Foreign"!==t.kind&&"ForeignExpired"!==t.kind&&e.push(t),e)),[]);if(i.length>0&&i[0]){const s=i[0].peerId,n=i.reduce(((e,t)=>{if(t.peerId!==s){if(c.isDev)throw new Error("Перессылаемые сообщения не из одного чата");return e}return e.push(t.cmid),e}),[]);try{const r=await e.fetch("messages.getByConversationMessageId",{peer_id:s,conversation_message_ids:n.join(","),extended:1,group_id:(0,l.getOwnerGroupId)(t)});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:s,foreignKind:"message",foreignItems:i,response:r}}catch{}}if("post"===r?.kind){const{channelId:t}=r.items[0],s=r.items.reduce(((e,s)=>{if(s.channelId!==t){if(c.isDev)throw new Error("Перессылаемые посты не из одного канала");return e}return e.push(s.cmid),e}),[]);try{const n=await e.fetch("channels.getMessagesById",{channel_id:t,cmids:s.join(","),extended:1});return{type:"ActualizeComposerDraft_RequestCompleted",peerId:o,foreignKind:"post",foreignItems:r.items,response:n}}catch{}}if("comment"===r?.kind){const{channelId:t,postCmid:s}=r.items[0],n=[...r.items].reduce(((e,n)=>{if(n.channelId!==t||n.postCmid!==s){if(c.isDev)throw new Error("Пересылаемые комменты не из одного поста или даже не из одного канала");return e}return e.push(n.cmid),e}),[]);try{const a=await e.fetchMany(n.map((e=>({method:"wall.getComments",params:{owner_id:t,post_id:s,start_comment_id:e,count:1,offset:0,extended:1}}))));return{type:"ActualizeComposerDraft_RequestCompleted",peerId:o,foreignKind:"comment",foreignItems:r.items,response:n.reduce(((e,t,s)=>{const n=a[s];return n?(e[t]=n,e):e}),{})}}catch{}}return{type:"Noop"}}}))}case"ActualizeComposerDraft_RequestCompleted":{const{response:s,foreignKind:n,foreignItems:r}=t;switch(n){case"message":{const{profiles:t,groups:n,contacts:a,items:i}=s;(0,l.insertPeers)(e,{apiUsers:t||[],apiGroups:n||[],apiContacts:a||[]});const c=i.reduce(((e,t)=>{if(t.deleted)return e;const s=(0,u.fromApiMessage)(t).message;return"Normal"===s.kind&&e.push(s),e}),[]),d=r.filter((e=>!f(c,e)));return d.length>0||c.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"message",itemsToDelete:d,itemsToReplace:c,peerId:o})]:[]}case"post":{const{profiles:t,groups:n,items:a}=s;(0,l.insertPeers)(e,{apiUsers:t||[],apiGroups:n||[],apiContacts:[]});const i=a?.map((e=>(0,p.fromApiPost)(e).post))??[],c=r.filter((e=>!C(i,e)));return c.length>0||i.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToDelete:c,itemsToReplace:i,peerId:o})]:[]}case"comment":{const{comments:t,itemsToDelete:n}=r.reduce(((t,n)=>{const r=s[n.cmid];if(!r)return t.itemsToDelete.push(n),t;const{profiles:a,groups:i,items:o}=r;return(0,l.insertPeers)(e,{apiUsers:a||[],apiGroups:i||[],apiContacts:[]}),0===o.length?(t.itemsToDelete.push(n),t):(o.forEach((e=>{const s=(0,h.fromApiComment)(e);"Normal"===s.kind&&s.cmid===n.cmid?t.comments.push(s):t.comments.push(n)})),t)}),{comments:[],itemsToDelete:[]});return n.length>0||t.length>0?[async()=>({type:"ComposerDraftsUpdateNeeded",foreignKind:"comment",itemsToDelete:n,itemsToReplace:t,peerId:o})]:[]}default:return(0,c.exhaustivenessCheck)(n)}}default:(0,c.exhaustivenessCheck)(t)}const k=e=>!(e.text.trim()||e.forward||e.reply||e.editing||0!==Object.keys(e.attaches).length||0!==e.uploadsTrackIds.size);let I=!1,b=!1;if(void 0!==o){const n=e.convos.get(o),r=s.vkm_up_drafted_convos_in_list&&n&&("UserChangedComposerDraft"===t.type||"UserClearedComposerDraft"===t.type);_=_.filter((e=>!k(e))),0===_.length?(r&&(a.updateIsDrafted(n,!1),i.refresh(e.organisers,n,s),k(y)||(b="UserClearedComposerDraft"!==t.type||!t.withoutLog)),delete e.composerDrafts[o]):(r&&n.canWrite.allowed&&(a.updateIsDrafted(n,!0),i.refresh(e.organisers,n,s),k(y)&&(I=!0)),e.composerDrafts[o]=_)}const w=(0,d.current)(e.composerDrafts);return[I?async({stats:e})=>(e.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:"create_draft_message",peer_id:o}}}),{type:"Noop"}):void 0,b?async({stats:e})=>(e.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:"delete_draft_message",peer_id:o}}}),{type:"Noop"}):void 0,async({storage:e})=>(e.set("drafts",w),{type:"Noop"})]};function g(e,t){switch(t.kind){case"addAttaches":{const{attaches:s,trackIds:n}=t;let r=e.attaches;s&&(r=(0,d.produce)(r,(e=>{o.addAttach(e,s)})));let a=e.uploadsTrackIds;return n?.length&&(a=(0,d.produce)(a,(e=>{n.forEach((t=>{e.delete(t)}))}))),{attaches:r,uploadsTrackIds:a}}case"removeAttach":{const{attach:s,index:n}=t;let r=e.attaches;return s&&(r=(0,d.produce)(r,(e=>{o.removeAttach(e,s,n)}))),{attaches:r}}case"removeVoice":return{attaches:(0,d.produce)(e.attaches,(e=>{e.voice&&delete e.voice}))};case"startUploading":{const{trackIds:s}=t;return{uploadsTrackIds:new Set([...e.uploadsTrackIds,...s])}}case"removeUploads":{const{trackIds:s}=t;return{uploadsTrackIds:(0,d.produce)(e.uploadsTrackIds,(e=>{s.forEach((t=>{e.delete(t)}))}))}}case"rearrangeAttaches":{const{key:s,currentPosition:n,newPosition:r}=t;let a=e.attaches;return-1!==r&&r!==n&&(a=(0,d.produce)(a,(e=>{o.rearrangeAttaches(e,{currentPosition:n,newPosition:r},s)}))),{attaches:a}}default:(0,c.exhaustivenessCheck)(t)}}function f(e=[],t){return e.find((e=>t.peerId===e.peerId&&t.cmid===e.cmid))}function C(e=[],t){return e.find((e=>t.channelId===e.channelId&&t.cmid===e.cmid))}function v(e=[],t){return e.find((e=>t.channelId===e.channelId&&t.postCmid===e.postCmid&&t.cmid===e.cmid))}},659476:(e,t,s)=>{"use strict";s.d(t,{handler:()=>m});var n=s(856562),r=s(175953),a=s(726478),i=s(358096),o=s(649166),c=s(401193),d=s(679005),l=s(777211),u=s(726356);const p={mute:"mute",unmute:"mute",mute_until:"mute_until",pin:"pin",unpin:"pin",mark_read:"mark_read",mark_unread:"mark_read",archive:"archive",unarchive:"archive",clear:"clear",leave:"leave",leave_and_clear:"leave_and_clear",show_pinned_message:"show_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"show_bot_keyboard",hide_bot_keyboard:"hide_bot_keyboard",pin_message_for_all:"pin_message_for_all",unpin_message_for_all:"pin_message_for_all",ban:"ban",unban:"unban",return_to_chat:"return_to_chat",business_notify_enable:"business_notify_enable",business_notify_disable:"business_notify_enable",forbid_writing_all:"forbid_writing_all",allow_writing_all:"allow_writing_all",forbid_writing_all_until:"forbid_writing_all_until",finish_call:"finish_call",restrict_to_write:"restrict_to_write",allow_to_write:"allow_to_write",off_stickers_popup_animation:"off_stickers_popup_animation",on_stickers_popup_animation:"on_stickers_popup_animation"},h={pin:"unpin",unpin:"pin",mark_read:"mark_unread",mark_unread:"mark_read",archive:"unarchive",unarchive:"archive",show_pinned_message:"hide_pinned_message",hide_pinned_message:"show_pinned_message",show_bot_keyboard:"hide_bot_keyboard",hide_bot_keyboard:"show_bot_keyboard"},m=(e,t,s)=>{const{type:p}=t;switch(p){case"UserChangedConvo":{const{peerId:i,userAction:o}=t,{organisers:d}=e,u=e.viewer.id,p=g(t.userAction,i);if(e.locks.convoActions.has(p))return[];e.locks.convoActions.add(p);const h=e.convos.get(i),m=e.peers.get(i),f=e.ownerId;if(!h||!m)return[];let C;switch(o){case"pin":C=e=>e.fetch("messages.pinConversation",{peer_id:i});break;case"unpin":C=e=>e.fetch("messages.unpinConversation",{peer_id:i});break;case"mark_read":n.setPeerFlag(h,n.PEER_FLAGS.isMarkedUnread,!1),C=e=>e.fetch("messages.markAsRead",{peer_id:i,mark_conversation_as_read:1,group_id:(0,l.getOwnerGroupId)(f)});break;case"mark_unread":n.setPeerFlag(h,n.PEER_FLAGS.isMarkedUnread,!0),C=e=>e.fetch("messages.markAsUnreadConversation",{peer_id:i,group_id:(0,l.getOwnerGroupId)(f)});break;case"archive":case"unarchive":{const t="archive"===o;n.setPeerFlag(h,n.PEER_FLAGS.isArchived,t),a.refresh(d,h,s),t&&(e.onboardingTriggers.userArchivedChat=!0),C=e=>e.fetch(t?"messages.archiveConversation":"messages.unarchiveConversation",{peer_id:i});break}case"hide_pinned_message":"ChatConvo"===h.kind&&h.pinnedMessage&&e.hiddenPinnedMessages.set(t.peerId,h.pinnedMessage.cmid);break;case"show_pinned_message":e.hiddenPinnedMessages.delete(t.peerId);break;case"hide_bot_keyboard":e.hiddenBotKeyboards.add(t.peerId);break;case"show_bot_keyboard":e.hiddenBotKeyboards.delete(t.peerId);break;case"clear":C=e=>e.fetch("messages.deleteConversation",{peer_id:i,group_id:(0,l.getOwnerGroupId)(f)}).then((({last_deleted_id:e})=>Boolean(e)));break;case"leave":case"leave_and_clear":{if("ChatConvo"!==h.kind)break;C=e=>e.fetch("messages.removeChatUser",{chat_id:r.toRealId(i),user_id:r.toRealId(u),group_id:(0,l.getOwnerGroupId)(f)});const t=e.peers.get(i);if(!t||"Chat"!==t.kind)break;n.clearChatDataOnLeave(h),r.clearChatDataOnLeave(t);break}case"ban":if(!("User"===m.kind&&"UserConvo"===h.kind||"Group"===m.kind&&"GroupConvo"===h.kind))break;r.updateIsPeerBlacklistedByMe(m,!0),"UserConvo"===h.kind&&n.restrictViewerToWrite(h,"peer_blacklisted_by_me"),s.vkm_up_drafted_convos_in_list&&h.isDrafted&&(n.updateIsDrafted(h,!1),a.refresh(e.organisers,h,s)),C=r.isGroupPeerId(f)?e=>e.fetch("groups.ban",{owner_id:i,group_id:(0,l.getOwnerGroupId)(f)}):r.isGroupPeerId(i)?e=>e.fetch("messages.denyMessagesFromGroup",{group_id:r.toRealId(i)}):e=>e.fetch("account.ban",{owner_id:i});break;case"unban":if(!("User"===m.kind&&"UserConvo"===h.kind||"Group"===m.kind&&"GroupConvo"===h.kind))break;if(r.updateIsPeerBlacklistedByMe(m,!1),"UserConvo"===h.kind&&n.allowViewerToWrite(h),s.vkm_up_drafted_convos_in_list&&!h.isDrafted){const t=e.composerDrafts[i];t&&t[t.length-1]&&(n.updateIsDrafted(h,!0),a.refresh(e.organisers,h,s))}C=r.isGroupPeerId(f)?e=>e.fetch("groups.unban",{owner_id:i,group_id:(0,l.getOwnerGroupId)(f)}):r.isGroupPeerId(i)?e=>e.fetch("messages.allowMessagesFromGroup",{group_id:r.toRealId(i)}):e=>e.fetch("account.unban",{owner_id:i});break;case"return_to_chat":C=e=>e.fetch("messages.addChatUser",{chat_id:r.toRealId(i),user_id:r.toRealId(u)}).then((({result:e})=>Boolean(e)));break;case"finish_call":if(n.canFinishCall(h)){const e=h.activeCall.id;C=t=>t.fetch("messages.forceCallFinish",{call_id:e})}break;default:(0,c.exhaustivenessCheck)(o)}return[async function({api:e}){try{let t=!1;return C&&(t=!await C(e)),{type:"UserChangedConvo_RequestCompleted",hasFailed:t,userAction:o,peerId:i}}catch(e){return{type:"UserChangedConvo_RequestCompleted",hasFailed:!0,userAction:o,peerId:i}}}]}case"UserChangedConvo_RequestCompleted":{const{peerId:r,userAction:a,hasFailed:i}=t,d=g(a,r);e.locks.convoActions.delete(d);const l=h[a];if(i&&l)return m(e,{type:"UserChangedConvo",userAction:l,peerId:r},s),[];if(i)return[];switch(a){case"clear":case"pin":case"unpin":case"mark_read":case"mark_unread":case"unarchive":case"show_pinned_message":case"hide_pinned_message":case"show_bot_keyboard":case"hide_bot_keyboard":case"ban":case"unban":case"finish_call":return[];case"archive":{const t=e.convos.get(r);if(!t||"ChatConvo"!==t.kind||!t.unreadMentions.size)return[];const s=o.resolveCmid(Math.max(...t.unreadMentions));return[async function({storage:e}){const t=e.get("archive-mentions-map");return t&&s?(t[r]=s,e.set("archive-mentions-map",t),{type:"Noop"}):{type:"Noop"}}]}case"leave":{const t=e.convos.get(r);return"ChatConvo"===t?.kind&&n.setConvoState(t,"left"),[]}case"leave_and_clear":{const t=e.convos.get(r);return"ChatConvo"!==t?.kind?[]:(n.setConvoState(t,"left"),m(e,{type:"UserChangedConvo",userAction:"clear",peerId:r},s))}case"return_to_chat":{const t=e.convos.get(r);return"ChatConvo"===t?.kind&&n.setConvoState(t,"in"),[]}default:return(0,c.exhaustivenessCheck)(t)}}case"UserChangedMute":{const{peerId:s,timer:n,userAction:r}=t,a=g(t.userAction,s);if(e.locks.convoActions.has(a))return[];const i=e.convos.get(s);if(!i)return[];let o;switch(r){case"mute":i.push={mode:"every-mention",disabledUntil:1/0},o=-1;break;case"unmute":i.push={mode:"everything",disabledUntil:0},o=0;break;case"mute_until":i.push={mode:"every-mention",disabledUntil:Date.now()+1e3*n},o=n;break;default:(0,c.exhaustivenessCheck)(r)}return[async function({api:e}){try{return{type:"UserChangedMute_RequestCompleted",hasFailed:1!==await e.fetch("account.setSilenceMode",{time:o,peer_id:s,sound:"unmute"===r?1:0}),userAction:r,peerId:s}}catch(e){return{type:"UserChangedMute_RequestCompleted",hasFailed:!0,userAction:r,peerId:s}}}]}case"UserChangedMute_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a}=t,i=g(r,n);e.locks.convoActions.delete(i);const o={mute:"unmute",unmute:"mute",mute_until:"unmute"}[r];return a&&o?(m(e,{type:"UserChangedMute",userAction:o,peerId:n,timer:0},s),[]):[]}case"UserPinMessage":{const{peerId:s,cmid:r,userAction:a}=t,i=g(t.userAction,s);if(e.locks.convoActions.has(i))return[];e.locks.convoActions.add(i);const c=e.convos.get(s),u=e.ownerId;if(!c||"ChatConvo"!==c.kind)return[];const p=c.pinnedMessage&&(0,d.current)(c.pinnedMessage),h=n.findMessageByCmid(c,r);return"Normal"===h?.kind&&n.pinMessage(c,o.toPinned(h)),[async function({api:e}){try{return await e.fetch("messages.pin",{peer_id:s,cmid:r,group_id:(0,l.getOwnerGroupId)(u)}),{type:"UserPinMessage_RequestCompleted",hasFailed:!1,userAction:a,peerId:s,cmid:r}}catch(e){return{type:"UserPinMessage_RequestCompleted",hasFailed:!0,userAction:a,pinnedMessage:p,peerId:s,cmid:r}}}]}case"UserPinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,pinnedMessage:a,userAction:i}=t,o=g(i,s);e.locks.convoActions.delete(o);const c=e.convos.get(s);return c&&"ChatConvo"===c.kind?(r&&(n.unpinMessage(c),a&&n.pinMessage(c,a)),[]):[]}case"UserUnpinMessage":{const{peerId:s,userAction:r}=t,a=g(t.userAction,s);if(e.locks.convoActions.has(a))return[];const i=e.convos.get(s),o=e.ownerId;if(!i||"ChatConvo"!==i.kind)return[];const c=(0,d.current)(n.unpinMessage(i));return[async function({api:e}){try{return await e.fetch("messages.unpin",{peer_id:s,group_id:(0,l.getOwnerGroupId)(o)}),{type:"UserUnpinMessage_RequestCompleted",hasFailed:!1,userAction:r,peerId:s}}catch(e){return{type:"UserUnpinMessage_RequestCompleted",hasFailed:!0,userAction:r,prevPinnedMessage:c,peerId:s}}}]}case"UserUnpinMessage_RequestCompleted":{const{peerId:s,hasFailed:r,prevPinnedMessage:a,userAction:i}=t,o=g(i,s);e.locks.convoActions.delete(o);const c=e.convos.get(s);return c&&"ChatConvo"===c.kind?(r&&a&&n.pinMessage(c,a),[]):[]}case"UserChangedBusinessNotify":{const{userAction:s,peerId:n}=t,a=g(t.userAction,n);if(e.locks.convoActions.has(a))return[];const i=e.peers.get(n);return"Group"!==i?.kind||i.isBlacklistedByMe&&"business_notify_disable"===s||!i.isBlacklistedByMe&&"business_notify_enable"===s?[]:(r.updateIsPeerBlacklistedByMe(i,"business_notify_disable"===s),[async function({api:e}){try{return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:1!==await e.fetch("business_notify_disable"===s?"messages.denyMessagesFromGroup":"messages.allowMessagesFromGroup",{group_id:r.toRealId(n)}),userAction:s,peerId:n}}catch(e){return{type:"UserChangedBusinessNotify_RequestCompleted",hasFailed:!0,userAction:s,peerId:n}}}])}case"UserChangedBusinessNotify_RequestCompleted":{const{userAction:s,peerId:n,hasFailed:a}=t,i=g(s,n);e.locks.convoActions.delete(i);const o=e.peers.get(n);return"Group"!==o?.kind||a&&r.updateIsPeerBlacklistedByMe(o,!o.isBlacklistedByMe),[]}case"UserRestrictChatMemberToWrite":{const{userAction:s,chatId:n,memberId:r,duration:a}=t,o=e.convos.get(n);if(!o||"ChatConvo"!==o.kind)return[];const d=g(t.userAction,n);if(e.locks.convoActions.has(d))return[];switch(e.locks.convoActions.add(d),s){case"restrict_to_write":i.restrictMemberToWrite(o.members,r);break;case"allow_to_write":i.allowMemberToWrite(o.members,r);break;default:(0,c.exhaustivenessCheck)(s)}const l=o.peerId;return[async({api:e})=>{try{const t=await e.fetch("messages.changeConversationMemberRestrictions",{peer_id:l,member_ids:r.toString(),..."restrict_to_write"===s?{for:a,action:"ro"}:{action:"rw"}});return{type:"UserRestrictChatMemberToWrite_RequestCompleted",hasFailed:0!==t.failed_member_ids?.length,chatId:n,failedIds:t.failed_member_ids,userAction:s}}catch{return{type:"UserRestrictChatMemberToWrite_RequestCompleted",chatId:n,hasFailed:!0,failedIds:[],userAction:s}}}]}case"UserRestrictChatMemberToWrite_RequestCompleted":{const{hasFailed:s,userAction:n,failedIds:a,chatId:o}=t,d=g(n,o);e.locks.convoActions.delete(d);const l=e.convos.get(o);if(!l||"ChatConvo"!==l.kind)return[];if(s&&a.length)switch(n){case"restrict_to_write":a.forEach((e=>{i.allowMemberToWrite(l.members,r.resolveId(e))}));break;case"allow_to_write":a.forEach((e=>{i.restrictMemberToWrite(l.members,r.resolveId(e))}));break;default:(0,c.exhaustivenessCheck)(n)}return[]}case"UserChangeForbidWritingAll":{const{peerId:s,duration:a,userAction:i}=t,o=g(t.userAction,s);if(e.locks.convoActions.has(o))return[];const d=e.convos.get(s);if(!d||"ChatConvo"!==d.kind)return[];switch(i){case"forbid_writing_all":n.forbidWritingForAll(d,!0);break;case"allow_writing_all":d.forbidedWritingForAll=void 0;break;case"forbid_writing_all_until":n.forbidWritingForAll(d,!0,Date.now()+1e3*a);break;default:(0,c.exhaustivenessCheck)(i)}const u=r.toRealId(s),p=e.ownerId;return[async function({api:e}){try{return{type:"UserChangeForbidWritingAll_RequestCompleted",hasFailed:1!==await("allow_writing_all"===i?e.fetch("messages.enableChatWriting",{chat_id:u,group_id:(0,l.getOwnerGroupId)(p)}):e.fetch("messages.disableChatWriting",{chat_id:u,group_id:(0,l.getOwnerGroupId)(p),duration_sec:a===1/0?0:Math.round(a/1e3)})),userAction:i,peerId:s}}catch(e){return{type:"UserChangeForbidWritingAll_RequestCompleted",hasFailed:!0,userAction:i,peerId:s}}}]}case"UserChangeForbidWritingAll_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a}=t,i=g(r,n);e.locks.convoActions.delete(i);const o={forbid_writing_all:"allow_writing_all",allow_writing_all:"forbid_writing_all",forbid_writing_all_until:"allow_writing_all"}[r];return a&&o?(m(e,{type:"UserChangeForbidWritingAll",userAction:o,peerId:n,duration:1/0},s),[]):[]}case"UserChangedStickersPopupAutoplay":{const{peerId:e,userAction:s}=t,n="on_stickers_popup_animation"===s?1:0;return[async function({api:t}){try{const r=await t.fetch("stickers.setPopupSettings",{name:"autoplay_disabled_peer_ids",value:n,chat_id:e});return{type:"UserChangedStickersPopupAutoplay_RequestCompleted",peerId:e,response:r,userAction:s}}catch{return{type:"Noop"}}}]}case"UserChangedStickersPopupAutoplay_RequestCompleted":{const{response:s,peerId:r,userAction:a}=t,i=e.convos.get(r);if(!i)return[];const o="off_stickers_popup_animation"===a;return n.updateIsStickersPopupAutoplayDisabledByUser(i,o),s.popup&&(0,u.setDisabledPeerIdsByUser)(s.popup.autoplay.disabled_peer_ids),[]}default:(0,c.exhaustivenessCheck)(t)}},g=(e,t)=>`${p[e]}-${t.toString()}`},134649:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(175953),r=s(401193);const a=(e,t)=>{switch(t.type){case"UserChangedFriendship":{const s=e.peers.get(t.userId);if("User"!==s?.kind||e.locks.updateFriendshipOrMembership.has(s.id))return[];const r=s.friendship;return n.updateFriendship(s,t.change),r===s.friendship?[]:(e.locks.updateFriendshipOrMembership.add(s.id),[async function({api:e}){let s=!1;try{await e.fetch(`friends.${t.change}`,{user_id:n.toRealId(t.userId)})}catch(e){s=!0}return{type:"UserChangedFriendship_RequestCompleted",userId:t.userId,change:t.change,hasFailed:s}}])}case"UserChangedFriendship_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.userId);const s=e.peers.get(t.userId);return"User"!==s?.kind||t.hasFailed&&n.updateFriendship(s,{add:"delete",delete:"add"}[t.change]),[]}default:return(0,r.exhaustivenessCheck)(t)}}},861556:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(175953),r=s(401193);const a=(e,t)=>{switch(t.type){case"UserChangedGroupMembership":{const s=e.peers.get(t.groupId);if("Group"!==s?.kind||e.locks.updateFriendshipOrMembership.has(s.id))return[];const r=s.membership;return n.updateMembership(s,t.change),r===s.membership?[]:(e.locks.updateFriendshipOrMembership.add(s.id),[async function({api:e}){const s=`groups.${t.change}`;let n=!1;try{await e.fetch(s,{group_id:-t.groupId})}catch(e){n=!0}return{type:"UserChangedGroupMembership_RequestCompleted",groupId:t.groupId,change:t.change,hasFailed:n}}])}case"UserChangedGroupMembership_RequestCompleted":{e.locks.updateFriendshipOrMembership.delete(t.groupId);const s=e.peers.get(t.groupId);return"Group"!==s?.kind||t.hasFailed&&n.updateMembership(s,{join:"leave",leave:"join"}[t.change]),[]}default:return(0,r.exhaustivenessCheck)(t)}}},933112:(e,t,s)=>{"use strict";s.d(t,{handler:()=>m});var n=s(679005),r=s(649166),a=s(856562),i=s(84113),o=s(401193),c=s(6016),d=s(777211),l=s(810704),u=s(726478);const p={mark_important:"unmark_important",unmark_important:"mark_important"},h={delete:"delete",restore:"restore",mark_important:"mark_important",unmark_important:"mark_important"},m=(e,t,s)=>{const{type:h}=t;switch(h){case"UserChangedMessage":{const{peerId:s,userAction:r,cmids:i}=t;for(let t=0;t<i.length;t+=1){const n=i[t];if(!n)return[];const a=g(r,s,n);if(e.locks.messageActions.has(a))return[];e.locks.messageActions.add(a)}const d=e.convos.get(s);let l;switch(r){case"mark_important":case"unmark_important":i.forEach((t=>{if(d){const e=(0,n.castDraft)(a.findMessageByCmid(d,t));"Normal"===e?.kind&&(e.isImportant="mark_important"===r)}const i=e.importantMessages.messages.get((0,c.getImportantMessageKey)(s,t));i&&(i.isImportant="mark_important"===r)})),l=e=>e.fetch("messages.markAsImportant",{peer_id:s,cmids:i.join(","),important:"mark_important"===r?1:0}).then((e=>Boolean(e.marked.length)));break;default:(0,o.exhaustivenessCheck)(r)}return[async function({api:e}){try{let t=!1;return l&&(t=!await l(e)),{type:"UserChangedMessage_RequestCompleted",hasFailed:t,userAction:r,cmids:i,peerId:s}}catch(e){return{type:"UserChangedMessage_RequestCompleted",hasFailed:!0,userAction:r,cmids:i,peerId:s}}}]}case"UserChangedMessage_RequestCompleted":{const{peerId:n,userAction:r,hasFailed:a,cmids:i}=t;i.forEach((t=>{const s=g(r,n,t);e.locks.messageActions.delete(s)}));const o=p[r];return a&&o&&m(e,{type:"UserChangedMessage",userAction:o,peerId:n,cmids:i},s),[]}case"UserDeleteMessage":{const{deleteType:s,peerId:n,userAction:i,messages:c}=t,l=e.ownerId,u=e.convos.get(n);if(!u)return[];const p=new Map,h="spam"===s?t.reason:void 0,m=c.length>5;for(let t=0;t<c.length;t+=1){const d=c[t];if(!d||"Normal"!==d.kind)return[];const l=g(i,n,d.cmid);if(e.locks.messageActions.has(l))return[];e.locks.messageActions.add(l),p.set(d.cmid,d);const h=a.isCasper(u)||r.isCall(d)||m;switch(s){case"local":case"spam":if(h){a.deleteMessage(u,d,{isRestorable:!1});break}a.deleteMessage(u,d,{isRestorable:!0,isSpam:"spam"===s});break;case"for_all":a.deleteMessage(u,d,{isRestorable:!1});break;default:(0,o.exhaustivenessCheck)(s)}}return[async function({api:e}){try{const t=100,a=c.reduce(((e,s,n)=>{const r=Math.floor(n/t);return e[r]||(e[r]=[]),e[r]?.push(s.cmid),e}),new Array),o=await e.fetchMany(a.map((e=>({method:"messages.delete",params:{peer_id:n,cmids:e.join(","),delete_for_all:"for_all"===s?1:0,spam:"spam"===s?1:0,group_id:(0,d.getOwnerGroupId)(l),reason:h}})))),u=[];return o.forEach(((e,t)=>{if(!1===e){const e=a[t];e&&u.push(...e)}else e.forEach((e=>{if(1!==e.response){const t=r.resolveCmid(e.conversation_message_id);0!==t&&u.push(t)}}))})),{type:"UserDeleteMessage_RequestCompleted",hasFailed:!1,failedCmids:u,userAction:i,deleteType:s,peerId:n,messages:c,deletedMessages:p}}catch(e){return{type:"UserDeleteMessage_RequestCompleted",hasFailed:!0,failedCmids:[],userAction:i,deleteType:s,peerId:n,messages:c,deletedMessages:p}}}]}case"UserDeleteFailedMessage":{const{peerId:r,randomId:i}=t,o=e.convos.get(r);if(!o)return[];a.removePending(o,i),u.refresh(e.organisers,o,s);const c=(0,n.current)(o);return[async({storage:e})=>((0,l.saveConvosFailedMessagesInStorage)(c,e),{type:"Noop"})]}case"UserDeleteAllFailedMessage":{const{peerId:s}=t,r=e.convos.get(s);if(!r)return[];a.allQueuedMessages(r).filter((e=>e.hasFailed)).forEach((e=>{a.removePending(r,e.randomId)}));const i=(0,n.current)(r);return[async({storage:e})=>((0,l.saveConvosFailedMessagesInStorage)(i,e),{type:"Noop"})]}case"UserDeleteMessage_RequestCompleted":{const{peerId:s,userAction:n,messages:r,failedCmids:i,hasFailed:o,deletedMessages:c}=t,d=e.convos.get(s);return d&&(o?c.forEach((e=>{a.restoreMessage(d,e,!1)})):i.forEach((e=>{const t=c.get(e);t&&a.restoreMessage(d,t,!1)}))),r.forEach((({cmid:t})=>{const r=g(n,s,t);e.locks.messageActions.delete(r)})),[async()=>({type:"Noop"})]}case"UserRestoreMessage":{const{peerId:s,userAction:n,cmid:r}=t,o=g(n,s,r);if(e.locks.messageActions.has(o))return[];e.locks.messageActions.add(o);const c=e.convos.get(s);if(!c)return[];const l=e.ownerId,u=i.findNodeByCmid(c.history,r).node;return"DeletedNode"===u?.kind&&a.restoreMessage(c,u.restorable,!1),[async function({api:e}){try{const t=await e.fetch("messages.restore",{peer_id:s,cmid:r,group_id:(0,d.getOwnerGroupId)(l)});return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!Boolean(t),userAction:n,peerId:s,cmid:r}}catch(e){return{type:"UserRestoreMessage_RequestCompleted",hasFailed:!0,userAction:n,peerId:s,cmid:r}}}]}case"UserRestoreMessage_RequestCompleted":{const{peerId:n,userAction:r,cmid:i,hasFailed:o}=t,c=g(r,n,i);e.locks.messageActions.delete(c);const d=e.convos.get(n);if(void 0===d)return[];const l=a.findMessageByCmid(d,i);return o&&"Normal"===l?.kind&&m(e,{type:"UserDeleteMessage",messages:[l],deleteType:"local",peerId:n,userAction:"delete"},s),[]}default:(0,o.exhaustivenessCheck)(t)}},g=(e,t,s)=>`${h[e]}-${t.toString()}-${s.toString()}`},257209:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(946990),r=s(401193),a=s(856562);const i=(e,t)=>{switch(t.type){case"UserChangedMessageAttachment":return[async function({api:e}){try{const s=(await e.fetch("messages.getByConversationMessageId",{peer_id:t.peerId,conversation_message_ids:t.cmid.toString(),extended:1,group_id:t.groupId||0},{retries:3})).items[0];return s?{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!1,peerId:t.peerId,apiMessage:s}:{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedMessageAttachment_RequestCompleted",hasFailed:!0}}}];case"UserChangedMessageAttachment_RequestCompleted":{if(t.hasFailed)return[];const{message:s,mentions:r}=(0,n.fromApiMessage)(t.apiMessage),i=e.convos.get(t.peerId);return i?(a.replaceMessage(i,s,r.hasDirect||r.hasMass),[]):[]}default:(0,r.exhaustivenessCheck)(t)}}},458123:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(175953),a=s(856562),i=s(726478),o=s(679005);const c=(e,t,s)=>{const{type:c}=t,{viewer:d}=e,l=d.id;switch(c){case"UserSentMessageRequest":{const{peerId:s}=t;return e.locks.changeMessageRequest.has(s)?[]:(e.locks.changeMessageRequest.add(s),[async function({api:e}){try{return await e.fetch("messages.sendMessageRequest",{peer_id:s}),{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}catch(e){return{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}}])}case"UserAcceptedChatMessageRequest":{const{peerId:s}=t;return e.locks.changeMessageRequest.has(s)?[]:(e.locks.changeMessageRequest.add(s),[async function({api:e}){try{return await e.fetch("messages.acceptMessageRequest",{peer_id:s,user_id:r.toRealId(l)}),{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}catch(e){return{type:"UserAcceptedChatMessageRequest_RequestCompleted",peerId:s}}}])}case"UserRejectedMessageRequest":{const{peerId:n,isSpam:c,isNewMR:d=!1}=t,u=e.convos.get(n),p=(0,o.current)(u);if("MessageRequestChatConvo"!==u?.kind&&"MessageRequestUserConvo"!==u?.kind&&"UserConvo"!==u?.kind)return[];if(e.locks.changeMessageRequest.has(n))return[];if(e.locks.changeMessageRequest.add(n),s.vkm_edu_message_request&&d);else{const t=a.rejectMR(u);e.convos.set(n,t),i.refresh(e.organisers,t,s)}return[async function({api:e}){try{return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:1!==await e.fetch("messages.rejectMessageRequest",{peer_id:n,user_id:r.toRealId(l),spam:c?1:0}),peerId:n,prevConvo:p,isNewMR:d}}catch(e){return{type:"UserRejectedChatMessageRequest_RequestCompleted",hasFailed:!0,peerId:n,prevConvo:p,isNewMR:d}}}]}case"UserAcceptedChatMessageRequest_RequestCompleted":case"UserSentMessageRequest_RequestCompleted":{const{peerId:s}=t;return e.locks.changeMessageRequest.delete(s),[]}case"UserRejectedChatMessageRequest_RequestCompleted":{const{prevConvo:n,hasFailed:r,peerId:a,isNewMR:o}=t;return e.locks.changeMessageRequest.delete(a),s.vkm_edu_message_request&&o||r&&void 0!==n&&(e.convos.set(a,n),i.refresh(e.organisers,n,s)),[]}default:(0,n.exhaustivenessCheck)(c)}}},774744:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(401193),r=s(103026),a=s(302551),i=s(841093);const o=(e,t)=>{switch(t.type){case"UserChangedPostAttachment":{const{channelId:e,cmid:s}=t;return[async function({api:t}){try{const n=await t.fetch("channels.getMessagesById",{channel_id:e,cmids:s.toString(),extended:1},{retries:3}),r=n.items?.[0];return r?{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!1,channelId:e,apiPost:r}:{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}catch(e){return{type:"UserChangedPostAttachment_RequestCompleted",hasFailed:!0}}}]}case"UserChangedPostAttachment_RequestCompleted":{if(t.hasFailed)return[];const{apiPost:s,channelId:n}=t,o=e.channels.get(n);if(!o)return[];if("ChannelRestricted"===o.kind)return[];const{post:c,reactions:d}=(0,i.fromApiPost)(s),l=r.findPostByCmid(o,c.cmid),u=a.merge(c,"Node"===l?.kind?l.item:void 0);for(const t of d)e.reactionsOld.set(t.id,t);return r.replacePost(o,u),[]}default:(0,n.exhaustivenessCheck)(t)}}},849939:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(679005);const a=(e,t)=>{switch(t.type){case"UserChangedPushSetting":{const{setting:s,value:n}=t;e.viewer.settings.push[s]=n;const a=(0,r.current)(e.viewer.settings.push);return[async function({storage:e}){return e.set("settings-push",a),{type:"UserChangedPushSetting_RequestCompleted",hasFailed:!1,setting:s,value:n}}]}case"UserChangedPushSetting_RequestCompleted":return t.hasFailed,[];default:(0,n.exhaustivenessCheck)(t)}}},277383:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(843779);const a=(e,t)=>{const{type:s}=t;switch(s){case"UserChangedSetting":{const s=t.setting;if(e.locks.settings.has(s))return[];e.locks.settings.add(s);const a=e.viewer.settings[t.setting];return e.viewer.settings[t.setting]=t.value,[async function(e){try{const s=await function({env:e,setting:t,value:s}){const{api:r,storage:a}=e;switch(t){case"ctrSubmit":return r.fetch("account.setInfo",{name:"messages_multiline_input",value:String(Number(s))},{retries:3});case"soundNotifications":return"boolean"==typeof s&&a.set("settings-sound-notifications-on",s),Promise.resolve(1);case"eduAccountSwitchBanner":return r.fetch("messages.setConfig",{config:JSON.stringify({edu_account_switch_banner:Number(s)})},{retries:3});case"showRecommendations":return r.fetch("account.setInfo",{name:"messages_recommendation_list_hidden",value:String(Number(!s))},{retries:3});case"countOnlyNotMuted":return r.fetch("account.setInfo",{name:"show_only_not_muted_messages",value:String(Number(s))},{retries:3});case"autoUnarchive":return r.fetch("account.setInfo",{name:"messages_auto_unarchive",value:String(Number(s))},{retries:3});case"transcriptAutoShow":return r.fetch("account.setInfo",{name:"messages_transcript_auto_show",value:String(Number(s))},{retries:3});case"verticalFoldersView":return r.fetch("messages.setConfig",{config:JSON.stringify({vertical_folders_view:Number(s)})},{retries:3});case"messageReactionAnimation":return r.fetch("messages.setConfig",{config:JSON.stringify({message_reactions_animation:Number(s)})},{retries:3});case"fastActionsTrigger":{let e="hover_and_right_button_click";switch(s){case"hover":case!1:e="hover";break;case"rightClick":case!0:e="right_button_click";break;default:e="hover_and_right_button_click"}return r.fetch("messages.setConfig",{config:JSON.stringify({fast_action_type:e})},{retries:3})}case"autoExtendReactionPicker":return r.fetch("messages.setConfig",{config:JSON.stringify({auto_extend_reactions_picker:Number(s)})},{retries:3});case"showThemeStyles":return"boolean"==typeof s&&a.set("settings-show-theme-styles",s),Promise.resolve(1);case"callsEnabled":return"boolean"==typeof s&&a.set("settings-calls-enabled",s),Promise.resolve(1);case"convoListWidthPercent":return r.fetch("messages.setConfig",{config:JSON.stringify({chat_list_collapse:Number(s)})},{retries:3});case"videoMessageAutoplay":return"boolean"==typeof s&&a.set("video-message-autoplay",s),Promise.resolve(1);default:(0,n.exhaustivenessCheck)(t)}}({env:e,setting:t.setting,value:t.value}),i=1===s||void 0!==s.version;if("transcriptAutoShow"===t.setting&&i&&e.stats.logEvent({type:"type_action",type_action:{type:"type_settings_changes_item",type_settings_changes_item:{type:"general",name:"voice_transcription_autoshow",value_old:String(Number(a)),value_new:String(Number(t.value)),screen:"im_web_settings"}}}),"messageReactionAnimation"===t.setting&&i&&e.stats.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:"REACT_ANIMATION",label:t.value?"ON":"OFF"}}}),i&&"callsEnabled"===t.setting&&(t.value?e.calls?.init?.():e.calls?.dispose()),i&&"reduced_motion"!==t.entrypoint&&r.isReducedMotionSetting(t.setting)){const s=e.storage.get("prev-reduced-motion-settings");s&&e.storage.set("prev-reduced-motion-settings",{...s,[t.setting]:t.value})}return{type:"UserChangedSetting_RequestCompleted",hasFailed:!i,setting:t.setting,value:t.value,previousValue:a}}catch(e){return{type:"UserChangedSetting_RequestCompleted",hasFailed:!0,setting:t.setting,value:t.value,previousValue:a}}}]}case"UserChangedSetting_RequestCompleted":{const s=t.setting;if(e.locks.settings.delete(s),t.hasFailed)return e.viewer.settings[t.setting]=t.previousValue,[];if("eduAccountSwitchBanner"===t.setting){const s=e.viewer,n=r.isEdu(s.profileType);return[async function(e){return e.stats.logEvent({type:"general",name:n?"go_to_messenger_banner":"go_to_sferum_banner",value_new:t.value?"enable":"disable",value_old:t.value?"disable":"enable"}),{type:"Noop"}}]}return[]}default:(0,n.exhaustivenessCheck)(s)}}},626261:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(254335),r=s(596917),a=s(401193);const i=(e,t)=>{switch(t.type){case"UserChangedSpace":{const{spaceId:s,description:a,name:i}=t,o=e.spaces.get(s);if(!o)return[];const c=i?o.name:void 0,d=void 0!==a?o.description:void 0;return i&&n.setName(o,i),void 0!==a&&n.setDescription(o,r.fromClientText(a)),[async function({api:e}){try{const t={space_id:s,description:a,name:i},n=await e.fetch("spaces.edit",t);return{type:"UserChangedSpace_RequestCompleted",spaceId:s,hasFailed:!n,prevDescription:d,prevName:c}}catch(e){return{type:"UserChangedSpace_RequestCompleted",spaceId:s,hasFailed:!0,prevDescription:d,prevName:c}}}]}case"UserChangedSpace_RequestCompleted":{const{hasFailed:s,spaceId:r,prevDescription:a,prevName:i}=t,o=e.spaces.get(r);return o&&s?(i&&n.setName(o,i),void 0!==a&&n.setDescription(o,a),[]):[]}default:(0,a.exhaustivenessCheck)(t)}}},130920:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(679005),r=s(401193);const a=(e,t)=>{switch(t.type){case"UserChangedSpaceMute":{const{spaceId:s,muteTill:r,useSound:a}=t;if(e.locks.spacesSetSettings.has(s))return[];const i=e.spaces.get(s);if(!i)return[];e.locks.spacesSetSettings.add(s);const o=(0,n.current)(i.viewerData.notificationSettings),c={muteTill:void 0!==r?r:i.viewerData.notificationSettings.muteTill,useSound:void 0!==a?a:i.viewerData.notificationSettings.useSound};return i.viewerData.notificationSettings=c,[async function({api:e}){try{const t=await e.fetch("spaces.setSpaceSettings",{space_id:s,mute_till:Math.floor(c.muteTill>0?c.muteTill/1e3:c.muteTill),use_sound:c.useSound?1:0});return{type:"UserChangedSpaceMute_RequestCompleted",spaceId:s,prev:o,response:t}}catch(e){return{type:"UserChangedSpaceMute_RequestCompleted",spaceId:s,prev:o}}}]}case"UserChangedSpaceMute_RequestCompleted":{const{spaceId:s,prev:n,response:r}=t;e.locks.spacesSetSettings.delete(s);const a=e.spaces.get(s);return a?(r||(a.viewerData.notificationSettings=n),[]):[]}default:return(0,r.exhaustivenessCheck)(t)}}},596431:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(164231);const a={delete:"delete",report:"report",restore:"restore"},i=(e,t,s)=>{const{type:a,videoId:c,commentCmid:d,userAction:l}=t,u=o(l.kind,c,d),p=e.videoConvos.get(c),h=p?.comments.find((e=>e.cmid===d));if(!p||!h)return[];const m=p.ownerId;switch(a){case"UserChangedVideoComment":{if(e.locks.videoCommentActions.has(u))return[];let t,s;switch(e.locks.videoCommentActions.add(u),l.kind){case"delete":if("Normal"!==h.kind)break;r.deleteComment(p,d),t=e=>e.fetch("video.deleteComment",{owner_id:m,comment_id:d}).then((e=>Boolean(e)));break;case"restore":r.restoreComment(p,d),t=e=>e.fetch("video.restoreComment",{owner_id:m,comment_id:d}).then((e=>Boolean(e)));break;case"report":if("Normal"!==h.kind)break;r.deleteComment(p,d),t=e=>e.fetch("video.reportComment",{owner_id:m,comment_id:d,reason:l.reason}).then((e=>Boolean(e))),s=l.onSuccess;break;default:(0,n.exhaustivenessCheck)(l)}return[async function({api:e}){try{let n=!1;if(t){n=!await t(e)}return{type:"UserChangedVideoComment_RequestCompleted",videoId:c,commentCmid:d,hasFailed:n,userAction:l,onSuccess:s}}catch(e){return{type:"UserChangedVideoComment_RequestCompleted",videoId:c,commentCmid:d,hasFailed:!0,userAction:l}}}]}case"UserChangedVideoComment_RequestCompleted":{const{hasFailed:r,onSuccess:a}=t;if(e.locks.videoCommentActions.delete(u),r){let t;switch(l.kind){case"delete":case"report":t={kind:"restore"};break;case"restore":t={kind:"delete"};break;default:(0,n.exhaustivenessCheck)(l)}t&&i(e,{type:"UserChangedVideoComment",userAction:t,videoId:c,commentCmid:d},s),e.locks.videoCommentActions.delete(u)}return a?.(),[]}default:(0,n.exhaustivenessCheck)(t)}},o=(e,t,s)=>`${a[e]}-${t}-${s}`},719240:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(103026),r=s(401193);const a=(e,t)=>{if("UserClosedChannelPostponed"===t.type){const{channelId:s}=t,r=e.channels.get(s);return r&&"ChannelRestricted"!==r.kind?(n.resetPostponed(r),[]):[]}(0,r.exhaustivenessCheck)(t.type)}},742315:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(728921),r=s(401193),a=s(777211),i=s(512871);const o=(e,t,s)=>{if("UserCreatedFolder"===t.type){const r=(0,a.insertFolders)(e,[(0,i.fromApiFolder)({id:t.folderId,name:t.name,type:t.folderType,flags:n.convertFlags({type:t.folderType,hasSublist:!1})})]),o=(0,a.getConvosByIds)(e,t.peerIds);return(0,a.addConvosToFolder)(e,t.folderId,o,s),s.vkm_new_convo_folder_logic||r[0]&&"default"===t.folderType&&n.setHasMore(r[0],"all",!1),[]}(0,r.exhaustivenessCheck)(t.type)}},246622:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t,s)=>{if("UserCreatedSpaceRoom"===t.type){const n=e.spaces.get(t.spaceId);return n&&"Space"===n.kind&&n.rooms.set(t.room.id,t.room),(0,r.insertSpaceCalls)(e,t.calls||[]),(0,r.insertSpaceTribunes)(e,t.tribunes||[]),(0,r.insertConvos)(e,t.conversations||[],s),(0,r.insertPeers)(e,{apiUsers:t.profiles||[],apiGroups:t.groups||[],apiContacts:[]}),[]}(0,n.exhaustivenessCheck)(t.type)}},558434:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{if("UserCreatedSpaceSection"===t.type){const s=e.spaces.get(t.spaceId);return s&&"Space"===s.kind&&s.sections.set(t.section.id,t.section),[]}(0,n.exhaustivenessCheck)(t.type)}},688494:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(728921),r=s(856562),a=s(401193);const i=(e,t,s)=>{switch(t.type){case"UserDeletedFolder":{const{folderId:a}=t;if(e.locks.deleteFolder.has(a))return[];if(e.locks.deleteFolder.add(a),n.deleteFolder(e.organisers.folders,a),!s.vkm_new_convo_folder_logic)for(const t of e.convos.values())r.removeFolder(t,a);return[async function({api:e}){try{return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:1!==await e.fetch("messages.deleteFolder",{folder_id:a}),folderId:a}}catch(e){return{type:"UserDeletedFolder_DeleteRequestCompleted",hasFailed:!0,folderId:a}}}]}case"UserDeletedFolder_DeleteRequestCompleted":{const{hasFailed:s,folderId:n}=t;if(e.locks.deleteFolder.delete(n),s&&a.isDev)throw new Error("Не удалось удалить папку");return[]}default:(0,a.exhaustivenessCheck)(t)}}},214078:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(856562),r=s(520828);const a=(e,t)=>{if("UserHaveSeenPopupAnimation"===t.type){const{message:s}=t,a=e.convos.get(s.peerId);if(!a)return[];let i;return i="Queued"===s.kind?n.findMessageByRandomId(a,s.randomId):n.findMessageByCmid(a,s.cmid),i?(r.toggleStickerIsPopupAutoplayed(i,!0),[]):[]}return[]}},230378:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{if("UserHideConversationsBar"===t.type){if(!e.conversationsBar)return[];const{name:s}=t;return e.conversationsBar.name!==s?[]:(delete e.conversationsBar,[async function({api:e}){try{await e.fetch("messages.conversationBarHide",{name:s})}catch{}return{type:"Noop"}}])}(0,n.exhaustivenessCheck)(t.type)}},981758:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(856562);const a=(e,t)=>{if("UserHideConvoBanner"===t.type){const{peerId:s,name:n}=t,a=r.safeGet(e.convos,s);return r.hideBanner(a),[async function({api:e}){try{await e.fetch("messages.conversationBarHide",{name:n,peer_id:s})}catch{}return{type:"Noop"}}]}(0,n.exhaustivenessCheck)(t.type)}},808277:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(211274),r=s(401193);const a=(e,t)=>{switch(t.type){case"UserHideFilter":return"businessNotify"===t.kind?e.organisers.filters.businessNotify.unreadCount>0?[]:[async function({storage:e}){return e.set("business-notify-manually-hidden",!0),{type:"UserHideFilter_Completed",kind:"businessNotify"}}]:"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserHideFilter_Completed":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!1),[]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserUndoHideFilter":return"businessNotify"===t.kind?(n.toggleBusinessNotifyVisibility(e.organisers.filters,!0),[async function({storage:e}){return e.set("business-notify-manually-hidden",!1),{type:"Noop"}}]):"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);case"UserActualizeHideFilter":if("businessNotify"===t.kind){const t=e.organisers.filters.businessNotify.unreadCount,{isHidden:s}=e.organisers.filters.businessNotify;return[async function({storage:e}){const n=e.get("business-notify-manually-hidden");return n&&!s?{type:"UserHideFilter",kind:"businessNotify"}:!n&&s?{type:"UserUndoHideFilter",kind:"businessNotify"}:0===t?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}}]}return"all"===t.kind||"unread"===t.kind||"chats"===t.kind||"messageRequest"===t.kind||"archive"===t.kind?[]:(0,r.exhaustivenessCheck)(t.kind);default:(0,r.exhaustivenessCheck)(t)}}},273803:(e,t,s)=>{"use strict";s.d(t,{handler:()=>p});var n=s(84113),r=s(302551),a=s(136872),i=s(520828),o=s(401193),c=s(73514),d=s(497706),l=s(795412),u=s(777211);const p=(e,t)=>{const{channelId:s,postCmid:p,replyCmid:m}=t,g=h(s,p),f=e.channels.get(s);if(!f||"ChannelRestricted"===f.kind)return[];const C=n.findNodeByCmid(f.history,p).node,v="Node"===C?.kind&&C.item;if(!v)return[];const y=m&&(r.findCommentByCmid(v,m)?.rootCmid||m),_=(0,d.getCommentsHistoryLockKey)(s,p,v.comments.order,y);switch(t.type){case"UserHitCommentSend":{const{text:n,attaches:r,extra:a,fromGroupId:o,onComplete:c,onFail:d}=t,l=i.ids(r).join(",");return n||l||a?.sticker?e.locks.sendComment.has(g)?[]:(e.locks.sendComment.add(g),[async function({api:e}){try{c?.();return{type:"UserHitCommentSend_RequestCompleted",hasFailed:!1,response:await e.fetch("wall.createComment",{owner_id:s,post_id:p,message:n,attachments:l,reply_to_comment:m,sticker_id:a?.sticker?.id,sticker_referrer:a?.sticker?.referrer,from_group:o?Math.abs(o):void 0}),channelId:s,postCmid:p,replyCmid:m,text:n,attaches:r,fromGroupId:o}}catch(e){return d?.(e),{type:"UserHitCommentSend_RequestCompleted",hasFailed:!0,channelId:s,postCmid:p,replyCmid:m,text:n,attaches:r,fromGroupId:o}}}]):[]}case"UserHitCommentSend_RequestCompleted":{const{text:n,attaches:i,hasFailed:o,response:l,fromGroupId:u}=t;if(o)return e.locks.sendComment.delete(g),[];const h=y?r.findCommentByCmid(v,y)?.replies:v.comments;if(!h)return[];const f=a.resolveCmid(l.comment_id);if(h.nextFrom){e.locks.getPostCommentsHistory.add(_);const t=(0,d.mapOrderToSort)(v.comments.order);return[async function({api:e}){try{return{type:"UserHitCommentSend_HistoryRequestCompleted",hasFailed:!1,response:await e.fetch("wall.getComments",{owner_id:s,post_id:p,count:c.COMMENTS_PER_PAGE,thread_items_count:c.THREAD_COMMENTS_COUNT,need_likes:1,extended:1,sort:t,start_comment_id:f,comment_id:y,offset:1-c.COMMENTS_PER_PAGE}),channelId:s,postCmid:p,rootCommentCmid:y,newCommentCmid:f,replyCmid:m}}catch(e){return{type:"UserHitCommentSend_HistoryRequestCompleted",hasFailed:!0,channelId:s,postCmid:p,rootCommentCmid:y,newCommentCmid:f,replyCmid:m}}}]}e.locks.sendComment.delete(g);const C=!!i.sticker||!!i.ugcSticker,k=a.newNormal({canEdit:!C,channelId:s,postCmid:p,sentAt:Date.now(),rootCmid:y,cmid:f,peerId:u||e.ownerId,attaches:i,canDelete:!0},n);if(y){const e=r.findCommentByCmid(v,y);if(!e)return[];e.replies.history=[...e.replies.history,k],e.replies.count+=1}else v.comments.history=[...v.comments.history,k],v.comments.count+=1,v.comments.oneLevelCount+=1;return v.comments.lastSendCmid=f,[]}case"UserHitCommentSend_HistoryRequestCompleted":{const{hasFailed:n,response:a,newCommentCmid:i}=t;if(e.locks.sendComment.delete(g),e.locks.getPostCommentsHistory.delete(_),n)return[];const o=a.items.map((e=>(0,l.fromApiComment)(e,s,p)));if(y){const e=r.findCommentByCmid(v,y);if(!e)return[];e.replies={...e.replies,count:a.current_level_count||0,history:o,nextFrom:a.next_from,prevFrom:a.prev_from}}else v.comments={...v.comments,history:o,count:a.count,oneLevelCount:a.current_level_count||0,nextFrom:a.next_from,prevFrom:a.prev_from};return v.comments.lastSendCmid=i,(0,u.insertPeers)(e,{apiUsers:a.profiles||[],apiGroups:a.groups||[],apiContacts:[]}),[]}default:(0,o.exhaustivenessCheck)(t)}},h=(e,t)=>`${e}-${t}`},316034:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(401193),r=s(679005),a=s(649166),i=s(856562),o=s(520828),c=s(777211);const d=(e,t)=>{switch(t.type){case"UserHitEdit":{const{cmid:s,text:n,attaches:r,peerId:d,keepForwarded:l,skipCheckChanges:u}=t,p=e.convos.get(d),h=e.ownerId;if(!p)return[];const m=i.findMessageByCmid(p,s);if(!u&&"Normal"===m?.kind&&!a.checkMessageHasChanged({draft:{text:n,attaches:r,keepForwarded:l},message:m}))return[];"Normal"===m?.kind&&a.edit(m,{text:n,attaches:r,keepForwarded:l}),e.locks.edit.add(d);const g=o.ids(r).join(",");return[async function({api:e}){let t=!1;try{await e.fetch("messages.edit",{cmid:s,peer_id:d,message:n,attachment:0===g.length?void 0:g,group_id:(0,c.getOwnerGroupId)(h),keep_forward_messages:l?1:0,keep_snippets:r.link||r.inviteLink||r.donutLink||r.stickerPack||r.miniApps?1:0,lat:r.geo?.coordinates.latitude,long:r.geo?.coordinates.longitude})}catch(e){t=!0}return{type:"UserHitEdit_RequestCompleted",peerId:d,cmid:s,hasFailed:t}}]}case"UserHitEdit_Resend":{const{cmid:s,peerId:n}=t,o=e.convos.get(n);if(!o)return[];const c=i.findMessageByCmid(o,s);if("Normal"===c?.kind&&"failed"===c.editing?.status){const e=(0,r.current)(c),{cmid:t,peerId:s,attaches:n,replyMessage:i,forwardedMessages:o}=e,d=Boolean(i||o?.length),l=a.toRawText(c);return[async function(){return{type:"UserHitEdit",cmid:t,text:l,attaches:n,peerId:s,keepForwarded:d,skipCheckChanges:!0}}]}return[]}case"UserHitEdit_RequestCompleted":{const{peerId:s,hasFailed:n,cmid:r}=t;e.locks.edit.delete(s);const o=e.convos.get(s);if(!o)return[];if(n){const e=i.findMessageByCmid(o,r);"Normal"===e?.kind&&a.editFailed(e)}return[]}case"UserHitEdit_CancelFailedEditing":{const{peerId:s,cmid:n}=t,r=e.convos.get(s);if(!r)return[];const a=i.findMessageByCmid(r,n);return a&&"Normal"===a.kind&&a.editing?.status&&a.editing?.originalEditedMessage&&i.replaceMessage(r,a.editing.originalEditedMessage,!1),[]}default:return(0,n.exhaustivenessCheck)(t)}}},315973:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(520828),a=s(302551),i=s(84113),o=s(596917);const c=(e,t)=>{const{channelId:s,postCmid:c,commentCmid:l}=t,u=d(s,c);switch(t.type){case"UserHitEditComment":{const{text:n,attaches:a,onComplete:i,onFail:o}=t;if(e.locks.sendComment.has(u))return[];e.locks.sendComment.add(u);const d=r.ids(a).join(",");return n||d?[async function({api:e}){let t=!1;try{t=!Boolean(await e.fetch("wall.editComment",{attachments:d,owner_id:s,message:n,comment_id:l})),i?.()}catch(e){o?.(e),t=!0}return{type:"UserHitEditComment_RequestCompleted",hasFailed:t,text:n,attaches:a,channelId:s,postCmid:c,commentCmid:l}}]:[]}case"UserHitEditComment_RequestCompleted":{e.locks.sendComment.delete(u);const{hasFailed:n,text:r,attaches:d}=t;if(n)return[];const p=e.channels.get(s);if("ChannelRestricted"===p?.kind)return[];const h=p&&i.findNodeByCmid(p.history,c).node,m="Node"===h?.kind&&h.item,g=m&&a.findCommentByCmid(m,l);return g&&"Normal"===g.kind?(a.replaceComment(m,{...g,chunks:o.fromServerText(r),attaches:d}),[]):[]}default:return(0,n.exhaustivenessCheck)(t)}},d=(e,t)=>`${e}-${t}`},230360:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(103026),r=s(520828),a=s(302551),i=s(510632),o=s(743206),c=s(401193),d=s(841093);const l=(e,t,s)=>{switch(t.type){case"UserHitPostEdit":{const{cmid:s,text:a,attaches:i,channelId:o,options:c,visibility:d,donutDelay:l,onComplete:p,isPostponed:h,publishAt:m,onFail:g}=t,f=e.channels.get(o);if(!f||"ChannelRestricted"===f.kind)return[];const C=r.ids(i).join(",");if(!a&&!C)return[];const v=h?n.findPostInPostponedByCmid(f,s):n.findPostByCmid(f,s);return v&&"DeletedNode"!==v.kind?(e.locks.editPost.add(o),[async function({api:e}){try{p();const t=await e.fetch("channels.editMessage",{channel_id:o,cmid:s,message:a,attachments:C,publish_date:m&&Math.floor(m/1e3),close_comments:u(c.has("close_comments")),signed:u(c.has("signed")),donut_paid_duration:"all"===d?void 0:-1===l?l:86400*l});return{type:"UserHitPostEdit_RequestCompleted",hasFailed:!1,channelId:o,response:t,isPostponed:h}}catch(e){return g(e),{type:"UserHitPostEdit_RequestCompleted",hasFailed:!0,channelId:o}}}]):[]}case"UserHitPostEdit_RequestCompleted":{const{hasFailed:r,channelId:c}=t;e.locks.editPost.delete(c);const l=e.channels.get(c);if(!l||"ChannelRestricted"===l.kind||r)return[];if(t.isPostponed){const{post:e}=(0,d.fromApiPostonedPost)(t.response),s=i.getElementById(l.postponed.history,e.cmid);return s?(s.content=e,[]):[]}const{post:u,reactions:p}=(0,d.fromApiPost)(t.response),h=n.findPostByCmid(l,u.cmid),m=a.merge(u,"Node"===h?.kind?h.item:void 0);for(const t of p)e.reactionsOld.set(t.id,t);return n.replacePost(l,m),o.handler(e,{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[m]},s),[]}default:(0,c.exhaustivenessCheck)(t)}},u=e=>void 0!==e?Number(e)&&1:e},544434:(e,t,s)=>{"use strict";s.d(t,{handler:()=>p});var n=s(103026),r=s(520828),a=s(84113),i=s(302551),o=s(175953),c=s(726478),d=s(743206),l=s(401193),u=s(841093);const p=(e,t,s)=>{switch(t.type){case"UserHitPostSend":{const{text:s,attaches:n,channelId:c,publishAt:d,options:l,visibility:u,donutDelay:p,onComplete:m,onFail:g,forwardingPost:f,ads:C}=t,v=e.channels.get(c);if(!v||"ChannelRestricted"===v.kind)return[];const y=r.ids(n).join(",");if(!s&&!y&&!f)return[];let _;if(void 0===d){const e=f?{...n,wall:{kind:"Wall",id:f.cmid,date:Date.now(),authorId:o.resolveRealId("Group",-f.channelId),attaches:f.attaches,isDeleted:!1,isVisibleFor:"all",isAds:!!f.ads.markedAsAds,chunks:f.chunks}}:n;_=i.newPending({channelId:c,attaches:e,sentAt:+new Date},s),a.appendPending(v.history,_)}return[async function({api:e}){try{const t={channel_id:c,message:s,attachments:y,publish_date:d&&Math.floor(d.getTime()/1e3),close_comments:h(l.has("close_comments")),mark_as_ads:h(C.isAd),ord_erid:C.erId,mute_notifications:h(l.has("mute_notifications")),signed:h(l.has("signed")),donut_paid_duration:"all"===u?void 0:-1===p?p:86400*p};let n,r;if(f){r=(await e.fetch("wall.repost",{object:`wall${f.channelId}_${f.cmid}`,message:t.message,group_id:Math.abs(c),close_comments:t.close_comments,publish_date:t.publish_date,mark_as_ads:t.mark_as_ads,mute_notifications:t.mute_notifications})).post_id}else n=await e.fetch("channels.sendMessage",{...t,from_group:1}),r=n.cmid;return m(i.resolveCmid(r)),{type:"UserHitPostSend_RequestCompleted",hasFailed:!1,randomId:_?.randomId,channelId:c,cmid:i.resolveCmid(r),response:n}}catch(e){return g(e),{type:"UserHitPostSend_RequestCompleted",hasFailed:!0,randomId:_?.randomId,channelId:c}}}]}case"UserHitPostSend_RequestCompleted":{const{hasFailed:r,randomId:i,channelId:o}=t,l=e.channels.get(o);if(!l||"ChannelRestricted"===l.kind)return[];if(r)return i&&a.removePending(l.history,i),[];const p=i&&a.findPendingNode(l.history,i);if(!p)return[];if(p.item.cmid=t.cmid,!t.response)return[];const{post:h,reactions:m}=(0,u.fromApiPost)(t.response);for(const t of m)e.reactionsOld.set(t.id,t);return n.appendPost(l,h),c.refreshChannels(e.organisers,l),d.handler(e,{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[h]},s),[]}default:(0,l.exhaustivenessCheck)(t)}},h=e=>void 0!==e?Number(e)&&1:e},637692:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(103026),r=s(510632),a=s(401193),i=s(841093);const o=(e,t)=>{switch(t.type){case"UserHitPostponedPostEditTime":{const{channelId:s,cmid:a}=t,o=e.channels.get(s);if(!o||"ChannelRestricted"===o.kind)return[];if(!t.response)return[];const{post:c}=(0,i.fromApiPostonedPost)(t.response);return r.removeElement(o.postponed.history,a),n.insertPostponedPosts(o,[{id:c.cmid,content:c}]),[]}case"UserHitPostponedPostEdit":{const{channelId:s}=t,n=e.channels.get(s);if(!n||"ChannelRestricted"===n.kind)return[];if(!t.response)return[];const{post:a}=(0,i.fromApiPostonedPost)(t.response),o=r.getElementById(n.postponed.history,a.cmid);return o?(o.content=a,[]):[]}default:(0,a.exhaustivenessCheck)(t)}}},402278:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(103026),r=s(510632),a=s(726478),i=s(401193),o=s(841093),c=s(743206);const d=(e,t,s)=>{switch(t.type){case"UserHitPostponedPostPublish":{const{channelId:s,cmid:i}=t,c=e.channels.get(s);if(!c||"ChannelRestricted"===c.kind)return[];r.removeElement(c.postponed.history,i);const{post:d}=(0,o.fromApiPost)(t.response);return n.appendPost(c,d),a.refreshChannels(e.organisers,c),[]}case"UserHitPostponedPostSend":{const{channelId:r}=t,a=e.channels.get(r);if(!a||"ChannelRestricted"===a.kind)return[];if(!t.response)return[];const{post:i}=(0,o.fromApiPostonedPost)(t.response);return n.insertPostponedPosts(a,[{id:i.cmid,content:i}]),c.handler(e,{type:"ComposerDraftsUpdateNeeded",foreignKind:"post",itemsToReplace:[i]},s),[]}default:(0,i.exhaustivenessCheck)(t)}}},513300:(e,t,s)=>{"use strict";s.d(t,{handler:()=>y});var n=s(679005),r=s(78874),a=s(726356),i=s(401193),o=s(649166),c=s(175953),d=s(856562),l=s(84113),u=s(726478),p=s(520828),h=s(157274),m=s(777211),g=s(73514),f=s(592087),C=s(810704),v=s(162241);const y=(e,t,s)=>{switch(t.type){case"UserHitSend":{const{peerId:n,analyticsAppName:r,analyticsOrigin:i}=t,l=e.convos.get(n);return l?function(e,t){const{text:s,attaches:n,peerId:r,timestamp:a,expireTTL:i,deleteTTL:c,entrypoint:d,extra:l,reply:u,forwarded:p}=e,h=function(e){const t=e.length;if(t<g.MAX_MESSAGE_SIZE)return[e];const s=[];let n=0;for(let r=0;r<Math.ceil(t/g.MAX_MESSAGE_SIZE);r++){const r=e.substring(n,n+g.MAX_MESSAGE_SIZE).lastIndexOf(" "),a=-1===r?g.MAX_MESSAGE_SIZE:r,i=t-n<=g.MAX_MESSAGE_SIZE?e.substring(n):e.substring(n,n+a);n+=i.length,s.push(i)}return s.map((e=>e.trim()))}(s),m=function(e){const t=Object.values(e).flat(),s=Object.fromEntries(Object.entries(e).map((([e,t])=>Array.isArray(t)?[t[0].kind,{key:e,isArray:!0}]:[t.kind,{key:e,isArray:!1}])));if(t.length<=g.MAX_MESSAGE_ATTACHES)return[e];return t.reduce(((e,t,n)=>{const r=Math.floor(n/g.MAX_MESSAGE_ATTACHES),a=s[t.kind];return a?(e[r][a.key]=a.isArray?e[r][a.key]?.concat(t)||[t]:t,e):e}),Array.from({length:Math.ceil(t.length/g.MAX_MESSAGE_ATTACHES)},(()=>Object())))}(n),f=h.length+m.length-1,C=[];for(let e=0;e<f;e++){const s=h[e]||"",n=m[e-h.length+1]||{},g=o.newQueued({peerId:r,text:s,isOut:!0,sentAt:a+e,authorId:t,attaches:n,expireTTL:i,deleteTTL:c,extra:l,entrypoint:d},0===e?u:void 0,e===f-1?p:void 0);C.push(g)}return C}(t,e.ownerId).flatMap((t=>{d.appendQueuedMessage(l,s.vkm_new_remove_empty_forwards?o.removeEmptyForwardsFromQueued(t):t);const u=e.locks.sendQueue.get(l.peerId);if(u)return u.add(t.randomId),[];e.locks.sendQueue.set(l.peerId,new Set([t.randomId])),t.attaches.sticker&&h.isPopupSticker(t.attaches.sticker)&&!(0,a.isPopupAutoplayOnSendOff)()&&p.toggleStickerIsPopupAutoplayed(t,!1);return[l.isDrafted?async({stats:e})=>(e.logEvent({type:"type_action",type_action:{type:"type_messaging_action_item",type_messaging_action_item:{action_type:"send_draft_message",peer_id:n}}}),{type:"Noop"}):void 0,_(t.peerId,t.randomId,t.text,p.ids(t.attaches),t.extra,t.entrypoint,t.attaches.geo,(0,m.getOwnerGroupId)(e.ownerId),k(t),r,i),c.isMarusia(t.peerId)&&async function({marusia:e}){return e?.handleAction({type:"add_message",payload:{randomId:Number(t.randomId),text:o.toRawText(t),isOutbound:t.isOut,local:!0,payload:t.extra.botPayload,attachIds:p.ids(t.attaches)}}),{type:"Noop"}}]})):[]}case"UserHitSend_RequestCompleted":{const{peerId:a,randomId:i,response:c,error:h,analyticsAppName:g,analyticsOrigin:v}=t,y=e.convos.get(a),I=e.ownerId;if(!y)return e.locks.sendQueue.delete(a),[];const b=l.findPendingNode(y.history,i);b&&(c?c.cmid&&o.updateCmid(b.item,o.resolveCmid(c.cmid)):(h&&h instanceof f.IApi.RequestError?(o.updateFailedStatus(b.item,!0,h.code),h.code===r.API_ERROR_MESSAGES_WRITING_DISABLED_FOR_CHAT&&(d.forbidWritingForAll(y,!0),d.restrictViewerToWrite(y,"forbid_writing_for_all"),d.updateIsDrafted(y,!1))):o.updateFailedStatus(b.item,!0),u.refresh(e.organisers,y,s)));const w=(0,n.current)(y),S=async({storage:e})=>((0,C.saveConvosFailedMessagesInStorage)(w,e),{type:"Noop"}),R=e.locks.sendQueue.get(y.peerId);if(!R)return[S];R.delete(i);const M=[...R][0];if(!M)return e.locks.sendQueue.delete(a),[S];const E=l.findPendingNode(y.history,M)?.item;if(!E)return[S];const A=(0,n.current)(E);return[_(a,A.randomId,A.text,p.ids(A.attaches),A.extra,A.entrypoint,A.attaches.geo,(0,m.getOwnerGroupId)(I),k(A),g,v),S]}case"UserHitResendFailedMessage":{const{randomId:s,peerId:r,entrypoint:a,analyticsAppName:i,analyticsOrigin:o}=t,c=e.convos.get(r),u=e.ownerId;if(!c)return[];const h=l.findPendingNode(c.history,s)?.item;if(!h)return[];d.updateSendingFail(c,s,!1),d.changeQueuedMessageEntrypoint(c,s,a);const g=e.locks.sendQueue.get(c.peerId);if(g)return g.add(h.randomId),[];e.locks.sendQueue.set(c.peerId,new Set([h.randomId]));const f=(0,n.current)(h);return[_(r,f.randomId,f.text,p.ids(f.attaches),f.extra,a,f.attaches.geo,(0,m.getOwnerGroupId)(u),k(f),i,o)]}case"UserHitResendAllConvoFailedMessages":{const{peerId:n,entrypoint:r,analyticsAppName:a,analyticsOrigin:i}=t,o=e.convos.get(n);if(!o)return[];return d.allQueuedMessages(o).filter((e=>e.hasFailed)).flatMap((t=>y(e,{type:"UserHitResendFailedMessage",peerId:n,randomId:t.randomId,entrypoint:r||t.entrypoint,analyticsAppName:a,analyticsOrigin:i},s)))}case"UserHitSendWidget":{const{peerId:n,text:r,timestamp:a,entrypoint:i,extra:c,analyticsAppName:d}=t;if(e.convos.get(n))return y(e,{type:"UserHitSend",attaches:{},extra:c,entrypoint:i,text:r,peerId:n,timestamp:a,analyticsAppName:d},s);const l=o.newQueued({peerId:n,text:r,isOut:!0,sentAt:a,authorId:e.ownerId,attaches:{},extra:c,entrypoint:i});return[_(l.peerId,l.randomId,l.text,p.ids(l.attaches),l.extra,l.entrypoint,l.attaches.geo,(0,m.getOwnerGroupId)(e.ownerId),null,d)]}case"UserHitSend_ErrorSnackbarShown":{const{peerId:s,randomId:r}=t,a=e.convos.get(s);if(!a)return[];const i=d.allQueuedMessages(a).find((e=>e.randomId===r));if(!i)return[];o.updateFailedStatus(i,!0,void 0);const c=(0,n.current)(a);return[async({storage:e})=>((0,C.saveConvosFailedMessagesInStorage)(c,e),{type:"Noop"})]}default:return(0,i.exhaustivenessCheck)(t)}};function _(e,t,s,n,r,a,i,o,c,d,l){return async function({api:u,perfStats:p,stats:h}){const m={};r.sticker&&(m.sticker_id=r.sticker.id,m.sticker_referrer=r.sticker.referrer),r.botPayload&&(m.payload=r.botPayload),r.silent&&(m.silent=1),r.expiresIn&&(m.expire_ttl=r.expiresIn),r.ref&&(m.ref=r.ref),r.refSource&&(m.ref_source=r.refSource),i&&(m.lat=i.coordinates.latitude,m.long=i.coordinates.longitude);try{p?.addEventData(v.IPerfStats.EventType.receiveMessage,{sendStart:p.getCurrentTime()});const r=await u.fetch("messages.send",{...m,peer_id:e,random_id:t,message:s,forward:c?JSON.stringify(c):void 0,attachment:0===n.length?void 0:n.join(","),entrypoint:a,group_id:o,from:d,fromOrigin:l});return p?.addEventData(v.IPerfStats.EventType.receiveMessage,{sendEnd:p.getCurrentTime()}),h.trackExternalEvent({type:"message_sent"}),{type:"UserHitSend_RequestCompleted",peerId:e,randomId:t,response:r,analyticsAppName:d,analyticsOrigin:l}}catch(s){return{type:"UserHitSend_RequestCompleted",peerId:e,randomId:t,analyticsAppName:d,analyticsOrigin:l,error:s instanceof Error?s:void 0}}}}function k(e){let t=null;return e.replyMessage&&(t={peer_id:e.replyMessage.peerId,conversation_message_ids:[e.replyMessage.cmid],is_reply:!0}),e.forwardedMessages&&(t={peer_id:e.forwardedMessages[0].peerId,conversation_message_ids:e.forwardedMessages.map((e=>e.cmid))}),t}},578744:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(103026),r=s(164231),a=s(302551),i=s(136872),o=s(520828),c=s(401193);const d=(e,t)=>{const{videoId:s}=t,d=l(s),u=e.videoConvos.get(s);if(!u)return[];const p=u.ownerId,h=u.isLive,m=u.accessKey;switch(t.type){case"UserHitVideoCommentSend":{const{text:n,attaches:r,extra:a,onComplete:i,onFail:c}=t,l=o.ids(r).join(",");return n||l||a?.sticker?e.locks.sendVideoComment.has(d)?[]:(e.locks.sendVideoComment.add(d),[async function({api:e}){try{i?.();const t=async()=>h&&a?.sticker?.id?e.fetch("video.liveSendSticker",{owner_id:p,video_id:s,sticker_id:a?.sticker.id,access_key:m}):e.fetch("video.createComment",{owner_id:p,video_id:s,access_key:m,message:n,attachments:l,sticker_id:a?.sticker?.id,sticker_referrer:a?.sticker?.referrer});return{type:"UserHitVideoCommentSend_RequestCompleted",hasFailed:!1,response:await t(),videoId:s,text:n,attaches:r}}catch(e){return c?.(e),{type:"UserHitVideoCommentSend_RequestCompleted",hasFailed:!0,videoId:s,text:n,attaches:r}}}]):[]}case"UserHitVideoCommentSend_RequestCompleted":{const{text:s,attaches:o,hasFailed:c,response:l}=t;if(c)return e.locks.sendVideoComment.delete(d),[];const m=!!o.sticker;if(!(h&&m)){const t=i.resolveCmid(l),c=i.newNormal({canEdit:!m,canDelete:!0,channelId:n.resolveId(p),postCmid:a.resolveCmid(0),sentAt:Date.now(),cmid:t,peerId:e.ownerId,attaches:o},s);r.addComment(u,c)}return e.locks.sendVideoComment.delete(d),[]}default:(0,c.exhaustivenessCheck)(t)}},l=e=>e},83306:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t,s)=>{switch(t.type){case"UserJoinedSpace":{const s=e.spaces.get(t.spaceId);return!s||s.viewerData.isChangingMembership||s.viewerData.isMember?[]:(s.viewerData.isChangingMembership=!0,[async function({api:e}){try{const s=await e.fetch("spaces.join",{space_id:t.spaceId,extended:1});return{type:"UserJoinedSpace_RequestCompleted",spaceId:t.spaceId,response:s}}catch(e){return{type:"UserJoinedSpace_RequestCompleted",spaceId:t.spaceId}}}])}case"UserJoinedSpace_RequestCompleted":{const n=e.spaces.get(t.spaceId);return n&&(n.viewerData.isChangingMembership=!1),t.response?((0,r.insertSpaces)(e,[t.response.space],{apiConvos:t.response.conversations||[],apiUsers:t.response.profiles||[],apiGroups:t.response.groups||[],apiSpaceCalls:t.response.calls||[],apiSpaceTribunes:t.response.tribunes||[]},s),[]):[]}case"UserLeftSpace":{const s=e.spaces.get(t.spaceId);return s&&!s.viewerData.isChangingMembership&&s.viewerData.isMember?(s.viewerData.isChangingMembership=!0,[async function({api:e}){try{const s=await e.fetch("spaces.leave",{space_id:t.spaceId,extended:1});return{type:"UserLeftSpace_RequestCompleted",spaceId:t.spaceId,response:s}}catch(e){return{type:"UserLeftSpace_RequestCompleted",spaceId:t.spaceId}}}]):[]}case"UserLeftSpace_RequestCompleted":{const n=e.spaces.get(t.spaceId);return n&&(n.viewerData.isChangingMembership=!1),t.response?((0,r.insertSpaces)(e,[t.response.space],{apiConvos:t.response.conversations||[],apiUsers:t.response.profiles||[],apiGroups:t.response.groups||[],apiSpaceCalls:t.response.calls||[],apiSpaceTribunes:t.response.tribunes||[]},s),[]):[]}default:(0,n.exhaustivenessCheck)(t)}}},354369:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(401193),r=s(302551),a=s(175953),i=s(84113),o=s(73514),c=s(777211);const d={UserChangedLike:"UserChangedLike",UserChangedLike_RequestCompleted:"UserChangedLike",UserLoadedLikes:"UserLoadedLikes",UserLoadedLikes_RequestCompleted:"UserLoadedLikes"},l=(e,t,s)=>{let p,h,m;switch(t.kind){case"comment":{const{channelId:s,postCmid:n,commentCmid:a}=t,o=e.channels.get(s);if("ChannelRestricted"===o?.kind)break;const c=o&&i.findNodeByCmid(o.history,n).node,d="Node"===c?.kind&&r.findCommentByCmid(c.item,a);if(!d||"Normal"!==d.kind)break;p=d.channelId,m=d,h=d.cmid;break}case"post":{const{channelId:s,postCmid:n}=t,r=e.channels.get(s);if("ChannelRestricted"===r?.kind)break;const a=r&&i.findNodeByCmid(r.history,n).node,o="Node"===a?.kind&&a.item;if(!o)break;p=o.channelId,h=o.cmid,m=o;break}default:(0,n.exhaustivenessCheck)(t)}if(!m||!p||!h)return[];const g=u(d[t.type],t.kind,p,h);switch(t.type){case"UserLoadedLikes":{if(e.locks.likeActions.has(g))return[];let s;switch(e.locks.likeActions.add(g),t.kind){case"comment":case"post":s=m.likes.peerIds.size;break;default:(0,n.exhaustivenessCheck)(t)}const r=0===m.likes.peerIds.size?o.LIKE_PEERS_FIRST_LOAD:o.LIKE_PEERS_PER_PAGE;return[async function({api:e}){try{const n=await e.fetch("likes.getList",{type:t.kind,owner_id:p,item_id:h,extended:1,skip_own:1,count:r,offset:s});return{...t,type:"UserLoadedLikes_RequestCompleted",response:n,hasFailed:!1}}catch(e){return{...t,type:"UserLoadedLikes_RequestCompleted",hasFailed:!0}}}]}case"UserLoadedLikes_RequestCompleted":{const{hasFailed:s,response:r}=t;if(e.locks.likeActions.delete(g),s||!r)return[];const i=[],o=[],d=[];switch(r.items.forEach((e=>{"group"!==e.type&&"page"!==e.type&&"event"!==e.type||(o.push(e),d.push(a.resolveRealId("Group",e.id))),"profile"!==e.type&&"email"!==e.type||(i.push(e),d.push(a.resolveRealId("User",e.id)))})),(0,c.insertPeers)(e,{apiUsers:i,apiGroups:o,apiContacts:[]}),t.kind){case"comment":case"post":d.forEach((e=>m?.likes.peerIds.add(e)));break;default:(0,n.exhaustivenessCheck)(t)}return[]}case"UserChangedLike":{const{reactionId:s}=t,n=m.likes.reactionId;if(n===s)return[];const r=void 0!==n;return e.locks.likeActions.has(g)?[]:(e.locks.likeActions.add(g),void 0===s?m.likes.count-=1:r||(m.likes.count+=1),m.likes.reactionId=s,[async function({api:e}){try{const n=await e.fetch(r&&void 0===s?"likes.delete":"likes.add",{type:t.kind,owner_id:p,item_id:h||0,reaction_id:s});return{...t,type:"UserChangedLike_RequestCompleted",response:n,hasFailed:!1}}catch(e){return{...t,type:"UserChangedLike_RequestCompleted",hasFailed:!0,prevReactionId:n}}}])}case"UserChangedLike_RequestCompleted":{const{hasFailed:n,response:r,prevReactionId:a}=t;return e.locks.likeActions.delete(g),n||!r?(l(e,{...t,type:"UserChangedLike",reactionId:a},s),e.locks.likeActions.delete(g),[]):(m.likes.count=r.likes,[])}default:(0,n.exhaustivenessCheck)(t)}},u=(e,t,s,n)=>`${e}-${t}-${s}-${n}`},497706:(e,t,s)=>{"use strict";s.d(t,{getCommentsHistoryLockKey:()=>l,handler:()=>d,mapOrderToSort:()=>u});var n=s(401193),r=s(302551),a=s(84113),i=s(777211),o=s(73514),c=s(795412);const d=(e,t)=>{switch(t.type){case"UserLoadedCommentsHistory":{const{channelId:s,postCmid:n,direction:i,order:c,rootCommentCmid:d}=t,p=l(s,n,c,d);if(e.locks.getPostCommentsHistory.has(p))return[];e.locks.getPostCommentsHistory.add(p);const h=e.channels.get(s);if(!h||"ChannelRestricted"===h.kind)return[];const m=a.findNodeByCmid(h.history,n).node,g="Node"===m?.kind&&m.item;if(!g)return[];c!==g.comments.order&&r.changeCommentsOrder(g,c);let f,C,v=u(c);if(d){const e=r.findCommentByCmid(g,d);if(!e)return[];v="asc",f=e.replies.nextFrom,C=e.replies.prevFrom}else f=g.comments.nextFrom,C=g.comments.prevFrom;return[async function({api:e}){try{const r=await e.fetch("wall.getComments",{owner_id:s,post_id:n,count:o.COMMENTS_PER_PAGE,thread_items_count:o.THREAD_COMMENTS_COUNT,need_likes:1,extended:1,sort:v,comment_id:d,next_from:"forward"===i?f:void 0,prev_from:"backward"===i?C:void 0});return{...t,type:"UserLoadedCommentsHistory_RequestSucceed",response:r}}catch(e){return{type:"UserLoadedCommentsHistory_RequestFailed",channelId:s,postCmid:n,order:c,direction:i,hasFailed:!0}}}]}case"UserLoadedCommentsHistory_RequestSucceed":{const{response:s,channelId:o,postCmid:d,direction:u,order:p,rootCommentCmid:h}=t;e.locks.getPostCommentsHistory.delete(l(o,d,p,h));const m=e.channels.get(o);if(!m||"ChannelRestricted"===m.kind)return[];const g=a.findNodeByCmid(m.history,d).node,f="Node"===g?.kind&&g.item;if(!f||f.comments.order!==p)return[];const C=s.items.map((e=>(0,c.fromApiComment)(e,o,d))),v=(e,t)=>{switch(u){case"forward":return{...e,history:[...e.history,...t],nextFrom:s.next_from};case"backward":return{...e,history:[...t,...e.history],prevFrom:s.prev_from};default:(0,n.exhaustivenessCheck)(u)}};if(h){const e=r.findCommentByCmid(f,h);if(!e)return[];e.replies=v(e.replies,C),e.replies.count=s.current_level_count||e.replies.count}else f.comments=v(f.comments,C),f.comments.count=s.count,f.comments.oneLevelCount=s.current_level_count||f.comments.oneLevelCount;return(0,i.insertPeers)(e,{apiUsers:s.profiles||[],apiGroups:s.groups||[],apiContacts:[]}),[]}case"UserLoadedCommentsHistory_RequestFailed":{const{channelId:s,postCmid:n,order:r,rootCommentCmid:a}=t;return e.locks.getPostCommentsHistory.delete(l(s,n,r,a)),[]}default:return(0,n.exhaustivenessCheck)(t)}},l=(e,t,s,n)=>`${e}-${t}-${s}-${n||""}`,u=e=>{switch(e){case"interesting":return;case"new":return"desc";case"old":return"asc";default:(0,n.exhaustivenessCheck)(e)}}},971891:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(401193),r=s(872060),a=s(777211),i=s(520828);const o=(e,t,s)=>{switch(t.type){case"UserLoadedUrlSnippets":{const{urls:s}=t;if(s.forEach((t=>!e.urlSnippetsCache.has(t)&&e.urlSnippetsQueue.add(t))),0===e.urlSnippetsQueue.size)return[];if(e.locks.urlSnippets.load||e.locks.urlSnippets.throttle)return[];const r=Array.from(e.urlSnippetsQueue);return e.urlSnippetsQueue=new Set,e.locks.urlSnippets={load:!0,throttle:!0},[async function({api:e}){try{const t=await e.fetch("wall.parseAttachedLink",{links:JSON.stringify(r),extended:1});return{type:"UserLoadedUrlSnippets_RequestCompleted",urls:r,res:t}}catch(e){return{type:"UserLoadedUrlSnippets_RequestCompleted",urls:r}}},async function(){return await(0,n.sleep)(300),{type:"UserLoadedUrlSnippets_ThrottleTimedOut"}}]}case"UserLoadedUrlSnippets_ThrottleTimedOut":return e.locks.urlSnippets.throttle=!1,e.locks.urlSnippets.load?[]:o(e,{type:"UserLoadedUrlSnippets",urls:[]},s);case"UserLoadedUrlSnippets_RequestCompleted":{const{res:n,urls:c}=t;if(e.locks.urlSnippets.load=!1,n){const{data:t,groups:s,profiles:o}=n;t.forEach(((t,s)=>{const n=(0,r.fromApiWallReplyAttach)([t]),a=Object.values(n).map((e=>Array.isArray(e)?e[0]:e))[0],o=c[s];a&&o&&i.isAddableAttach(a)&&(e.urlSnippetsCache.set(o,a),e.urlSnippetsCache.size>=60&&(e.urlSnippetsCache=new Map(Array.from(e.urlSnippetsCache).slice(-30))))})),(0,a.insertPeers)(e,{apiUsers:o||[],apiGroups:s||[],apiContacts:[]})}return e.locks.urlSnippets.throttle?[]:o(e,{type:"UserLoadedUrlSnippets",urls:[]},s)}default:(0,n.exhaustivenessCheck)(t)}}},414639:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(78874),r=s(103026),a=s(726478),i=s(401193),o=s(592087),c=s(777211);const d=(e,t)=>{switch(t.type){case"UserOpenedChannel":{const{channelId:s}=t,n=e.locks.channelsCleanup.get(s)||0;e.locks.channelsCleanup.set(s,n+1);return e.channels.get(s)?[]:[async function({api:e}){try{const t=await e.fetch("channels.getById",{channel_ids:s.toString(),extended:1},{retries:2});return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,response:t,hasFailed:!1}}catch(e){return{type:"UserOpenedChannel_ChannelRequestCompleted",channelId:s,hasFailed:!0,errCode:e instanceof o.IApi.RequestError?e.code:void 0}}}]}case"UserOpenedChannel_ChannelRequestCompleted":{const{hasFailed:s,channelId:r,response:o,errCode:d}=t;if(s&&(d===n.API_ERROR_MESSAGES_SHOULD_BE_EDU||d===n.API_ERROR_MESSAGES_SHOULD_NOT_BE_EDU))return e.channels.set(r,{id:r,kind:"ChannelRestricted",needSwitchAccount:!0}),[];if(s&&d===n.API_ERROR_ACCESS)return e.channels.set(r,{id:r,kind:"ChannelRestricted"}),[];if(!o)return[];(0,c.insertPeers)(e,{apiUsers:o.profiles||[],apiGroups:o.groups||[],apiContacts:[]}),(0,c.insertChannels)(e,{apiChannels:o.items||[],apiGroups:o.groups||[]});const l=e.channels.get(r);if(!l){if(i.isDev)throw new Error("Диалог не был найден");return[]}return"ChannelRestricted"===l.kind||l.isMember&&a.refreshChannels(e.organisers,l),[]}case"UserClosedChannel":{const{channelId:s}=t,n=e.locks.channelsCleanup.get(s);if(n&&n>1)return e.locks.channelsCleanup.set(s,n-1),[];e.locks.channelsCleanup.delete(s);const a=e.channels.get(s);return a?("ChannelRestricted"===a.kind||r.cleanup(a),[]):[]}default:return(0,i.exhaustivenessCheck)(t)}}},533787:(e,t,s)=>{"use strict";s.d(t,{handler:()=>u});var n=s(777211),r=s(175953),a=s(856562),i=s(726478),o=s(401193),c=s(700462),d=s(726356),l=s(162241);const u=(e,t,s)=>{switch(t.type){case"LoadChatMembers":case"ActualizeComposerDraft":return[];case"UserOpenedConvo":{e.convoLoadingFailed=void 0;const{peerId:r}=t,a=e.convos.get(r),i=e.locks.convosCleanup.get(r)||0;e.locks.convosCleanup.set(r,i+1);const o=(0,n.getOwnerGroupId)(e.ownerId);return a?u(e,{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!1},s):[async function({api:e,perfStats:t}){try{t?.addEventData(l.IPerfStats.EventType.openChat,{loadConvoStart:t.getCurrentTime()});const s=await e.fetch("messages.getConversationsById",{peer_ids:r.toString(),group_id:o,extended:1},{retries:3});return t?.addEventData(l.IPerfStats.EventType.openChat,{loadConvoEnd:t.getCurrentTime()}),{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!1,profiles:s.profiles,groups:s.groups,conversations:s.items,contacts:s.contacts}}catch(e){return{type:"UserOpenedConvo_ConvoRequestCompleted",peerId:r,hasFailed:!0}}}]}case"UserOpenedConvo_ConvoRequestCompleted":{const{peerId:c,conversations:l,profiles:u,groups:p,contacts:h,hasFailed:m}=t;if(m){if(o.isDev)throw new Error("Не удалось загрузить диалог");return e.convoLoadingFailed=c,[]}(0,n.insertConvos)(e,l||[],s);const g=(0,d.getIsAnimationAutoplay)();null!==g&&(e.viewer.settings.isStickersAnimationEnabled=g),(0,n.insertPeers)(e,{apiUsers:u||[],apiGroups:p||[],apiContacts:h||[]});const f=e.convos.get(c);if(!f){if(o.isDev)throw new Error("Диалог не был найден");return[]}const C=a.hasPeerFlag(f,a.PEER_FLAGS.isMarkedUnread)&&0===f.unreadCount;C&&a.markRead(f),(l||C)&&i.refresh(e.organisers,f,s);const v="ChatConvo"===f.kind&&0===f.members.memberIds.size&&a.canReadMembers(f)&&!e.locks.getConversationMembers.has(c);v&&e.locks.getConversationMembers.add(c);const y=(0,n.getOwnerGroupId)(e.ownerId),_=0===e.stickersKeywords.size;return[v&&r.isChatPeerId(c)&&async function(){return{type:"LoadChatMembers",peerId:c}},async function({api:e,storage:t}){try{const n=await async function({api:e,storage:t,shouldReturnStickersKeywordsIfNotExpired:s}){const n=t.get("stickers-keywords-meta"),r=Math.round((new Date).getTime()/1e3),a=86400;if(n&&n.expiresAt>r&&!n.incomplete){if(!s)return;const e=await t.getIDB("stickers-keywords");return e?.dictionary}const i=[];let o,c=0,d=!1;for(;;)try{const{dictionary:t,chunks_hash:s,chunks_count:n}=await e.fetch("store.getStickersKeywords",{need_stickers:0,all_products:0,chunk:c,chunks_hash:o},{retries:2});if(i.push(...t),o=s,c++,!n||n===c)break}catch{d=!0;break}try{await t.setIDB("stickers-keywords",{dictionary:i}),t.set("stickers-keywords-meta",{expiresAt:r+a,incomplete:d})}catch{}return i}({api:e,storage:t,featureFlags:s,shouldReturnStickersKeywordsIfNotExpired:_});return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted",response:n}}catch{return{type:"UserOpenedConvo_StickersKeywordsRequestCompleted"}}},C&&async function({api:e}){try{await e.fetch("messages.markAsRead",{peer_id:c,mark_conversation_as_read:0,group_id:y})}catch{}return{type:"Noop"}},async function(){return{type:"ActualizeComposerDraft",peerId:c}}]}case"UserClosedConvo":{const s=e.locks.convosCleanup.get(t.peerId);if(s&&s>1)return e.locks.convosCleanup.set(t.peerId,s-1),[];e.locks.convosCleanup.delete(t.peerId);const n=e.convos.get(t.peerId);return n?(a.cleanup(n),[]):[]}case"UserOpenedConvo_StickersKeywordsRequestCompleted":{const{response:s}=t;return s&&(e.stickersKeywords=(0,c.fromApiStickersKeywords)(s)),[]}default:return(0,o.exhaustivenessCheck)(t)}}},886546:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(175953),r=s(401193),a=s(777211),i=s(856562),o=s(469151);const c=(e,t,s)=>{switch(t.type){case"LoadChatMembers":return[];case"UserOpenedConvoProfile":{const{peerId:n,isLinkWithHistory:r}=t,i=e.convos.get(n),o=e.ownerId;return i?c(e,{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,isLinkWithHistory:r},s):[async function({api:e}){try{let t;return i||(t=await e.fetch("messages.getConversationsById",{peer_ids:n.toString(),extended:1,group_id:(0,a.getOwnerGroupId)(o)},{retries:3})),{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!1,convoResponse:t,isLinkWithHistory:r}}catch(e){return{type:"UserOpenedConvoProfile_ConvoRequestCompleted",peerId:n,hasFailed:!0,isLinkWithHistory:r}}}]}case"UserOpenedConvoProfile_ConvoRequestCompleted":{const{peerId:c,convoResponse:d,hasFailed:l,isLinkWithHistory:u}=t,p=e.ownerId;if(l){if(r.isDev)throw new Error("Не удалось загрузить диалог");return[async function(){return{type:"Noop"}}]}d&&((0,a.insertConvos)(e,d.items||[],s),(0,a.insertPeers)(e,{apiUsers:d.profiles||[],apiGroups:d.groups||[],apiContacts:d.contacts||[]}));const h=e.convos.get(c);if(!h){if(r.isDev)throw new Error("Диалог не был найден");return[]}const m="ChatConvo"===h.kind&&0===h.members.memberIds.size&&i.canReadMembers(h)&&!e.locks.getConversationMembers.has(c);m&&e.locks.getConversationMembers.add(c);const g="ChatConvo"===h.kind&&h.acl.canSeeInviteLink,f=n.isChatPeerId(c);return m&&e.locks.setChatStickersDisplay.add(c),[m&&n.isChatPeerId(c)&&async function(){return{type:"LoadChatMembers",peerId:c}},g&&n.isChatPeerId(c)&&async function({api:e}){try{return{type:"UserOpenedConvoProfile_InviteLinksCompleted",peerId:c,isLinkWithHistory:u,response:await e.fetch("messages.getInviteLink",{peer_id:c,visible_messages_count:u?o.VISIBLE_MESSAGES_COUNT:0,reset:0,group_id:(0,a.getOwnerGroupId)(p)},{retries:1})}}catch{}return{type:"Noop"}},f&&async function({api:e}){try{return{type:"UserOpenedConvoProfile_UGCPackListsCompleted",peerId:c,response:await e.fetch("stickers.getUGCPackLists",{owner_ids:c.toString()},{retries:1})}}catch{}return{type:"Noop"}}]}case"UserOpenedConvoProfile_InviteLinksCompleted":{const{peerId:s,response:{link:n},isLinkWithHistory:r}=t,a=e.convos.get(s);return a&&"ChatConvo"===a.kind&&n?(i.replaceInviteLinks(a,{...a.inviteLinks,...r?{withHistory:n}:{noHistory:n}}),[]):[]}case"UserOpenedConvoProfile_UGCPackListsCompleted":{const{peerId:s,response:{lists:n}}=t,r=e.convos.get(s);if(!r||"ChatConvo"!==r.kind||!n[0])return[];const{can_hide_keyboard:a,can_edit:o,is_keyboard_hidden:c,items:d}=n[0];return i.setStickersParams(r,{canEdit:o??!1,canHideKeyboard:a,isKeyboardHidden:c,hasStickers:0!==d.length}),e.locks.setChatStickersDisplay.delete(s),[]}default:(0,r.exhaustivenessCheck)(t)}}},746826:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t,s)=>{switch(t.type){case"UserOpenedSpace":{const s=e.spaces.get(t.spaceId);return"Space"!==s?.kind?e.locks.spacesGetById.has(t.spaceId)?[]:(e.locks.spacesGetById.add(t.spaceId),[async function({api:e}){try{return{type:"UserOpenedSpace_RequestCompleted",spaceId:t.spaceId,spacesGetByIdResponse:await e.fetch("spaces.getById",{space_ids:t.spaceId.toString(),extended:1},{retries:1/0})}}catch{return{type:"UserOpenedSpace_RequestCompleted",spaceId:t.spaceId}}}]):[]}case"UserClosedSpace":return[];case"UserOpenedSpace_RequestCompleted":return e.locks.spacesGetById.delete(t.spaceId),t.spacesGetByIdResponse?t.spacesGetByIdResponse.items[0]?((0,r.insertSpaces)(e,t.spacesGetByIdResponse.items,{apiConvos:t.spacesGetByIdResponse.conversations||[],apiUsers:t.spacesGetByIdResponse.profiles||[],apiGroups:t.spacesGetByIdResponse.groups||[],apiSpaceCalls:t.spacesGetByIdResponse.calls||[],apiSpaceTribunes:t.spacesGetByIdResponse.tribunes||[]},s),[]):(e.spaces.set(t.spaceId,null),[]):[];default:return(0,n.exhaustivenessCheck)(t)}}},393329:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(164231),r=s(401193),a=s(8508),i=s(777211),o=s(795412),c=s(400993),d=s(73514);const l=(e,t,s)=>{switch(t.type){case"UserOpenedVideoChat":{const{video:e}=t;return[async function({api:t,videoEngine:s}){const n=d.VIDEO_COMMENTS_PER_PAGE;try{const[r,a]=await t.fetchMany([{method:"video.getComments",params:{extended:1,video_id:e.id,owner_id:e.ownerId,access_key:e.accessKey,count:n,sort:"desc"}},...s&&"live"===e.type?[{method:"video.getLongPollServer",params:{video_id:e.id,owner_id:e.ownerId,access_key:e.accessKey}}]:[]]);if(s&&a)try{s.connect(a)}catch{return{type:"Noop"}}return{type:"UserOpenedVideoChat_RequestCompleted",commentsResponse:r,video:e,hasMore:r.items.length>=n}}catch{return{type:"UserOpenedVideoChat_RequestFailed",video:e}}}]}case"UserClosedVideoChat":{const{video:s}=t;return e.videoConvos.delete(n.resolveId(s.id)),[async function({videoEngine:e}){return e?.shutdown(),{type:"Noop"}}]}case"UserOpenedVideoChat_RequestCompleted":{const{commentsResponse:s,video:r,hasMore:a}=t,d=(0,c.fromAttachVideoConvo)(r,a),l=s.items.map((e=>(0,o.fromApiComment)(e))).reverse();return d.comments.push(...l),e.videoConvos.set(n.resolveId(r.id),d),(0,i.insertPeers)(e,{apiUsers:s.profiles||[],apiGroups:s.groups||[],apiContacts:[]}),[async function({videoEngine:e}){return e&&"live"===r.type?{type:"VideoEngineBatchReceived",variant:{kind:"FromVideoEngine",next:await e.poll()}}:{type:"Noop"}}]}case"UserOpenedVideoChat_RequestFailed":{const{video:s}=t,r=(0,c.fromAttachVideoConvo)(s,!1,!0);return e.videoConvos.set(n.resolveId(s.id),r),[]}case"VideoEngineBatchReceived":return a.handler(e,t,s);default:(0,r.exhaustivenessCheck)(t)}}},458077:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(856562),r=s(649166),a=s(401193),i=s(777211),o=s(679005);const c=(e,t)=>{switch(t.type){case"UserPlayedMessage":{const{cmid:s,peerId:a}=t,o=e.convos.get(a),c=o&&n.findMessageByCmid(o,s),d=e.ownerId;return"Normal"===c?.kind&&r.canChangeMessagePlayedStatus(c)?[async function({api:e}){try{return{type:"UserPlayedMessage_RequestCompleted",hasFailed:1!==await e.fetch("messages.markAsPlayed",{peer_id:a,cmid:s,group_id:(0,i.getOwnerGroupId)(d)},{retries:1}),cmid:s,peerId:a}}catch{return{type:"UserPlayedMessage_RequestCompleted",hasFailed:!0,cmid:s,peerId:a}}}]:[]}case"UserPlayedMessage_RequestCompleted":if(!t.hasFailed){const{cmid:s,peerId:a}=t,i=e.convos.get(a),c=i&&(0,o.castDraft)(n.findMessageByCmid(i,s));if("Normal"!==c?.kind||!r.canChangeMessagePlayedStatus(c))return[];c.isPlayed=!0}return[];default:(0,a.exhaustivenessCheck)(t)}}},88758:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{if("UserProfileInfo_Update"===t.type){const{user:s,profileInfo:n,accounts:r}=t;return n&&(e.viewer.profileInfo=n),s&&e.peers.set(s.id,s),r&&(e.viewer.accounts=r),[]}(0,n.exhaustivenessCheck)(t.type)}},449902:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(777211);const a=(e,t)=>{switch(t.type){case"UserReadAllReactions":{const{peerId:s}=t;if(e.locks.readAllReactions.has(s))return[];e.locks.readAllReactions.add(s);const n=(0,r.getOwnerGroupId)(e.ownerId),a=e.convos.get(s);let i=new Map;return a&&(i=new Map(a.unreadReactions.entries()),a.unreadReactions.clear()),[async function({api:e}){try{const t=await e.fetch("messages.markReactionsAsRead",{peer_id:s,cmids:Array.from(i.keys()).join(","),group_id:n});return{type:"UserReadAllReactions_RequestCompleted",peerId:s,hasFailed:1!==t,unreadReactions:i}}catch{return{type:"UserReadAllReactions_RequestCompleted",peerId:s,hasFailed:!0,unreadReactions:i}}}]}case"UserReadAllReactions_RequestCompleted":{const{hasFailed:s,peerId:n,unreadReactions:r}=t;if(e.locks.readAllReactions.delete(n),!s)return[];const a=e.convos.get(n);return a&&(a.unreadReactions=new Map([...r,...a.unreadReactions])),[]}default:return(0,n.exhaustivenessCheck)(t)}}},51273:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(726478),a=s(103026);const i=(e,t)=>{switch(t.type){case"UserReadPost":{const{cmid:s,channelId:n}=t,i=e.channels.get(n);if(!i)return[];if("ChannelRestricted"===i.kind)return[];if(s<=i.inReadCmid)return[];a.readUntil(i,s),r.refreshChannels(e.organisers,i);const c=e.channelReadQueues.has(n);return e.channelReadQueues.set(n,i.inReadCmid),c?[]:[o(n)]}case"UserReadPost_ThrottleTimedOut":{const{channelId:s}=t,n=e.channelReadQueues.get(s);return n?[async function({api:e}){try{await e.fetch("channels.markAsRead",{channel_id:s,last_read_cmid:n})}catch(e){}return{type:"UserReadPost_RequestCompleted",channelId:s,readUntilCmid:n}}]:[]}case"UserReadPost_RequestCompleted":{const{channelId:s,readUntilCmid:n}=t,r=e.channelReadQueues.get(s);return r?n>=r?(e.channelReadQueues.delete(s),[]):[o(s)]:[]}default:return(0,n.exhaustivenessCheck)(t)}};function o(e){return async function(){return await(0,n.sleep)(300),{type:"UserReadPost_ThrottleTimedOut",channelId:e}}}},780032:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(728921),r=s(401193),a=s(592087);const i=(e,t)=>{switch(t.type){case"UserReorderedFolders":{const{order:s}=t;return e.locks.reorderFolders?[]:(e.locks.reorderFolders=!0,n.reorderFolders(e.organisers.folders,s),[async function({api:e}){try{return{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:1!==await e.fetch("messages.reorderFolders",{folder_ids:s.join(",")}),order:s}}catch(e){let t;return e instanceof a.IApi.RequestError&&(t=e.code),{type:"UserReorderedFolders_ReorderRequestCompleted",hasFailed:!0,error:t,order:s}}}])}case"UserReorderedFolders_ReorderRequestCompleted":{const{hasFailed:s}=t;if(e.locks.reorderFolders=!1,s){if(t.error);else if(r.isDev)throw new Error("Не удалось изменить порядок папок");return[]}return[]}default:(0,r.exhaustivenessCheck)(t)}}},936064:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{if("UserReportAttach"===t.type){const{attach:e,reason:s}=t;let r;switch(e.kind){case"Photo":r=t=>t.fetch("photos.report",{reason:s,owner_id:e.ownerId,photo_id:e.id});break;case"Video":r=t=>t.fetch("video.report",{reason:s,owner_id:e.ownerId,video_id:e.id});break;default:(0,n.exhaustivenessCheck)(e)}return[async function({api:e}){try{r&&await r(e)}catch{}return{type:"Noop"}}]}(0,n.exhaustivenessCheck)(t.type)}},469151:(e,t,s)=>{"use strict";s.d(t,{VISIBLE_MESSAGES_COUNT:()=>i,handler:()=>o});var n=s(401193),r=s(856562),a=s(777211);const i=250,o=(e,t)=>{switch(t.type){case"UserRequestChatInvitationLink":{const{peerId:s,isLinkWithHistory:n}=t,r=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getInviteLink",{peer_id:s,reset:0,visible_messages_count:n?i:0,group_id:(0,a.getOwnerGroupId)(r)},{retries:1});return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!t.link,link:t.link,isLinkWithHistory:n,peerId:s}}catch(e){return{type:"UserRequestChatInvitationLink_RequestCompleted",hasFailed:!0,isLinkWithHistory:n,peerId:s}}}]}case"UserRequestChatInvitationLink_RequestCompleted":{const{peerId:s,link:n,isLinkWithHistory:a,hasFailed:i}=t,o=e.convos.get(s);return!i&&o&&"ChatConvo"===o.kind&&n?(r.replaceInviteLinks(o,{...o.inviteLinks,...a?{withHistory:n}:{noHistory:n}}),[]):[]}case"UserResetChatInvitationLink":{const{peerId:s}=t,n=e.ownerId;return[async function({api:e}){try{const t=await e.fetch("messages.getInviteLink",{peer_id:s,reset:1,visible_messages_count:i,group_id:(0,a.getOwnerGroupId)(n)},{retries:1}),r=await e.fetch("messages.getInviteLink",{peer_id:s,reset:0,visible_messages_count:0,group_id:(0,a.getOwnerGroupId)(n)},{retries:1});return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!t.link||!r.link,links:{withHistory:t.link,noHistory:r.link},peerId:s}}catch(e){return{type:"UserResetChatInvitationLink_RequestCompleted",hasFailed:!0,peerId:s,links:{}}}}]}case"UserResetChatInvitationLink_RequestCompleted":{const{peerId:s,links:n,hasFailed:a}=t,i=e.convos.get(s);return a||"ChatConvo"!==i?.kind?[]:n.noHistory&&n.withHistory?(r.replaceInviteLinks(i,n),[]):[]}default:return(0,n.exhaustivenessCheck)(t)}}},185350:(e,t,s)=>{"use strict";s.d(t,{handler:()=>l});var n=s(401193),r=s(73514),a=s(103026),i=s(302551),o=s(84113),c=s(841093),d=s(777211);const l=(e,t)=>{switch(t.type){case"UserScrolledChannelHistory":{const{channelId:s,direction:a,startCmid:i,possibleSkipped:o}=t,c=e.channels.get(s);if(!c)return[];if("ChannelRestricted"===c.kind)return[];if(e.locks.getChannelHistory.has(u(s,i)))return[];e.locks.getChannelHistory.add(u(s,i));let d,l=Math.min(r.POSTS_PER_PAGE,o||r.POSTS_PER_PAGE)+2;switch(a){case"backward":d=-1;break;case"forward":d=1-l;break;case"around":l=r.POSTS_PER_PAGE,d=-Math.floor(.8*l),c.inReadCmid===i&&(d=Math.max(-c.unreadCount,d));break;default:(0,n.exhaustivenessCheck)(a)}return[async function({api:e}){try{const t=await e.fetch("channels.getHistory",{channel_id:s,start_cmid:Math.max(i,1),count:l,offset:d,extended:1},{retries:5});let r,o;switch(a){case"backward":r=l===t.items.length,o=!0;break;case"around":{const e=t.items.filter((({cmid:e})=>e<=i)).length;r=e===l+d;const s=t.items.length-e;o=s===-d;break}case"forward":r=!0,o=l===t.items.length;break;default:(0,n.exhaustivenessCheck)(a)}return{type:"UserScrolledChannelHistory_RequestSucceed",channelId:s,startCmid:i,response:t,hasMoreBackward:r,hasMoreForward:o}}catch(e){return{type:"UserScrolledChannelHistory_RequestFailed",channelId:s,startCmid:i}}}]}case"UserScrolledChannelHistory_RequestSucceed":{const{channelId:s,startCmid:n,response:r,hasMoreBackward:l,hasMoreForward:p}=t;e.locks.getChannelHistory.delete(u(s,n));const h=e.channels.get(s);if(!h)return[];if("ChannelRestricted"===h.kind)return[];const m=[];return r.items.reverse().forEach(((t,s,n)=>{const{post:r,reactions:d}=(0,c.fromApiPost)(t),u=a.findPostByCmid(h,r.cmid),g=i.merge(r,"Node"===u?.kind?u.item:void 0);d.forEach((t=>{e.reactionsOld.set(t.id,t)})),0===s&&g.cmid>1&&l&&m.push({kind:"GapNode",fromCmid:i.resolveCmid(1),toCmid:i.resolveCmid(g.cmid-1)}),m.push({kind:"Node",item:g});const f=o.lastCmid(h.history);s===n.length-1&&void 0!==f&&p&&g.cmid<f&&m.push({kind:"GapNode",fromCmid:i.resolveCmid(g.cmid+1),toCmid:i.resolveCmid(f)})})),a.insertPosts(h,m),(0,d.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:[]}),[]}case"UserScrolledChannelHistory_RequestFailed":{const{channelId:s,startCmid:n}=t;return e.locks.getChannelHistory.delete(u(s,n)),[]}default:return(0,n.exhaustivenessCheck)(t)}};function u(e,t){return`${e}-${t}`}},293558:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(401193),r=s(73514),a=s(103026),i=s(302551),o=s(841093),c=s(777211);const d=(e,t)=>{switch(t.type){case"UserScrolledChannelPostponedHistory":{const{channelId:s,startCmid:a,direction:o}=t,c=e.channels.get(s);if(!c)return[];if("ChannelRestricted"===c.kind)return[];if(e.locks.getChannelPostponedHistory.has(l(s,a||i.resolveCmid(0))))return[];e.locks.getChannelPostponedHistory.add(l(s,a||i.resolveCmid(0)));let d,u=Math.min(r.POSTS_PER_PAGE,r.POSTS_PER_PAGE)+2;switch(o){case"backward":d=1-u;break;case"forward":d=-1;break;case"around":u=r.POSTS_PER_PAGE,d=-Math.floor(.8*u);break;default:(0,n.exhaustivenessCheck)(o)}return[async function({api:e}){try{const t=await e.fetch("channels.getHistory",{channel_id:s,start_cmid:a||-1,count:u,offset:d,filter:"postponed",extended:1},{retries:5});let r,i;switch(o){case"backward":r=u===t.items.length,i=!0;break;case"around":{const e=t.items.filter((({cmid:e})=>e<=1/0)).length;r=e===u;const s=t.items.length-e;i=s===-0;break}case"forward":r=!0,i=u===t.items.length;break;default:(0,n.exhaustivenessCheck)(o)}return{type:"UserScrolledChannelPostponedHistory_RequestSucceed",channelId:s,startCmid:a,response:t,hasMoreBackward:r,hasMoreForward:i,hasMore:i}}catch(e){return{type:"UserScrolledChannelPostponedHistory_RequestFailed",channelId:s,startCmid:a}}}]}case"UserScrolledChannelPostponedHistory_RequestSucceed":{const{channelId:s,startCmid:n,response:r,hasMore:d}=t;e.locks.getChannelPostponedHistory.delete(l(s,n||i.resolveCmid(0)));const u=e.channels.get(s);if(!u)return[];if("ChannelRestricted"===u.kind)return[];const p=[];return r.items.forEach((e=>{const{post:t}=(0,o.fromApiPostonedPost)(e);p.push({id:t.cmid,content:t})})),u.postponed.hasMore=d,u.postponed.loaded=!0,a.insertPostponedPosts(u,p),(0,c.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:[]}),[]}case"UserScrolledChannelPostponedHistory_RequestFailed":{const{channelId:s,startCmid:n}=t;return e.locks.getChannelPostponedHistory.delete(l(s,n||i.resolveCmid(0))),[]}default:return(0,n.exhaustivenessCheck)(t)}};function l(e,t){return`${e}-${t}`}},209030:(e,t,s)=>{"use strict";s.d(t,{handler:()=>m});var n=s(401193),r=s(175953),a=s(856562),i=s(84113),o=s(649166),c=s(73514),d=s(777211),l=s(78874),u=s(946990),p=s(162241),h=s(592087);const m=(e,t,s)=>{switch(t.type){case"UserScrolledConvoHistory":{const{peerId:s,direction:r,startCmid:a,possibleSkipped:i}=t,l=e.ownerId,u=e.convos.get(s);if(!u)return[];const h=g(s,a);if(e.locks.getHistory.has(h))return[];e.locks.getHistory.add(h);let m,f=Math.min(c.MESSAGES_PER_PAGE,i||c.MESSAGES_PER_PAGE)+2;switch(r){case"backward":m=-1;break;case"forward":m=1-f;break;case"around":f=c.MESSAGES_PER_PAGE,m=-Math.floor(.8*f),u.inReadBy===a&&(m=Math.max(-u.unreadCount,m));break;default:(0,n.exhaustivenessCheck)(r)}return[async function({api:e,perfStats:t}){try{t?.addEventData(p.IPerfStats.EventType.openChat,{loadHistoryStart:t.getCurrentTime()});const i=await e.fetch("messages.getHistory",{peer_id:s,start_cmid:a,count:f,offset:m,extended:1,group_id:(0,d.getOwnerGroupId)(l),fwd_extended:1},{retries:5});let c,u;switch(t?.addEventData(p.IPerfStats.EventType.openChat,{loadHistoryEnd:t.getCurrentTime()}),r){case"backward":c=f===i.items.length,u=!0;break;case"around":{const e=i.items.filter((({conversation_message_id:e})=>o.resolveCmid(e)<=a)).length;c=e===f+m;const t=i.items.length-e;u=t===-m;break}case"forward":c=!0,u=f===i.items.length;break;default:(0,n.exhaustivenessCheck)(r)}return{type:"UserScrolledConvoHistory_RequestSucceed",response:i,peerId:s,startCmid:a,hasMoreBackward:c,hasMoreForward:u}}catch(e){return{type:"UserScrolledConvoHistory_RequestFailed",peerId:s,startCmid:a,error:e instanceof Error?e:void 0}}}]}case"UserScrolledConvoHistory_RequestSucceed":{const{peerId:s,startCmid:n,response:r,hasMoreBackward:i,hasMoreForward:o}=t;e.locks.getHistory.delete(g(s,n));const c=e.convos.get(s);if(!c)return[];const l=r.items.map((e=>(0,u.fromApiMessage)(e).message));return a.insertMessages(c,l,{backward:i,forward:o}),(0,d.insertPeers)(e,{apiUsers:r.profiles||[],apiGroups:r.groups||[],apiContacts:[]}),[]}case"UserScrolledConvoHistory_RequestFailed":{const{peerId:n,startCmid:r,error:i}=t;if(e.locks.getHistory.delete(g(n,r)),s.vkm_convo_check_can_read&&i&&i instanceof h.IApi.RequestError&&i.code===l.API_ERROR_ACCESS){const t=e.convos.get(n);t&&a.removeInitialGroupConvoGap(t)}return[]}case"MessagesHistoryWarmUp":{if(!s.vkm_history_warm_up)return[];const{convos:n,now:a}=t,{limit:l,offsetMultiplier:u,maxUnreadInclude:p,timeDiffInclude:h}=s.vkm_history_warm_up,m=Number(l)||c.MESSAGES_PER_PAGE,f=Number(u)||.8,C=Number(p)||void 0,v=Number(h)||6048e5;let y=n.filter((({history:e})=>{const t=i.lastNode({history:e,withFailed:!1,withDeleted:!1,withPending:!1});return!!t&&a-t.item.sentAt<=v}));C&&(y=y.filter((({unreadCount:e})=>e<=C)));const _=y.reduce(((t,s)=>{const{peerId:n,inReadBy:r,history:a}=s,c=r===i.lastCmid(a),d=c?o.resolveCmid(r-1):r,l=g(n,d);if(e.locks.getHistory.has(l))return t;e.locks.getHistory.add(g(n,d));const u=c?-1:-Math.floor(m*f);return[...t,{peerId:n,offset:u,startCmid:d,convo:s}]}),[]),k=e.ownerId;return[async function({api:e}){let t;try{t=await e.fetch("messages.getDiffContent",{conversation_messages:JSON.stringify(_.map((({peerId:e,offset:t,startCmid:s})=>({peer_id:e,cmid_mark:s,offset:t,limit:m})))),extended:1,group_id:(0,d.getOwnerGroupId)(k)})}catch{return{type:"MessagesHistoryWarmUp_RequestFailed",failedItems:_}}const s=t.items.reduce(((e,{messages:t,peer_id:s})=>{const n=_.find((({peerId:e})=>e===r.resolveId(s)));if(!n||!t)return e;const{convo:a,startCmid:i,offset:c}=n,d=t.filter((({conversation_message_id:e})=>o.resolveCmid(e)<=i)).length,l=d===m+c,u=t.length-d===-c;return[...e,{peerId:a.peerId,apiMessages:t,hasMoreBackward:l,hasMoreForward:u}]}),[]);return{type:"MessagesHistoryWarmUp_RequestSucceed",requestedItems:_,historyItems:s,apiUsers:t.profiles??[],apiGroups:t.groups??[],apiContacts:t.contacts??[]}}]}case"MessagesHistoryWarmUp_RequestSucceed":{const{requestedItems:s,historyItems:n,apiUsers:r,apiGroups:i,apiContacts:o}=t;for(const{peerId:t,startCmid:n}of s)e.locks.getHistory.delete(g(t,n));for(const{peerId:t,apiMessages:s,hasMoreBackward:r,hasMoreForward:i}of n){const n=e.convos.get(t);if(!n)continue;const o=s.map((e=>(0,u.fromApiMessage)(e).message));a.insertMessages(n,o,{backward:r,forward:i})}return(0,d.insertPeers)(e,{apiUsers:r,apiGroups:i,apiContacts:o}),[]}case"MessagesHistoryWarmUp_RequestFailed":{const{failedItems:s}=t;for(const{peerId:t,startCmid:n}of s)e.locks.getHistory.delete(g(t,n));return[]}default:(0,n.exhaustivenessCheck)(t)}};function g(e,t){return`${e}-${t}`}},398374:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{switch(t.type){case"UserSeenHelpHint":return e.helpHints.delete(t.hintId)?[async function({api:e}){try{return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:1!==await e.fetch("account.hideHelpHint",{hint_id:t.hintId},{retries:1})}}catch{return{type:"UserSeenHelpHint_RequestCompleted",hasFailed:!0}}}]:[];case"UserSeenHelpHint_RequestCompleted":return[];default:(0,n.exhaustivenessCheck)(t)}}},160452:(e,t,s)=>{"use strict";s.d(t,{handler:()=>c});var n=s(401193),r=s(856562),a=s(726478),i=s(84113),o=s(777211);const c=(e,t,s)=>{switch(t.type){case"UserSeenMessages":{const{fromCmid:n,toCmid:o,peerId:c,analyticsAppName:l}=t,u=e.convos.get(c);if(!u)return[];const p=i.around(u.history,n);if(void 0===p)return[];const h=p.nodes.reduce(((e,t)=>{const s="Node"===t.kind?t.item:void 0;return void 0!==s&&s.cmid>e&&s.cmid<=o&&!s.isOut&&(e=s.cmid),e}),n),m=u.inReadBy;r.readInUntil(u,h);const g=[...u.unreadReactions.keys()].filter((e=>e>=n&&e<=o));if(u.inReadBy===m&&0===g.length)return[];g.forEach((e=>r.readReactions(u,e))),a.refresh(e.organisers,u,s);const f=e.readQueues.get(c);return f?(f.inReadBy=u.inReadBy,g.forEach((e=>f.reactions.add(e))),[]):(e.readQueues.set(c,{inReadBy:u.inReadBy,reactions:new Set(g)}),[d(c,m,l)])}case"UserSeenMessages_ThrottleTimedOut":{const{peerId:n,prevInReadBy:r,analyticsAppName:a}=t;if(!e.convos.get(n))return e.readQueues.delete(n),[];const i=e.readQueues.get(n);if(!i)return[];const d=[];for(const e of i.reactions)if(d.push(e),i.reactions.delete(e),100===d.length)break;const l=i.inReadBy,u=e.ownerId,p=r<l,h=!1!==s.vkm_reactions&&d.length>0;return p||h?[async function({api:e}){try{await e.fetchMany([p&&{method:"messages.markAsRead",params:{peer_id:n,up_to_cmid:l,mark_conversation_as_read:0,group_id:(0,o.getOwnerGroupId)(u),from:a}},h&&{method:"messages.markReactionsAsRead",params:{peer_id:n,cmids:d.join(","),group_id:(0,o.getOwnerGroupId)(u)}}])}catch(e){}return{type:"UserSeenMessages_RequestCompleted",peerId:n,readUntilCmid:l,analyticsAppName:a}}]:c(e,{type:"UserSeenMessages_RequestCompleted",peerId:n,readUntilCmid:l,analyticsAppName:a},s)}case"UserSeenMessages_RequestCompleted":{const{peerId:s,readUntilCmid:n,analyticsAppName:r}=t;if(!e.convos.get(s))return[];const a=e.readQueues.get(s);return a?a.inReadBy<=n&&0===a.reactions.size?(e.readQueues.delete(s),[]):[d(s,n,r)]:[]}default:return(0,n.exhaustivenessCheck)(t)}};function d(e,t,s){return async function(){return await(0,n.sleep)(500),{type:"UserSeenMessages_ThrottleTimedOut",prevInReadBy:t,peerId:e,analyticsAppName:s}}}},665703:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(401193),r=s(103026),a=s(592087);const i=(e,t)=>{switch(t.type){case"UserSetChannelReaction":{const{channelId:s,cmid:n,reactionId:i}=t,c=e.channels.get(s);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,n);if(!d||"Node"!==d.kind)return[];const l=d.item.reactionId,u=c.id,p=d.item.cmid;return o(d.item,i),[async function({api:e}){try{return await e.fetch("likes.add",{type:"post",owner_id:u,item_id:p,reaction_id:i}),{type:"UserSetChannelReaction_RequestCompleted",hasFailed:!1,cmid:n,channelId:s,reactionId:i,prevReactionId:l}}catch(e){let t;return e instanceof a.IApi.RequestError&&(t=e.code),{type:"UserSetChannelReaction_RequestCompleted",hasFailed:!0,cmid:n,error:t,channelId:s,reactionId:i,prevReactionId:l}}}]}case"UserSetChannelReaction_RequestCompleted":{const{hasFailed:s,channelId:n,cmid:a,prevReactionId:i}=t;if(!s)return[];const c=e.channels.get(n);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,a);return d&&"Node"===d.kind?(o(d.item,i),[]):[]}case"UserUnsetChannelReaction":{const{channelId:s,cmid:n}=t,a=e.channels.get(s);if(!a||"ChannelRestricted"===a.kind)return[];const i=r.findPostByCmid(a,n);if(!i||"Node"!==i.kind||void 0===i.item.reactionId)return[];const c=i.item.reactionId,d=a.id,l=i.item.cmid;return o(i.item,void 0),[async function({api:e}){try{return await e.fetch("likes.delete",{type:"post",owner_id:d,item_id:l}),{type:"UserUnsetChannelReaction_RequestCompleted",hasFailed:!1,cmid:n,channelId:s,reactionId:c}}catch{return{type:"UserUnsetChannelReaction_RequestCompleted",hasFailed:!0,cmid:n,channelId:s,reactionId:c}}}]}case"UserUnsetChannelReaction_RequestCompleted":{const{hasFailed:s,channelId:n,cmid:a,reactionId:i}=t;if(!s)return[];const c=e.channels.get(n);if(!c||"ChannelRestricted"===c.kind)return[];const d=r.findPostByCmid(c,a);return d&&"Node"===d.kind?(o(d.item,i),[]):[]}default:(0,n.exhaustivenessCheck)(t)}};function o(e,t){const s=e.reactionId;if(e.reactionId=t,void 0!==s){const t=e.reactions.get(s);if(!t&&n.isDev)throw new Error("Реакция не найдена в списке реакций сообщения");t&&(t.count<=1?e.reactions.delete(s):t.count-=1)}if(void 0!==t){const s=e.reactions.get(t);s?s.count+=1:e.reactions.set(t,{reactionId:t,count:1})}}},694155:(e,t,s)=>{"use strict";s.d(t,{handler:()=>o});var n=s(401193),r=s(856562),a=s(777211),i=s(592087);const o=(e,t)=>{switch(t.type){case"UserSetMessageReaction":{const{peerId:s,cmid:n,reactionId:o,analyticsAppName:d,onFail:l}=t,u=e.convos.get(s);if(!u)return[];const p=r.findMessageByCmid(u,n);if(!p||"Normal"!==p.kind)return[];const h=p.reactionId,m=e.ownerId;return c(p,o,e.ownerId),[async function({api:e}){try{return{type:"UserSetMessageReaction_RequestCompleted",hasFailed:1!==await e.fetch("messages.sendReaction",{cmid:n,peer_id:s,reaction_id:o,group_id:(0,a.getOwnerGroupId)(m),from:d}),cmid:n,peerId:s,reactionId:o,prevReactionId:h,onFail:l}}catch(e){let t;return e instanceof i.IApi.RequestError&&(t=e.code),{type:"UserSetMessageReaction_RequestCompleted",hasFailed:!0,cmid:n,error:t,peerId:s,reactionId:o,prevReactionId:h,onFail:l}}}]}case"UserSetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:n,cmid:a,prevReactionId:i,onFail:o}=t;if(!s)return[];1011===t.error&&o();const d=e.convos.get(n);if(!d)return[];const l=r.findMessageByCmid(d,a);return l&&"Normal"===l.kind?(c(l,i,e.ownerId),[]):[]}case"UserUnsetMessageReaction":{const{peerId:s,cmid:n}=t,i=e.convos.get(s);if(!i)return[];const o=r.findMessageByCmid(i,n);if(!o||"Normal"!==o.kind||!o.reactionId)return[];const d=o.reactionId,l=e.ownerId;return c(o,void 0,e.ownerId),[async function({api:e}){try{return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:1!==await e.fetch("messages.deleteReaction",{cmid:n,peer_id:s,group_id:(0,a.getOwnerGroupId)(l)}),cmid:n,peerId:s,reactionId:d}}catch{return{type:"UserUnsetMessageReaction_RequestCompleted",hasFailed:!0,cmid:n,peerId:s,reactionId:d}}}]}case"UserUnsetMessageReaction_RequestCompleted":{const{hasFailed:s,peerId:n,cmid:a,reactionId:i}=t;if(!s)return[];const o=e.convos.get(n);if(!o)return[];const d=r.findMessageByCmid(o,a);return d&&"Normal"===d.kind?(c(d,i,e.ownerId),[]):[]}default:(0,n.exhaustivenessCheck)(t)}};function c(e,t,s){const r=e.reactionId;if(e.reactionId=t,r){const t=e.reactions.get(r);if(!t&&n.isDev)throw new Error("Реакция не найдена в списке реакций сообщения");t&&(t.count<=1?e.reactions.delete(r):(t.count-=1,t.peerIds.delete(s)))}if(t){const n=e.reactions.get(t);n?(n.count+=1,n.peerIds=new Set([s,...n.peerIds].sort(((e,t)=>e-t)))):e.reactions.set(t,{reactionId:t,count:1,peerIds:new Set([s])})}}},157768:(e,t,s)=>{"use strict";s.d(t,{handler:()=>i});var n=s(728921),r=s(401193),a=s(777211);const i=(e,t,s)=>{switch(t.type){case"UserUpdatedFolder":{const{folderId:r,name:i,addPeerIds:c,removePeerIds:d}=t;if(e.locks.updateFolder.has(r))return[];if(function(e,t){if(new Set([...e].filter((e=>t.has(e)))).size)return!0;return!1}(c,d))throw new Error("Peer id не может одновременно находиться в списке на добавление и на удаление");e.locks.updateFolder.add(r);const l=e.organisers.folders.find((e=>e.id===r));if(!l)return[];const u=(0,a.getConvosByIds)(e,Array.from(d)),p=(0,a.getConvosByIds)(e,Array.from(c));return i&&n.setName(l,i),(0,a.removeConvosFromFolder)(e,l.id,u,s),(0,a.addConvosToFolder)(e,l.id,p,s),[o(r,i,c,d)]}case"UserUpdatedFolder_UpdateRequestCompleted":{const{hasFailed:s,folderId:n}=t;if(e.locks.updateFolder.delete(n),s&&r.isDev)throw new Error("Не удалось изменить папку");return[]}default:(0,r.exhaustivenessCheck)(t)}};function o(e,t,s,n){return async function({api:r}){let a=!1;const i={folder_id:e};t&&(i.name=t),s.size&&(i.add_included_peer_ids=[...s].join(",")),n.size&&(i.remove_included_peer_ids=[...n].join(","));try{a=1!==await r.fetch("messages.updateFolder",i)}catch(e){a=!0}return{type:"UserUpdatedFolder_UpdateRequestCompleted",hasFailed:a,folderId:e,addPeerIds:s,removePeerIds:n,name:t}}}},144507:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{if("UserUpdatedSpaceRoom"===t.type){const s=e.spaces.get(t.spaceId);if(s&&"Space"===s.kind){const e=s.rooms.get(t.roomId);e&&(e.sectionId=t.data.sectionId)}return[]}(0,n.exhaustivenessCheck)(t.type)}},262385:(e,t,s)=>{"use strict";s.d(t,{handler:()=>a});var n=s(401193),r=s(175953);const a=(e,t)=>{const{type:s}=t;if("VacationMarkExpired"===s){const s=e.peers.get(t.userId);return"User"!==s?.kind||e.locks.clearVacationMark.has(s.id)||(e.locks.clearVacationMark.add(s.id),r.clearVacation(s)),[]}(0,n.exhaustivenessCheck)(s)}},8508:(e,t,s)=>{"use strict";s.d(t,{handler:()=>d});var n=s(777211),r=s(401193),a=s(136872),i=s(175953),o=s(164231),c=s(795412);const d=(e,t)=>{switch(t.variant.kind){case"FromVideoEngine":return function(e,t){const{next:s}=t;if("Failure"===s.kind){const t=e.convoConn.reconnectAttempts++;return[async function({videoEngine:e}){if(!e)return{type:"Noop"};const n=Math.min(2**t*500,1e4);await(0,r.sleep)(n);try{e.connect(s.config)}catch{return{type:"Noop"}}return{type:"VideoEngineBatchReceived",variant:{kind:"FromVideoEngine",next:await e.poll()}}}]}const n=function(e,t){const s=new Set;function n(t){switch(t.type){case"video_comment_new":e.peers.has(i.resolveId(t.comment.from_id))||s.add(t.comment.from_id);break;case"video_comment_delete":case"sticker":case"video_like":break;default:}}for(const e of t.updates)n(e);return{userIds:s}}(e,s);if(n.userIds.size>0)return[async function({api:e}){try{const[t]=await e.fetchMany([n.userIds.size>0&&{method:"users.get",params:{user_ids:Array.from(n.userIds).map(i.resolveId).map(i.toRealId).join(","),extended:1}}],{retries:1/0});return{type:"VideoEngineBatchReceived",variant:{kind:"FromVideoEngineWithMissingData",next:s,response:t}}}catch{return{type:"Noop"}}}];return l(e,s)}(e,t.variant);case"FromVideoEngineWithMissingData":return function(e,t){const{next:s,response:r}=t;r&&(0,n.insertPeers)(e,{apiUsers:r||[],apiGroups:[],apiContacts:[]});return l(e,s)}(e,t.variant);default:return(0,r.exhaustivenessCheck)(t.variant)}};function l(e,t){const s={like:0,sticker:0},n=t.updates.reduce(((t,n)=>{if(("video_like"===n.type||"sticker"===n.type)&&n.user_id!==e.viewer.id){const e="video_like"===n.type?"like":"sticker";if(++s[e]>5)return t}return t.push(n),t}),[]).flatMap((t=>{switch(t.type){case"video_comment_new":return function(e,t){const{video_id:s,comment:n}=t,r=e.videoConvos.get(o.resolveId(s));r&&o.addComment(r,(0,c.fromApiComment)(n));return[]}(e,t);case"video_comment_delete":return function(e,t){const{video_id:s,comment_id:n}=t,r=e.videoConvos.get(o.resolveId(s));if(!r)return[];return o.deleteComment(r,a.resolveCmid(n)),[]}(e,t);case"sticker":case"video_like":return function(e,t){const{video_id:s,type:n}=t,r=e.videoConvos.get(o.resolveId(s)),a="video_like"===n?"like":t.sticker.id;if(r&&a)return[async function({videoStickers:e}){return e?.send("video_like"===n?"like":t.sticker),{type:"Noop"}}];return[]}(e,t);default:return[]}}));return[...n,async function({videoEngine:e}){if(!e)return{type:"Noop"};try{return{type:"VideoEngineBatchReceived",variant:{kind:"FromVideoEngine",next:await e.poll()}}}catch{return{type:"Noop"}}}]}},255315:(e,t,s)=>{"use strict";s.d(t,{handler:()=>r});var n=s(401193);const r=(e,t)=>{switch(t.type){case"VideoMessageShapesGetById":{const{shapeId:s}=t;return e.locks.getVideoMessageShapesById.has(s)||e.videoMessageShapes?.has(s)?[]:(e.locks.getVideoMessageShapesById.add(s),[async function({api:e,storage:t}){const n=t.get("videomessage-shapes");n&&(n.expiresAt=0);try{const t=await e.fetch("messages.getVideoMessageShapesByIds",{ids:s.toString()});return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:s,response:t,hasFailed:!Boolean(t)}}catch{return{type:"VideoMessageShapesGetById__RequestCompleted",shapeId:s,response:null,hasFailed:!0}}}])}case"VideoMessageShapesGetById__RequestCompleted":{const{response:s,shapeId:n}=t;if(e.locks.getVideoMessageShapesById.delete(n),!s)return[];const r=s.shapes.reduce(((e,t)=>(e.set(t.id,t.raw_path),e)),new Map);return e.videoMessageShapes=new Map([...e.videoMessageShapes??[],...r]),[]}default:return(0,n.exhaustivenessCheck)(t)}}},344107:(e,t,s)=>{"use strict";s.d(t,{createStore:()=>i});var n=s(559222),r=s(401193),a=s(363598);function i(e,t,s=a.initial,i,c,d,l){let u=!1,p=!1;const h=r.isDev&&(0,n.devTools)();let m=[],[g,f]=s(t,i,c,d,l);h&&h.init(g);const C=s=>{if(p)return;if(!u)throw new Error("Стор еще не был активирован. Нужно вызвать store.start().");const[n,r]=(0,a.reducer)(g,s,t);h&&h.send(s,n);const i=g!==n;if(g=n,o(C,r,e,s.type),i)for(const e of m)e(n)};return{start:()=>{u||(u=!0,o(C,f,e,"Init"))},dispatch:C,subscribe:e=>(m.push(e),()=>{m=m.filter((t=>t!==e))}),featureFlags:t,getState:()=>g,dispose(){p=!0}}}function o(e,t,s,n){0!==t.length&&setTimeout((()=>{for(const r of t)"function"==typeof r&&r(s).then(e).catch((e=>{s.logger.error(`[${n}] Необработанная ошибка редьюсера`,e)}))}))}},559222:(e,t,s)=>{"use strict";function n(){return"undefined"!=typeof window&&"__REDUX_DEVTOOLS_EXTENSION__"in window?window.__REDUX_DEVTOOLS_EXTENSION__.connect({serialize:{options:{map:!0,set:!0}}}):null}s.d(t,{devTools:()=>n})},363598:(e,t,s)=>{"use strict";s.d(t,{IMPORTANT_USERS_COUNT:()=>Pt,initial:()=>Mt,reducer:()=>Et});var n=s(679005),r=s(191741),a=s(777211),i=s(401193),o=s(726478),c=s(211274),d=s(728921),l=s(241503),u=s(856562),p=s(175953),h=s(649166),m=s(19068),g=s(818005),f=s(103026),C=s(302551),v=s(769609),y=s(843779),_=s(596917),k=s(776983),I=s(468831),b=s(73514),w=s(106789),S=s(959996),R=s(513300),M=s(316034),E=s(160452),A=s(533787),U=s(275795),P=s(302496),T=s(358167),F=s(277383),N=s(790250),x=s(590901),q=s(134649),O=s(262385),D=s(861556),B=s(590492),L=s(857612),G=s(884075),H=s(749006),V=s(595742),K=s(458077),z=s(398374),W=s(659476),j=s(933112),$=s(369466),Q=s(458123),J=s(808277),X=s(293558),Y=s(719240),Z=s(637692),ee=s(179061),te=s(886546),se=s(892807),ne=s(6016),re=s(742315),ae=s(157768),ie=s(688494),oe=s(214078),ce=s(780032),de=s(185350),le=s(414639),ue=s(742962),pe=s(166051),he=s(469151),me=s(746826),ge=s(338911),fe=s(320198),Ce=s(376308),ve=s(780642),ye=s(51273),_e=s(88758),ke=s(497706),Ie=s(412925),be=s(743206),we=s(552347),Se=s(257209),Re=s(354369),Me=s(370618),Ee=s(856823),Ae=s(255315),Ue=s(774744),Pe=s(888947),Te=s(431773),Fe=s(694155),Ne=s(665703),xe=s(518136),qe=s(755255),Oe=s(544434),De=s(402278),Be=s(642469),Le=s(322768),Ge=s(849939),He=s(246230),Ve=s(209030),Ke=s(449902),ze=s(872466),We=s(387531),je=s(572651),$e=s(799516),Qe=s(512871),Je=s(412937),Xe=s(810704),Ye=s(273803),Ze=s(124596),et=s(315973),tt=s(230378),st=s(981758),nt=s(423560),rt=s(656441),at=s(495445),it=s(230360),ot=s(788380),ct=s(971891),dt=s(393329),lt=s(856573),ut=s(596431),pt=s(578744),ht=s(969769),mt=s(552212),gt=s(444329),ft=s(936064),Ct=s(83306),vt=s(130920),yt=s(558434),_t=s(246622),kt=s(144507),It=s(851147),bt=s(626261),wt=s(162241),St=s(399332);const Rt={ctrSubmit:!1,soundNotifications:!0,browserNotifications:!1,showRecommendations:!0,countOnlyNotMuted:!1,autoUnarchive:!0,transcriptAutoShow:!0,theme:"system",themeStyleId:k.SYSTEM_STYLE_ID,showThemeStyles:!0,verticalFoldersView:!1,messageReactionAnimation:!0,businessNotify:!1,push:y.VIEWER_DEFAULT_PUSH_SETTINGS,teacherVerification:!1,fastActionsTrigger:"hoverAndRightClick",messageSelfMentionHighlighting:"none",eduAccountSwitchBanner:!0,autoExtendReactionPicker:!1,bubblesTheme:"default",stickerHintsEnabled:!0,isStickersAnimationEnabled:!0,callsEnabled:!0,convoListWidthPercent:100,videoMessageAutoplay:!0},Mt=(e,t,s,n,r)=>{const a=p.resolveId(t),i=s?p.resolveId(s):void 0;if(!p.isUserPeerId(a))throw Error("Viewer может быть только пользователем");if(void 0!==i&&!p.isUserPeerId(i)&&!p.isGroupPeerId(i))throw Error("Owner может быть только пользователем или группой");const c=(0,w.fromApiProfileType)(n),d={convoConn:{status:"loading",pts:0,reconnectAttempts:0},channelConn:{status:"running",ts:0,reconnectAttempts:0},spaceConn:{status:"running",ts:0,reconnectAttempts:0},viewer:{id:a,profileType:c,settings:Rt,profileInfo:{id:a},accounts:[]},ownerId:p.resolveId(),organisers:o.empty(),channels:new Map([[f.resolveId(0),{kind:"Channel",id:f.resolveId(0),name:"",description:[],activity:"",adminLevel:0,isVerified:!1,photo:{},inReadCmid:C.resolveCmid(0),unreadCount:0,isArchived:!1,isRepostsDisabled:!1,isMuted:!1,isClosed:!1,notificationsDisabledUntil:0,majorSortId:0,minorSortId:0,membersCount:0,isMember:!1,canMessage:!1,rights:{canPost:!1,canSendDonut:!1},pending:{},locks:{loading:!1,cleanUp:0},history:{confirmed:[],pending:[]},postponed:{history:{segments:[]},loaded:!1,hasMore:!0},actionButton:{isEnabled:!1},mediaViewerCache:{items:[],hasPrev:!0,hasNext:!0}}]]),spaces:new Map,spacesCalls:new Map,spacesTribunes:new Map,channelsRecommendationsIds:[],precreatedConvos:{peerIds:new Set,hasMore:!0},convos:new Map([[p.resolveId(),{kind:"UserConvo",peerId:p.resolveId(),unreadCount:0,majorSortId:0,minorSortId:0,isDrafted:!1,inReadBy:h.resolveCmid(0),outReadBy:h.resolveCmid(0),isNew:!1,folderIds:new Set,peerFlags:0,canWrite:{allowed:!1,reason:"unknown"},push:{mode:"everything",disabledUntil:0},unreadExpireables:new Set,unreadReactions:new Map,entrypoint:null,history:{confirmed:[],pending:[]},mediaViewerCache:{items:[],hasPrev:!0,hasNext:!0},styleId:k.SYSTEM_STYLE_ID,isStickersPopupAutoplayDisabledByAdmin:!1,isStickersPopupAutoplayDisabledByUser:!1}]]),composerDrafts:{},channelComposerDrafts:{},commentsComposerDrafts:{},readQueues:new Map,seenPosts:new Map,seenPostsStatsQueues:new Map,channelReadQueues:new Map,peers:new Map([[p.resolveId(),{kind:"User",id:p.resolveId(),firstName:"...",firstNameGen:"...",firstNameAcc:"...",lastName:"...",lastNameGen:"...",lastNameAcc:"...",sex:"unknown",isVerified:!1,canCall:!0,followersCount:0,canChangeFriendship:!1,canMessage:!1,friendship:"unfamiliar",isBlacklisted:!1,isBlacklistedByMe:!1,isProfileClosed:!1,isDeactivated:!1,canInviteToChats:!1}]]),lastSeens:new Map,typings:new Map,convosSearchIndex:v.create(),locks:{getConversations:{all:!1,unread:!1,archive:!1,messageRequest:!1},getChannels:{all:!1,unread:!1},hideFilter:{all:!1,unread:!1,chats:!1,archive:!1,messageRequest:!1,businessNotify:!1},getHistory:new Set,getConversationRestrictedMembers:new Set,getConversationMembers:new Set,getConversationInfo:new Set,getPrecreatedConversations:!1,spacesGetById:new Set,spacesGetCounters:!1,spacesSetSettings:new Set,sendQueue:new Map,edit:new Set,convosCleanup:new Map,channelsCleanup:new Map,updateFriendshipOrMembership:new Set,clearVacationMark:new Set,convoActions:new Set,setChatStickersDisplay:new Set,messageActions:new Set,channelActions:new Set,channelPostActions:new Set,settings:new Set,contactList:!1,deleteFolder:new Set,updateFolder:new Set,reorderFolders:!1,getChannelHistory:new Set,getChannelPostponedHistory:new Set,changeMessageRequest:new Set,getPostCommentsHistory:new Set,likeActions:new Set,commentActions:new Set,getVideoMessageShapesById:new Set,loadStickers:new Set,seenPostsStatsSend:!1,invalidateMessageReactions:!1,loadStickersKeywords:!1,loadStickerPacks:!1,loadStickersSettings:!1,loadRecommendedFolders:!1,readAllReactions:new Set,sendComment:new Set,editPost:new Set,urlSnippets:{load:!1,throttle:!1},loadCommentGroups:!1,getVideoCommentsHistory:new Set,videoCommentActions:new Set,sendVideoComment:new Set},hiddenPinnedMessages:new Map,helpHints:new Set,forceStickersReload:!1,stickers:new Map,stickersKeywords:new Map,contacts:{items:new Map,contacts:new Map,hasMore:!0},importantMessages:{messages:new Map,hasMore:!0},hiddenBotKeyboards:new Set,reactionsOld:new Map,messageReactionsConfig:{assets:new Map,allowedIds:new Set},allowedMessageReactionIds:new Set,postReactions:new Map,importantUsers:null,channelsConfig:{recommendations:{lastCollapsedVersion:0,version:1}},videoMessageShapes:null,activeCallsCount:0,messageReactedPeers:new Map,convosFailedMessages:Xe.DEFAULT_CONVOS_FAILED_MESSAGES_STORE,themeStyles:new Map,themeAppearances:new Map,themeBackgrounds:new Map,urlSnippetsCache:new Map,urlSnippetsQueue:new Set,onboardingTriggers:{userArchivedChat:!1},deviceId:"",eduIntegrationBanner:{isEnabled:!1,hiddenAt:null,hiddenCount:0},commentGroups:{ids:new Set,isReady:!1},videoConvos:new Map};if(0===a)return[d,[]];const l=void 0!==r&&r.viewer?.id===a&&r.viewer?.profileType===c&&(void 0===i||r.ownerId===i);return[l?{...d,...r}:d,[async function({storage:e,stats:t}){return e.identify(i||a),t.init(),{type:"Noop"}},()=>Promise.resolve({type:"InitialData",ownerId:i,withCache:l}),async({api:e,storage:t})=>{const s=await async function({api:e,storage:t}){const s=t.get("videomessage-shapes"),n=Math.round((new Date).getTime()/1e3),r=86400,a=s&&s.expiresAt>n;let i=null;if(a)i=s.response;else try{i=await e.fetch("messages.getVideoMessageShapes",{client_version:s?.response.version??0},{retries:3})}catch{}const o=i?{...i,shapes:[...s?.response.shapes||[],...i.shapes]}:null;!a&&o&&t.set("videomessage-shapes",{response:o,expiresAt:n+r});return o}({api:e,storage:t});return{type:"LoadVideoMessageShapes_RequestCompleted",videoMessageShapes:s}},async()=>e.vkm_reactions?{type:"InvalidateMessageReactions"}:{type:"Noop"}]]};function Et(e,t,s){if("TemporaryHackForResync"===t.type){const[t,n]=Mt(s,e.viewer.id,e.ownerId,"edu"===e.viewer.profileType?2:0);return t.organisers.filters.unread.headerNotMutedUnread=e.organisers.filters.unread.headerNotMutedUnread,[t,n]}const r=(0,n.createDraft)(e);let a;switch(t.type){case"Noop":a=[];break;case"InitialData":case"InitialData_RequestCompleted":case"InitialDataWithCached_RequestCompleted":case"InitialData_ChannelsReadyForUse":case"InitialData_SpacesReadyForUse":case"InitialData_ManagedGroupsFetched":case"InitialData_ThemeStylesLoaded":case"QueueConfigAndUsersFromSearch_RequestCompleted":a=At(r,t,s);break;case"LoadVideoMessageShapes_RequestCompleted":a=Ut(r,t,s);break;case"EngineBatchReceived":case"EngineBatchReceived_TypingsTimedOut":case"UpdateMessageRequestsCounter":case"UpdateMessageRequestsCounter_RequestCompleted":case"RefetchFoldersRequest_RequestCompleted":case"RefetchSpaceCounters_RequestCompleted":a=U.handler(r,t,s);break;case"ChannelEngineBatchReceived":a=P.handler(r,t,s);break;case"SpaceEngineBatchReceived":a=T.handler(r,t,s);break;case"QueueBatchReceived":a=V.handler(r,t,s);break;case"MoreConvosNeeded":case"MoreConvosNeeded_RequestCompleted":a=B.handler(r,t,s);break;case"MorePrecreatedConvosNeeded":case"MorePrecreatedConvosNeeded_RequestCompleted":a=G.handler(r,t,s);break;case"MoreChannelsNeeded":case"MoreChannelsNeeded_RequestCompleted":a=L.handler(r,t,s);break;case"CacheUpdateReceived":a=H.handler(r,t,s);break;case"UserSeenMessages":case"UserSeenMessages_ThrottleTimedOut":case"UserSeenMessages_RequestCompleted":a=E.handler(r,t,s);break;case"UserHitSend":case"UserHitSend_RequestCompleted":case"UserHitResendAllConvoFailedMessages":case"UserHitResendFailedMessage":case"UserHitSendWidget":case"UserHitSend_ErrorSnackbarShown":a=R.handler(r,t,s);break;case"UserHitEdit":case"UserHitEdit_Resend":case"UserHitEdit_CancelFailedEditing":case"UserHitEdit_RequestCompleted":a=M.handler(r,t,s);break;case"UserOpenedConvo":case"UserClosedConvo":case"UserOpenedConvo_ConvoRequestCompleted":case"UserOpenedConvo_StickersKeywordsRequestCompleted":a=A.handler(r,t,s);break;case"StickersCacheReceived":case"StickersReloadCompleted":a=Pe.handler(r,t,s);break;case"LoadStickersSettingsFromApi":case"LoadStickersSettingsFromApi_RequestCompleted":case"ChangeStickersSettings":case"ChangeStickersSettings_RequestCompleted":a=Te.handler(r,t,s);break;case"UserChangedFriendship":case"UserChangedFriendship_RequestCompleted":a=q.handler(r,t,s);break;case"VacationMarkExpired":a=O.handler(r,t,s);break;case"UserChangedGroupMembership":case"UserChangedGroupMembership_RequestCompleted":a=D.handler(r,t,s);break;case"UserChangedSetting":case"UserChangedSetting_RequestCompleted":a=F.handler(r,t,s);break;case"SettingThemeUpdated":case"SettingThemeUpdated_RequestCompleted":a=N.handler(r,t,s);break;case"SettingExperimentalUpdated":case"SettingExperimentalUpdated_RequestCompleted":a=x.handler(r,t,s);break;case"UserChangedBubblesTheme":case"UserChangedBubblesTheme_RequestCompleted":a=je.handler(r,t,s);break;case"UserPlayedMessage":case"UserPlayedMessage_RequestCompleted":a=K.handler(r,t,s);break;case"UserSeenHelpHint":case"UserSeenHelpHint_RequestCompleted":a=z.handler(r,t,s);break;case"UserChangedConvo":case"UserChangedConvo_RequestCompleted":case"UserPinMessage":case"UserPinMessage_RequestCompleted":case"UserUnpinMessage":case"UserUnpinMessage_RequestCompleted":case"UserChangedStickersPopupAutoplay":case"UserChangedStickersPopupAutoplay_RequestCompleted":case"UserChangedMute":case"UserChangedMute_RequestCompleted":case"UserChangedBusinessNotify":case"UserChangedBusinessNotify_RequestCompleted":case"UserChangeForbidWritingAll":case"UserChangeForbidWritingAll_RequestCompleted":case"UserRestrictChatMemberToWrite":case"UserRestrictChatMemberToWrite_RequestCompleted":a=W.handler(r,t,s);break;case"UserChangedMessage":case"UserChangedMessage_RequestCompleted":case"UserDeleteMessage":case"UserDeleteMessage_RequestCompleted":case"UserDeleteFailedMessage":case"UserDeleteAllFailedMessage":case"UserRestoreMessage":case"UserRestoreMessage_RequestCompleted":a=j.handler(r,t,s);break;case"UserChangedCollapsedVersion":a=ue.handler(r,t,s);break;case"LoadContactList":case"LoadContactList_RequestCompleted":a=$.handler(r,t,s);break;case"UserHideFilter":case"UserHideFilter_Completed":case"UserUndoHideFilter":case"UserActualizeHideFilter":a=J.handler(r,t,s);break;case"UserSentMessageRequest":case"UserSentMessageRequest_RequestCompleted":case"UserAcceptedChatMessageRequest":case"UserRejectedMessageRequest":case"UserAcceptedChatMessageRequest_RequestCompleted":case"UserRejectedChatMessageRequest_RequestCompleted":a=Q.handler(r,t,s);break;case"UserChangedChatTitle":case"UserChangedChatDescription":case"UserChangedChatTitle_RequestCompleted":case"UserChangedChatDescription_RequestCompleted":case"UserRemovedChatPhoto":case"UserSetChatPhoto":case"UserRemovedChatPhoto_RequestCompleted":case"UserChangedChatSettings":case"UserChangedChatSettings_RequestCompleted":a=ee.handler(r,t,s);break;case"UserOpenedConvoProfile":case"UserOpenedConvoProfile_ConvoRequestCompleted":case"UserOpenedConvoProfile_InviteLinksCompleted":case"UserOpenedConvoProfile_UGCPackListsCompleted":a=te.handler(r,t,s);break;case"UserChangedChatStickersDisplay":case"UserChangedChatStickersDisplay_RequestCompleted":a=se.handler(r,t,s);break;case"LoadImportantMessages":case"LoadImportantMessages_RequestCompleted":case"UserClosedImportantMessages":a=ne.handler(r,t,s);break;case"UserCreatedFolder":a=re.handler(r,t,s);break;case"UserUpdatedFolder":case"UserUpdatedFolder_UpdateRequestCompleted":a=ae.handler(r,t,s);break;case"UserDeletedFolder":case"UserDeletedFolder_DeleteRequestCompleted":a=ie.handler(r,t,s);break;case"UserHaveSeenPopupAnimation":a=oe.handler(r,t,s);break;case"UserReorderedFolders":case"UserReorderedFolders_ReorderRequestCompleted":a=ce.handler(r,t,s);break;case"UserScrolledChannelHistory":case"UserScrolledChannelHistory_RequestSucceed":case"UserScrolledChannelHistory_RequestFailed":a=de.handler(r,t,s);break;case"UserOpenedChannel":case"UserClosedChannel":case"UserOpenedChannel_ChannelRequestCompleted":a=le.handler(r,t,s);break;case"UserChangedChatMember":case"UserChangedChatMember_RequestCompleted":case"UserRemoveIncognitoMember":case"UserRemoveIncognitoMember_RequestCompleted":a=pe.handler(r,t,s);break;case"UserRequestChatInvitationLink":case"UserRequestChatInvitationLink_RequestCompleted":case"UserResetChatInvitationLink":case"UserResetChatInvitationLink_RequestCompleted":a=he.handler(r,t,s);break;case"LoadChatMembers":case"LoadChatMembers_RequestComplete":a=ge.handler(r,t,s);break;case"LoadChatInfo":case"LoadChatInfo_RequestComplete":a=fe.handler(r,t,s);break;case"UserChangedChannel":case"UserChangedChannel_RequestCompleted":case"UserSetChannelPhoto":case"UserUpdateChannelInfo":a=Ce.handler(r,t,s);break;case"UserChangedChannelPost":case"UserChangedChannelPost_RequestCompleted":a=ve.handler(r,t,s);break;case"UserOpenedSpace":case"UserClosedSpace":case"UserOpenedSpace_RequestCompleted":a=me.handler(r,t,s);break;case"UserReadPost":case"UserReadPost_ThrottleTimedOut":case"UserReadPost_RequestCompleted":a=ye.handler(r,t,s);break;case"UserLoadedCommentsHistory":case"UserLoadedCommentsHistory_RequestSucceed":case"UserLoadedCommentsHistory_RequestFailed":a=ke.handler(r,t,s);break;case"ChannelsOnboardingDone":case"ChannelsOnboardingDone_RequestSucceeded":case"ChannelsOnboardingDone_RequestFailed":a=Ie.handler(r,t,s);break;case"UserChangedComposerDraft":case"UserClearedComposerDraft":case"ComposerDraftsUpdateNeeded":case"ActualizeComposerDraft":case"ActualizeComposerDraft_RequestCompleted":a=be.handler(r,t,s);break;case"ResetUpdatesCounter":case"ResetUpdatesCounter_RequestCompleted":a=we.handler(r,t,s);break;case"UserProfileInfo_Update":a=_e.handler(r,t,s);break;case"UserChangedMessageAttachment":case"UserChangedMessageAttachment_RequestCompleted":a=Se.handler(r,t,s);break;case"UserChangedComment":case"UserChangedComment_RequestCompleted":a=Me.handler(r,t,s);break;case"UserLoadedLikes":case"UserLoadedLikes_RequestCompleted":case"UserChangedLike":case"UserChangedLike_RequestCompleted":a=Re.handler(r,t,s);break;case"UserChangedBrowserNotifications":case"UserChangedBrowserNotifications_RequestCompleted":a=Ee.handler(r,t,s);break;case"UserSetMessageReaction":case"UserSetMessageReaction_RequestCompleted":case"UserUnsetMessageReaction":case"UserUnsetMessageReaction_RequestCompleted":a=Fe.handler(r,t,s);break;case"ImportContact":a=Be.handler(r,t,s);break;case"VideoMessageShapesGetById":case"VideoMessageShapesGetById__RequestCompleted":a=Ae.handler(r,t,s);break;case"UserChangedPostAttachment":case"UserChangedPostAttachment_RequestCompleted":a=Ue.handler(r,t,s);break;case"PollConvoReactions":case"PollConvoReactions_RequestSucceed":a=xe.handler(r,t,s);break;case"UserChangedChannelComposerDraft":case"UserClearedChannelComposerDraft":a=qe.handler(r,t,s);break;case"UserHitPostSend":case"UserHitPostSend_RequestCompleted":a=Oe.handler(r,t,s);break;case"UserHitPostponedPostSend":case"UserHitPostponedPostPublish":a=De.handler(r,t,s);break;case"InvalidateMessageReactions":case"InvalidateMessageReactions_RequestCompleted":a=Le.handler(r,t,s);break;case"UserChangedPushSetting":case"UserChangedPushSetting_RequestCompleted":a=Ge.handler(r,t,s);break;case"UserScrolledConvoHistory":case"UserScrolledConvoHistory_RequestSucceed":case"UserScrolledConvoHistory_RequestFailed":case"MessagesHistoryWarmUp":case"MessagesHistoryWarmUp_RequestSucceed":case"MessagesHistoryWarmUp_RequestFailed":a=Ve.handler(r,t,s);break;case"UserReadAllReactions":case"UserReadAllReactions_RequestCompleted":a=Ke.handler(r,t,s);break;case"PollChannelPosts":case"PollChannelPosts_RequestSucceed":a=We.handler(r,t,s);break;case"LoadRecommendedFolders":case"LoadRecommendedFolders_RequestComplete":a=$e.handler(r,t,s);break;case"UserHitCommentSend":case"UserHitCommentSend_RequestCompleted":case"UserHitCommentSend_HistoryRequestCompleted":a=Ye.handler(r,t,s);break;case"UserChangedCommentsComposerDraft":case"UserClearedCommentsComposerDraft":a=Ze.handler(r,t,s);break;case"UserHitEditComment":case"UserHitEditComment_RequestCompleted":a=et.handler(r,t,s);break;case"UserScrolledChannelPostponedHistory":case"UserScrolledChannelPostponedHistory_RequestFailed":case"UserScrolledChannelPostponedHistory_RequestSucceed":a=X.handler(r,t,s);break;case"UserClosedChannelPostponed":a=Y.handler(r,t,s);break;case"UserHitPostponedPostEdit":case"UserHitPostponedPostEditTime":a=Z.handler(r,t,s);break;case"UserSetChannelReaction":case"UserSetChannelReaction_RequestCompleted":case"UserUnsetChannelReaction":case"UserUnsetChannelReaction_RequestCompleted":a=Ne.handler(r,t,s);break;case"UserHideConversationsBar":a=tt.handler(r,t,s);break;case"UserHideConvoBanner":a=st.handler(r,t,s);break;case"UserHitPostEdit":case"UserHitPostEdit_RequestCompleted":a=it.handler(r,t,s);break;case"ConvoMediaViewerCacheRemoved":case"ConvoMediaViewerCacheInserted":a=rt.handler(r,t,s);break;case"ChannelMediaViewerCacheRemoved":case"ChannelMediaViewerCacheInserted":a=at.handler(r,t,s);break;case"SettingsFromApiLoaded":case"SettingsFromApiLoaded_RequestCompleted":a=ot.handler(r,t,s);break;case"SettingsThemeStyleUpdated":case"SettingsThemeStyleUpdated_RequestCompleted":a=mt.handler(r,t,s);break;case"UserLoadedUrlSnippets":case"UserLoadedUrlSnippets_RequestCompleted":case"UserLoadedUrlSnippets_ThrottleTimedOut":a=ct.handler(r,t,s);break;case"HideEduIntegrationBanner":case"ShowEduIntegrationBanner":a=He.handler(r,t,s);break;case"UserReportAttach":a=ft.handler(r,t,s);break;case"UserJoinedSpace":case"UserJoinedSpace_RequestCompleted":case"UserLeftSpace":case"UserLeftSpace_RequestCompleted":a=Ct.handler(r,t,s);break;case"UserChangedSpaceMute":case"UserChangedSpaceMute_RequestCompleted":a=vt.handler(r,t,s);break;case"UserCreatedSpaceSection":a=yt.handler(r,t,s);break;case"UserCreatedSpaceRoom":a=_t.handler(r,t,s);break;case"UserUpdatedSpaceRoom":a=kt.handler(r,t,s);break;case"LoadCommentGroups":case"LoadCommentGroups_RequestComplete":a=It.handler(r,t,s);break;case"UserChangedSpace":case"UserChangedSpace_RequestCompleted":a=bt.handler(r,t,s);break;case"UserOpenedVideoChat":case"UserOpenedVideoChat_RequestCompleted":case"UserOpenedVideoChat_RequestFailed":case"UserClosedVideoChat":case"VideoEngineBatchReceived":a=dt.handler(r,t,s);break;case"MoreVideoCommentsNeeded":case"MoreVideoCommentsNeeded_RequestCompleted":a=lt.handler(r,t,s);break;case"UserChangedVideoComment":case"UserChangedVideoComment_RequestCompleted":a=ut.handler(r,t,s);break;case"UserHitVideoCommentSend":case"UserHitVideoCommentSend_RequestCompleted":a=pt.handler(r,t,s);break;default:(0,i.exhaustivenessCheck)(t)}r.convos.set(p.resolveId(),u.safeGet(e.convos,p.resolveId())),r.peers.set(p.resolveId(),p.safeGet(e.peers,p.resolveId())),r.channels.set(f.resolveId(0),f.safeGet(e.channels,f.resolveId(0)));const o=(0,n.finishDraft)(r);if(e.hiddenPinnedMessages!==o.hiddenPinnedMessages&&a.push((async function({storage:e}){return e.set("hidden-pinned-messages",Array.from(o.hiddenPinnedMessages.entries()).reduce(((e,[t,s])=>(e[t]=s,e)),{})),{type:"Noop"}})),e.hiddenBotKeyboards!==o.hiddenBotKeyboards&&a.push((async function({storage:e}){return e.set("hidden-bot-keyboards",o.hiddenBotKeyboards),{type:"Noop"}})),o.organisers.filters.businessNotify.isHidden&&"Noop"!==t.type&&"UserUndoHideFilter"!==t.type&&"visible"===document.visibilityState){const e=o.organisers.filters.businessNotify.unreadCount;a.push((async function(){return 0===e?{type:"Noop"}:{type:"UserUndoHideFilter",kind:"businessNotify"}}))}return[o,a]}const At=(e,t,s)=>{switch(t.type){case"InitialData":{const{ownerId:n,withCache:o}=t,c=n?(0,a.getOwnerGroupId)(n):0,l=e.viewer.id,u=async({engine:e,api:t,storage:n,perfStats:a})=>{const u=await(0,Xe.getConvosFailedMessagesFromStorage)(n);if(s.vkm_new_chunk_parser){_.dontUse__enableNewParser__hack();let e=!1,t=500;for(;!e;)try{await(0,r.default)(),e=!0}catch{await(0,i.sleep)(t),t=Math.min(2*t,2e3)}}if(o){const[e,s,n,r]=await t.fetchMany([{method:"account.getInfo",params:{fields:b.API_GET_INFO_FIELDS.join(",")}},{method:"account.getMulti",params:{fields:b.API_GET_MULTI_FIELDS.join(",")}},{method:"account.getProfileInfo",params:{}},{method:"notifications.getSettings",params:{}}],{retries:2,timeout:2e4});return{type:"InitialDataWithCached_RequestCompleted",responseMultiAccount:s,responseProfileInfo:n,serverUserSettings:{ctrSubmit:Boolean(e.messages_multiline_input),showRecommendations:!Boolean(e.messages_recommendation_list_hidden),countOnlyNotMuted:Boolean(e.show_only_not_muted_messages),autoUnarchive:Boolean(e.messages_auto_unarchive),transcriptAutoShow:Boolean(e.messages_transcript_auto_show),businessNotify:Boolean(e.business_notify_enabled),push:(0,S.fromApiViewerPushSettings)(r),teacherVerification:Boolean("1"===e.settings?.find((e=>"messages_show_banner_teacher_verification"===e.name))?.value)}}}const p=await t.fetch("messages.getLongPollServer",{need_pts:1,lp_version:e.version,group_id:c},{retries:1/0,usePrefetch:!0});if(!p.pts)throw new Error("Отсутствует pts");e.connect({...p,pts:p.pts});const h=s.vkm_up_drafted_convos_in_list?Object.keys(n.get("drafts")||{}):[],[f,C,v,y,I,w,R,M,E,A,U,P,T]=await t.fetchMany([{method:"messages.getConversations",params:{count:b.CONVOS_PER_PAGE,group_id:c,extended:1}},{method:"messages.getConversationsById",params:{peer_ids:[l.toString(),...h].join(","),group_id:c,extended:1}},{method:"messages.getFolders",params:{with_peers:1,supported_types:d.getSupportedTypes(s)}},s.vkm_recommended_folders&&{method:"messages.getRecommendedFolders",params:{supported_types:d.getSupportedTypes(s)}},{method:"users.get",params:{}},0!==c&&{method:"groups.getById",params:{group_ids:String(c)}},{method:"messages.getCounters",params:{filter:"all"}},{method:"account.getInfo",params:{fields:b.API_GET_INFO_FIELDS.join(",")}},{method:"account.getHelpHints",params:{hints:b.API_GET_HELP_HINTS.join(",")}},{method:"account.getMulti",params:{fields:b.API_GET_MULTI_FIELDS.join(",")}},{method:"messages.getConfig",params:{}},{method:"account.getProfileInfo",params:{}},{method:"notifications.getSettings",params:{}}],{retries:1/0,timeout:2e4,usePrefetch:!0});a?.addEventData(wt.IPerfStats.EventType.appStart,{loadDataEnd:a.getCurrentTime()});const F=w?.groups?.[0],N=I[0];if(!N)throw new Error("Не удалось получить текущего пользователя");const x=U.config??{},[q,O]=Ft(n,x),D=window.localStorage.getItem(b.STORAGE_DEVICE_ID_KEY)||(0,gt.nanoid)();window.localStorage.setItem(b.STORAGE_DEVICE_ID_KEY,D);const B=n.get("edu-integration-banner"),L=n.get("settings-show-theme-styles");return{type:"InitialData_RequestCompleted",responseViewer:N,responseMultiAccount:A,responseGroup:F,responseConvos:f,responseProfileInfo:P,responseConvosById:C,responseMessagesConfig:U,hasMoreConvos:f.items.length>=b.CONVOS_PER_PAGE,folders:v,recommendedFolders:y?.items||[],activeCallsCount:R.calls||0,unreadCount:{messages:R.messages||0,messagesUnmuted:R.messages_unread_unmuted||0,archive:R.messages_archive_unread||0,archiveMentions:R.messages_archive_mentions_count||0,archiveTotal:R.messages_archive||0,messageRequest:R.message_requests||0,businessNotify:R.business_notify||0,businessNotifyTotal:R.business_notify_all||0,channelsTotal:R.channels?.total_count||0,channelsUnmuted:R.channels?.unmuted_count||0,folders:R.messages_folders||[]},convoLp:{pts:p.pts},hiddenPinnedMessages:n.get("hidden-pinned-messages"),hiddenBotKeyboards:n.get("hidden-bot-keyboards"),composerDrafts:m.validateRequiredFields(n.get("drafts")||{}),channelComposerDrafts:g.validateRequiredFields(n.get("channels-drafts")||{}),commentsComposerDrafts:n.get("comments-drafts")||{},businessNotifyManuallyHidden:!!n.get("business-notify-manually-hidden"),userSettings:{isStickersAnimationEnabled:!0,ctrSubmit:Boolean(M.messages_multiline_input),soundNotifications:n.get("settings-sound-notifications-on")??!0,browserNotifications:Boolean(n.get("settings-browser-notifications-on"))??!1,showRecommendations:!Boolean(M.messages_recommendation_list_hidden),countOnlyNotMuted:Boolean(M.show_only_not_muted_messages),autoUnarchive:Boolean(M.messages_auto_unarchive),transcriptAutoShow:Boolean(M.messages_transcript_auto_show),businessNotify:Boolean(M.business_notify_enabled),push:n.get("settings-push")??(0,S.fromApiViewerPushSettings)(T),teacherVerification:Boolean("1"===M.settings?.find((e=>"messages_show_banner_teacher_verification"===e.name))?.value),eduAccountSwitchBanner:q.eduAccountSwitchBanner,verticalFoldersView:q.verticalFoldersView,messageReactionAnimation:q.messageReactionAnimation,autoExtendReactionPicker:q.autoExtendReactionPicker,fastActionsTrigger:q.fastActionsTrigger,theme:q.theme,themeStyleId:s.vkm_theme_styles_settings?n.get("theme-style-id")||k.MABLE_STYLE_ID:k.SYSTEM_STYLE_ID,showThemeStyles:!s.vkm_theme_styles_settings||(L??!0),bubblesTheme:q.bubblesTheme,messageSelfMentionHighlighting:q.messageSelfMentionHighlighting,stickerHintsEnabled:q.stickerHintsEnabled,callsEnabled:q.callsEnabled,convoListWidthPercent:q.convoListWidthPercent,videoMessageAutoplay:q.videoMessageAutoplay},settingsWrittenToApi:O,helpHints:E.items.reduce(((e,t)=>(e.add(t.id),e)),new Set),conversationsBar:M.conversations_bar,convosFailedMessages:u,themeAppearances:n.get("theme-styles-appearances")||new Map,themeBackgrounds:n.get("theme-styles-backgrounds")||new Map,themeStyles:n.get("theme-styles")?.items||new Map,deviceId:D,eduIntegrationBanner:{isEnabled:!!s.vkm_edu_integration_banner&&!!x.messages_featureblocks_enabled?.enabled_items?.includes(b.EDU_INTEGRATION_BANNER_ID),hiddenAt:B?.hiddenAt??null,hiddenCount:B?.hiddenCount??0}}};return o?[async function(){return{type:"EngineBatchReceived",variant:{kind:"FromEngineFailure",now:Date.now()}}},u]:[u]}case"InitialDataWithCached_RequestCompleted":{e.viewer.profileInfo=(0,w.fromApiViewerProfileInfo)(t.responseProfileInfo),e.viewer.accounts=t.responseMultiAccount.items.map(w.fromApiViewerAccount),e.viewer.settings={...e.viewer.settings,...t.serverUserSettings};const n=e.viewer.id,r=e.ownerId,a=e.viewer.settings.callsEnabled;return[Tt(n,r,!0,s),async function({calls:e}){return a&&e?.init?.(),{type:"Noop"}},async function({channelEngine:e}){return e&&s.me_channels?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:{kind:"Failure"}}}:{type:"Noop"}}]}case"InitialData_RequestCompleted":{e.eduIntegrationBanner=t.eduIntegrationBanner,e.convosFailedMessages=t.convosFailedMessages,e.convoConn={status:"running",pts:t.convoLp.pts,reconnectAttempts:0},e.deviceId=t.deviceId,e.activeCallsCount=t.activeCallsCount,e.hiddenPinnedMessages=new Map(Object.entries(t.hiddenPinnedMessages||{}).map((([e,t])=>[p.resolveId(parseInt(e)),h.resolveCmid(t)]))),e.hiddenBotKeyboards=t.hiddenBotKeyboards||new Set,e.composerDrafts=t.composerDrafts,e.channelComposerDrafts=t.channelComposerDrafts,e.commentsComposerDrafts=t.commentsComposerDrafts,s.vkm_sublists_in_folder&&(0,a.insertSublists)(e,t.folders.included_lists_info?.map(Je.fromApiSublist));const n=(0,a.insertConvos)(e,t.responseConvos.items,s);(0,a.insertConvos)(e,t.responseConvosById.items,s),e.organisers.filters.businessNotify.isHidden=!!t.businessNotifyManuallyHidden,c.push(e.organisers.filters,"all",n,t.hasMoreConvos),0===t.unreadCount.archiveTotal&&c.push(e.organisers.filters,"archive",[],!1),0===t.unreadCount.messageRequest&&c.push(e.organisers.filters,"messageRequest",[],!1),c.updateCounters(e.organisers.filters,{unread:t.unreadCount.messages,unreadUnmuted:t.unreadCount.messagesUnmuted,archive:t.unreadCount.archive,archiveMentions:t.unreadCount.archiveMentions,archiveTotal:t.unreadCount.archiveTotal,messageRequests:t.unreadCount.messageRequest,businessNotify:t.unreadCount.businessNotify,businessNotifyTotal:t.unreadCount.businessNotifyTotal}),(0,a.insertFolders)(e,t.folders.items.map(Qe.fromApiFolder)),(0,a.insertRecommendedFolders)(e,t.recommendedFolders),t.unreadCount.folders?.forEach((t=>{d.setUnreadCounters(e.organisers.folders,d.resolveId(t.folder_id),t.total_count,t.unmuted_count)})),l.updateCounters(e.organisers.channelFilters,{unread:t.unreadCount.channelsTotal,unreadUnmuted:t.unreadCount.channelsUnmuted,archiveTotal:0}),(0,a.insertPeers)(e,{apiUsers:[...t.responseConvos.profiles||[],...t.responseConvosById.profiles||[]],apiGroups:[...t.responseConvos.groups||[],...t.responseConvosById.groups||[]],apiContacts:[...t.responseConvos.contacts||[],...t.responseConvosById.contacts||[]]}),e.viewer.profileInfo=(0,w.fromApiViewerProfileInfo)(t.responseProfileInfo),t.conversationsBar&&(e.conversationsBar=(0,nt.fromApiConversationsBar)(t.conversationsBar));const{user:r}=(0,I.fromApiUser)(t.responseViewer);e.peers.set(r.id,r),e.viewer.id=r.id,e.viewer.accounts=t.responseMultiAccount.items.map(w.fromApiViewerAccount);const i=t.responseGroup?(0,I.fromApiGroup)(t.responseGroup):void 0;i&&e.peers.set(i.id,i);const o=i?i.id:r.id;e.ownerId=o,e.viewer.settings=t.userSettings,e.helpHints=t.helpHints,e.themeStyles=t.themeStyles,e.themeAppearances=t.themeAppearances,e.themeBackgrounds=t.themeBackgrounds;const u=e.viewer.settings.callsEnabled;return[U.pollEngine(),Tt(r.id,o,!1,s),async function({api:e}){try{return{type:"InitialData_ManagedGroupsFetched",groups:(await e.fetch("groups.get",{user_id:p.toRealId(r.id),filter:"editor",offset:0,count:1e3,extended:1},{retries:2})).items||[]}}catch{return{type:"Noop"}}},async function({calls:e}){return u&&e?.init?.(),{type:"Noop"}},async function({api:e,channelEngine:t,storage:n}){if(!t||!s.me_channels)return{type:"Noop"};const r=await e.fetch("channels.getLongPollServer",{},{retries:1/0});t.connect(r);try{const t=async()=>{const t=n.get("channels-recomendations");if(!(!t||t.expiresAt<Date.now()))return{recommendedChannelIds:t.response,recommendationsVersion:t.version||1};const s=await e.fetch("channels.getRecommendations",{extended:0}),r=(s.items||[]).map((e=>f.resolveId(e.channel_id)));return n.set("channels-recomendations",{expiresAt:Date.now()+St.Time.Day,response:r,version:s.recommendations_version||1}),{recommendedChannelIds:r,recommendationsVersion:s.recommendations_version||1}},{recommendedChannelIds:s,recommendationsVersion:a}=await t(),i=n.get("selected-channels-from-search")||[],o=[...s,...i],[c,d,l]=await e.fetchMany([{method:"channels.get",params:{count:b.CHANNELS_PER_PAGE,extended:1}},0!==o.length&&{method:"channels.getById",params:{channel_ids:o.map((e=>e.toString())).join(","),extended:1}},{method:"channels.getConfig",params:{}}],{retries:1/0});return{type:"InitialData_ChannelsReadyForUse",ts:r.ts,channelsGetResponse:c,additionalChannelsResponse:d||void 0,recommendedChannelIds:s,channelsConfig:{recommendations:{lastCollapsedVersion:l.last_collapsed_recommendations_version||0,version:a}}}}catch{return{type:"Noop"}}},async function({api:e,spaceEngine:t}){if(!t)return{type:"Noop"};try{const s=await e.fetch("spaces.getLongPollServer",{});return t.connect(s),{type:"InitialData_SpacesReadyForUse",ts:s.ts,spacesGetResponse:await e.fetch("spaces.get",{},{retries:1/0})}}catch{return{type:"Noop"}}},async function(){return{type:"SettingThemeUpdated",value:t.userSettings.theme}},async function(){return{type:"SettingsFromApiLoaded",value:t.settingsWrittenToApi}},s.vkm_theme_styles_settings&&Ot(o),...s.vkm_history_warm_up?Ve.handler(e,{type:"MessagesHistoryWarmUp",convos:n,now:Date.now()},s):[],async function(){return{type:"LoadStickersSettingsFromApi"}},async function({notification:e}){return e.notifyListeners({kind:"counter",payload:t.unreadCount.messagesUnmuted}),{type:"Noop"}}]}case"QueueConfigAndUsersFromSearch_RequestCompleted":{const{queueConfig:n,importantUsers:r,selectedFromSearchConvos:i}=t;(0,a.insertConvos)(e,[...r.items,...i?.items??[]],s),(0,a.insertPeers)(e,{apiUsers:[...r.profiles??[],...i?.profiles??[]],apiGroups:[...r.groups??[],...i?.groups??[]],apiContacts:[...r.contacts??[],...i?.contacts??[]]});const o=r.items.reduce(((e,t)=>{const s=(0,ze.fromApiConvo)(t);return s&&e.add(s.convo.peerId),e}),new Set);e.importantUsers=o;const c=e.viewer.id;return[async function({queue:e}){return e.connect({user_id:p.toRealId(c),...n}),{type:"QueueBatchReceived",next:await e.poll()}}]}case"InitialData_ManagedGroupsFetched":return(0,a.insertPeers)(e,{apiGroups:t.groups,apiUsers:[],apiContacts:[]}),[];case"InitialData_ChannelsReadyForUse":{const{ts:s,channelsConfig:n,channelsGetResponse:r,recommendedChannelIds:i,additionalChannelsResponse:o}=t;if(e.channelConn.status="running",e.channelConn.ts=s,e.channelsConfig.recommendations=n.recommendations,o){const t=(0,a.insertChannels)(e,{apiChannels:o.items||[],apiGroups:o.groups||[]});i.forEach((s=>{-1!==t.findIndex((e=>e.id===s))&&e.channelsRecommendationsIds.push(s)}))}const c=(0,a.insertChannels)(e,{apiChannels:r.items||[],apiGroups:r.groups||[]}),d=(r.items?.length||0)>=b.CHANNELS_PER_PAGE;return l.push(e.organisers.channelFilters,"all",c,d),(0,a.insertPeers)(e,{apiUsers:[...r.profiles||[],...o?.profiles||[]],apiGroups:[...r.groups||[],...o?.groups||[]],apiContacts:[]}),[async function({channelEngine:e}){return e?{type:"ChannelEngineBatchReceived",variant:{kind:"FromChannelEngine",next:await e.poll()}}:{type:"Noop"}}]}case"InitialData_ThemeStylesLoaded":{const{themeStyles:s,themeAppearances:n,themeBackgrounds:r}=t;return e.themeStyles=s,e.themeAppearances=n,e.themeBackgrounds=r,[]}case"InitialData_SpacesReadyForUse":return e.spaceConn={status:"running",ts:t.ts,reconnectAttempts:0},(0,a.insertSpaces)(e,t.spacesGetResponse.items,{apiConvos:[],apiUsers:[],apiGroups:[],apiSpaceCalls:[],apiSpaceTribunes:[]},s),[async function({spaceEngine:e}){return e?{type:"SpaceEngineBatchReceived",variant:{kind:"FromSpaceEngine",next:await e.poll()}}:{type:"Noop"}}];default:return[]}},Ut=(e,t)=>"LoadVideoMessageShapes_RequestCompleted"===t.type?(e.videoMessageShapes=t.videoMessageShapes?.shapes.reduce(((e,{id:t,raw_path:s})=>(e.set(t,s),e)),new Map)??new Map,[]):[];const Pt=10;function Tt(e,t,s,n){const r=(0,a.getOwnerGroupId)(t);return async({api:t,storage:a,logger:i})=>{const o=a.get("selected-convos-from-search"),[c,d,l]=await t.fetchMany([{method:"queue.subscribe",params:{queue_ids:`onlfriends_${e},accountcounters_${e}`}},{method:"messages.searchConversations",params:{q:" ",count:Pt,extended:1,group_id:r}},!s&&!r&&!!o?.length&&{method:"messages.getConversationsById",params:{peer_ids:o.join(","),extended:1,group_id:r}}],{retries:1/0}).catch((e=>{throw"messages.getConversationsById"===e.apiError?.method&&100===e.code&&i.error(`Какая-то ошибка с пустым peer_ids в messages.getConversationsById. Значение сохранённых бесед selectedFromSearchConvosId: ${o}, typeof selectedFromSearchConvosId: ${typeof o}, stringyfied selectedFromSearchConvosId: ${JSON.stringify(o)}`,e),e}));return{type:"QueueConfigAndUsersFromSearch_RequestCompleted",queueConfig:c,importantUsers:d,selectedFromSearchConvos:l,featureFlags:n}}}const Ft=(e,t)=>{const s=e.get("settings-bubbles-theme"),n=e.get("settings-right-click-actions-enabled"),r=e.get("folders-view-vertical"),a=e.get("message-reactions-animation"),i=e.get("settings-edu-account-switch-banner-on"),o=e.get("settings-auto-extend-reaction-picker"),c=e.get("settings-message-self-mention-highlighting"),d=e.get("theme"),l=e.get("settings-calls-enabled"),u=e.get("video-message-autoplay"),p={bubblesTheme:qt(t.bubble_theme??s),fastActionsTrigger:Dt(t.fast_action_type??n),verticalFoldersView:t.vertical_folders_view??r??Rt.verticalFoldersView,messageReactionAnimation:t.message_reactions_animation??a??Rt.messageReactionAnimation,eduAccountSwitchBanner:t.edu_account_switch_banner??i??Rt.eduAccountSwitchBanner,autoExtendReactionPicker:t.auto_extend_reactions_picker??o??Rt.autoExtendReactionPicker,messageSelfMentionHighlighting:Nt(t.message_self_mention_highlighting??c),theme:xt(t.theme??d),stickerHintsEnabled:t.sticker_hints_enabled??Rt.stickerHintsEnabled,callsEnabled:l??Rt.callsEnabled,convoListWidthPercent:t.chat_list_collapse??Rt.convoListWidthPercent,videoMessageAutoplay:u??Rt.videoMessageAutoplay},h={};return void 0===t.bubble_theme&&void 0!==s&&(h.bubble_theme="enabled"===s),void 0===t.vertical_folders_view&&void 0!==r&&(h.vertical_folders_view=r),void 0===t.message_reactions_animation&&void 0!==a&&(h.message_reactions_animation=a),void 0===t.edu_account_switch_banner&&void 0!==i&&(h.edu_account_switch_banner=i),void 0===t.auto_extend_reactions_picker&&void 0!==o&&(h.auto_extend_reactions_picker=o),void 0===t.message_self_mention_highlighting&&void 0!==c&&(h.message_self_mention_highlighting=c),void 0===t.theme&&void 0!==d&&(h.theme=d),[p,h]},Nt=e=>{switch(e){case"primary":case"secondary":return e;default:return Rt.messageSelfMentionHighlighting}},xt=e=>{switch(e){case"light":case"dark":case"system":return e;default:return Rt.theme}},qt=e=>{switch(e){case"enabled":case!0:return"enabled";case"disabled":case!1:return"disabled";case"default":return"default";default:return Rt.bubblesTheme}};function Ot(e,t="ru"){const s=(0,a.getOwnerGroupId)(e);return async({api:e,storage:n})=>{n.get("theme-appearances")&&n.del("theme-appearances"),n.get("theme-backgrounds")&&n.del("theme-backgrounds");const r=n.get("theme-styles"),a=n.get("theme-styles-appearances")||new Map,i=n.get("theme-styles-backgrounds")||new Map,[o,c,d,l]=await e.fetchMany([{method:"messages.enumerateAppearances",params:{group_id:s}},{method:"messages.enumerateBackgrounds",params:{group_id:s}},{method:"messages.getConversationStyles",params:{show_hidden:1}},{method:"messages.getConversationStylesLang",params:{lang:t,version_hash:r?.langVersionHash}}],{retries:1/0}),u=o.appearances.reduce(((e,t)=>{const s=k.resolveAppearanceId(t.id),n=a.get(s);return(!n||n.updateTime<t.update_time)&&e.push(s),e}),[]),p=c.backgrounds.reduce(((e,t)=>{const s=k.resolveBackgroundId(t.id),n=i.get(s);return(!n||n.updateTime<t.update_time)&&e.push(s),e}),[]);if(0!==u.length||0!==p.length){const[t,s]=await e.fetchMany([0!==u.length&&{method:"messages.getAppearances",params:{appearance_ids:u.map((e=>e.toString())).join(",")}},0!==p.length&&{method:"messages.getBackgrounds",params:{background_ids:p.map((e=>e.toString())).join(",")}}],{retries:1/0});t?.appearances.forEach((e=>{const t=(0,ht.fromApiAppearance)(e);a.set(t.id,t)})),s?.backgrounds.forEach((e=>{const t=(0,ht.fromApiBackground)(e);i.set(t.id,t)})),n.set("theme-styles-appearances",a),n.set("theme-styles-backgrounds",i)}const h=l.not_changed&&l.lang===r?.lang,m=l.styles.reduce(((e,t)=>(e.set(t.id,t.value),e)),new Map),g=d.items.reduce(((e,t)=>{const s=h?r?.items.get(k.resolveStyleId(t.id))?.title:m.get(t.id);if(!s)return e;const n=(0,ht.fromApiStyle)(t,s);return e.set(n.id,n),e}),new Map);return n.set("theme-styles",{items:g,langVersionHash:l.version_hash,lang:"ru"}),{type:"InitialData_ThemeStylesLoaded",themeStyles:g,themeAppearances:a,themeBackgrounds:i}}}const Dt=e=>{switch(e){case"hover":case!1:return"hover";case"rightClick":case"right_button_click":case!0:return"rightClick";case"hoverAndRightClick":case"hover_and_right_button_click":return"hoverAndRightClick";default:return Rt.fastActionsTrigger}}},90604:(e,t,s)=>{"use strict";s.d(t,{initConfig:()=>r});var n=s(679005);function r(){(0,n.enableMapSet)()}},390964:(e,t,s)=>{"use strict";s.d(t,{MediaScopeStats:()=>a});const n=(0,s(476726).partConfigEnabled)("messenger_mediascope_stats_collect"),r={vk:{open:"23112",close:"25112",active:"24112"},vkme:{open:"23122",close:"25122",active:"24122"},mvk:{open:"23112",close:"25112",active:"24112"}};const a=new class{constructor(){this.sendRequest=e=>{const t=r[this.platform][e];t&&("hidden"===document.visibilityState&&void 0!==navigator.sendBeacon?navigator.sendBeacon(`https://${t}.ms.vk.com`):fetch(`https://${t}.ms.vk.com`,{method:"HEAD",mode:"no-cors"}).catch((()=>{})))},this.stopStatsCollecting=()=>{clearInterval(this.timerId),this.sendRequest("close")},this.startStatsCollecting=()=>{this.sendRequest("open"),this.timerId=setInterval((()=>{this.sendRequest("active")}),1e4)},this.handleVisibilityChange=()=>{"hidden"===document.visibilityState?this.stopStatsCollecting():this.startStatsCollecting()},this.start=e=>{n&&(this.platform=e,this.startStatsCollecting(),document.addEventListener("visibilitychange",this.handleVisibilityChange))},this.stop=()=>{this.platform&&(this.stopStatsCollecting(),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}}}},135020:(e,t,s)=>{"use strict";s.d(t,{screenWakeLocker:()=>n});const n=new class{_onVisibilityChange(){this.wakeLockSentinel&&"visible"===document.visibilityState&&this.lock().then((()=>{})).catch(console.error)}requestWakeLock(){return navigator.wakeLock?this.wakeLockSentinel?Promise.resolve():navigator.wakeLock.request("screen").then((e=>{this.wakeLockSentinel=e})):Promise.reject()}isLocked(){return!!this.wakeLockSentinel&&!this.wakeLockSentinel.released}lock(){return this.requestWakeLock().then((()=>{this.wakeLockSentinel&&document.addEventListener("visibilitychange",this.onVisibilityChange)})).catch((()=>{}))}unlock(){return this.wakeLockSentinel?(document.removeEventListener("visibilitychange",this.onVisibilityChange),this.wakeLockSentinel.release().finally((()=>{this.wakeLockSentinel=null}))):Promise.resolve()}constructor(){this.onVisibilityChange=this._onVisibilityChange.bind(this)}}},746217:(e,t,s)=>{"use strict";s.d(t,{IdleManager:()=>c});var n=s(678751),r=s(714209),a=s(705744),i=s(135020);const o=r.browser.iphone||r.browser.ipad||r.browser.ipod;class c extends n.default{stop(){this.started=!1,l(this.opts.element,this.opts.triggerEvents,this.cbActive),(0,a.isMvk)()&&this._isTopLevel()&&p()&&l(document,p(),this.onVisiblityChange),(0,a.isMvk)()&&o||(l(this.opts.focusElement,"focus",this.cbActive),l(this.opts.focusElement,"blur",this.cbInactive)),clearTimeout(this.setIdleTo),clearTimeout(this.checkIdleCbTo),clearTimeout(this.sendCbTO),this.is_idle=!0,this.opts.parentManager&&this.opts.parentManager.off("idle",this.cbInactive)}idle(e){this.is_idle=!0,e||this.opts.onIdleCb(),this.emit("idle")}unidle(e){this.is_idle=!1,e||this.opts.onUnIdleCb(),this.emit("unidle")}start(){this.started=!0,!(0,a.isMvk)()&&r.browser.mobile||(this.is_idle=!this._isFocused(),this.opts.parentManager&&this.opts.parentManager.on("idle",this.cbInactive),(0,a.isMvk)()&&this._isTopLevel()&&p()&&d(document,p(),this.onVisiblityChange),(0,a.isMvk)()&&o||(d(this.opts.focusElement,"focus",this.cbActive),d(this.opts.focusElement,"blur",this.cbInactive)),clearTimeout(this.checkIdleCbTo),this.checkIdleCb(),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))}constructor(e){super(),this.started=!1,this.is_idle=!0,this.activeTimeStart=null,this.checkIdleCb=()=>{this.started&&(d(this.opts.element,this.opts.triggerEvents,this.cbActive),clearTimeout(this.setIdleTo),this.setIdleTo=setTimeout(this.cbInactive,this.opts.idleTimeout))},this.cbActive=()=>{this.started&&(this.activeTimeStart=(new Date).getTime(),clearTimeout(this.setIdleTo),this.is_idle&&(this.is_idle=!1,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout((()=>{this.emit("unidle"),this.opts.onUnIdleCb&&this.opts.onUnIdleCb()}),100)),l(this.opts.element,this.opts.triggerEvents,this.cbActive),clearTimeout(this.checkIdleCbTo),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout))},this.cbInactive=()=>{this.started&&(i.screenWakeLocker.isLocked()||(this.activeTimeStart=null,this.is_idle||(this.is_idle=!0,clearTimeout(this.sendCbTO),this.sendCbTO=setTimeout((()=>{this.emit("idle"),this.opts.onIdleCb&&this.opts.onIdleCb()}),100)),clearTimeout(this.checkIdleCbTo),l(this.opts.element,this.opts.triggerEvents,this.cbActive),d(this.opts.element,this.opts.triggerEvents,this.cbActive),this.checkIdleCbTo=setTimeout(this.checkIdleCb,this.opts.idleTimeout)))},this.getActiveTime=()=>!this.is_idle&&this.activeTimeStart?(new Date).getTime()-this.activeTimeStart:0,this.onVisiblityChange=()=>{"visible"===u()?this.cbActive():this.cbInactive()},this._isTopLevel=()=>{const{focusElement:e}=this.opts;return e===window||e===document},this._isFocused=()=>{const{focusElement:e}=this.opts;if(this._isTopLevel()){const e=u();return"string"==typeof e&&"visible"===e}return document.activeElement===e},this.opts={triggerEvents:"mousemove keydown",onIdleCb:()=>{},onUnIdleCb:()=>{},focusElement:e.element,idleTimeout:3e4,...e}}}function d(e,t,s){(0,a.isMvk)()?window.addEvent(e,t,s,{passive:!0}):window.addEvent(e,t,s)}function l(e,t,s){(0,a.isMvk)()?window.removeEvent(e,t,s,{passive:!0}):window.removeEvent(e,t,s)}function u(){return document.visibilityState||document.webkitVisibilityState}function p(){let e="visibilitychange";return document.visibilityState||(document.webkitVisibilityState?e+="webkit":e=""),e}},431270:(e,t,s)=>{"use strict";e.exports=s.p+"fa49a94eafeb8afcab7c.js"}}]);try{stManager.done("dist/web/chunks/05cf136b.07c856a9.js")}catch(e){}