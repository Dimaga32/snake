"use strict";(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[18887],{233613:(e,t,i)=>{i.d(t,{StickersAnimation:()=>r});var s=i(226095);let r=function(){let e,t,i,n=!1,o=!1,a={},c={},l={},d={};const u={};function h(e){let t=e.getAttribute("data-uid");return t||(t=Math.random().toString(32).substr(2),e.setAttribute("data-uid",t)),t}function g(e,t){u[h(e)]=t}function p(e){let t=e.getAttribute("data-uniq-id");if(!e.querySelector(".svg_sticker_animation"))return!1;let i=l[t];return i||!1}function _(e){if(u[h(e)])return;g(e,!0);let t=p(e),n=e.getAttribute("data-uniq-id");const o=e.getAttribute("data-uid");if(e.classList.contains("animation_play"))return;let d=e.getAttribute("data-animation-path"),_=e.getAttribute("data-sticker-id"),f=!1;const v=c[_];if(_&&(f=(v||d)&&m(e)),f){const u=e.getAttribute("data-animation-class")||"";let h={containers:[e],loop:!0,autoplay:!0,name:o,group:"sticker",lazyLoading:!1,className:`svg_sticker_animation ${u}`};v?h.animationData=v:h.animationUrl=d;let g=e.querySelector(".svg_sticker_animation");g&&g.remove(),t=i.loadAnimation(h),a[_]||t.then((t=>{const i=t.animationData;c[_]=i,l[n]=t,t.addEventListener("firstFrame",(()=>{const t=e.querySelector(".sticker_img");t&&(0,s.hide)(t),e.classList.add("animation_play")}),{once:!0}),t.addEventListener("destroy",(()=>{r.stopAnimation(e)}))})).catch((()=>null))}}function f(){return t().then((e=>(i=e,i)))}return{init(e){t=e.animatorLoader},checkSettingsAndLoadInWeb:function(e){if(StickersSettings.getAutoplay()){let t=document.getElementById("fc_msg"+e),i=t?t.querySelector(".sticker_animation"):null;r.loadAndPlaySticker(i)}},checkSettingsAndLoad:function(e){if(StickersSettings.getAutoplay()){let t=$(`.msg_id_${e} .sticker_animation`);r.loadAndPlaySticker(t)}},loadStickerInMvkIMAndPlay:function(e,t){let i="_msg"+e;t&&(i="msg_id_"+e);const s=document.querySelector(`.${i}`);let n=s?s.querySelector(".sticker_animation"):null;r.loadAndPlayStickerWithTimer(n,500)},loadAutoplayAnimationStickers:function(e){if(!i)return void f().then((()=>{r.loadAutoplayAnimationStickers(e)}));if(e){if(o)return;o=!0}if(n)return;n=!0;let t=document.querySelectorAll(".sticker_animation_autoplay");t&&each(t,(function(e,t){_(t)})),n=!1},loadAndPlaySticker:function(e){e&&(i?requestAnimationFrame((()=>{_(e)})):f().then((()=>{r.loadAndPlaySticker(e)})))},loadAndPlayStickerWithTimer:function(e,t){if(!e)return;if(d[e])return;t||(t=1e3);let i=document.getElementById(e);i?.classList.contains("sticker_animation_disabled_timer")||(d[e]=setTimeout((function(){!i&&(i=document.getElementById(e),i?.classList.contains("sticker_animation_disabled_timer"))||(r.loadAndPlaySticker(i),clearTimeout(d[e]),d[e]=!1)}),t))},reloadStickers:function(){l={}},touchStartSticker:function(t){t.addEventListener("contextmenu",r.preventContextMenu,!1),e=setTimeout((function(){r.loadAndPlaySticker(t)}),500)},touchEndSticker:function(){e&&clearTimeout(e)},preventContextMenu:function(e){e.preventDefault(),e.stopPropagation()},stopAnimation(e){const t=p(e);t&&t.pause();const i=e.getAttribute("data-uniq-id");e.classList.remove("animation_play");const r=e.querySelector(".sticker_img");r&&(0,s.show)(r),g(e,!1),delete l[i]}};function m(e){let t=e.getBoundingClientRect().top,i=e.getBoundingClientRect().bottom;return t<window.innerHeight&&i>=0&&"none"!==e.style.display}}()},533481:(e,t,i)=>{i.d(t,{StickersAnimation:()=>r.StickersAnimation});var s=i(8520),r=i(233613);r.StickersAnimation.init({animatorLoader:()=>(0,s.asyncImportLoader)((()=>Promise.all([i.e(69706),i.e(23666)]).then(i.bind(i,15556)).then((({LottieManager:e})=>e))))})},685749:(e,t,i)=>{i.d(t,{GIFTS_STICKERS_RANDOM_PACK_GIFT_ID:()=>s});const s=10101},309649:(e,t,i)=>{i.d(t,{Gift:()=>s});class s{constructor(e,t,i,s,r,n,o){this.id=e,this.images=t,this.title=i,this.description=s,this.isDisabled=r,this.price=n,this.limit=o}}},183982:(e,t,i)=>{i.d(t,{GiftService:()=>d});var s=i(331635),r=i(407033),n=i(621320),o=i(634348),a=i(127126),c=i(309649),l=i(685749);let d=class{async fetchGift(e,t){const i=await this.giftsApi.getCatalogGift({gift_id:e},{signal:t});if(i.length)return this.createGiftFromApiData(i[0])}createGiftFromApiData(e){const t=e.gift?.id;if(!t)return;const i=[[48,e.gift?.thumb_48],[96,e.gift?.thumb_96],[256,e.gift?.thumb_256],[512,e.gift?.thumb_512]].filter((e=>void 0!==e[1])).map((([e,t])=>({width:e,height:e,url:t})));let s,r;return t===l.GIFTS_STICKERS_RANDOM_PACK_GIFT_ID?s=e.description||void 0:r=e.description||void 0,new c.Gift(t,i,s,r,Boolean(e.disabled),e.price??0,e.gifts_left)}async fetchBalance(e){return(await this.accountApi.getBalance({},{signal:e})).votes}async send(e){try{const t=await this.giftsApi.send({gift_id:e.giftIds.join(","),user_ids:e.recipientIds.join(","),message:e.message,privacy:e.isPrivate?1:0,ref:e.ref,confirm:e.isConfirmed?1:0,guid:Math.round(1e6*Math.random())}),i={};return t.confirmation?.price&&(i.confirmation={price:t.confirmation.price,balance:t.confirmation.balance}),i}catch(e){if("api_error"===e.type){const{error_code:t,confirmation_text:i}=e.error;if(t===r.API_ERROR_NEED_CONFIRMATION)return{confirmation:{text:i}};if(t===r.API_ERROR_BALANCE)return{isNeedVotes:!0}}throw e}}constructor(e,t){this.accountApi=e,this.giftsApi=t}};d=(0,s.__decorate)([a.scope.container(),(0,s.__metadata)("design:paramtypes",[n.AccountApi,o.GiftsApi])],d)},929420:(e,t,i)=>{i.d(t,{GiftRecipient:()=>s});class s{constructor(e,t,i,s,r,n,o){this.id=e,this.name=t,this.description=i,this.photos=s,this.isOnline=r,this.isOnlineMobile=n,this.isDisabled=o}}},175026:(e,t,i)=>{i.d(t,{GiftRecipientsProvider:()=>l});var s=i(331635),r=i(72442),n=i(420429),o=i(127126),a=i(929420);const c="occupation,photo_50,photo_100,online,deactivated";let l=class{async fetchSelectedGiftRecipients(e,t){if(!e.length)return[];return(await this.usersApi.get({user_ids:e.join(","),fields:c},{signal:t})).map((e=>this.createGiftRecipientFromApiData(e)))}async fetchSuggestedGiftRecipients(e,t,i){const s=await this.friendsApi.get({order:"hints",offset:e,count:t,fields:c},{signal:i});if(s.items.some((e=>e instanceof Object))){const{items:e,count:t}=s;return[e.map((e=>this.createGiftRecipientFromApiData(e))),t]}return[[],0]}async searchGiftRecipients(e,t,i,s){const{items:r,count:n}=await this.usersApi.search({q:e,offset:t,count:i,from_list:"friends",fields:c},{signal:s});return[r.map((e=>this.createGiftRecipientFromApiData(e))),n]}createGiftRecipientFromApiData(e){const t=[e.first_name,e.last_name].filter((e=>void 0!==e)).join(" ")||void 0,i=[[50,e.photo_50],[100,e.photo_100]].filter((e=>void 0!==e[1])).map((([e,t])=>({width:e,height:e,url:t})));return new a.GiftRecipient(e.id,t,e.occupation?.name,i,Boolean(e.online),Boolean(e.online_mobile),Boolean(e.deactivated))}constructor(e,t){this.friendsApi=e,this.usersApi=t}};l=(0,s.__decorate)([o.scope.container(),(0,s.__metadata)("design:paramtypes",[r.FriendsApi,n.UsersApi])],l)},609897:(e,t,i)=>{i.d(t,{ApiNamespace:()=>n});var s=i(933052),r=i(853883);class n{makeMethod(e,t){return(i,n,o)=>{const a=`${this.namespace}.${e}`;if(t){const e=o?.version??r.API_VERSION;try{const t=this.apiPrefetch?.loadPrefetchCache(a,e,i);if(t)return Promise.resolve(t)}catch(e){return console.error(e),Promise.reject(e)}}return(0,s.api)(a,i,o,n)}}constructor(e){this.apiPrefetch=e}}},621320:(e,t,i)=>{i.d(t,{AccountApi:()=>o});var s=i(331635),r=i(609897),n=i(127126);let o=class extends r.ApiNamespace{get namespace(){return"account"}constructor(){super(...arguments),this.getInfo=this.makeMethod("getInfo"),this.getPrivacySettings=this.makeMethod("getPrivacySettings"),this.setPrivacy=this.makeMethod("setPrivacy"),this.getProfileInfo=this.makeMethod("getProfileInfo"),this.getBalance=this.makeMethod("getBalance"),this.hideHelpHint=this.makeMethod("hideHelpHint"),this.getHelpHints=this.makeMethod("getHelpHints")}};o=(0,s.__decorate)([n.scope.global()],o)},72442:(e,t,i)=>{i.d(t,{FriendsApi:()=>o});var s=i(331635),r=i(127126),n=i(609897);let o=class extends n.ApiNamespace{get namespace(){return"friends"}constructor(){super(...arguments),this.get=this.makeMethod("get"),this.search=this.makeMethod("search"),this.getLists=this.makeMethod("getLists"),this.add=this.makeMethod("add"),this.delete=this.makeMethod("delete")}};o=(0,s.__decorate)([r.scope.global()],o)},634348:(e,t,i)=>{i.d(t,{GiftsApi:()=>o});var s=i(331635),r=i(609897),n=i(127126);let o=class extends r.ApiNamespace{get namespace(){return"gifts"}constructor(){super(...arguments),this.getCatalogGift=this.makeMethod("getCatalogGift"),this.send=this.makeMethod("send")}};o=(0,s.__decorate)([n.scope.global()],o)},420429:(e,t,i)=>{i.d(t,{UsersApi:()=>o});var s=i(331635),r=i(609897),n=i(127126);let o=class extends r.ApiNamespace{get namespace(){return"users"}constructor(){super(...arguments),this.get=this.makeMethod("get"),this.search=this.makeMethod("search")}};o=(0,s.__decorate)([n.scope.global()],o)},851436:(e,t,i)=>{i.d(t,{useIsMounted:()=>r});var s=i(296540);const r=()=>{const e=(0,s.useRef)(!1);return(0,s.useEffect)((()=>(e.current=!0,()=>{e.current=!1})),[]),(0,s.useCallback)((()=>e.current),[])}},930095:(e,t,i)=>{i.d(t,{useLottie:()=>o});var s=i(851436),r=i(296540),n=i(441120);function o(e,{play:t,show:i}={}){const{animationUrl:o,animationData:a}=e,c=(0,r.useRef)(!1),l=(0,r.useRef)(null),d=(0,r.useRef)(null),[u,h]=(0,r.useState)(!1),[g,p]=(0,r.useState)(null),[_,f]=(0,r.useState)(!1),[m,v]=(0,r.useState)(!1),k=(0,s.useIsMounted)();(0,r.useEffect)((()=>{const e=d.current;e&&!_&&(void 0!==t&&(t?e.play():e.pause()),void 0!==i&&(i?e.show():e.hide()))}),[_,t,i]),(0,r.useLayoutEffect)((()=>((async()=>{const t=d.current;t?c.current=!1:(f(!0),v(!1));const i=l.current;if((o||a)&&i&&!c.current){c.current=!0,h(!1),p(null);try{const t=await n.LottieManager.loadAnimation({containers:[i],...e});t.addEventListener("enterFrame",(()=>{requestAnimationFrame((()=>{v(!0)}))}),{once:!0}),t.addEventListener("destroy",(()=>{v(!1)}),{once:!0}),f(!1),d.current=t}catch(e){h(!0),p(e)}k()&&t?.destroy()}})(),()=>{d.current?.destroy()})),[o,a]);return{lottieError:u,lottieLoading:_,lottieLoaded:!_&&!u,lottieRendered:m,lottiePlayerRef:d,lottieContainerRef:l,lottieErrorMessage:g}}},740705:(e,t,i)=>{i.d(t,{InitOptionsProvider:()=>n,useInitOptions:()=>o});var s=i(296540);const r=(0,s.createContext)({}),n=r.Provider;function o(){const{payload:e,...t}=(0,s.useContext)(r);return{...e,...t}}},764277:(e,t,i)=>{i.d(t,{stickers:()=>s});const s=(0,i(32489).createDomain)()},176688:(e,t,i)=>{i.d(t,{$isBuying:()=>a,buyFx:()=>o});var s=i(853883),r=i(764277),n=i(389732);const o=r.stickers.createEffect((async e=>{const t=window.Stickers.Cart.create([n.RANDOM_PRODUCT_ID]);await t.load();let i=null;try{i=await t.order({v:s.API_VERSION,ignoreEmptyError:!0,emptyErrorLoader:!1,randomStickerPackAttemptId:e})}catch{}return i&&i.random_selector_result&&!i.error?i:null})),a=r.stickers.createStore(!1).on(o,(()=>!0)).on(o.finally,(()=>!1))},649506:(e,t,i)=>{i.d(t,{hideSnackbar:()=>n,showSnackbar:()=>r});var s=i(32489);const r=(0,s.createEvent)(),n=(0,s.createEvent)()},389732:(e,t,i)=>{i.d(t,{RANDOM_PRODUCT_ID:()=>s,StickersGroup:()=>n,StickersReferrer:()=>o,UGC_STICKERS_APP_ID:()=>r});const s=10101,r=51538586;var n,o;!function(e){e.LAYER="layer"}(n||(n={})),function(e){e.TYPE_STICKERS_KEYBOARD="stickers_keyboard2"}(o||(o={}))},228758:(e,t,i)=>{i.d(t,{openProductModal:()=>s});const s=i(764277).stickers.createEvent()},480508:(e,t,i)=>{i.d(t,{openRandomSelectorPacksModal:()=>s});const s=i(764277).stickers.createEvent()},195641:(e,t,i)=>{i.d(t,{openRandomSelectorResultModal:()=>s});const s=i(764277).stickers.createEvent()},780727:(e,t,i)=>{i.d(t,{getCache:()=>c,getPackByStickerId:()=>g,getSticker:()=>d,getStickers:()=>u,updateCache:()=>l});var s=i(624216),r=i(207753),n=i(81277),o=i(85785),a=i(250682);const c=()=>{if(!window.stickersCache){const e=a.ls.get("stickers_cache");window.stickersCache={...r.DEFAULT_CACHE,...e}}return window.stickersCache},l=e=>{window.stickersCache={...c(),...e}},d=e=>c().stickers.get(e),u=e=>{const{stickers:t}=c();return e.map((e=>t.get(e)))},h=e=>{const t=d(e);if(!t||!t.pack_id)return null;const i=(0,o.getProductFromCache)(t.pack_id);return i&&(0,n.isBasePack)(i)?i:null},g=e=>{const t=h(e);return t?Promise.resolve(t):new Promise((t=>{s.ajax.post("stickers.php",{act:"get_products",sticker_ids:[e]},{onDone(i){(0,o.cacheProductsData)(i),t(h(e))},onFail:e=>(console.error(e),t(null),!0)})}))}},15603:(e,t,i)=>{i.d(t,{Cart:()=>c});var s=i(624216),r=i(793401),n=i(207753),o=i(85785),a=i(850101);class c{static create(e,t=[]){const i=e.map((e=>({product_id:e,amount:1})));return new c(i,t)}copy(){const e=new c(this.getItems(),this.getRecipientIds());return e.setOrder(this.getOrder()),e}getItems(){return Array.from(this.items.values())}setItems(e){this.items=new Map(e.map((e=>[e.product_id,e])))}loadItems(){const e=Array.from(this.items.keys());return(0,o.getProducts)(e).then((()=>{for(const e of Array.from(this.items.values()))e.product=(0,o.getProductFromCache)(e.product_id)}))}getProducts(){return(0,o.getProductsFromCache)(Array.from(this.items.keys()))}hasProduct(e){return this.items.has(e)}addProduct(e,t=!1){if(!this.hasProduct(e)){const i={product_id:e,amount:1};t?this.setItems([...this.getItems(),i]):this.setItems([i,...this.getItems()]),this.onChange&&this.onChange()}}removeProduct(e){this.hasProduct(e)&&(this.items.delete(e),this.onChange&&this.onChange())}getRecipientIds(e=!1){return this.recipientIds.size?Array.from(this.recipientIds.values()):this.isGift&&e?[n.SAMPLE_RECIPIENT_ID]:[]}setRecipientIds(e){this.recipientIds=new Set(e)}hasRecipientId(e){return this.recipientIds.has(e)}addRecipientId(e){this.hasRecipientId(e)||(this.recipientIds.add(e),this.onChange&&this.onChange())}removeRecipientId(e){this.hasRecipientId(e)&&(this.recipientIds.delete(e),this.onChange&&this.onChange())}setOrder(e){if(this._order=e,e){this.recipientIds.clear();for(const t of e.items)t.recipient_id!==n.SAMPLE_RECIPIENT_ID&&this.recipientIds.add(t.recipient_id)}}loadOrder(e){const t=e.items.map((e=>e.product_id));return(0,o.getProducts)(t).then((t=>({...e,items:e.items.map(((e,i)=>({...e,product:t[i]})))})),(()=>e))}getOrder(){return this._order}getRecipientsMap(){return this.recipients}getRecipients(){return Array.from(this.recipients.values())}getRecipientById(e){return this.recipients.get(e)}addRecipients(e){this.recipients=new Map([...this.getRecipients(),...e].map((e=>[e[0],e])))}getJSON(){return JSON.stringify({items:this.getItems().map((e=>({...e,product:void 0}))),recipient_ids:this.getRecipientIds(!0)})}isLoaded(){return null!==this.getOrder()}cancelLoad(){this.loadTimeout&&(window.clearTimeout(this.loadTimeout),this.loadTimeout=null),this.loadCancellationToken&&(this.loadCancellationToken.cancel(),this.loadCancellationToken=null)}load(e=!1){return this.cancelLoad(),new Promise((t=>{this.loadTimeout=window.setTimeout((()=>{this.loadCancellationToken=new r.AjaxCancellationToken,s.ajax.post("stickers.php",{act:"preview_products_order",cart:this.getJSON(),with_suggested_recipients:e?1:0},{cancellationToken:this.loadCancellationToken,onDone:e=>{(0,o.cacheProductsData)(e),Promise.all([this.loadItems(),this.loadOrder(e.order)]).then((([,i])=>{this.setOrder(i),e.recipients&&this.addRecipients(e.recipients),t(this)}),(()=>{}))},onFail:e=>(e&&window.__dev&&console.error(e),t(this),!0)})}),300)}))}order({ignoreEmptyError:e,emptyErrorLoader:t,...i}={}){return new Promise((r=>{s.ajax.post("stickers.php",{act:"order_products",cart:this.getJSON(),hash:i.hash||this.getOrder()?.hash,message:i.message,is_private:i.is_private?1:0,ref:i.ref,gift_ref:i.gift_ref,v:i.v,random_sticker_pack_attempt_id:i.randomStickerPackAttemptId},{onDone:e=>{requestAnimationFrame((()=>{(0,a.hideBoxLoader)()})),(0,o.cacheProductsData)(e),e.result.random_selector_result=e.random_selector_result,Promise.all([this.loadOrder(e.order),this.loadOrder(e.result)]).then((([e,t])=>{this.setOrder(e),r(t)}),(()=>{}))},onFail:i=>!i&&e?(t&&requestAnimationFrame((()=>{(0,a.showBoxLoader)()})),!0):(i&&console.error(i),r(null),!0)})}))}constructor(e,t=[]){this.loadTimeout=null,this.loadCancellationToken=null,this.isGift=!1,this.onChange=null,this._order=null,this.setItems(e),this.recipientIds=new Set(t),this.recipients=new Map}}},83747:(e,t,i)=>{i.d(t,{StickerProductsGift:()=>L});var s=i(474848),r=i(296540),n=i(209642),o=i(125852),a=i(416124),c=i(785118),l=i(828902),d=i(475748),u=i(415782),h=i(966576),g=i(490660),p=i(850101),_=i(645024),f=i(610989),m=i(81277),v=i(755513),k=i(779819),S=i(187643),y=i(40872),b=i(859755),P=i(8520);const L=({cart:e,options:{ref:t,gift_ref:i},closeBox:L,updateBox:w})=>{const[C,I]=(0,k.useCart)(e),A=!C.isLoaded()&&I;(0,r.useEffect)((()=>{w()}),[A]);const x=C.getRecipientIds(),R=C.getOrder(),M=R&&!R.error&&R.items.find((e=>!e.error&&!(0,v.isSampleOrderItem)(e))),[E,G]=function(e){if(!e)return[null,null];let t;for(const i of e.items){const{product:e}=i;if(e&&(0,m.isPackProduct)(e)){t=e;break}}let i=e.items.filter((({product:e})=>e?.can_gift));const s=i.filter((e=>!e.error&&!(0,v.isSampleOrderItem)(e)));s.length&&(i=s);const r=new m.ProductsByType(i.map((e=>e.product))),n=r.pack.values().next().value,o=Array.from(r.style);let a="",c="";if(1===o.length)a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_1_style"),"title",o[0].title),n?c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_with_pack"),"title",n.title):t&&(c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_for_pack"),"title",t.title));else if(n){if(a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_pack"),"title",n.title),o.length)switch(o.length){case 2:c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_with_2_styles"),"title1",o[0].title,"title2",o[1].title);break;case 3:c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_with_3_styles"),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title);break;case 4:c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_with_3_styles_and_1_more"),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title);break;default:const e=o.length-3;c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_with_3_styles_and_n_more",e),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title,"n",e)}}else if(o.length){switch(o.length){case 2:a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_2_styles"),"title1",o[0].title,"title2",o[1].title);break;case 3:a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_3_styles"),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title);break;case 4:a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_3_styles_and_1_more"),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title);break;default:const e=o.length-3;a=(0,_.langStr)(f.getLang("purchases_stickers_gift_title_3_styles_and_n_more",e),"title1",o[0].title,"title2",o[1].title,"title3",o[2].title,"n",e)}t&&(c=(0,_.langStr)(f.getLang("purchases_stickers_gift_description_for_pack"),"title",t.title))}o.length?c+=" "+f.getLang("purchases_stickers_gift_description_styles"):c+=" "+f.getLang("purchases_stickers_gift_description");return[a,c]}(R),[,j]=(0,r.useState)(null);(0,r.useLayoutEffect)((()=>{const e=C.getRecipients();if(j(window.WideDropdown.init("StickerProductsGiftRecipientsDropdown",{defaultItems:e,items:e,noResult:f.getLang("gifts_nobody_found"),introText:f.getLang("gifts_start_typing_recipient"),maxItems:20,onChange:(e,t)=>{1===e?C.addRecipientId(+t):C.removeRecipientId(+t)}})),x.length)for(const e of x){const t=C.getRecipientById(e);t&&window.WideDropdown.select("StickerProductsGiftRecipientsDropdown",!1,t)}else window.WideDropdown.focus("StickerProductsGiftRecipientsDropdown");return()=>{window.WideDropdown.deinit("StickerProductsGiftRecipientsDropdown")}}),[A]);const[B,D]=(0,r.useState)(""),[O,T]=(0,r.useState)(!1),[F,N]=(0,r.useState)(!1),H=()=>{F||(N(!0),C.order({message:B,is_private:O,ref:t,gift_ref:i}).then((e=>{N(!1),e&&!e.error&&((0,p.showDoneBox)(function(e,t){const i=new m.ProductsByType(e.items.filter((e=>!e.error)).map((e=>e.product))),s=function(e){const t=e.getPack(),i=e.getStyles();if(t)return i.length?(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_pack_and_styles",i.length),"title",t.title,"styles_num",i.length):(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_pack"),"title",t.title);if(i.length)switch(i.length){case 1:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_1_style"),"title",i[0].title);case 2:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_2_styles"),"title1",i[0].title,"title2",i[1].title);case 3:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_3_styles"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);case 4:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_3_styles_and_1_more"),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title);default:{const e=i.length-3;return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_products_3_styles_and_n_more",e),"title1",i[0].title,"title2",i[1].title,"title3",i[2].title,"n",e)}}return null}(i);if(!s)return null;const r=new Set;for(const i of e.items){const{error:e,recipient_id:s}=i;if(e)continue;const n=t(s);n&&r.add(n)}const n=function(e,t){const i=Array.from(e.values());switch(i.length){case 0:return null;case 1:{const e=1===t?f.getLang("purchases_stickers_gift_result_1_recipient_single","raw"):f.getLang("purchases_stickers_gift_result_1_recipient_multiple","raw");return(0,_.langStr)((0,f.langSex)(i[0][8],e),"name",i[0][8])}case 2:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_2_recipients",t),"name1",i[0][8],"name2",i[1][8]);case 3:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_3_recipients",t),"name1",i[0][8],"name2",i[1][8],"name3",i[2][8]);case 4:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_4_recipients",t),"name1",i[0][8],"name2",i[1][8],"name3",i[2][8],"name4",i[3][8]);case 5:return(0,_.langStr)(f.getLang("purchases_stickers_gift_result_5_recipients",t),"name1",i[0][8],"name2",i[1][8],"name3",i[2][8],"name4",i[3][8],"name5",i[4][8]);default:{const e=i.length-4,s=1===t?f.getLang("purchases_stickers_gift_result_4_recipients_and_n_more_single"):f.getLang("purchases_stickers_gift_result_4_recipients_and_n_more_multiple");return(0,_.langStr)(s,"name1",i[0][8],"name2",i[1][8],"name3",i[2][8],"name4",i[3][8],"n",e)}}return null}(r,i.getCount());if(!n)return null;return(0,_.langStr)(n,"products",s)}(e,(e=>C.getRecipientById(e)))),L())}),(()=>{})))};return(0,r.useEffect)((()=>{window.WideDropdown.disable("StickerProductsGiftRecipientsDropdown",F)}),[F]),(0,s.jsxs)(n.ModalBox,{"data-testid":"sticker-gift-modal",children:[(0,s.jsx)(o.ModalHeader,{onClose:L,closeAriaLabel:f.getLang("global_close"),children:f.getLang("purchases_stickers_gift_box_title")}),(0,s.jsx)(a.ModalBody,{insetLevel:2,children:A?(0,s.jsx)(c.Div,{children:(0,s.jsx)(l.Spinner,{stretched:!0})}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(S.default,{order:R,forceValid:!M}),(0,s.jsx)("h1",{className:"StickerProductsGift__productsTitle",children:(0,P.decodeHTMLEntities)(E||"")}),(0,s.jsx)("p",{className:"StickerProductsGift__productsDescription",children:(0,P.decodeHTMLEntities)(G||"")}),R&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("dl",{className:"StickerProductsGift__price",children:[(0,s.jsx)("dt",{className:"StickerProductsGift__priceLabel",children:f.getLang("purchases_gift_price_label")})," ",(0,s.jsx)("dd",{className:"StickerProductsGift__priceValue",children:f.getLang("global_n_votes",R.price.current)})]}),(0,s.jsx)("div",{className:"StickerProductsGift__balance",children:(0,_.langStr)(f.getLang("gifts_you_have_X_votes"),"votes",f.getLang("global_n_votes",R.balance))})]}),(0,s.jsxs)("div",{className:"StickerProductsGift__recipients",children:[(0,s.jsx)("label",{className:"StickerProductsGift__recipientsLabel",htmlFor:"StickerProductsGiftRecipientsInput",children:f.getLang("gifts_receiver")}),(0,s.jsxs)("div",{className:"wdd StickerProductsGift__recipientsDropdown",id:"StickerProductsGiftRecipientsDropdown",children:[(0,s.jsx)("div",{className:"fl_r wdd_arr"}),(0,s.jsx)("input",{className:"wdd_text fl_l",id:"StickerProductsGiftRecipientsInput",placeholder:f.getLang("gifts_choose_recipients")})]})]}),(0,s.jsxs)("div",{className:"StickerProductsGift__message",children:[(0,s.jsx)("label",{className:"StickerProductsGift__messageLabel",htmlFor:"StickerProductsGiftMessageInput",children:f.getLang("purchases_gift_your_message")}),(0,s.jsx)(d.Textarea,{id:"StickerProductsGiftMessageInput",rows:3,value:B,onChange:e=>D(e.currentTarget.value),onResize:()=>w(),disabled:F})]}),(0,s.jsx)(u.Checkbox,{noPadding:!0,stretched:!1,checked:O,disabled:F,onChange:()=>T(!O),children:f.getLang("gifts_receiver_only")})]})}),(0,s.jsx)(h.ModalFooter,{before:(0,s.jsx)("div",{className:"StickerProductsGift__footerNote",children:!I&&R&&(0,s.jsxs)("div",{className:"StickerProductsGift__details",children:[f.getLang("purchases_stickers_gift_details_label"),(0,s.jsx)(g.HintIcon,{gap:"l",tooltip:{placement:"top",...(0,y.stickerProductsGiftDetails)({order:R,recipients:C.getRecipientsMap()})}})]})}),actions:(0,s.jsx)(b.default,{className:"StickerProductsGift__gift",mode:M?"primary":"secondary",size:"m",loading:I||F,disabled:!M,price:R?.price,text:M?(0,_.langStr)(f.getLang("purchases_stickers_gift_send_for"),"price",f.getLang("global_n_votes",R?.price.current)):f.getLang("purchases_stickers_gift_send"),onClick:()=>H()})})]})}},40872:(e,t,i)=>{i.d(t,{stickerProductsGiftDetails:()=>u});var s=i(474848),r=i(296540),n=i(8520),o=i(102846),a=i(645024),c=i(610989),l=i(755513),d=i(81277);const u=({order:e,recipients:t})=>{const i=function(e){if(!e)return null;let t=e.items.filter((({product:e})=>e?.can_gift));const i=t.filter((e=>!e.error&&!(0,l.isSampleOrderItem)(e)));i.length&&(t=i);const s=[],r=[];for(const e of t){const{product:t}=e;t&&((0,d.isPackProduct)(t)?s.push(e):(0,d.isStyleProduct)(t)&&r.push(e))}const n=r.reduce(((e,t)=>e+(t.price?.current||0)),0);if(s.length){const e=s.reduce(((e,t)=>e+(t.price?.current||0)),0);return r.length?(0,a.langStr)(c.getLang("purchases_stickers_gift_details_summary_pack_with_styles",r.length),"pack_price_sum",c.getLang("global_n_votes",e),"styles_num",r.length,"styles_price_sum",c.getLang("global_n_votes",n)):(0,a.langStr)(c.getLang("purchases_stickers_gift_details_summary_pack"),"pack_price_sum",c.getLang("global_n_votes",e))}if(r.length)return(0,a.langStr)(c.getLang("purchases_stickers_gift_details_summary_styles",r.length),"styles_num",r.length,"styles_price_sum",c.getLang("global_n_votes",n));return null}(e)||"",u=new Map;for(const i of e.items){const{error:e,product:s,recipient_id:r}=i;if(e)continue;const n=t.get(r);if(!n)continue;let o=u.get(n);o||(o=new d.ProductsByType,u.set(n,o)),o.add(s)}const g=Array.from(u.entries()),p=g.length,_={maxWidth:291,text:g.map((([e,t])=>(0,s.jsxs)(r.Fragment,{children:[(0,s.jsx)(o.InnerHTML,{Component:"span",children:e[1]}),": ",(0,n.decodeHTMLEntities)(h(t)||"")," "]},e[0])))};return _[i&&p?"header":"text"]=(0,s.jsx)(o.InnerHTML,{children:i}),_};function h(e){const t=e.getPack(),i=e.getStyles();let s="";return i.length&&(s=i.map((e=>(0,a.langStr)(c.getLang("purchases_stickers_gift_details_recipient_style_title"),"title",e.title))).join(", ")),t?s?(0,a.langStr)(c.getLang("purchases_stickers_gift_details_recipient_pack_and_styles"),"pack_title",t.title,"style_titles",s):(0,a.langStr)(c.getLang("purchases_stickers_gift_details_recipient_pack"),"title",t.title):s?(0,a.langStr)(c.getLang("purchases_stickers_gift_details_recipient_styles"),"style_titles",s):null}},187643:(e,t,i)=>{i.d(t,{default:()=>l});var s=i(474848),r=i(8520),n=i(81277),o=i(755513);const a={s:56,m:96,l:168},c="sticker-products-gifts-icon",l=({order:e,forceValid:t=!1})=>{const i=new Map,l=new Map;if(e)for(const t of e.items){const{product:e}=t;e&&((0,n.isPackProduct)(e)?i.has(e)?i.get(e)?.push(t):i.set(e,[t]):(0,n.isStyleProduct)(e)&&(l.has(e)?l.get(e)?.push(t):l.set(e,[t])))}const d=i.keys().next().value,u=(d?1:0)+l.size,h=u>1?u>2?"s":"m":"l",g=a[h],p=Array.from(l.entries());t||p.sort((([,e],[,t])=>t.filter((e=>!e.error)).length-e.filter((e=>!e.error)).length));const _=p.slice(0,3);let f=p.slice(3),m=!0;if(!t){const e=f.filter((([,e])=>e.find((e=>!e.error))));e.length?f=e:m=!1}return(0,s.jsxs)("ul",{className:"StickerProductsGiftIcons",children:[d&&(0,s.jsx)("li",{"data-testid":c,className:(0,r.classNames)("StickerProductsGiftIcons__icon",`StickerProductsGiftIcons__icon--${h}`,"StickerProductsGiftIcons__icon--pack",{"StickerProductsGiftIcons__icon--invalid":!t&&!i.get(d)?.find((e=>!e.error))}),style:{backgroundImage:`url(${(0,o.getStickerPackIconUrl)(d,g,g)})`}},d.id),_.map((([e,i])=>(0,s.jsx)("li",{"data-testid":c,className:(0,r.classNames)("StickerProductsGiftIcons__icon",`StickerProductsGiftIcons__icon--${h}`,"StickerProductsGiftIcons__icon--style",{"StickerProductsGiftIcons__icon--invalid":!t&&!i.find((e=>!e.error))}),style:{backgroundImage:`url(${(0,o.getStickerPackIconUrl)(e,g,g)})`}},e.id))),f.length?(0,s.jsxs)("li",{"data-testid":c,className:(0,r.classNames)("StickerProductsGiftIcons__icon",`StickerProductsGiftIcons__icon--${h}`,"StickerProductsGiftIcons__icon--more",{"StickerProductsGiftIcons__icon--invalid":!m}),children:["+",f.length]},"more"):null]})}},859755:(e,t,i)=>{i.d(t,{default:()=>c});var s=i(474848),r=i(296540),n=i(533048),o=i(8520),a=i(610989);const c=({className:e,price:t,text:i,placeholder:c,...l})=>{let d=(0,r.useMemo)((()=>{if(t){let e;t.current!==t.regular&&t.regular&&(e=(0,s.jsx)("span",{className:"StickersPriceButton__regular",children:t.current?t.regular:(0,a.langStr)(a.getLang("purchases_stickers_n_for_m"),"%n","","%m",a.getLang("global_n_votes",t.regular))},"regular"));const r=(0,s.jsx)("span",{className:"StickersPriceButton__current",children:t.current?a.getLang("global_n_votes",t.current):a.getLang("purchases_for_free_btn").toLowerCase()},"current");return i?i.split(/(\{regular_price\}|\{price\})/).map(((t,i)=>"{regular_price}"===t?e:"{price}"===t?r:t?(0,s.jsx)("span",{className:"StickersPriceButton__label",children:t},`label${i}`):void 0)):[e,r]}return[c]}),[i,c,t?.regular,t?.current]);return(0,s.jsx)(n.Button,{className:(0,o.classNames)("StickersPriceButton",e),...l,children:d})}},779819:(e,t,i)=>{i.d(t,{useCart:()=>r});var s=i(296540);const r=e=>{const[t,i]=(0,s.useState)(e),[r,n]=(0,s.useState)(null),o=(0,s.useCallback)((()=>{const e=t.load();n(e),e.then((t=>{i(t),n((t=>t===e?null:t))}),(()=>{}))}),[t]);return(0,s.useEffect)((()=>(t.onChange=o,t.isLoaded()||o(),()=>{t.onChange=null,t.cancelLoad()})),[t]),[t,null!==r]}},85785:(e,t,i)=>{i.d(t,{activateProduct:()=>h,cacheProductsData:()=>n,getProduct:()=>u,getProductFromCache:()=>o,getProducts:()=>d,getProductsFromCache:()=>a,updateUserProductState:()=>g});var s=i(624216),r=i(780727);const n=(e,t=[])=>{const i=(0,r.getCache)();if(e.stickers){const{stickers:t}=i;for(const i of e.stickers)t.has(i.id)?t.set(i.id,{...t.get(i.id),...i}):t.set(i.id,i)}if(e.products)for(const t of e.products)i.products.set(t.id,t),i.productPromises.delete(t.id);for(const e of t)i.products.has(e)||i.products.set(e,null),i.productPromises.delete(e);e.emoji&&window.Emoji&&window.Emoji.updateTabs(e.emoji.stickers,e.emoji.keywords,!0),(0,r.updateCache)(i)},o=e=>(0,r.getCache)().products.get(e),a=e=>{const t=(0,r.getCache)().products;return e.map((e=>t.get(e)))};function c(){let{productsPromise:e}=(0,r.getCache)();return e||(e=new Promise((e=>setTimeout((()=>{const t=(0,r.getCache)().productIdsQueue,i=Array.from(t);t.clear(),(0,r.updateCache)({productIdsQueue:t,productsPromise:void 0}),s.ajax.post("stickers.php",{act:"get_products",product_ids:i},{onDone(t){n(t,i),e([])},onFail:t=>(console.error(t),n({},i),e([]),!0)})}),300))),(0,r.updateCache)({productsPromise:e})),e}const l=e=>{if(!e.length)return Promise.resolve([]);const{productPromises:t,productIdsQueue:i}=(0,r.getCache)(),s=new Set;for(const r of e)if(t.has(r)){const e=t.get(r);e&&s.add(e)}else{i.add(r);const e=c();t.set(r,e),s.add(e)}return(0,r.updateCache)({productIdsQueue:i,productPromises:t}),Promise.all(s).then((()=>a(e)))},d=(e,t=!0)=>{const i=t?e.filter((e=>void 0===o(e))):e;return i.length?l(i).then((()=>a(e))):Promise.resolve(a(e))},u=(e,t=!0)=>{if(t){const t=o(e);if(void 0!==t)return Promise.resolve(t)}return l([e]).then((()=>o(e)))},h=e=>new Promise((t=>{s.ajax.post("stickers.php",{act:"activate_product",product_id:e.id,hash:e.csrf_hash},{onDone(e){n(e),t()},onFail:e=>(console.error(e),t(),!0)})})),g=(e,t,i,r=!0)=>new Promise((o=>{s.ajax.post("stickers.php",{act:"update_user_product_state",product_ids:[e],key:t,value:i},{onDone(e){r&&n(e),o()},onFail:e=>(console.error(e),o(),!0)})}))},113725:(e,t,i)=>{i.d(t,{giftStickerProducts:()=>h,giftStickersCart:()=>u});var s=i(474848),r=i(440961),n=i(505954),o=i(20025),a=i(15603),c=i(550072),l=i(780727),d=i(83747);function u(e,t){const{productsGiftLock:i}=(0,l.getCache)();if(i)return null;let a;(0,l.updateCache)({productsGiftLock:!0});const u={...t};function h(){return a?.bodyNode.querySelector(".StickersProductsGift")}function g(){a?.hide()}function p(){a?.updateBoxCoords()}return(0,c.showLoader)(),e.isGift=!0,Promise.all([e.load(!0),window.stManager.add(["stickers.css",window.jsc("web/wide_dd.js"),"wide_dd.css"])]).then((([e])=>{(0,c.hideLoader)(),a=new o.MessageBox({hideButtons:!0,bodyStyle:"padding: 0; background: none;",width:450,onShow(){!function(e){const t=h();t&&r.render((0,s.jsx)(n.AppRootProvider,{children:(0,s.jsx)(d.StickerProductsGift,{cart:e,options:u,closeBox:g,updateBox:p})}),t)}(e),requestAnimationFrame((()=>{p()}))},onHideAttempt:()=>(function(){const e=h();e&&r.unmountComponentAtNode(e)}(),!0),onHide(){(0,l.updateCache)({productsGiftLock:!1})}}),a.content('<div class="StickersProductsGift"></div>'),a.show()}),(()=>{})),{hide:g}}function h(e,t=[],i){return u(a.Cart.create(e,t),i)}},8393:(e,t,i)=>{i.d(t,{ViewId:()=>s,views:()=>d});var s,r=i(296540);i(226991);!function(e){e.LAYER="layer",e.LAYER_PURCHASE_DETAILS="layer_purchase_details",e.RANDOM_SELECTOR="random_selector",e.RANDOM_SELECTOR_PACKS="RANDOM_SELECTOR_packs",e.RANDOM_SELECTOR_RESULT="RANDOM_SELECTOR_result"}(s||(s={}));const n=(0,r.lazy)((()=>Promise.all([i.e(91498),i.e(89631),i.e(762),i.e(69706),i.e(65437),i.e(60648),i.e(52731)]).then(i.bind(i,918401)).then((({Layer:e})=>({default:e}))))),o=(0,r.lazy)((()=>Promise.all([i.e(91498),i.e(89631),i.e(16846)]).then(i.bind(i,282823)).then((({PurchaseDetails:e})=>({default:e}))))),a=(0,r.lazy)((()=>Promise.all([i.e(91498),i.e(89631),i.e(762),i.e(69706),i.e(64273)]).then(i.bind(i,160628)).then((({Main:e})=>({default:e}))))),c=(0,r.lazy)((()=>Promise.all([i.e(91498),i.e(89631),i.e(762),i.e(65437),i.e(12318)]).then(i.bind(i,60692)).then((({Packs:e})=>({default:e}))))),l=(0,r.lazy)((()=>Promise.all([i.e(91498),i.e(89631),i.e(762),i.e(71409)]).then(i.bind(i,353400)).then((({Result:e})=>({default:e}))))),d=new Map([["layer",{Component:n,width:640}],["layer_purchase_details",{Component:o}],["random_selector",{Component:a}],["RANDOM_SELECTOR_packs",{Component:c}],["RANDOM_SELECTOR_result",{Component:l}]])},226991:(e,t,i)=>{i(261588)},261588:(e,t,i)=>{var s=i(32489),r=i(659179),n=i(649506);const o=(0,s.createEffect)((({title:e,subtitle:t,action:i,timeout:s,onClose:n})=>{(0,r.showSnackbar)({text:e,subtitle:t,timeout:s,action:i,onClose:n})}));(0,s.sample)({clock:n.showSnackbar,target:o});const a=(0,s.createEffect)((e=>{(0,r.hideSnackbar)(e)}));(0,s.sample)({clock:n.hideSnackbar,target:a})},174583:(e,t,i)=>{i.d(t,{openView:()=>a});var s=i(474848),r=i(8393),n=i(740705),o=i(272259);async function a(e){const{view:t,modalBoxOptions:i}=e,{width:a,Component:c}=r.views.get(t)||{};if(c)return(0,o.showMessageBoxModalSuspense)((({onClose:t,refreshCoordinates:i})=>(0,s.jsx)(n.InitOptionsProvider,{value:{payload:{},...e,init:i,destroy:t},children:(0,s.jsx)(c,{})})),{width:a,...i})}},900855:(e,t,i)=>{i.d(t,{openLayerPurchaseDetails:()=>n});var s=i(8393),r=i(174583);function n(e){return(0,r.openView)({payload:e,view:s.ViewId.LAYER_PURCHASE_DETAILS})}},24595:(e,t,i)=>{i.d(t,{openStickersLayerView:()=>l});var s=i(32489),r=i(8393),n=i(174583),o=i(900855),a=i(764277),c=i(228758);async function l(e){const{modalBoxOptions:t}=e;return(0,n.openView)({payload:{...e,onPurchaseDetailsOpen:e=>(0,o.openLayerPurchaseDetails)({details:e})},modalBoxOptions:t,view:r.ViewId.LAYER})}const d=a.stickers.createEffect(l);(0,s.sample)({clock:c.openProductModal,target:d})},313348:(e,t,i)=>{i.d(t,{openStickersRandomSelectorView:()=>f});var s=i(32489),r=i(174583),n=i(8393),o=i(764277),a=i(176688),c=i(480508),l=i(195641),d=i(940209),u=i(850101);const h={},g=o.stickers.createEvent(),p=o.stickers.createStore(h).reset(g),_=o.stickers.createEffect((e=>{(0,u.hideBoxLoader)(),(0,r.openView)({...e,view:n.ViewId.RANDOM_SELECTOR,modalBoxOptions:{onDestroy:()=>{e.modalBoxOptions?.onDestroy?.(),g()}},payload:{onGift:()=>{(0,d.showGiftModal)({giftId:10101,recipientIds:e.payload?.recipientIds??[]})}}})})),f=o.stickers.createEvent();(0,s.sample)({clock:f,target:p}),(0,s.sample)({source:p,filter:e=>e!==h,target:_});const m=o.stickers.createEffect((()=>{(0,r.openView)({view:n.ViewId.RANDOM_SELECTOR_PACKS})}));(0,s.sample)({clock:c.openRandomSelectorPacksModal,target:m});const v=o.stickers.createEffect((()=>{(0,r.openView)({view:n.ViewId.RANDOM_SELECTOR_RESULT})}));(0,s.sample)({clock:l.openRandomSelectorResultModal,target:v}),(0,s.sample)({clock:a.buyFx.finally,source:p,filter:()=>!(0,u.curBox)(),fn:e=>({...e,payload:{...e.payload,preventReload:!0}}),target:_})},523326:(e,t,i)=>{i.d(t,{GiftModal:()=>I});var s=i(474848),r=i(296540),n=i(456921),o=i(209642),a=i(797008),c=i(355254),l=i(380118),d=i(416124),u=i(704296),h=i(529558),g=i(428918),p=i(475748),_=i(415782),f=i(966576),m=i(533048),v=i(8520),k=i(272259),S=i(770125),y=i(127126),b=i(659179),P=i(967751),L=i(594976),w=i(334033);const C=(0,n.observer)((()=>{const e=(0,S.useLangs)(),t=(0,P.useGiftModalModel)(),{props:i,gift:n,isLoading:y,loadError:C,price:I,recipients:A,balance:x,message:R,isPrivate:M,isSending:E,confirmation:G,sendError:j,isSent:B}=t;if((0,r.useEffect)((()=>{i?.refreshCoordinates()})),(0,r.useEffect)((()=>{if(!y){if(!n||C)return(0,b.showSnackbar)({type:"error",text:e.getLang("gifts_gift_modal_load_error_not_found"),timeout:3e3}),void i?.onClose();if(!j)return B?((0,b.showSnackbar)({type:"ok",text:e.getLang("gifts_gift_sent"),timeout:3e3}),void i?.onClose()):void 0;(0,b.showSnackbar)({type:"error",text:e.getLang("gifts_server_error"),timeout:3e3})}}),[y,n,C,j,B]),y)return i?.refreshCoordinates?(0,s.jsx)(k.MessageBoxModalLoader,{refreshCoordinates:i.refreshCoordinates}):void 0;if(!n||C||j||B)return;if(G){const e=e=>{t.send(i?.ref,!0,e)};return(0,s.jsx)(k.MessageBoxModal,{onDestroy:()=>{t.cancelSend()},children:t=>(0,s.jsx)(w.GiftConfirmationModal,{...t,gift:n,confirmation:G,onConfirm:e,isSending:E})})}const D=E,{title:O,description:T}=n,F=t.getImage(256,256,window.devicePixelRatio),N=F??t.getImage(128,128,window.devicePixelRatio);return(0,s.jsxs)(o.ModalBox,{children:[(0,s.jsx)(a.ModalHeaderHero,{onClose:i?.onClose??v.noop,closeAriaLabel:e.getLang("global_close"),icon:N&&(0,s.jsx)(c.ImageBase,{src:N.url,size:F?256:128,withTransparentBackground:!0,noBorder:!0}),description:(0,s.jsxs)(s.Fragment,{children:[T&&(0,s.jsx)(l.Footnote,{children:T}),I&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(l.Footnote,{children:[e.getLang("gifts_gift_price_label")," ",I," ",e.numeric(I,e.getLang("votes_flex",!0))]}),void 0!==x&&(0,s.jsxs)(l.Footnote,{children:[e.getLang("gifts_your_balance")," ",e.numeric(x,e.getLang("global_n_votes",!0))]})]})]}),children:O}),(0,s.jsx)(d.ModalBody,{insetLevel:2,children:(0,s.jsxs)(u.FormLayout,{children:[(0,s.jsx)(h.FormItem,{top:e.getLang("gifts_receivers"),disabled:D,noPadding:!0,children:(0,s.jsx)(L.GiftRecipientsSelect,{value:[...A],isDisabled:D,onChange:e=>{t.setRecipients(e)},isFocused:!1})}),(0,s.jsx)(g.Spacing,{size:18}),(0,s.jsx)(h.FormItem,{top:e.getLang("gifts_your_message"),disabled:D,noPadding:!0,children:(0,s.jsx)(p.Textarea,{rows:4,value:R,disabled:D,onChange:e=>{t.setMessage(e.target.value)}})}),(0,s.jsx)(g.Spacing,{size:18}),(0,s.jsx)(h.FormItem,{disabled:D,noPadding:!0,children:(0,s.jsx)(_.Checkbox,{checked:M,disabled:D,onChange:e=>{t.setIsPrivate(Boolean(e.target.checked))},children:e.getLang("gifts_receiver_only")})})]})}),(0,s.jsx)(f.ModalFooter,{actions:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(m.Button,{size:"m",mode:"secondary",onClick:i?.onClose,disabled:D,children:e.getLang("global_cancel")}),(0,s.jsx)(m.Button,{size:"m",onClick:()=>{t.send(i?.ref)},loading:E,disabled:!A.length,children:e.getLang("box_send")})]})})]})})),I=(0,y.createWidget)(P.GiftModalModelProvider,C)},590831:(e,t,i)=>{i.d(t,{GiftConfirmationModal:()=>g});var s=i(474848),r=i(296540),n=i(209642),o=i(795728),a=i(416124),c=i(102846),l=i(966576),d=i(533048),u=i(770125),h=i(802515);const g=({confirmation:e,onConfirm:t,isSending:i,onClose:g,refreshCoordinates:p})=>{const _=(0,u.useLangs)();(0,r.useEffect)((()=>{p()}));let f="";if(function(e){return"text"in e}(e))f=e.text;else if(function(e){return"price"in e}(e)){const{price:t,balance:i}=e;f=_.numeric(t,_.getLang("gifts_send_confirm",!0)),i&&(f+=` ${_.getLang("gifts_your_balance")} ${_.numeric(i,_.getLang("global_n_votes",!0))}`)}else(0,h.expectNever)(e);return(0,s.jsxs)(n.ModalBox,{children:[(0,s.jsx)(o.ModalHeaderCard,{title:_.getLang("gifts_confirmation_modal_title"),onClose:g,closeAriaLabel:_.getLang("global_close")}),(0,s.jsx)(a.ModalBody,{insetLevel:2,children:(0,s.jsx)(c.InnerHTML,{children:f})}),(0,s.jsx)(l.ModalFooter,{actions:[(0,s.jsx)(d.Button,{size:"m",mode:"secondary",disabled:i,onClick:g,children:_.getLang("global_cancel")},"cancel"),(0,s.jsx)(d.Button,{size:"m",onClick:()=>t(),loading:i,children:_.getLang("box_send")},"ok")]})]})}},334033:(e,t,i)=>{i.d(t,{GiftConfirmationModal:()=>s.GiftConfirmationModal});var s=i(590831)},940209:(e,t,i)=>{i.d(t,{showGiftModal:()=>s.showGiftModal});i(523326);var s=i(952059)},371973:(e,t,i)=>{i.d(t,{getVotes:()=>r});var s=i(624216);async function r(e,t){return new Promise(((i,r)=>{window.cur.paymentsHideLastBoxOnly=!0,s.ajax.post("al_gifts.php",{act:"do_send",number:e,mids:t.join(","),check_only:!0},{onDone:()=>{i()},onFail:e=>{void 0===e&&window.cur.paymentSuccess||r(e)}})}))}},967751:(e,t,i)=>{i.d(t,{GiftModalModelProvider:()=>h,useGiftModalModel:()=>g});var s=i(331635),r=i(327813),n=i(8520),o=i(183982),a=i(175026),c=i(127126),l=i(857031),d=i(371973);class u{[c.init](e){this[c.update](e)}[c.update](e){this.props=e;const{giftId:t,recipientIds:i=[]}=e;t!==this.giftId&&(this.loadGift(t),this.loadBalance()),i!==this.recipientIds&&(i.length||this.recipientIds.length)&&this.loadRecipients(i)}async loadGift(e){this.giftAbortController?.abort(void 0),this.giftAbortController=new AbortController,this.giftId=e,this.isLoadingGift=!0;try{const t=await this.giftService.fetchGift(e,this.giftAbortController.signal);(0,r.runInAction)((()=>{e===this.giftId&&(this.gift=t,this.isLoadingGift=!1,this.giftError=void 0)}))}catch(t){console.error(t),(0,r.runInAction)((()=>{e===this.giftId&&(this.gift=void 0,this.isLoadingGift=!1,this.giftError=t)}))}}async loadBalance(){this.balanceAbortController?.abort(void 0),this.balanceAbortController=new AbortController,this.isLoadingBalance=!0;try{const e=await this.giftService.fetchBalance(this.balanceAbortController.signal);(0,r.runInAction)((()=>{this.balance=e,this.isLoadingBalance=!1,this.balanceError=void 0}))}catch(e){console.error(e),(0,r.runInAction)((()=>{this.balance=void 0,this.isLoadingBalance=!1,this.balanceError=e}))}}async loadRecipients(e){this.recipientsAbortController?.abort(void 0),this.recipientsAbortController=new AbortController,this.recipients=[],this.recipientIds=e,this.isLoadingRecipients=!0;try{const t=await this.giftRecipientsProvider.fetchSelectedGiftRecipients(e,this.recipientsAbortController.signal);(0,r.runInAction)((()=>{this.recipientIds===e&&(this.isLoadingRecipients=!1,this.recipients=t,this.recipientsError=void 0,this.recipientsAbortController=void 0)}))}catch(t){console.error(t),(0,r.runInAction)((()=>{this.recipientIds===e&&(this.isLoadingRecipients=!1,this.recipientsError=t,this.recipientsAbortController=void 0)}))}}get isLoading(){return this.isLoadingGift||this.isLoadingBalance||this.isLoadingRecipients}get loadError(){return this.giftError??this.balanceError??this.recipientsError}getImage(e,t,i=1){return this.gift?.images.find((s=>s.width>=e*i&&s.height>=t*i))}setRecipients(e){this.recipients=e}get price(){if(!this.gift)return;const{price:e}=this.gift;return e?e*Math.max(this.recipients.length,1):0}[c.destroy](){this.giftId=void 0,this.gift=void 0,this.isLoadingGift=!1,this.giftError=void 0,this.giftAbortController?.abort(void 0),this.giftAbortController=void 0,this.balance=void 0,this.isLoadingBalance=!1,this.balanceError=void 0,this.balanceAbortController?.abort(void 0),this.balanceAbortController=void 0,this.recipientIds=[],this.recipients=[],this.isLoadingRecipients=!1,this.recipientsError=void 0,this.recipientsAbortController?.abort(void 0),this.recipientsAbortController=void 0,this.message="",this.isPrivate=!1,this.isSending=!1,this.sendResult=void 0,this.sendError=void 0}setMessage(e){this.message=e}get messageLength(){return(0,n.encodeHTMLEntities)(this.message).length}setIsPrivate(e){this.isPrivate=e}async send(e,t,i){if(!this.isSending&&this.giftId&&this.recipients.length){this.isSending=!0;try{const s=this.recipients.map((({id:e})=>e)),n=await this.giftService.send({giftIds:[this.giftId],recipientIds:s,message:this.message,isPrivate:this.isPrivate,ref:e,isConfirmed:t,isStickersBonusEnabled:i});if(n.isNeedVotes)return await(0,d.getVotes)(this.giftId,s),this.isSending=!1,await this.send(e,t,i);(0,r.runInAction)((()=>{this.isSending=!1,this.sendResult=n,this.onSend(n)}))}catch(e){(0,r.runInAction)((()=>{this.isSending=!1,this.sendResult=void 0,this.sendError=e}))}}}cancelSend(){(0,r.runInAction)((()=>{this.isSending=!1,this.sendResult=void 0,this.sendError=void 0}))}onSend(e){"profile"===window.cur.module&&(0,l.isVKCOMProfileRedesignedEnabled)()&&this.recipients.find((({id:e})=>e===window.cur.oid))&&(window.Profile?.hideBirthdayBlock(),window.Profile?.updateGiftBlock())}get confirmation(){return this.sendResult?.confirmation}get isSent(){return void 0!==this.sendResult&&!this.sendResult.confirmation}constructor(e,t){this.giftService=e,this.giftRecipientsProvider=t,this.props=void 0,this.giftId=void 0,this.gift=void 0,this.isLoadingGift=!1,this.giftError=void 0,this.giftAbortController=void 0,this.balance=void 0,this.isLoadingBalance=!1,this.balanceError=void 0,this.balanceAbortController=void 0,this.recipientIds=[],this.recipients=[],this.isLoadingRecipients=!1,this.recipientsError=void 0,this.recipientsAbortController=void 0,this.message="",this.isPrivate=!1,this.isSending=!1,this.sendResult=void 0,this.sendError=void 0,(0,r.makeAutoObservable)(this,{props:!1,gift:r.observable.ref,recipientIds:!1,recipients:r.observable.shallow})}}u=(0,s.__decorate)([c.scope.transient(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===o.GiftService?Object:o.GiftService,void 0===a.GiftRecipientsProvider?Object:a.GiftRecipientsProvider])],u);const{Provider:h,useModel:g}=(0,c.createProvider)(u)},952059:(e,t,i)=>{i.d(t,{showGiftModal:()=>a});var s=i(474848),r=i(507607),n=i(272259);const o=(0,r.asyncComponent)((()=>Promise.all([i.e(27602),i.e(52007)]).then(i.bind(i,21647))),(({GiftModalLegacy:e})=>e));function a(e){(0,n.showMessageBoxModalSuspense)((t=>(0,s.jsx)(o,{...e,...t})),{width:456})}},661008:(e,t,i)=>{i.d(t,{GiftRecipientsSelect:()=>f});var s=i(474848),r=i(296540),n=i(456921),o=i(753457),a=i(785118),c=i(828902),l=i(533048),d=i(280234),u=i(127126),h=i(770125),g=i(37625);function p(e){return{label:e.name||"",value:String(e.id),recipient:e}}const _=(0,n.observer)((()=>{const e=(0,h.useLangs)(),t=(0,g.useGiftRecipientsSelectModel)(),{props:i,searchQuery:n,recipients:u,isLoading:_,hasMore:f,isFocused:m}=t,v=()=>{t.setIsFocused(!0)},k=(0,r.useRef)(null);(0,r.useEffect)((()=>{m&&k.current?.focus()}),[m]);const S=(0,r.useRef)(void 0),y=e=>{e.preventDefault(),e.stopPropagation(),t.loadMore()},b=(0,r.useMemo)((()=>i?.value.map(p)??[]),[i?.value]),P=(0,r.useMemo)((()=>new Set(b.map((({value:e})=>e)))),[b]),L=(0,r.useMemo)((()=>{const e=u.map(p).filter((({value:e})=>!P.has(e)));return f?e.push({label:"",value:"",preset:"loadMore"}):_&&e.push({label:"",value:"",preset:"loading"}),e}),[u,f,_,P]);return(0,s.jsx)(o.ChipsSelect,{mode:"default",disabled:Boolean(i?.isDisabled),value:b,options:L,filterFn:()=>!0,creatable:!1,onChange:e=>{i?.onChange(e.map((({recipient:e})=>e)).filter((e=>void 0!==e))),v()},selectedBehavior:"hide",closeAfterSelect:!1,inputValue:n??"",onInputChange:e=>{const{value:i}=e.target;t.searchQuery=i,S.current&&clearTimeout(S.current),S.current=setTimeout((()=>{t.load()}),300)},getRef:k,onFocus:v,onBlur:()=>{t.setIsFocused(!1)},placeholder:e.getLang("gifts_choose_recipients"),emptyText:e.getLang("gifts_nobody_found"),renderOption:(i,r)=>{const{preset:n,recipient:u}=r;if("loading"===n)return(0,s.jsx)(a.Div,{children:(0,s.jsx)(c.Spinner,{size:"small"})});if("loadMore"===n)return(0,s.jsx)(a.Div,{children:(0,s.jsx)(l.Button,{appearance:"neutral",size:"s",loading:_,onClick:y,children:e.getLang("gifts_gift_modal_recipients_load_more")})});if(!u)return;const h=t.getPhoto(u,40,40,window.devicePixelRatio),g=h&&t.getAvatarBadgePreset(u),p=(0,s.jsx)(d.RichAvatar,{size:40,src:h?.url,children:g&&(0,s.jsx)(d.RichAvatar.BadgeWithPreset,{preset:g})});return(0,s.jsx)(o.CustomSelectOption,{...i,before:p,description:u.description,children:u.name})}})})),f=(0,u.createWidget)(g.GiftRecipientsSelectModelProvider,_)},594976:(e,t,i)=>{i.d(t,{GiftRecipientsSelect:()=>s.GiftRecipientsSelect});var s=i(661008)},37625:(e,t,i)=>{i.d(t,{GiftRecipientsSelectModelProvider:()=>c,useGiftRecipientsSelectModel:()=>l});var s=i(331635),r=i(327813),n=i(175026),o=i(127126);class a{[o.init](e){this[o.update](e)}[o.update](e){return this.props=e,void 0===this.prevSearchQuery&&this.load(),void 0===this.isFocused&&this.setIsFocused(e.isFocused),this}get hasMore(){return void 0!==this.totalCount&&this.recipients.length<this.totalCount}load(){this.searchQuery!==this.prevSearchQuery&&(this.recipients=[],this.totalCount=void 0,this.fetch(this.searchQuery))}loadMore(){const e=this.recipients.length;void 0!==this.totalCount&&e>=this.totalCount||this.fetch(this.prevSearchQuery??"",e)}async fetch(e,t=0){this.abortController?.abort(void 0),this.abortController=new AbortController,this.prevSearchQuery=e,this.isLoading=!0;try{const[i,s]=await(""!==e?this.giftRecipientsProvider.searchGiftRecipients(e,t,25,this.abortController.signal):this.cache.get(t)??this.giftRecipientsProvider.fetchSuggestedGiftRecipients(t,25,this.abortController.signal));(0,r.runInAction)((()=>{e===this.prevSearchQuery&&(""===e&&this.cache.set(t,[i,s]),this.recipients.push(...i),this.totalCount=s,this.isLoading=!1,this.error=void 0,this.abortController=void 0)}))}catch(t){console.error(t),(0,r.runInAction)((()=>{e===this.prevSearchQuery&&(this.isLoading=!1,this.error=t,this.abortController=void 0)}))}}setIsFocused(e){this.isFocused=e}[o.destroy](){this.cache.clear(),this.recipients=[],this.prevSearchQuery=void 0,this.searchQuery="",this.isLoading=!1,this.totalCount=void 0,this.error=void 0,this.abortController?.abort(void 0),this.abortController=void 0,this.isFocused=void 0}getPhoto(e,t,i,s){return e.photos.find((e=>e.width>=t*s&&e.height>=i*s))??e.photos[0]}getAvatarBadgePreset(e){return e.isOnlineMobile?"online-mobile":e.isOnline?"online":void 0}constructor(e){this.giftRecipientsProvider=e,this.props=void 0,this.cache=new Map,this.recipients=[],this.prevSearchQuery=void 0,this.searchQuery="",this.isLoading=!1,this.totalCount=void 0,this.error=void 0,this.abortController=void 0,this.isFocused=void 0,(0,r.makeAutoObservable)(this,{props:r.observable.shallow,recipients:r.observable.shallow})}}a=(0,s.__decorate)([o.scope.transient(),(0,s.__metadata)("design:type",Function),(0,s.__metadata)("design:paramtypes",[void 0===n.GiftRecipientsProvider?Object:n.GiftRecipientsProvider])],a);const{Provider:c,useModel:l}=(0,o.createProvider)(a)}}]);try{stManager.done("dist/web/chunks/fc936a0f.f81dde02.js")}catch(e){}